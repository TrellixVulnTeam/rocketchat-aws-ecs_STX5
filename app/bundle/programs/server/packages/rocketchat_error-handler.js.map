{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:error-handler/server/lib/RocketChat.ErrorHandler.js","meteor://ðŸ’»app/packages/rocketchat:error-handler/server/startup/settings.js"],"names":["ErrorHandler","constructor","reporting","rid","lastError","registerHandlers","RocketChat","settings","get","key","value","trim","getRoomId","process","on","Meteor","bindEnvironment","error","trackError","message","stack","self","originalMeteorDebug","_debug","call","apply","arguments","roomName","replace","room","models","Rooms","findOneByName","fields","_id","t","user","Users","findOneById","sendMessage","msg","addGroup","add","type"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAMA,YAAN,CAAmB;AAClBC,eAAc;AACb,OAAKC,SAAL,GAAiB,KAAjB;AACA,OAAKC,GAAL,GAAW,IAAX;AACA,OAAKC,SAAL,GAAiB,IAAjB;AAEA,OAAKC,gBAAL;AAEAC,aAAWC,QAAX,CAAoBC,GAApB,CAAwB,2BAAxB,EAAqD,CAACC,GAAD,EAAMC,KAAN,KAAgB;AACpE,OAAIA,MAAMC,IAAN,EAAJ,EAAkB;AACjB,SAAKT,SAAL,GAAiB,IAAjB;AACA,SAAKC,GAAL,GAAW,KAAKS,SAAL,CAAeF,KAAf,CAAX;AACA,IAHD,MAGO;AACN,SAAKR,SAAL,GAAiB,KAAjB;AACA,SAAKC,GAAL,GAAW,EAAX;AACA;AACD,GARD;AASA;;AAEDE,oBAAmB;AAClBQ,UAAQC,EAAR,CAAW,mBAAX,EAAgCC,OAAOC,eAAP,CAAwBC,KAAD,IAAW;AACjE,OAAI,CAAC,KAAKf,SAAV,EAAqB;AACpB;AACA;;AACD,QAAKgB,UAAL,CAAgBD,MAAME,OAAtB,EAA+BF,MAAMG,KAArC;AACA,GAL+B,CAAhC;AAOA,QAAMC,OAAO,IAAb;AACA,QAAMC,sBAAsBP,OAAOQ,MAAnC;;AACAR,SAAOQ,MAAP,GAAgB,UAASJ,OAAT,EAAkBC,KAAlB,EAAyB;AACxC,OAAI,CAACC,KAAKnB,SAAV,EAAqB;AACpB,WAAOoB,oBAAoBE,IAApB,CAAyB,IAAzB,EAA+BL,OAA/B,EAAwCC,KAAxC,CAAP;AACA;;AACDC,QAAKH,UAAL,CAAgBC,OAAhB,EAAyBC,KAAzB;AACA,UAAOE,oBAAoBG,KAApB,CAA0B,IAA1B,EAAgCC,SAAhC,CAAP;AACA,GAND;AAOA;;AAEDd,WAAUe,QAAV,EAAoB;AACnBA,aAAWA,SAASC,OAAT,CAAiB,GAAjB,CAAX;AACA,QAAMC,OAAOvB,WAAWwB,MAAX,CAAkBC,KAAlB,CAAwBC,aAAxB,CAAsCL,QAAtC,EAAgD;AAAEM,WAAQ;AAAEC,SAAK,CAAP;AAAUC,OAAG;AAAb;AAAV,GAAhD,CAAb;;AACA,MAAIN,SAASA,KAAKM,CAAL,KAAW,GAAX,IAAkBN,KAAKM,CAAL,KAAW,GAAtC,CAAJ,EAAgD;AAC/C,UAAON,KAAKK,GAAZ;AACA,GAFD,MAEO;AACN,QAAKhC,SAAL,GAAiB,KAAjB;AACA;AACD;;AAEDgB,YAAWC,OAAX,EAAoBC,KAApB,EAA2B;AAC1B,MAAI,KAAKlB,SAAL,IAAkB,KAAKC,GAAvB,IAA8B,KAAKC,SAAL,KAAmBe,OAArD,EAA8D;AAC7D,QAAKf,SAAL,GAAiBe,OAAjB;AACA,SAAMiB,OAAO9B,WAAWwB,MAAX,CAAkBO,KAAlB,CAAwBC,WAAxB,CAAoC,YAApC,CAAb;;AAEA,OAAIlB,KAAJ,EAAW;AACVD,cAAW,GAAGA,OAAS,aAAaC,KAAO,UAA3C;AACA;;AAEDd,cAAWiC,WAAX,CAAuBH,IAAvB,EAA6B;AAAEI,SAAKrB;AAAP,IAA7B,EAA+C;AAAEe,SAAK,KAAK/B;AAAZ,IAA/C;AACA;AACD;;AA3DiB;;AA8DnBG,WAAWN,YAAX,GAA0B,IAAIA,YAAJ,EAA1B,C;;;;;;;;;;;AC9DAM,WAAWC,QAAX,CAAoBkC,QAApB,CAA6B,MAA7B,EAAqC,YAAW;AAC/C,MAAKC,GAAL,CAAS,2BAAT,EAAsC,EAAtC,EAA0C;AAAEC,QAAM;AAAR,EAA1C;AACA,CAFD,E","file":"/packages/rocketchat_error-handler.js","sourcesContent":["class ErrorHandler {\n\tconstructor() {\n\t\tthis.reporting = false;\n\t\tthis.rid = null;\n\t\tthis.lastError = null;\n\n\t\tthis.registerHandlers();\n\n\t\tRocketChat.settings.get('Log_Exceptions_to_Channel', (key, value) => {\n\t\t\tif (value.trim()) {\n\t\t\t\tthis.reporting = true;\n\t\t\t\tthis.rid = this.getRoomId(value);\n\t\t\t} else {\n\t\t\t\tthis.reporting = false;\n\t\t\t\tthis.rid = '';\n\t\t\t}\n\t\t});\n\t}\n\n\tregisterHandlers() {\n\t\tprocess.on('uncaughtException', Meteor.bindEnvironment((error) => {\n\t\t\tif (!this.reporting) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.trackError(error.message, error.stack);\n\t\t}));\n\n\t\tconst self = this;\n\t\tconst originalMeteorDebug = Meteor._debug;\n\t\tMeteor._debug = function(message, stack) {\n\t\t\tif (!self.reporting) {\n\t\t\t\treturn originalMeteorDebug.call(this, message, stack);\n\t\t\t}\n\t\t\tself.trackError(message, stack);\n\t\t\treturn originalMeteorDebug.apply(this, arguments);\n\t\t};\n\t}\n\n\tgetRoomId(roomName) {\n\t\troomName = roomName.replace('#');\n\t\tconst room = RocketChat.models.Rooms.findOneByName(roomName, { fields: { _id: 1, t: 1 } });\n\t\tif (room && (room.t === 'c' || room.t === 'p')) {\n\t\t\treturn room._id;\n\t\t} else {\n\t\t\tthis.reporting = false;\n\t\t}\n\t}\n\n\ttrackError(message, stack) {\n\t\tif (this.reporting && this.rid && this.lastError !== message) {\n\t\t\tthis.lastError = message;\n\t\t\tconst user = RocketChat.models.Users.findOneById('rocket.cat');\n\n\t\t\tif (stack) {\n\t\t\t\tmessage = `${ message }\\n\\`\\`\\`\\n${ stack }\\n\\`\\`\\``;\n\t\t\t}\n\n\t\t\tRocketChat.sendMessage(user, { msg: message }, { _id: this.rid });\n\t\t}\n\t}\n}\n\nRocketChat.ErrorHandler = new ErrorHandler;\n","RocketChat.settings.addGroup('Logs', function() {\n\tthis.add('Log_Exceptions_to_Channel', '', { type: 'string' });\n});\n"]}