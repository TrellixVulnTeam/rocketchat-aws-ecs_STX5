{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:mentions/server/server.js","meteor://ðŸ’»app/packages/rocketchat:mentions/server/Mentions.js","meteor://ðŸ’»app/packages/rocketchat:mentions/Mentions.js"],"names":["_","module","watch","require","default","v","MentionsServer","mention","pattern","RocketChat","settings","get","messageMaxAll","getUsers","usernames","Meteor","users","find","username","$in","unique","fields","_id","fetch","getChannel","rid","models","Rooms","findOneById","getChannels","channels","name","t","callbacks","add","message","execute","priority","HIGH","export","Mentions","constructor","args","m","_getUsers","_getChannels","_getChannel","_messageMaxAll","getUsersByMentions","msg","mentions","getUserMentions","mentionsAll","userMentions","forEach","trim","substr","push","allChannel","length","getChannelbyMentions","getChannelMentions","map","c","exportDefault","useRealName","me","_me","p","_pattern","s","_useRealName","userMentionRegex","RegExp","channelMentionRegex","replaceUsers","str","replace","match","includes","mentionObj","findWhere","temp","replaceChannels","n1","n2","test","parse","html"],"mappings":"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","file":"/packages/rocketchat_mentions.js","sourcesContent":["import _ from 'underscore';\nimport MentionsServer from './Mentions';\n\nconst mention = new MentionsServer({\n\tpattern: () => RocketChat.settings.get('UTF8_Names_Validation'),\n\tmessageMaxAll: () => RocketChat.settings.get('Message_MaxAll'),\n\tgetUsers: (usernames) => Meteor.users.find({ username: {$in: _.unique(usernames)}}, { fields: {_id: true, username: true }}).fetch(),\n\tgetChannel: (rid) => RocketChat.models.Rooms.findOneById(rid),\n\tgetChannels: (channels) => RocketChat.models.Rooms.find({ name: {$in: _.unique(channels)}, t: 'c'\t}, { fields: {_id: 1, name: 1 }}).fetch()\n});\nRocketChat.callbacks.add('beforeSaveMessage', (message) => mention.execute(message), RocketChat.callbacks.priority.HIGH, 'mentions');\n","/*\n* Mentions is a named function that will process Mentions\n* @param {Object} message - The message object\n*/\nimport Mentions from '../Mentions';\nexport default class MentionsServer extends Mentions {\n\tconstructor(args) {\n\t\tsuper(args);\n\t\tthis.messageMaxAll = args.messageMaxAll;\n\t\tthis.getChannel = args.getChannel;\n\t\tthis.getChannels = args.getChannels;\n\t\tthis.getUsers = args.getUsers;\n\t}\n\tset getUsers(m) {\n\t\tthis._getUsers = m;\n\t}\n\tget getUsers() {\n\t\treturn typeof this._getUsers === 'function' ? this._getUsers : () => this._getUsers;\n\t}\n\tset getChannels(m) {\n\t\tthis._getChannels = m;\n\t}\n\tget getChannels() {\n\t\treturn typeof this._getChannels === 'function' ? this._getChannels : () => this._getChannels;\n\t}\n\tset getChannel(m) {\n\t\tthis._getChannel = m;\n\t}\n\tget getChannel() {\n\t\treturn typeof this._getChannel === 'function' ? this._getChannel : () => this._getChannel;\n\t}\n\tset messageMaxAll(m) {\n\t\tthis._messageMaxAll = m;\n\t}\n\tget messageMaxAll() {\n\t\treturn typeof this._messageMaxAll === 'function' ? this._messageMaxAll() : this._messageMaxAll;\n\t}\n\tgetUsersByMentions({msg, rid}) {\n\t\tlet mentions = this.getUserMentions(msg);\n\t\tconst mentionsAll = [];\n\t\tconst userMentions = [];\n\n\t\tmentions.forEach((m) => {\n\t\t\tconst mention = m.trim().substr(1);\n\t\t\tif (mention !== 'all' && mention !== 'here') {\n\t\t\t\treturn userMentions.push(mention);\n\t\t\t}\n\t\t\tif (mention === 'all') {\n\t\t\t\tconst messageMaxAll = this.messageMaxAll;\n\t\t\t\tconst allChannel = this.getChannel(rid);\n\t\t\t\tif (messageMaxAll !== 0 && allChannel.usernames.length >= messageMaxAll) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tmentionsAll.push({\n\t\t\t\t_id: mention,\n\t\t\t\tusername: mention\n\t\t\t});\n\t\t});\n\t\tmentions = userMentions.length ? this.getUsers(userMentions) : [];\n\t\treturn [...mentionsAll, ...mentions];\n\t}\n\tgetChannelbyMentions({msg}) {\n\t\tconst channels = this.getChannelMentions(msg);\n\t\treturn this.getChannels(channels.map(c => c.trim().substr(1)));\n\t}\n\texecute(message) {\n\t\tconst mentionsAll = this.getUsersByMentions(message);\n\t\tconst channels = this.getChannelbyMentions(message);\n\n\t\tmessage.mentions = mentionsAll;\n\n\t\tmessage.channels = channels;\n\t\treturn message;\n\t}\n}\n","/*\n* Mentions is a named function that will process Mentions\n* @param {Object} message - The message object\n*/\nimport _ from 'underscore';\nexport default class {\n\tconstructor({pattern, useRealName, me}) {\n\t\tthis.pattern = pattern;\n\t\tthis.useRealName = useRealName;\n\t\tthis.me = me;\n\t}\n\tset me(m) {\n\t\tthis._me = m;\n\t}\n\tget me() {\n\t\treturn typeof this._me === 'function' ? this._me() : this._me;\n\t}\n\tset pattern(p) {\n\t\tthis._pattern = p;\n\t}\n\tget pattern() {\n\t\treturn typeof this._pattern === 'function' ? this._pattern() : this._pattern;\n\t}\n\tset useRealName(s) {\n\t\tthis._useRealName = s;\n\t}\n\tget useRealName() {\n\t\treturn typeof this._useRealName === 'function' ? this._useRealName() : this._useRealName;\n\t}\n\tget userMentionRegex() {\n\t\treturn new RegExp(`@(${ this.pattern })`, 'gm');\n\t}\n\tget channelMentionRegex() {\n\t\treturn new RegExp(`^#(${ this.pattern })| #(${ this.pattern })`, 'gm');\n\t}\n\treplaceUsers(str, message, me) {\n\t\treturn str.replace(this.userMentionRegex, (match, username) => {\n\t\t\tif (['all', 'here'].includes(username)) {\n\t\t\t\treturn `<a class=\"mention-link mention-link-me mention-link-all background-attention-color\">${ match }</a>`;\n\t\t\t}\n\n\t\t\tconst mentionObj = _.findWhere(message.mentions, {username});\n\t\t\tif (message.temp == null && mentionObj == null) {\n\t\t\t\treturn match;\n\t\t\t}\n\t\t\tconst name = this.useRealName && mentionObj && mentionObj.name;\n\n\t\t\treturn `<a class=\"mention-link ${ username === me ? 'mention-link-me background-primary-action-color':'' }\" data-username=\"${ username }\" title=\"${ name ? username : '' }\">${ name || match }</a>`;\n\t\t});\n\t}\n\treplaceChannels(str, message) {\n\t\t//since apostrophe escaped contains # we need to unescape it\n\t\treturn str.replace(/&#39;/g, '\\'').replace(this.channelMentionRegex, (match, n1, n2) => {\n\t\t\tconst name = n1 || n2;\n\t\t\tif (message.temp == null && _.findWhere(message.channels, {name}) == null) {\n\t\t\t\treturn match;\n\t\t\t}\n\n\t\t\t// remove the link from inside the link and put before\n\t\t\tif (/^\\s/.test(match)) {\n\t\t\t\treturn ` <a class=\"mention-link\" data-channel=\"${ name }\">${ match.trim() }</a>`;\n\t\t\t}\n\n\t\t\treturn `<a class=\"mention-link\" data-channel=\"${ name }\">${ match }</a>`;\n\t\t});\n\t}\n\tgetUserMentions(str) {\n\t\treturn str.match(this.userMentionRegex) || [];\n\t}\n\tgetChannelMentions(str) {\n\t\treturn (str.match(this.channelMentionRegex) || []).map(match => match.trim());\n\t}\n\tparse(message) {\n\t\tlet msg = (message && message.html) || '';\n\t\tif (!msg.trim()) {\n\t\t\treturn message;\n\t\t}\n\t\tmsg = this.replaceUsers(msg, message, this.me);\n\t\tmsg = this.replaceChannels(msg, message, this.me);\n\t\tmessage.html = msg;\n\t\treturn message;\n\t}\n}\n"]}