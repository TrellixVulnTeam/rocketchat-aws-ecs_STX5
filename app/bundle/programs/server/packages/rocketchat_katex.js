(function () {

/* Imports */
var Meteor = Package.meteor.Meteor;
var global = Package.meteor.global;
var meteorEnv = Package.meteor.meteorEnv;
var ECMAScript = Package.ecmascript.ECMAScript;
var RocketChat = Package['rocketchat:lib'].RocketChat;
var meteorInstall = Package.modules.meteorInstall;
var meteorBabelHelpers = Package['babel-runtime'].meteorBabelHelpers;
var Promise = Package.promise.Promise;
var TAPi18next = Package['tap:i18n'].TAPi18next;
var TAPi18n = Package['tap:i18n'].TAPi18n;

/* Package-scope variables */
var str, message;

var require = meteorInstall({"node_modules":{"meteor":{"rocketchat:katex":{"settings.js":function(){

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                  //
// packages/rocketchat_katex/settings.js                                                                            //
//                                                                                                                  //
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                    //
Meteor.startup(function () {
	const enableQuery = {
		_id: 'Katex_Enabled',
		value: true
	};
	RocketChat.settings.add('Katex_Enabled', true, {
		type: 'boolean',
		group: 'Message',
		section: 'Katex',
		'public': true,
		i18n: 'Katex_Enabled_Description'
	});
	RocketChat.settings.add('Katex_Parenthesis_Syntax', true, {
		type: 'boolean',
		group: 'Message',
		section: 'Katex',
		'public': true,
		enableQuery,
		i18nDescription: 'Katex_Parenthesis_Syntax_Description'
	});
	return RocketChat.settings.add('Katex_Dollar_Syntax', false, {
		type: 'boolean',
		group: 'Message',
		section: 'Katex',
		'public': true,
		enableQuery,
		i18nDescription: 'Katex_Dollar_Syntax_Description'
	});
}); // ---
// generated by coffee-script 1.9.2
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"katex.js":function(require,exports,module){

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                  //
// packages/rocketchat_katex/katex.js                                                                               //
//                                                                                                                  //
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                    //
let _;

module.watch(require("underscore"), {
	default(v) {
		_ = v;
	}

}, 0);
let s;
module.watch(require("underscore.string"), {
	default(v) {
		s = v;
	}

}, 1);

const katex = require('katex');

class Boundary {
	constructor() {}

	length() {
		return this.end - this.start;
	}

	extract(str) {
		return str.substr(this.start, this.length());
	}

}

class Katex {
	constructor() {
		this.delimiters_map = [{
			opener: '\\[',
			closer: '\\]',
			displayMode: true,
			enabled: () => {
				return this.parenthesis_syntax_enabled();
			}
		}, {
			opener: '\\(',
			closer: '\\)',
			displayMode: false,
			enabled: () => {
				return this.parenthesis_syntax_enabled();
			}
		}, {
			opener: '$$',
			closer: '$$',
			displayMode: true,
			enabled: () => {
				return this.dollar_syntax_enabled();
			}
		}, {
			opener: '$',
			closer: '$',
			displayMode: false,
			enabled: () => {
				return this.dollar_syntax_enabled();
			}
		}];
	} // Searches for the first opening delimiter in the string from a given position


	find_opening_delimiter(str, start) {
		// Search the string for each opening delimiter
		const matches = (() => {
			const map = this.delimiters_map;
			const results = [];
			map.forEach(op => {
				if (op.enabled()) {
					results.push({
						options: op,
						pos: str.indexOf(op.opener, start)
					});
				}
			});
			return results;
		})();

		const positions = (() => {
			const results = [];
			matches.forEach(pos => {
				if (pos.pos >= 0) {
					results.push(pos.pos);
				}
			});
			return results;
		})(); // No opening delimiters were found


		if (positions.length === 0) {
			return null;
		} //Take the first delimiter found


		const pos = Math.min.apply(Math, positions);

		const match_index = (() => {
			const results = [];
			matches.forEach(m => {
				results.push(m.pos);
			});
			return results;
		})().indexOf(pos);

		const match = matches[match_index];
		return match;
	} // Returns the outer and inner boundaries of the latex block starting
	// at the given opening delimiter


	get_latex_boundaries(str, opening_delimiter_match) {
		const inner = new Boundary();
		const outer = new Boundary(); // The closing delimiter matching to the opening one

		const closer = opening_delimiter_match.options.closer;
		outer.start = opening_delimiter_match.pos;
		inner.start = opening_delimiter_match.pos + closer.length; // Search for a closer delimiter after the opening one

		const closer_index = str.substr(inner.start).indexOf(closer);

		if (closer_index < 0) {
			return null;
		}

		inner.end = inner.start + closer_index;
		outer.end = inner.end + closer.length;
		return {
			outer,
			inner
		};
	} // Searches for the first latex block in the given string


	find_latex(str) {
		let start = 0;
		let opening_delimiter_match;

		while ((opening_delimiter_match = this.find_opening_delimiter(str, start++)) != null) {
			const match = this.get_latex_boundaries(str, opening_delimiter_match);

			if (match && match.inner.extract(str).trim().length) {
				match.options = opening_delimiter_match.options;
				return match;
			}
		}

		return null;
	} // Breaks a message to what comes before, after and to the content of a
	// matched latex block


	extract_latex(str, match) {
		const before = str.substr(0, match.outer.start);
		const after = str.substr(match.outer.end);
		let latex = match.inner.extract(str);
		latex = s.unescapeHTML(latex);
		return {
			before,
			latex,
			after
		};
	} // Takes a latex math string and the desired display mode and renders it
	// to HTML using the KaTeX library


	render_latex(latex, displayMode) {
		let rendered;

		try {
			rendered = katex.renderToString(latex, {
				displayMode
			});
		} catch (error) {
			const e = error;
			const display_mode = displayMode ? 'block' : 'inline';
			rendered = `<div class="katex-error katex-${display_mode}-error">`;
			rendered += `${s.escapeHTML(e.message)}`;
			rendered += '</div>';
		}

		return rendered;
	} // Takes a string and renders all latex blocks inside it


	render(str, render_func) {
		let result = '';

		while (this.find_latex(str) != null) {
			// Find the first latex block in the string
			const match = this.find_latex(str);
			const parts = this.extract_latex(str, match); // Add to the reuslt what comes before the latex block as well as
			// the rendered latex content

			const rendered = render_func(parts.latex, match.options.displayMode);
			result += parts.before + rendered; // Set what comes after the latex block to be examined next

			str = parts.after;
		}

		return result += str;
	} // Takes a rocketchat message and renders latex in its content


	render_message(message) {
		//Render only if enabled in admin panel
		let render_func;

		if (this.katex_enabled()) {
			let msg = message;

			if (!_.isString(message)) {
				if (s.trim(message.html)) {
					msg = message.html;
				} else {
					return message;
				}
			}

			if (_.isString(message)) {
				render_func = (latex, displayMode) => {
					return this.render_latex(latex, displayMode);
				};
			} else {
				if (message.tokens == null) {
					message.tokens = [];
				}

				render_func = (latex, displayMode) => {
					const token = `=!=${Random.id()}=!=`;
					message.tokens.push({
						token,
						text: this.render_latex(latex, displayMode)
					});
					return token;
				};
			}

			msg = this.render(msg, render_func);

			if (!_.isString(message)) {
				message.html = msg;
			} else {
				message = msg;
			}
		}

		return message;
	}

	katex_enabled() {
		return RocketChat.settings.get('Katex_Enabled');
	}

	dollar_syntax_enabled() {
		return RocketChat.settings.get('Katex_Dollar_Syntax');
	}

	parenthesis_syntax_enabled() {
		return RocketChat.settings.get('Katex_Parenthesis_Syntax');
	}

}

RocketChat.katex = new Katex();
const cb = RocketChat.katex.render_message.bind(RocketChat.katex);
RocketChat.callbacks.add('renderMessage', cb, RocketChat.callbacks.priority.HIGH - 1, 'katex');

if (Meteor.isClient) {
	Blaze.registerHelper('RocketChatKatex', function (text) {
		return RocketChat.katex.render_message(text);
	});
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"node_modules":{"katex":{"package.json":function(require,exports){

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                  //
// node_modules/katex/package.json                                                                                  //
//                                                                                                                  //
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                    //
exports.name = "katex";
exports.version = "0.7.1";
exports.main = "katex.js";

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"katex.js":function(require,exports,module){

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                  //
// node_modules/meteor/rocketchat_katex/node_modules/katex/katex.js                                                 //
//                                                                                                                  //
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                    //
/* eslint no-console:0 */
/**
 * This is the main entry point for KaTeX. Here, we expose functions for
 * rendering expressions either to DOM nodes or to markup strings.
 *
 * We also expose the ParseError class to check if errors thrown from KaTeX are
 * errors in the expression, or errors in javascript handling.
 */

var ParseError = require("./src/ParseError");
var Settings = require("./src/Settings");

var buildTree = require("./src/buildTree");
var parseTree = require("./src/parseTree");
var utils = require("./src/utils");

/**
 * Parse and build an expression, and place that expression in the DOM node
 * given.
 */
var render = function(expression, baseNode, options) {
    utils.clearNode(baseNode);

    var settings = new Settings(options);

    var tree = parseTree(expression, settings);
    var node = buildTree(tree, expression, settings).toNode();

    baseNode.appendChild(node);
};

// KaTeX's styles don't work properly in quirks mode. Print out an error, and
// disable rendering.
if (typeof document !== "undefined") {
    if (document.compatMode !== "CSS1Compat") {
        typeof console !== "undefined" && console.warn(
            "Warning: KaTeX doesn't work in quirks mode. Make sure your " +
                "website has a suitable doctype.");

        render = function() {
            throw new ParseError("KaTeX doesn't work in quirks mode.");
        };
    }
}

/**
 * Parse and build an expression, and return the markup for that.
 */
var renderToString = function(expression, options) {
    var settings = new Settings(options);

    var tree = parseTree(expression, settings);
    return buildTree(tree, expression, settings).toMarkup();
};

/**
 * Parse an expression and return the parse tree.
 */
var generateParseTree = function(expression, options) {
    var settings = new Settings(options);
    return parseTree(expression, settings);
};

module.exports = {
    render: render,
    renderToString: renderToString,
    /**
     * NOTE: This method is not currently recommended for public use.
     * The internal tree representation is unstable and is very likely
     * to change. Use at your own risk.
     */
    __parse: generateParseTree,
    ParseError: ParseError
};

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}}}}}}},{
  "extensions": [
    ".js",
    ".json"
  ]
});
require("./node_modules/meteor/rocketchat:katex/settings.js");
require("./node_modules/meteor/rocketchat:katex/katex.js");

/* Exports */
if (typeof Package === 'undefined') Package = {};
Package['rocketchat:katex'] = {};

})();

//# sourceURL=meteor://💻app/packages/rocketchat_katex.js
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1ldGVvcjovL/CfkrthcHAvcGFja2FnZXMvcm9ja2V0Y2hhdDprYXRleC9zZXR0aW5ncy5qcyIsIm1ldGVvcjovL/CfkrthcHAvcGFja2FnZXMvcm9ja2V0Y2hhdDprYXRleC9rYXRleC5qcyJdLCJuYW1lcyI6WyJNZXRlb3IiLCJzdGFydHVwIiwiZW5hYmxlUXVlcnkiLCJfaWQiLCJ2YWx1ZSIsIlJvY2tldENoYXQiLCJzZXR0aW5ncyIsImFkZCIsInR5cGUiLCJncm91cCIsInNlY3Rpb24iLCJpMThuIiwiaTE4bkRlc2NyaXB0aW9uIiwiXyIsIm1vZHVsZSIsIndhdGNoIiwicmVxdWlyZSIsImRlZmF1bHQiLCJ2IiwicyIsImthdGV4IiwiQm91bmRhcnkiLCJjb25zdHJ1Y3RvciIsImxlbmd0aCIsImVuZCIsInN0YXJ0IiwiZXh0cmFjdCIsInN0ciIsInN1YnN0ciIsIkthdGV4IiwiZGVsaW1pdGVyc19tYXAiLCJvcGVuZXIiLCJjbG9zZXIiLCJkaXNwbGF5TW9kZSIsImVuYWJsZWQiLCJwYXJlbnRoZXNpc19zeW50YXhfZW5hYmxlZCIsImRvbGxhcl9zeW50YXhfZW5hYmxlZCIsImZpbmRfb3BlbmluZ19kZWxpbWl0ZXIiLCJtYXRjaGVzIiwibWFwIiwicmVzdWx0cyIsImZvckVhY2giLCJvcCIsInB1c2giLCJvcHRpb25zIiwicG9zIiwiaW5kZXhPZiIsInBvc2l0aW9ucyIsIk1hdGgiLCJtaW4iLCJhcHBseSIsIm1hdGNoX2luZGV4IiwibSIsIm1hdGNoIiwiZ2V0X2xhdGV4X2JvdW5kYXJpZXMiLCJvcGVuaW5nX2RlbGltaXRlcl9tYXRjaCIsImlubmVyIiwib3V0ZXIiLCJjbG9zZXJfaW5kZXgiLCJmaW5kX2xhdGV4IiwidHJpbSIsImV4dHJhY3RfbGF0ZXgiLCJiZWZvcmUiLCJhZnRlciIsImxhdGV4IiwidW5lc2NhcGVIVE1MIiwicmVuZGVyX2xhdGV4IiwicmVuZGVyZWQiLCJyZW5kZXJUb1N0cmluZyIsImVycm9yIiwiZSIsImRpc3BsYXlfbW9kZSIsImVzY2FwZUhUTUwiLCJtZXNzYWdlIiwicmVuZGVyIiwicmVuZGVyX2Z1bmMiLCJyZXN1bHQiLCJwYXJ0cyIsInJlbmRlcl9tZXNzYWdlIiwia2F0ZXhfZW5hYmxlZCIsIm1zZyIsImlzU3RyaW5nIiwiaHRtbCIsInRva2VucyIsInRva2VuIiwiUmFuZG9tIiwiaWQiLCJ0ZXh0IiwiZ2V0IiwiY2IiLCJiaW5kIiwiY2FsbGJhY2tzIiwicHJpb3JpdHkiLCJISUdIIiwiaXNDbGllbnQiLCJCbGF6ZSIsInJlZ2lzdGVySGVscGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUFBLE9BQU9DLE9BQVAsQ0FBZSxZQUFXO0FBQ3pCLE9BQU1DLGNBQWM7QUFDbkJDLE9BQUssZUFEYztBQUVuQkMsU0FBTztBQUZZLEVBQXBCO0FBSUFDLFlBQVdDLFFBQVgsQ0FBb0JDLEdBQXBCLENBQXdCLGVBQXhCLEVBQXlDLElBQXpDLEVBQStDO0FBQzlDQyxRQUFNLFNBRHdDO0FBRTlDQyxTQUFPLFNBRnVDO0FBRzlDQyxXQUFTLE9BSHFDO0FBSTlDLFlBQVUsSUFKb0M7QUFLOUNDLFFBQU07QUFMd0MsRUFBL0M7QUFPQU4sWUFBV0MsUUFBWCxDQUFvQkMsR0FBcEIsQ0FBd0IsMEJBQXhCLEVBQW9ELElBQXBELEVBQTBEO0FBQ3pEQyxRQUFNLFNBRG1EO0FBRXpEQyxTQUFPLFNBRmtEO0FBR3pEQyxXQUFTLE9BSGdEO0FBSXpELFlBQVUsSUFKK0M7QUFLekRSLGFBTHlEO0FBTXpEVSxtQkFBaUI7QUFOd0MsRUFBMUQ7QUFRQSxRQUFPUCxXQUFXQyxRQUFYLENBQW9CQyxHQUFwQixDQUF3QixxQkFBeEIsRUFBK0MsS0FBL0MsRUFBc0Q7QUFDNURDLFFBQU0sU0FEc0Q7QUFFNURDLFNBQU8sU0FGcUQ7QUFHNURDLFdBQVMsT0FIbUQ7QUFJNUQsWUFBVSxJQUprRDtBQUs1RFIsYUFMNEQ7QUFNNURVLG1CQUFpQjtBQU4yQyxFQUF0RCxDQUFQO0FBUUEsQ0E1QkQsRSxDQThCQTtBQUNB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QUFLcEYsV0FBV2UsS0FBWCxDQUFpQjBELGNBQWpCLENBQWdDWSxJQUFoQyxDQUFxQ3JGLFdBQVdlLEtBQWhELENBQVg7QUFFQWYsV0FBV3NGLFNBQVgsQ0FBcUJwRixHQUFyQixDQUF5QixlQUF6QixFQUEwQ2tGLEVBQTFDLEVBQThDcEYsV0FBV3NGLFNBQVgsQ0FBcUJDLFFBQXJCLENBQThCQyxJQUE5QixHQUFxQyxDQUFuRixFQUFzRixPQUF0Rjs7QUFFQSxJQUFJN0YsT0FBTzhGLFFBQVgsRUFBcUI7QUFDcEJDLE9BQU1DLGNBQU4sQ0FBcUIsaUJBQXJCLEVBQXdDLFVBQVNULElBQVQsRUFBZTtBQUN0RCxTQUFPbEYsV0FBV2UsS0FBWCxDQUFpQjBELGNBQWpCLENBQWdDUyxJQUFoQyxDQUFQO0FBQ0EsRUFGRDtBQUdBLEMiLCJmaWxlIjoiL3BhY2thZ2VzL3JvY2tldGNoYXRfa2F0ZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJNZXRlb3Iuc3RhcnR1cChmdW5jdGlvbigpIHtcblx0Y29uc3QgZW5hYmxlUXVlcnkgPSB7XG5cdFx0X2lkOiAnS2F0ZXhfRW5hYmxlZCcsXG5cdFx0dmFsdWU6IHRydWVcblx0fTtcblx0Um9ja2V0Q2hhdC5zZXR0aW5ncy5hZGQoJ0thdGV4X0VuYWJsZWQnLCB0cnVlLCB7XG5cdFx0dHlwZTogJ2Jvb2xlYW4nLFxuXHRcdGdyb3VwOiAnTWVzc2FnZScsXG5cdFx0c2VjdGlvbjogJ0thdGV4Jyxcblx0XHQncHVibGljJzogdHJ1ZSxcblx0XHRpMThuOiAnS2F0ZXhfRW5hYmxlZF9EZXNjcmlwdGlvbidcblx0fSk7XG5cdFJvY2tldENoYXQuc2V0dGluZ3MuYWRkKCdLYXRleF9QYXJlbnRoZXNpc19TeW50YXgnLCB0cnVlLCB7XG5cdFx0dHlwZTogJ2Jvb2xlYW4nLFxuXHRcdGdyb3VwOiAnTWVzc2FnZScsXG5cdFx0c2VjdGlvbjogJ0thdGV4Jyxcblx0XHQncHVibGljJzogdHJ1ZSxcblx0XHRlbmFibGVRdWVyeSxcblx0XHRpMThuRGVzY3JpcHRpb246ICdLYXRleF9QYXJlbnRoZXNpc19TeW50YXhfRGVzY3JpcHRpb24nXG5cdH0pO1xuXHRyZXR1cm4gUm9ja2V0Q2hhdC5zZXR0aW5ncy5hZGQoJ0thdGV4X0RvbGxhcl9TeW50YXgnLCBmYWxzZSwge1xuXHRcdHR5cGU6ICdib29sZWFuJyxcblx0XHRncm91cDogJ01lc3NhZ2UnLFxuXHRcdHNlY3Rpb246ICdLYXRleCcsXG5cdFx0J3B1YmxpYyc6IHRydWUsXG5cdFx0ZW5hYmxlUXVlcnksXG5cdFx0aTE4bkRlc2NyaXB0aW9uOiAnS2F0ZXhfRG9sbGFyX1N5bnRheF9EZXNjcmlwdGlvbidcblx0fSk7XG59KTtcblxuLy8gLS0tXG4vLyBnZW5lcmF0ZWQgYnkgY29mZmVlLXNjcmlwdCAxLjkuMlxuIiwiLypcbiAqIEthVGVYIGlzIGEgZmFzdCwgZWFzeS10by11c2UgSmF2YVNjcmlwdCBsaWJyYXJ5IGZvciBUZVggbWF0aCByZW5kZXJpbmcgb24gdGhlIHdlYi5cbiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9LaGFuL0thVGVYXG4gKi9cbmltcG9ydCBfIGZyb20gJ3VuZGVyc2NvcmUnO1xuaW1wb3J0IHMgZnJvbSAndW5kZXJzY29yZS5zdHJpbmcnO1xuXG5jb25zdCBrYXRleCA9IHJlcXVpcmUoJ2thdGV4Jyk7XG5cbmNsYXNzIEJvdW5kYXJ5IHtcblx0Y29uc3RydWN0b3IoKSB7fVxuXG5cdGxlbmd0aCgpIHtcblx0XHRyZXR1cm4gdGhpcy5lbmQgLSB0aGlzLnN0YXJ0O1xuXHR9XG5cblx0ZXh0cmFjdChzdHIpIHtcblx0XHRyZXR1cm4gc3RyLnN1YnN0cih0aGlzLnN0YXJ0LCB0aGlzLmxlbmd0aCgpKTtcblx0fVxuXG59XG5cbmNsYXNzIEthdGV4IHtcblx0Y29uc3RydWN0b3IoKSB7XG5cdFx0dGhpcy5kZWxpbWl0ZXJzX21hcCA9IFtcblx0XHRcdHtcblx0XHRcdFx0b3BlbmVyOiAnXFxcXFsnLFxuXHRcdFx0XHRjbG9zZXI6ICdcXFxcXScsXG5cdFx0XHRcdGRpc3BsYXlNb2RlOiB0cnVlLFxuXHRcdFx0XHRlbmFibGVkOiAoKSA9PiB7XG5cdFx0XHRcdFx0cmV0dXJuIHRoaXMucGFyZW50aGVzaXNfc3ludGF4X2VuYWJsZWQoKTtcblx0XHRcdFx0fVxuXHRcdFx0fSwge1xuXHRcdFx0XHRvcGVuZXI6ICdcXFxcKCcsXG5cdFx0XHRcdGNsb3NlcjogJ1xcXFwpJyxcblx0XHRcdFx0ZGlzcGxheU1vZGU6IGZhbHNlLFxuXHRcdFx0XHRlbmFibGVkOiAoKSA9PiB7XG5cdFx0XHRcdFx0cmV0dXJuIHRoaXMucGFyZW50aGVzaXNfc3ludGF4X2VuYWJsZWQoKTtcblx0XHRcdFx0fVxuXHRcdFx0fSwge1xuXHRcdFx0XHRvcGVuZXI6ICckJCcsXG5cdFx0XHRcdGNsb3NlcjogJyQkJyxcblx0XHRcdFx0ZGlzcGxheU1vZGU6IHRydWUsXG5cdFx0XHRcdGVuYWJsZWQ6ICgpID0+IHtcblx0XHRcdFx0XHRyZXR1cm4gdGhpcy5kb2xsYXJfc3ludGF4X2VuYWJsZWQoKTtcblx0XHRcdFx0fVxuXHRcdFx0fSwge1xuXHRcdFx0XHRvcGVuZXI6ICckJyxcblx0XHRcdFx0Y2xvc2VyOiAnJCcsXG5cdFx0XHRcdGRpc3BsYXlNb2RlOiBmYWxzZSxcblx0XHRcdFx0ZW5hYmxlZDogKCkgPT4ge1xuXHRcdFx0XHRcdHJldHVybiB0aGlzLmRvbGxhcl9zeW50YXhfZW5hYmxlZCgpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XTtcblx0fVxuXHQvLyBTZWFyY2hlcyBmb3IgdGhlIGZpcnN0IG9wZW5pbmcgZGVsaW1pdGVyIGluIHRoZSBzdHJpbmcgZnJvbSBhIGdpdmVuIHBvc2l0aW9uXG5cblx0ZmluZF9vcGVuaW5nX2RlbGltaXRlcihzdHIsIHN0YXJ0KSB7IC8vIFNlYXJjaCB0aGUgc3RyaW5nIGZvciBlYWNoIG9wZW5pbmcgZGVsaW1pdGVyXG5cdFx0Y29uc3QgbWF0Y2hlcyA9ICgoKSA9PiB7XG5cdFx0XHRjb25zdCBtYXAgPSB0aGlzLmRlbGltaXRlcnNfbWFwO1xuXHRcdFx0Y29uc3QgcmVzdWx0cyA9IFtdO1xuXG5cdFx0XHRtYXAuZm9yRWFjaCgob3ApID0+IHtcblx0XHRcdFx0aWYgKG9wLmVuYWJsZWQoKSkge1xuXHRcdFx0XHRcdHJlc3VsdHMucHVzaCh7XG5cdFx0XHRcdFx0XHRvcHRpb25zOiBvcCxcblx0XHRcdFx0XHRcdHBvczogc3RyLmluZGV4T2Yob3Aub3BlbmVyLCBzdGFydClcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0XHRyZXR1cm4gcmVzdWx0cztcblx0XHR9KSgpO1xuXG5cdFx0Y29uc3QgcG9zaXRpb25zID0gKCgpID0+IHtcblx0XHRcdGNvbnN0IHJlc3VsdHMgPSBbXTtcblx0XHRcdG1hdGNoZXMuZm9yRWFjaCgocG9zKSA9PiB7XG5cdFx0XHRcdGlmIChwb3MucG9zID49IDApIHtcblx0XHRcdFx0XHRyZXN1bHRzLnB1c2gocG9zLnBvcyk7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXHRcdFx0cmV0dXJuIHJlc3VsdHM7XG5cdFx0fSkoKTtcblxuXHRcdC8vIE5vIG9wZW5pbmcgZGVsaW1pdGVycyB3ZXJlIGZvdW5kXG5cdFx0aWYgKHBvc2l0aW9ucy5sZW5ndGggPT09IDApIHtcblx0XHRcdHJldHVybiBudWxsO1xuXHRcdH1cblxuXHRcdC8vVGFrZSB0aGUgZmlyc3QgZGVsaW1pdGVyIGZvdW5kXG5cdFx0Y29uc3QgcG9zID0gTWF0aC5taW4uYXBwbHkoTWF0aCwgcG9zaXRpb25zKTtcblxuXHRcdGNvbnN0IG1hdGNoX2luZGV4ID0gKCgpPT4ge1xuXHRcdFx0Y29uc3QgcmVzdWx0cyA9IFtdO1xuXHRcdFx0bWF0Y2hlcy5mb3JFYWNoKChtKSA9PiB7XG5cdFx0XHRcdHJlc3VsdHMucHVzaChtLnBvcyk7XG5cdFx0XHR9KTtcblx0XHRcdHJldHVybiByZXN1bHRzO1xuXHRcdH0pKCkuaW5kZXhPZihwb3MpO1xuXG5cdFx0Y29uc3QgbWF0Y2ggPSBtYXRjaGVzW21hdGNoX2luZGV4XTtcblx0XHRyZXR1cm4gbWF0Y2g7XG5cdH1cblxuXHQvLyBSZXR1cm5zIHRoZSBvdXRlciBhbmQgaW5uZXIgYm91bmRhcmllcyBvZiB0aGUgbGF0ZXggYmxvY2sgc3RhcnRpbmdcblx0Ly8gYXQgdGhlIGdpdmVuIG9wZW5pbmcgZGVsaW1pdGVyXG5cdGdldF9sYXRleF9ib3VuZGFyaWVzKHN0ciwgb3BlbmluZ19kZWxpbWl0ZXJfbWF0Y2gpIHtcblx0XHRjb25zdCBpbm5lciA9IG5ldyBCb3VuZGFyeTtcblx0XHRjb25zdCBvdXRlciA9IG5ldyBCb3VuZGFyeTtcblxuXHRcdC8vIFRoZSBjbG9zaW5nIGRlbGltaXRlciBtYXRjaGluZyB0byB0aGUgb3BlbmluZyBvbmVcblx0XHRjb25zdCBjbG9zZXIgPSBvcGVuaW5nX2RlbGltaXRlcl9tYXRjaC5vcHRpb25zLmNsb3Nlcjtcblx0XHRvdXRlci5zdGFydCA9IG9wZW5pbmdfZGVsaW1pdGVyX21hdGNoLnBvcztcblx0XHRpbm5lci5zdGFydCA9IG9wZW5pbmdfZGVsaW1pdGVyX21hdGNoLnBvcyArIGNsb3Nlci5sZW5ndGg7XG5cblx0XHQvLyBTZWFyY2ggZm9yIGEgY2xvc2VyIGRlbGltaXRlciBhZnRlciB0aGUgb3BlbmluZyBvbmVcblx0XHRjb25zdCBjbG9zZXJfaW5kZXggPSBzdHIuc3Vic3RyKGlubmVyLnN0YXJ0KS5pbmRleE9mKGNsb3Nlcik7XG5cdFx0aWYgKGNsb3Nlcl9pbmRleCA8IDApIHtcblx0XHRcdHJldHVybiBudWxsO1xuXHRcdH1cblx0XHRpbm5lci5lbmQgPSBpbm5lci5zdGFydCArIGNsb3Nlcl9pbmRleDtcblx0XHRvdXRlci5lbmQgPSBpbm5lci5lbmQgKyBjbG9zZXIubGVuZ3RoO1xuXHRcdHJldHVybiB7XG5cdFx0XHRvdXRlcixcblx0XHRcdGlubmVyXG5cdFx0fTtcblx0fVxuXG5cdC8vIFNlYXJjaGVzIGZvciB0aGUgZmlyc3QgbGF0ZXggYmxvY2sgaW4gdGhlIGdpdmVuIHN0cmluZ1xuXHRmaW5kX2xhdGV4KHN0cikge1xuXHRcdGxldCBzdGFydCA9IDA7XG5cdFx0bGV0IG9wZW5pbmdfZGVsaW1pdGVyX21hdGNoO1xuXG5cdFx0d2hpbGUgKChvcGVuaW5nX2RlbGltaXRlcl9tYXRjaCA9IHRoaXMuZmluZF9vcGVuaW5nX2RlbGltaXRlcihzdHIsIHN0YXJ0KyspKSAhPSBudWxsKSB7XG5cdFx0XHRjb25zdCBtYXRjaCA9IHRoaXMuZ2V0X2xhdGV4X2JvdW5kYXJpZXMoc3RyLCBvcGVuaW5nX2RlbGltaXRlcl9tYXRjaCk7XG5cdFx0XHRpZiAobWF0Y2ggJiYgbWF0Y2guaW5uZXIuZXh0cmFjdChzdHIpLnRyaW0oKS5sZW5ndGgpIHtcblx0XHRcdFx0bWF0Y2gub3B0aW9ucyA9IG9wZW5pbmdfZGVsaW1pdGVyX21hdGNoLm9wdGlvbnM7XG5cdFx0XHRcdHJldHVybiBtYXRjaDtcblx0XHRcdH1cblx0XHR9XG5cdFx0cmV0dXJuIG51bGw7XG5cdH1cblxuXHQvLyBCcmVha3MgYSBtZXNzYWdlIHRvIHdoYXQgY29tZXMgYmVmb3JlLCBhZnRlciBhbmQgdG8gdGhlIGNvbnRlbnQgb2YgYVxuXHQvLyBtYXRjaGVkIGxhdGV4IGJsb2NrXG5cdGV4dHJhY3RfbGF0ZXgoc3RyLCBtYXRjaCkge1xuXHRcdGNvbnN0IGJlZm9yZSA9IHN0ci5zdWJzdHIoMCwgbWF0Y2gub3V0ZXIuc3RhcnQpO1xuXHRcdGNvbnN0IGFmdGVyID0gc3RyLnN1YnN0cihtYXRjaC5vdXRlci5lbmQpO1xuXHRcdGxldCBsYXRleCA9IG1hdGNoLmlubmVyLmV4dHJhY3Qoc3RyKTtcblx0XHRsYXRleCA9IHMudW5lc2NhcGVIVE1MKGxhdGV4KTtcblx0XHRyZXR1cm4ge1xuXHRcdFx0YmVmb3JlLFxuXHRcdFx0bGF0ZXgsXG5cdFx0XHRhZnRlclxuXHRcdH07XG5cdH1cblxuXHQvLyBUYWtlcyBhIGxhdGV4IG1hdGggc3RyaW5nIGFuZCB0aGUgZGVzaXJlZCBkaXNwbGF5IG1vZGUgYW5kIHJlbmRlcnMgaXRcblx0Ly8gdG8gSFRNTCB1c2luZyB0aGUgS2FUZVggbGlicmFyeVxuXHRyZW5kZXJfbGF0ZXgobGF0ZXgsIGRpc3BsYXlNb2RlKSB7XG5cdFx0bGV0IHJlbmRlcmVkO1xuXHRcdHRyeSB7XG5cdFx0XHRyZW5kZXJlZCA9IGthdGV4LnJlbmRlclRvU3RyaW5nKGxhdGV4LCB7XG5cdFx0XHRcdGRpc3BsYXlNb2RlXG5cdFx0XHR9KTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0Y29uc3QgZSA9IGVycm9yO1xuXHRcdFx0Y29uc3QgZGlzcGxheV9tb2RlID0gZGlzcGxheU1vZGUgPyAnYmxvY2snIDogJ2lubGluZSc7XG5cdFx0XHRyZW5kZXJlZCA9IGA8ZGl2IGNsYXNzPVwia2F0ZXgtZXJyb3Iga2F0ZXgtJHsgZGlzcGxheV9tb2RlIH0tZXJyb3JcIj5gO1xuXHRcdFx0cmVuZGVyZWQgKz0gYCR7IHMuZXNjYXBlSFRNTChlLm1lc3NhZ2UpIH1gO1xuXHRcdFx0cmVuZGVyZWQgKz0gJzwvZGl2Pic7XG5cdFx0fVxuXHRcdHJldHVybiByZW5kZXJlZDtcblx0fVxuXG5cdC8vIFRha2VzIGEgc3RyaW5nIGFuZCByZW5kZXJzIGFsbCBsYXRleCBibG9ja3MgaW5zaWRlIGl0XG5cdHJlbmRlcihzdHIsIHJlbmRlcl9mdW5jKSB7XG5cdFx0bGV0IHJlc3VsdCA9ICcnO1xuXHRcdHdoaWxlICh0aGlzLmZpbmRfbGF0ZXgoc3RyKSAhPSBudWxsKSB7XG5cdFx0XHQvLyBGaW5kIHRoZSBmaXJzdCBsYXRleCBibG9jayBpbiB0aGUgc3RyaW5nXG5cdFx0XHRjb25zdCBtYXRjaCA9IHRoaXMuZmluZF9sYXRleChzdHIpO1xuXHRcdFx0Y29uc3QgcGFydHMgPSB0aGlzLmV4dHJhY3RfbGF0ZXgoc3RyLCBtYXRjaCk7XG5cblx0XHRcdC8vIEFkZCB0byB0aGUgcmV1c2x0IHdoYXQgY29tZXMgYmVmb3JlIHRoZSBsYXRleCBibG9jayBhcyB3ZWxsIGFzXG5cdFx0XHQvLyB0aGUgcmVuZGVyZWQgbGF0ZXggY29udGVudFxuXHRcdFx0Y29uc3QgcmVuZGVyZWQgPSByZW5kZXJfZnVuYyhwYXJ0cy5sYXRleCwgbWF0Y2gub3B0aW9ucy5kaXNwbGF5TW9kZSk7XG5cdFx0XHRyZXN1bHQgKz0gcGFydHMuYmVmb3JlICsgcmVuZGVyZWQ7XG5cdFx0XHQvLyBTZXQgd2hhdCBjb21lcyBhZnRlciB0aGUgbGF0ZXggYmxvY2sgdG8gYmUgZXhhbWluZWQgbmV4dFxuXHRcdFx0c3RyID0gcGFydHMuYWZ0ZXI7XG5cdFx0fVxuXHRcdHJldHVybiByZXN1bHQgKz0gc3RyO1xuXHR9XG5cblx0Ly8gVGFrZXMgYSByb2NrZXRjaGF0IG1lc3NhZ2UgYW5kIHJlbmRlcnMgbGF0ZXggaW4gaXRzIGNvbnRlbnRcblx0cmVuZGVyX21lc3NhZ2UobWVzc2FnZSkge1xuXHRcdC8vUmVuZGVyIG9ubHkgaWYgZW5hYmxlZCBpbiBhZG1pbiBwYW5lbFxuXHRcdGxldCByZW5kZXJfZnVuYztcblx0XHRpZiAodGhpcy5rYXRleF9lbmFibGVkKCkpIHtcblx0XHRcdGxldCBtc2cgPSBtZXNzYWdlO1xuXHRcdFx0aWYgKCFfLmlzU3RyaW5nKG1lc3NhZ2UpKSB7XG5cdFx0XHRcdGlmIChzLnRyaW0obWVzc2FnZS5odG1sKSkge1xuXHRcdFx0XHRcdG1zZyA9IG1lc3NhZ2UuaHRtbDtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRyZXR1cm4gbWVzc2FnZTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0aWYgKF8uaXNTdHJpbmcobWVzc2FnZSkpIHtcblx0XHRcdFx0cmVuZGVyX2Z1bmMgPSAobGF0ZXgsIGRpc3BsYXlNb2RlKSA9PiB7XG5cdFx0XHRcdFx0cmV0dXJuIHRoaXMucmVuZGVyX2xhdGV4KGxhdGV4LCBkaXNwbGF5TW9kZSk7XG5cdFx0XHRcdH07XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRpZiAobWVzc2FnZS50b2tlbnMgPT0gbnVsbCkge1xuXHRcdFx0XHRcdG1lc3NhZ2UudG9rZW5zID0gW107XG5cdFx0XHRcdH1cblx0XHRcdFx0cmVuZGVyX2Z1bmMgPSAobGF0ZXgsIGRpc3BsYXlNb2RlKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgdG9rZW4gPSBgPSE9JHsgUmFuZG9tLmlkKCkgfT0hPWA7XG5cdFx0XHRcdFx0bWVzc2FnZS50b2tlbnMucHVzaCh7XG5cdFx0XHRcdFx0XHR0b2tlbixcblx0XHRcdFx0XHRcdHRleHQ6IHRoaXMucmVuZGVyX2xhdGV4KGxhdGV4LCBkaXNwbGF5TW9kZSlcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRyZXR1cm4gdG9rZW47XG5cdFx0XHRcdH07XG5cdFx0XHR9XG5cdFx0XHRtc2cgPSB0aGlzLnJlbmRlcihtc2csIHJlbmRlcl9mdW5jKTtcblx0XHRcdGlmICghXy5pc1N0cmluZyhtZXNzYWdlKSkge1xuXHRcdFx0XHRtZXNzYWdlLmh0bWwgPSBtc2c7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRtZXNzYWdlID0gbXNnO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRyZXR1cm4gbWVzc2FnZTtcblx0fVxuXG5cdGthdGV4X2VuYWJsZWQoKSB7XG5cdFx0cmV0dXJuIFJvY2tldENoYXQuc2V0dGluZ3MuZ2V0KCdLYXRleF9FbmFibGVkJyk7XG5cdH1cblxuXHRkb2xsYXJfc3ludGF4X2VuYWJsZWQoKSB7XG5cdFx0cmV0dXJuIFJvY2tldENoYXQuc2V0dGluZ3MuZ2V0KCdLYXRleF9Eb2xsYXJfU3ludGF4Jyk7XG5cdH1cblxuXHRwYXJlbnRoZXNpc19zeW50YXhfZW5hYmxlZCgpIHtcblx0XHRyZXR1cm4gUm9ja2V0Q2hhdC5zZXR0aW5ncy5nZXQoJ0thdGV4X1BhcmVudGhlc2lzX1N5bnRheCcpO1xuXHR9XG5cbn1cblxuUm9ja2V0Q2hhdC5rYXRleCA9IG5ldyBLYXRleDtcblxuY29uc3QgY2IgPSBSb2NrZXRDaGF0LmthdGV4LnJlbmRlcl9tZXNzYWdlLmJpbmQoUm9ja2V0Q2hhdC5rYXRleCk7XG5cblJvY2tldENoYXQuY2FsbGJhY2tzLmFkZCgncmVuZGVyTWVzc2FnZScsIGNiLCBSb2NrZXRDaGF0LmNhbGxiYWNrcy5wcmlvcml0eS5ISUdIIC0gMSwgJ2thdGV4Jyk7XG5cbmlmIChNZXRlb3IuaXNDbGllbnQpIHtcblx0QmxhemUucmVnaXN0ZXJIZWxwZXIoJ1JvY2tldENoYXRLYXRleCcsIGZ1bmN0aW9uKHRleHQpIHtcblx0XHRyZXR1cm4gUm9ja2V0Q2hhdC5rYXRleC5yZW5kZXJfbWVzc2FnZSh0ZXh0KTtcblx0fSk7XG59XG4iXX0=
