{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:reactions/server/models/Messages.js","meteor://ðŸ’»app/packages/rocketchat:reactions/setReaction.js"],"names":["RocketChat","models","Messages","setReactions","messageId","reactions","update","_id","$set","unsetReactions","$unset","_","module","watch","require","default","v","Meteor","methods","setReaction","reaction","userId","Error","method","message","findOneById","room","call","rid","user","Array","isArray","muted","indexOf","username","reactWhenReadOnly","Notifications","notifyUser","Random","id","ts","Date","msg","TAPi18n","__","language","Subscriptions","findOne","replace","usernames","splice","length","isEmpty","callbacks","run","push","msgStream","emit"],"mappings":"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","file":"/packages/rocketchat_reactions.js","sourcesContent":["RocketChat.models.Messages.setReactions = function(messageId, reactions) {\n\treturn this.update({ _id: messageId }, { $set: { reactions }});\n};\n\nRocketChat.models.Messages.unsetReactions = function(messageId) {\n\treturn this.update({ _id: messageId }, { $unset: { reactions: 1 }});\n};\n","/* globals msgStream */\nimport _ from 'underscore';\n\nMeteor.methods({\n\tsetReaction(reaction, messageId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'setReaction' });\n\t\t}\n\n\t\tconst message = RocketChat.models.Messages.findOneById(messageId);\n\n\t\tif (!message) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'setReaction' });\n\t\t}\n\n\t\tconst room = Meteor.call('canAccessRoom', message.rid, Meteor.userId());\n\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'setReaction' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (Array.isArray(room.muted) && room.muted.indexOf(user.username) !== -1 && !room.reactWhenReadOnly) {\n\t\t\tRocketChat.Notifications.notifyUser(Meteor.userId(), 'message', {\n\t\t\t\t_id: Random.id(),\n\t\t\t\trid: room._id,\n\t\t\t\tts: new Date(),\n\t\t\t\tmsg: TAPi18n.__('You_have_been_muted', {}, user.language)\n\t\t\t});\n\t\t\treturn false;\n\t\t} else if (!RocketChat.models.Subscriptions.findOne({ rid: message.rid })) {\n\t\t\treturn false;\n\t\t}\n\n\t\treaction = `:${ reaction.replace(/:/g, '') }:`;\n\n\t\tif (message.reactions && message.reactions[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\n\t\t\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\n\n\t\t\tif (message.reactions[reaction].usernames.length === 0) {\n\t\t\t\tdelete message.reactions[reaction];\n\t\t\t}\n\n\t\t\tif (_.isEmpty(message.reactions)) {\n\t\t\t\tdelete message.reactions;\n\t\t\t\tRocketChat.models.Messages.unsetReactions(messageId);\n\t\t\t\tRocketChat.callbacks.run('unsetReaction', messageId, reaction);\n\t\t\t} else {\n\t\t\t\tRocketChat.models.Messages.setReactions(messageId, message.reactions);\n\t\t\t\tRocketChat.callbacks.run('setReaction', messageId, reaction);\n\t\t\t}\n\t\t} else {\n\t\t\tif (!message.reactions) {\n\t\t\t\tmessage.reactions = {};\n\t\t\t}\n\t\t\tif (!message.reactions[reaction]) {\n\t\t\t\tmessage.reactions[reaction] = {\n\t\t\t\t\tusernames: []\n\t\t\t\t};\n\t\t\t}\n\t\t\tmessage.reactions[reaction].usernames.push(user.username);\n\n\t\t\tRocketChat.models.Messages.setReactions(messageId, message.reactions);\n\t\t\tRocketChat.callbacks.run('setReaction', messageId, reaction);\n\t\t}\n\n\t\tmsgStream.emit(message.rid, message);\n\n\t\treturn;\n\t}\n});\n"]}