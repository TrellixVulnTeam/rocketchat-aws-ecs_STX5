{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:assets/server/assets.js"],"names":["_","module","watch","require","default","v","sizeOf","mime","crypto","extensions","RocketChatAssetsInstance","RocketChatFile","GridFS","name","assets","logo","label","defaultUrl","constraints","type","width","undefined","height","favicon_ico","favicon","favicon_16","favicon_32","favicon_192","favicon_512","touchicon_180","touchicon_180_pre","tile_144","tile_150","tile_310_square","tile_310_wide","safari_pinned","RocketChat","Assets","setAsset","binaryContent","contentType","asset","Meteor","Error","function","extension","includes","errorTitle","file","Buffer","dimensions","rs","bufferToStream","deleteFile","ws","createWriteStream","on","bindEnvironment","setTimeout","key","value","url","settings","updateById","processAsset","pipe","unsetAsset","refreshClients","process","emit","refresh","settingKey","settingValue","indexOf","assetKey","replace","assetValue","cache","getFileSync","hash","createHash","update","buffer","digest","split","pop","path","cacheable","sourceMapUrl","where","content","size","length","uploadDate","addGroup","add","group","i18nLabel","addAssetToSetting","fileConstraints","public","Object","keys","models","Settings","find","observe","added","record","_id","changed","removed","startup","calculateClientHash","WebAppHashing","manifest","includeFilter","runtimeConfigOverride","WebAppInternals","staticFiles","manifestItem","findWhere","index","push","call","methods","userId","method","hasPermission","authz","action","WebApp","connectHandlers","use","req","res","next","params","decodeURIComponent","staticFilesMiddleware","writeHead","end","reqModifiedHeader","headers","toUTCString","setHeader","Date"],"mappings":"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","file":"/packages/rocketchat_assets.js","sourcesContent":["/* global WebAppHashing, WebAppInternals */\nimport _ from 'underscore';\n\nimport sizeOf from 'image-size';\nimport mime from 'mime-type/with-db';\nimport crypto from 'crypto';\n\nmime.extensions['image/vnd.microsoft.icon'] = ['ico'];\n\nconst RocketChatAssetsInstance = new RocketChatFile.GridFS({\n\tname: 'assets'\n});\n\nthis.RocketChatAssetsInstance = RocketChatAssetsInstance;\n\nconst assets = {\n\tlogo: {\n\t\tlabel: 'logo (svg, png, jpg)',\n\t\tdefaultUrl: 'images/logo/logo.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined\n\t\t}\n\t},\n\tfavicon_ico: {\n\t\tlabel: 'favicon (ico)',\n\t\tdefaultUrl: 'favicon.ico',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['ico'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined\n\t\t}\n\t},\n\tfavicon: {\n\t\tlabel: 'favicon (svg)',\n\t\tdefaultUrl: 'images/logo/icon.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined\n\t\t}\n\t},\n\tfavicon_16: {\n\t\tlabel: 'favicon 16x16 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-16x16.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 16,\n\t\t\theight: 16\n\t\t}\n\t},\n\tfavicon_32: {\n\t\tlabel: 'favicon 32x32 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-32x32.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 32,\n\t\t\theight: 32\n\t\t}\n\t},\n\tfavicon_192: {\n\t\tlabel: 'android-chrome 192x192 (png)',\n\t\tdefaultUrl: 'images/logo/android-chrome-192x192.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 192,\n\t\t\theight: 192\n\t\t}\n\t},\n\tfavicon_512: {\n\t\tlabel: 'android-chrome 512x512 (png)',\n\t\tdefaultUrl: 'images/logo/512x512.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 512,\n\t\t\theight: 512\n\t\t}\n\t},\n\ttouchicon_180: {\n\t\tlabel: 'apple-touch-icon 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180\n\t\t}\n\t},\n\ttouchicon_180_pre: {\n\t\tlabel: 'apple-touch-icon-precomposed 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon-precomposed.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180\n\t\t}\n\t},\n\ttile_144: {\n\t\tlabel: 'mstile 144x144 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-144x144.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 144,\n\t\t\theight: 144\n\t\t}\n\t},\n\ttile_150: {\n\t\tlabel: 'mstile 150x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-150x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 150,\n\t\t\theight: 150\n\t\t}\n\t},\n\ttile_310_square: {\n\t\tlabel: 'mstile 310x310 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x310.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 310\n\t\t}\n\t},\n\ttile_310_wide: {\n\t\tlabel: 'mstile 310x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 150\n\t\t}\n\t},\n\tsafari_pinned: {\n\t\tlabel: 'safari pinned tab (svg)',\n\t\tdefaultUrl: 'images/logo/safari-pinned-tab.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined\n\t\t}\n\t}\n};\n\nRocketChat.Assets = new (class {\n\tget mime() {\n\t\treturn mime;\n\t}\n\n\tget assets() {\n\t\treturn assets;\n\t}\n\n\tsetAsset(binaryContent, contentType, asset) {\n\t\tif (!assets[asset]) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset'\n\t\t\t});\n\t\t}\n\n\t\tconst extension = mime.extension(contentType);\n\t\tif (assets[asset].constraints.extensions.includes(extension) === false) {\n\t\t\tthrow new Meteor.Error(contentType, `Invalid file type: ${ contentType }`, {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset',\n\t\t\t\terrorTitle: 'error-invalid-file-type'\n\t\t\t});\n\t\t}\n\n\t\tconst file = new Buffer(binaryContent, 'binary');\n\t\tif (assets[asset].constraints.width || assets[asset].constraints.height) {\n\t\t\tconst dimensions = sizeOf(file);\n\t\t\tif (assets[asset].constraints.width && assets[asset].constraints.width !== dimensions.width) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-width', 'Invalid file width', {\n\t\t\t\t\tfunction: 'Invalid file width'\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (assets[asset].constraints.height && assets[asset].constraints.height !== dimensions.height) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-height');\n\t\t\t}\n\t\t}\n\n\t\tconst rs = RocketChatFile.bufferToStream(file);\n\t\tRocketChatAssetsInstance.deleteFile(asset);\n\n\t\tconst ws = RocketChatAssetsInstance.createWriteStream(asset, contentType);\n\t\tws.on('end', Meteor.bindEnvironment(function() {\n\t\t\treturn Meteor.setTimeout(function() {\n\t\t\t\tconst key = `Assets_${ asset }`;\n\t\t\t\tconst value = {\n\t\t\t\t\turl: `assets/${ asset }.${ extension }`,\n\t\t\t\t\tdefaultUrl: assets[asset].defaultUrl\n\t\t\t\t};\n\n\t\t\t\tRocketChat.settings.updateById(key, value);\n\t\t\t\treturn RocketChat.Assets.processAsset(key, value);\n\t\t\t}, 200);\n\t\t}));\n\n\t\trs.pipe(ws);\n\t}\n\n\tunsetAsset(asset) {\n\t\tif (!assets[asset]) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.unsetAsset'\n\t\t\t});\n\t\t}\n\n\t\tRocketChatAssetsInstance.deleteFile(asset);\n\t\tconst key = `Assets_${ asset }`;\n\t\tconst value = {\n\t\t\tdefaultUrl: assets[asset].defaultUrl\n\t\t};\n\n\t\tRocketChat.settings.updateById(key, value);\n\t\tRocketChat.Assets.processAsset(key, value);\n\t}\n\n\trefreshClients() {\n\t\treturn process.emit('message', {\n\t\t\trefresh: 'client'\n\t\t});\n\t}\n\n\tprocessAsset(settingKey, settingValue) {\n\t\tif (settingKey.indexOf('Assets_') !== 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst assetKey = settingKey.replace(/^Assets_/, '');\n\t\tconst assetValue = assets[assetKey];\n\n\t\tif (!assetValue) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!settingValue || !settingValue.url) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst file = RocketChatAssetsInstance.getFileSync(assetKey);\n\t\tif (!file) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst hash = crypto.createHash('sha1').update(file.buffer).digest('hex');\n\t\tconst extension = settingValue.url.split('.').pop();\n\n\t\treturn assetValue.cache = {\n\t\t\tpath: `assets/${ assetKey }.${ extension }`,\n\t\t\tcacheable: false,\n\t\t\tsourceMapUrl: undefined,\n\t\t\twhere: 'client',\n\t\t\ttype: 'asset',\n\t\t\tcontent: file.buffer,\n\t\t\textension,\n\t\t\turl: `/assets/${ assetKey }.${ extension }?${ hash }`,\n\t\t\tsize: file.length,\n\t\t\tuploadDate: file.uploadDate,\n\t\t\tcontentType: file.contentType,\n\t\t\thash\n\t\t};\n\t}\n});\n\nRocketChat.settings.addGroup('Assets');\n\nRocketChat.settings.add('Assets_SvgFavicon_Enable', true, {\n\ttype: 'boolean',\n\tgroup: 'Assets',\n\ti18nLabel: 'Enable_Svg_Favicon'\n});\n\nfunction addAssetToSetting(key, value) {\n\treturn RocketChat.settings.add(`Assets_${ key }`, {\n\t\tdefaultUrl: value.defaultUrl\n\t}, {\n\t\ttype: 'asset',\n\t\tgroup: 'Assets',\n\t\tfileConstraints: value.constraints,\n\t\ti18nLabel: value.label,\n\t\tasset: key,\n\t\tpublic: true\n\t});\n}\n\nfor (const key of Object.keys(assets)) {\n\tconst value = assets[key];\n\taddAssetToSetting(key, value);\n}\n\nRocketChat.models.Settings.find().observe({\n\tadded(record) {\n\t\treturn RocketChat.Assets.processAsset(record._id, record.value);\n\t},\n\n\tchanged(record) {\n\t\treturn RocketChat.Assets.processAsset(record._id, record.value);\n\t},\n\n\tremoved(record) {\n\t\treturn RocketChat.Assets.processAsset(record._id, undefined);\n\t}\n});\n\nMeteor.startup(function() {\n\treturn Meteor.setTimeout(function() {\n\t\treturn process.emit('message', {\n\t\t\trefresh: 'client'\n\t\t});\n\t}, 200);\n});\n\nconst calculateClientHash = WebAppHashing.calculateClientHash;\n\nWebAppHashing.calculateClientHash = function(manifest, includeFilter, runtimeConfigOverride) {\n\tfor (const key of Object.keys(assets)) {\n\t\tconst value = assets[key];\n\t\tif (!value.cache && !value.defaultUrl) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tlet cache = {};\n\t\tif (value.cache) {\n\t\t\tcache = {\n\t\t\t\tpath: value.cache.path,\n\t\t\t\tcacheable: value.cache.cacheable,\n\t\t\t\tsourceMapUrl: value.cache.sourceMapUrl,\n\t\t\t\twhere: value.cache.where,\n\t\t\t\ttype: value.cache.type,\n\t\t\t\turl: value.cache.url,\n\t\t\t\tsize: value.cache.size,\n\t\t\t\thash: value.cache.hash\n\t\t\t};\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }`] = value.cache;\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }.${ value.cache.extension }`] = value.cache;\n\t\t} else {\n\t\t\tconst extension = value.defaultUrl.split('.').pop();\n\t\t\tcache = {\n\t\t\t\tpath: `assets/${ key }.${ extension }`,\n\t\t\t\tcacheable: false,\n\t\t\t\tsourceMapUrl: undefined,\n\t\t\t\twhere: 'client',\n\t\t\t\ttype: 'asset',\n\t\t\t\turl: `/assets/${ key }.${ extension }?v3`,\n\t\t\t\thash: 'v3'\n\t\t\t};\n\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }`] = WebAppInternals.staticFiles[`/__cordova/${ value.defaultUrl }`];\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }.${ extension }`] = WebAppInternals.staticFiles[`/__cordova/${ value.defaultUrl }`];\n\t\t}\n\n\t\tconst manifestItem = _.findWhere(manifest, {\n\t\t\tpath: key\n\t\t});\n\n\t\tif (manifestItem) {\n\t\t\tconst index = manifest.indexOf(manifestItem);\n\t\t\tmanifest[index] = cache;\n\t\t} else {\n\t\t\tmanifest.push(cache);\n\t\t}\n\t}\n\n\treturn calculateClientHash.call(this, manifest, includeFilter, runtimeConfigOverride);\n};\n\nMeteor.methods({\n\trefreshClients() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'refreshClients'\n\t\t\t});\n\t\t}\n\n\t\tconst hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'manage-assets');\n\t\tif (!hasPermission) {\n\t\t\tthrow new Meteor.Error('error-action-now-allowed', 'Managing assets not allowed', {\n\t\t\t\tmethod: 'refreshClients',\n\t\t\t\taction: 'Managing_assets'\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.Assets.refreshClients();\n\t},\n\n\tunsetAsset(asset) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'unsetAsset'\n\t\t\t});\n\t\t}\n\n\t\tconst hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'manage-assets');\n\t\tif (!hasPermission) {\n\t\t\tthrow new Meteor.Error('error-action-now-allowed', 'Managing assets not allowed', {\n\t\t\t\tmethod: 'unsetAsset',\n\t\t\t\taction: 'Managing_assets'\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.Assets.unsetAsset(asset);\n\t},\n\n\tsetAsset(binaryContent, contentType, asset) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'setAsset'\n\t\t\t});\n\t\t}\n\n\t\tconst hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'manage-assets');\n\t\tif (!hasPermission) {\n\t\t\tthrow new Meteor.Error('error-action-now-allowed', 'Managing assets not allowed', {\n\t\t\t\tmethod: 'setAsset',\n\t\t\t\taction: 'Managing_assets'\n\t\t\t});\n\t\t}\n\n\t\tRocketChat.Assets.setAsset(binaryContent, contentType, asset);\n\t}\n});\n\nWebApp.connectHandlers.use('/assets/', Meteor.bindEnvironment(function(req, res, next) {\n\tconst params = {\n\t\tasset: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')).replace(/\\.[^.]*$/, '')\n\t};\n\n\tconst file = assets[params.asset] && assets[params.asset].cache;\n\n\tif (!file) {\n\t\tif (assets[params.asset] && assets[params.asset].defaultUrl) {\n\t\t\treq.url = `/${ assets[params.asset].defaultUrl }`;\n\t\t\tWebAppInternals.staticFilesMiddleware(WebAppInternals.staticFiles, req, res, next);\n\t\t} else {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\n\t\treturn;\n\t}\n\n\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\tif (reqModifiedHeader) {\n\t\tif (reqModifiedHeader === (file.uploadDate && file.uploadDate.toUTCString())) {\n\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\tres.writeHead(304);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n\n\tres.setHeader('Cache-Control', 'public, max-age=0');\n\tres.setHeader('Expires', '-1');\n\tres.setHeader('Last-Modified', (file.uploadDate && file.uploadDate.toUTCString()) || new Date().toUTCString());\n\tres.setHeader('Content-Type', file.contentType);\n\tres.setHeader('Content-Length', file.size);\n\tres.writeHead(200);\n\tres.end(file.content);\n}));\n"]}