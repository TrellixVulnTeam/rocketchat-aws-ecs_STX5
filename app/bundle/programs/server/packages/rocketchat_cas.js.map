{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:cas/server/cas_rocketchat.js","meteor://ðŸ’»app/packages/rocketchat:cas/server/cas_server.js","meteor://ðŸ’»app/packages/rocketchat:cas/server/models/CredentialTokens.js"],"names":["logger","Logger","Meteor","startup","RocketChat","settings","addGroup","add","type","group","public","values","key","i18nLabel","section","timer","updateServices","clearTimeout","setTimeout","data","enabled","get","base_url","login_url","buttonLabelText","buttonLabelColor","buttonColor","width","height","autoclose","info","ServiceConfiguration","configurations","upsert","service","$set","remove","value","_","module","watch","require","default","v","fiber","Npm","url","CAS","RoutePolicy","declare","closePopup","res","writeHead","content","end","casTicket","req","token","callback","error","parsedUrl","parse","ticketId","query","ticket","baseUrl","cas_version","parseFloat","appUrl","absoluteUrl","replace","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","debug","cas","version","validate","bindEnvironment","err","status","username","details","message","user_info","attributes","extend","models","CredentialTokens","create","middleware","next","barePath","substring","indexOf","splitPath","split","credentialToken","WebApp","connectHandlers","use","run","Accounts","registerLoginHandler","options","undefined","credentials","findOneById","Error","LoginCancelledError","numericError","result","userInfo","syncUserDataFieldMap","trim","sync_enabled","ext_attrs","int_attrs","email","name","rooms","each","ext_name","attr_map","JSON","source","int_name","isString","user","users","findOne","_id","_setRealName","update","emails","address","verified","newUser","active","globalRoles","services","external_id","attrs","userId","insertUserDoc","room_name","room","Rooms","findOneByNameAndType","createWithIdTypeAndName","Random","id","addUsernameByName","Subscriptions","createWithRoomAndUser","ts","Date","open","alert","unread","userMentions","groupMentions","_Base","constructor","tryEnsureIndex","sparse","expireAfterSeconds","validForMilliseconds","expireAt","now","insert","$gt"],"mappings":"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","file":"/packages/rocketchat_cas.js","sourcesContent":["/* globals logger:true */\n\nlogger = new Logger('CAS', {});\n\nMeteor.startup(function() {\n\tRocketChat.settings.addGroup('CAS', function() {\n\t\tthis.add('CAS_enabled', false, { type: 'boolean', group: 'CAS', public: true });\n\t\tthis.add('CAS_base_url', '', { type: 'string', group: 'CAS', public: true });\n\t\tthis.add('CAS_login_url', '', { type: 'string', group: 'CAS', public: true });\n\t\tthis.add('CAS_version', '1.0', { type: 'select', values: [{ key: '1.0', i18nLabel: '1.0'}, { key: '2.0', i18nLabel: '2.0'}], group: 'CAS' });\n\n\t\tthis.section('Attribute_handling', function() {\n\t\t\t// Enable/disable sync\n\t\t\tthis.add('CAS_Sync_User_Data_Enabled', true, { type: 'boolean' });\n\t\t\t// Attribute mapping table\n\t\t\tthis.add('CAS_Sync_User_Data_FieldMap', '{}', { type: 'string' });\n\t\t});\n\n\t\tthis.section('CAS_Login_Layout', function() {\n\t\t\tthis.add('CAS_popup_width', '810', { type: 'string', group: 'CAS', public: true });\n\t\t\tthis.add('CAS_popup_height', '610', { type: 'string', group: 'CAS', public: true });\n\t\t\tthis.add('CAS_button_label_text', 'CAS', { type: 'string', group: 'CAS'});\n\t\t\tthis.add('CAS_button_label_color', '#FFFFFF', { type: 'color', group: 'CAS'});\n\t\t\tthis.add('CAS_button_color', '#13679A', { type: 'color', group: 'CAS'});\n\t\t\tthis.add('CAS_autoclose', true, { type: 'boolean', group: 'CAS'});\n\t\t});\n\t});\n});\n\nlet timer;\n\nfunction updateServices(/*record*/) {\n\tif (typeof timer !== 'undefined') {\n\t\tMeteor.clearTimeout(timer);\n\t}\n\n\ttimer = Meteor.setTimeout(function() {\n\t\tconst data = {\n\t\t\t// These will pe passed to 'node-cas' as options\n\t\t\tenabled:          RocketChat.settings.get('CAS_enabled'),\n\t\t\tbase_url:         RocketChat.settings.get('CAS_base_url'),\n\t\t\tlogin_url:        RocketChat.settings.get('CAS_login_url'),\n\t\t\t// Rocketchat Visuals\n\t\t\tbuttonLabelText:  RocketChat.settings.get('CAS_button_label_text'),\n\t\t\tbuttonLabelColor: RocketChat.settings.get('CAS_button_label_color'),\n\t\t\tbuttonColor:      RocketChat.settings.get('CAS_button_color'),\n\t\t\twidth:            RocketChat.settings.get('CAS_popup_width'),\n\t\t\theight:           RocketChat.settings.get('CAS_popup_height'),\n\t\t\tautoclose:        RocketChat.settings.get('CAS_autoclose')\n\t\t};\n\n\t\t// Either register or deregister the CAS login service based upon its configuration\n\t\tif (data.enabled) {\n\t\t\tlogger.info('Enabling CAS login service');\n\t\t\tServiceConfiguration.configurations.upsert({service: 'cas'}, { $set: data });\n\t\t} else {\n\t\t\tlogger.info('Disabling CAS login service');\n\t\t\tServiceConfiguration.configurations.remove({service: 'cas'});\n\t\t}\n\t}, 2000);\n}\n\nRocketChat.settings.get(/^CAS_.+/, (key, value) => {\n\tupdateServices(value);\n});\n","/* globals RoutePolicy, logger */\n/* jshint newcap: false */\nimport _ from 'underscore';\n\nconst fiber = Npm.require('fibers');\nconst url = Npm.require('url');\nconst CAS = Npm.require('cas');\n\nRoutePolicy.declare('/_cas/', 'network');\n\nconst closePopup = function(res) {\n\tres.writeHead(200, {'Content-Type': 'text/html'});\n\tconst content = '<html><head><script>window.close()</script></head></html>';\n\tres.end(content, 'utf-8');\n};\n\nconst casTicket = function(req, token, callback) {\n\n\t// get configuration\n\tif (!RocketChat.settings.get('CAS_enabled')) {\n\t\tlogger.error('Got ticket validation request, but CAS is not enabled');\n\t\tcallback();\n\t}\n\n\t// get ticket and validate.\n\tconst parsedUrl = url.parse(req.url, true);\n\tconst ticketId = parsedUrl.query.ticket;\n\tconst baseUrl = RocketChat.settings.get('CAS_base_url');\n\tconst cas_version = parseFloat(RocketChat.settings.get('CAS_version'));\n\tconst appUrl = Meteor.absoluteUrl().replace(/\\/$/, '') + __meteor_runtime_config__.ROOT_URL_PATH_PREFIX;\n\tlogger.debug(`Using CAS_base_url: ${ baseUrl }`);\n\n\tconst cas = new CAS({\n\t\tbase_url: baseUrl,\n\t\tversion: cas_version,\n\t\tservice: `${ appUrl }/_cas/${ token }`\n\t});\n\n\tcas.validate(ticketId, Meteor.bindEnvironment(function(err, status, username, details) {\n\t\tif (err) {\n\t\t\tlogger.error(`error when trying to validate: ${ err.message }`);\n\t\t} else if (status) {\n\t\t\tlogger.info(`Validated user: ${ username }`);\n\t\t\tconst user_info = { username };\n\n\t\t\t// CAS 2.0 attributes handling\n\t\t\tif (details && details.attributes) {\n\t\t\t\t_.extend(user_info, { attributes: details.attributes });\n\t\t\t}\n\t\t\tRocketChat.models.CredentialTokens.create(token, user_info);\n\t\t} else {\n\t\t\tlogger.error(`Unable to validate ticket: ${ ticketId }`);\n\t\t}\n\t\t//logger.debug(\"Receveied response: \" + JSON.stringify(details, null , 4));\n\n\t\tcallback();\n\t}));\n\n\treturn;\n};\n\nconst middleware = function(req, res, next) {\n\t// Make sure to catch any exceptions because otherwise we'd crash\n\t// the runner\n\ttry {\n\t\tconst barePath = req.url.substring(0, req.url.indexOf('?'));\n\t\tconst splitPath = barePath.split('/');\n\n\t\t// Any non-cas request will continue down the default\n\t\t// middlewares.\n\t\tif (splitPath[1] !== '_cas') {\n\t\t\tnext();\n\t\t\treturn;\n\t\t}\n\n\t\t// get auth token\n\t\tconst credentialToken = splitPath[2];\n\t\tif (!credentialToken) {\n\t\t\tclosePopup(res);\n\t\t\treturn;\n\t\t}\n\n\t\t// validate ticket\n\t\tcasTicket(req, credentialToken, function() {\n\t\t\tclosePopup(res);\n\t\t});\n\n\t} catch (err) {\n\t\tlogger.error(`Unexpected error : ${ err.message }`);\n\t\tclosePopup(res);\n\t}\n};\n\n// Listen to incoming OAuth http requests\nWebApp.connectHandlers.use(function(req, res, next) {\n\t// Need to create a fiber since we're using synchronous http calls and nothing\n\t// else is wrapping this in a fiber automatically\n\tfiber(function() {\n\t\tmiddleware(req, res, next);\n\t}).run();\n});\n\n/*\n * Register a server-side login handle.\n * It is call after Accounts.callLoginMethod() is call from client.\n *\n */\nAccounts.registerLoginHandler(function(options) {\n\n\tif (!options.cas) {\n\t\treturn undefined;\n\t}\n\n\tconst credentials = RocketChat.models.CredentialTokens.findOneById(options.cas.credentialToken);\n\tif (credentials === undefined) {\n\t\tthrow new Meteor.Error(Accounts.LoginCancelledError.numericError,\n\t\t\t'no matching login attempt found');\n\t}\n\n\tconst result = credentials.userInfo;\n\tconst syncUserDataFieldMap = RocketChat.settings.get('CAS_Sync_User_Data_FieldMap').trim();\n\tconst cas_version = parseFloat(RocketChat.settings.get('CAS_version'));\n\tconst sync_enabled = RocketChat.settings.get('CAS_Sync_User_Data_Enabled');\n\n\t// We have these\n\tconst ext_attrs = {\n\t\tusername: result.username\n\t};\n\n\t// We need these\n\tconst int_attrs = {\n\t\temail: undefined,\n\t\tname: undefined,\n\t\tusername: undefined,\n\t\trooms: undefined\n\t};\n\n\t// Import response attributes\n\tif (cas_version >= 2.0) {\n\t\t// Clean & import external attributes\n\t\t_.each(result.attributes, function(value, ext_name) {\n\t\t\tif (value) {\n\t\t\t\text_attrs[ext_name] = value[0];\n\t\t\t}\n\t\t});\n\t}\n\n\t// Source internal attributes\n\tif (syncUserDataFieldMap) {\n\n\t\t// Our mapping table: key(int_attr) -> value(ext_attr)\n\t\t// Spoken: Source this internal attribute from these external attributes\n\t\tconst attr_map = JSON.parse(syncUserDataFieldMap);\n\n\t\t_.each(attr_map, function(source, int_name) {\n\t\t\t// Source is our String to interpolate\n\t\t\tif (_.isString(source)) {\n\t\t\t\t_.each(ext_attrs, function(value, ext_name) {\n\t\t\t\t\tsource = source.replace(`%${ ext_name }%`, ext_attrs[ext_name]);\n\t\t\t\t});\n\n\t\t\t\tint_attrs[int_name] = source;\n\t\t\t\tlogger.debug(`Sourced internal attribute: ${ int_name } = ${ source }`);\n\t\t\t}\n\t\t});\n\t}\n\n\t// Search existing user by its external service id\n\tlogger.debug(`Looking up user by id: ${ result.username }`);\n\tlet user = Meteor.users.findOne({ 'services.cas.external_id': result.username });\n\n\tif (user) {\n\t\tlogger.debug(`Using existing user for '${ result.username }' with id: ${ user._id }`);\n\t\tif (sync_enabled) {\n\t\t\tlogger.debug('Syncing user attributes');\n\t\t\t// Update name\n\t\t\tif (int_attrs.name) {\n\t\t\t\tRocketChat._setRealName(user._id, int_attrs.name);\n\t\t\t}\n\n\t\t\t// Update email\n\t\t\tif (int_attrs.email) {\n\t\t\t\tMeteor.users.update(user, { $set: { emails: [{ address: int_attrs.email, verified: true }] }});\n\t\t\t}\n\t\t}\n\t} else {\n\n\t\t// Define new user\n\t\tconst newUser = {\n\t\t\tusername: result.username,\n\t\t\tactive: true,\n\t\t\tglobalRoles: ['user'],\n\t\t\temails: [],\n\t\t\tservices: {\n\t\t\t\tcas: {\n\t\t\t\t\texternal_id: result.username,\n\t\t\t\t\tversion: cas_version,\n\t\t\t\t\tattrs: int_attrs\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\t// Add User.name\n\t\tif (int_attrs.name) {\n\t\t\t_.extend(newUser, {\n\t\t\t\tname: int_attrs.name\n\t\t\t});\n\t\t}\n\n\t\t// Add email\n\t\tif (int_attrs.email) {\n\t\t\t_.extend(newUser, {\n\t\t\t\temails: [{ address: int_attrs.email, verified: true }]\n\t\t\t});\n\t\t}\n\n\t\t// Create the user\n\t\tlogger.debug(`User \"${ result.username }\" does not exist yet, creating it`);\n\t\tconst userId = Accounts.insertUserDoc({}, newUser);\n\n\t\t// Fetch and use it\n\t\tuser = Meteor.users.findOne(userId);\n\t\tlogger.debug(`Created new user for '${ result.username }' with id: ${ user._id }`);\n\t\t//logger.debug(JSON.stringify(user, undefined, 4));\n\n\t\tlogger.debug(`Joining user to attribute channels: ${ int_attrs.rooms }`);\n\t\tif (int_attrs.rooms) {\n\t\t\t_.each(int_attrs.rooms.split(','), function(room_name) {\n\t\t\t\tif (room_name) {\n\t\t\t\t\tlet room = RocketChat.models.Rooms.findOneByNameAndType(room_name, 'c');\n\t\t\t\t\tif (!room) {\n\t\t\t\t\t\troom = RocketChat.models.Rooms.createWithIdTypeAndName(Random.id(), 'c', room_name);\n\t\t\t\t\t}\n\t\t\t\t\tRocketChat.models.Rooms.addUsernameByName(room_name, result.username);\n\t\t\t\t\tRocketChat.models.Subscriptions.createWithRoomAndUser(room, user, {\n\t\t\t\t\t\tts: new Date(),\n\t\t\t\t\t\topen: true,\n\t\t\t\t\t\talert: true,\n\t\t\t\t\t\tunread: 1,\n\t\t\t\t\t\tuserMentions: 1,\n\t\t\t\t\t\tgroupMentions: 0\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t}\n\n\treturn { userId: user._id };\n});\n","RocketChat.models.CredentialTokens = new class extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('credential_tokens');\n\n\t\tthis.tryEnsureIndex({ 'expireAt': 1 }, { sparse: 1, expireAfterSeconds: 0 });\n\t}\n\n\tcreate(_id, userInfo) {\n\t\tconst validForMilliseconds = 60000;\t\t// Valid for 60 seconds\n\t\tconst token = {\n\t\t\t_id,\n\t\t\tuserInfo,\n\t\t\texpireAt: new Date(Date.now() + validForMilliseconds)\n\t\t};\n\n\t\tthis.insert(token);\n\t\treturn token;\n\t}\n\n\tfindOneById(_id) {\n\t\tconst query = {\n\t\t\t_id,\n\t\t\texpireAt: { $gt: new Date() }\n\t\t};\n\n\t\treturn this.findOne(query);\n\t}\n};\n"]}