{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/startup/custom-sounds.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/startup/permissions.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/models/CustomSounds.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/publications/customSounds.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/methods/deleteCustomSound.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/methods/insertOrUpdateSound.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/methods/listCustomSounds.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/methods/uploadCustomSound.js"],"names":["_","module","watch","require","default","v","Meteor","startup","storeType","RocketChat","settings","get","RocketChatStore","RocketChatFile","Error","console","log","green","path","trim","RocketChatFileCustomSoundsInstance","name","absolutePath","self","WebApp","connectHandlers","use","bindEnvironment","req","res","params","sound","decodeURIComponent","url","replace","isEmpty","writeHead","write","end","file","getFileWithReadStream","setHeader","fileUploadDate","undefined","uploadDate","toUTCString","reqModifiedHeader","headers","Date","length","readStream","pipe","models","Permissions","createOrUpdate","addGroup","add","type","values","key","i18nLabel","enableQuery","_id","value","CustomSounds","_Base","constructor","tryEnsureIndex","findOneByID","options","findOne","findByName","query","find","findByNameExceptID","except","$nin","setName","update","$set","create","data","insert","removeByID","remove","s","publish","filter","limit","userId","ready","fields","extension","sort","filterReg","RegExp","escapeRegExp","methods","deleteCustomSound","authz","hasPermission","method","deleteFile","Notifications","notifyAll","soundData","insertOrUpdateSound","field","nameValidation","test","input","matchingResults","fetch","createSound","newFile","previousExtension","previousName","listCustomSounds","uploadCustomSound","binaryContent","contentType","Buffer","rs","bufferToStream","ws","createWriteStream","on","setTimeout"],"mappings":"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","file":"/packages/rocketchat_custom-sounds.js","sourcesContent":["/* globals RocketChatFileCustomSoundsInstance */\nimport _ from 'underscore';\n\nMeteor.startup(function() {\n\tlet storeType = 'GridFS';\n\n\tif (RocketChat.settings.get('CustomSounds_Storage_Type')) {\n\t\tstoreType = RocketChat.settings.get('CustomSounds_Storage_Type');\n\t}\n\n\tconst RocketChatStore = RocketChatFile[storeType];\n\n\tif (RocketChatStore == null) {\n\t\tthrow new Error(`Invalid RocketChatStore type [${ storeType }]`);\n\t}\n\n\tconsole.log(`Using ${ storeType } for custom sounds storage`.green);\n\n\tlet path = '~/uploads';\n\tif (RocketChat.settings.get('CustomSounds_FileSystemPath') != null) {\n\t\tif (RocketChat.settings.get('CustomSounds_FileSystemPath').trim() !== '') {\n\t\t\tpath = RocketChat.settings.get('CustomSounds_FileSystemPath');\n\t\t}\n\t}\n\n\tthis.RocketChatFileCustomSoundsInstance = new RocketChatStore({\n\t\tname: 'custom_sounds',\n\t\tabsolutePath: path\n\t});\n\n\tself = this;\n\n\treturn WebApp.connectHandlers.use('/custom-sounds/', Meteor.bindEnvironment(function(req, res/*, next*/) {\n\t\tconst params =\n\t\t\t{ sound: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')) };\n\n\t\tif (_.isEmpty(params.sound)) {\n\t\t\tres.writeHead(403);\n\t\t\tres.write('Forbidden');\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tconst file = RocketChatFileCustomSoundsInstance.getFileWithReadStream(params.sound);\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\tres.setHeader('Content-Disposition', 'inline');\n\n\t\tlet fileUploadDate = undefined;\n\t\tif (file.uploadDate != null) {\n\t\t\tfileUploadDate = file.uploadDate.toUTCString();\n\t\t}\n\n\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\tif (reqModifiedHeader != null) {\n\t\t\tif (reqModifiedHeader === fileUploadDate) {\n\t\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\t\tres.writeHead(304);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tres.setHeader('Cache-Control', 'public, max-age=0');\n\t\tres.setHeader('Expires', '-1');\n\t\tif (fileUploadDate != null) {\n\t\t\tres.setHeader('Last-Modified', fileUploadDate);\n\t\t} else {\n\t\t\tres.setHeader('Last-Modified', new Date().toUTCString());\n\t\t}\n\t\tres.setHeader('Content-Type', 'audio/mpeg');\n\t\tres.setHeader('Content-Length', file.length);\n\n\t\tfile.readStream.pipe(res);\n\t}));\n});\n","Meteor.startup(() => {\n\tif (RocketChat.models && RocketChat.models.Permissions) {\n\t\tRocketChat.models.Permissions.createOrUpdate('manage-sounds', ['admin']);\n\t}\n});\n","RocketChat.settings.addGroup('CustomSoundsFilesystem', function() {\n\tthis.add('CustomSounds_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS'\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem'\n\t\t}],\n\t\ti18nLabel: 'FileUpload_Storage_Type'\n\t});\n\n\tthis.add('CustomSounds_FileSystemPath', '', {\n\t\ttype: 'string',\n\t\tenableQuery: {\n\t\t\t_id: 'CustomSounds_Storage_Type',\n\t\t\tvalue: 'FileSystem'\n\t\t},\n\t\ti18nLabel: 'FileUpload_FileSystemPath'\n\t});\n});\n","class CustomSounds extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('custom_sounds');\n\n\t\tthis.tryEnsureIndex({ 'name': 1 });\n\t}\n\n\t//find one\n\tfindOneByID(_id, options) {\n\t\treturn this.findOne(_id, options);\n\t}\n\n\t//find\n\tfindByName(name, options) {\n\t\tconst query = {\n\t\t\tname\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\tfindByNameExceptID(name, except, options) {\n\t\tconst query = {\n\t\t\t_id: { $nin: [ except ] },\n\t\t\tname\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\t//update\n\tsetName(_id, name) {\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\tname\n\t\t\t}\n\t\t};\n\n\t\treturn this.update({_id}, update);\n\t}\n\n\t// INSERT\n\tcreate(data) {\n\t\treturn this.insert(data);\n\t}\n\n\n\t// REMOVE\n\tremoveByID(_id) {\n\t\treturn this.remove(_id);\n\t}\n}\n\nRocketChat.models.CustomSounds = new CustomSounds();\n","import s from 'underscore.string';\n\nMeteor.publish('customSounds', function(filter, limit) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tconst fields = {\n\t\tname: 1,\n\t\textension: 1\n\t};\n\n\tfilter = s.trim(filter);\n\n\tconst options = {\n\t\tfields,\n\t\tlimit,\n\t\tsort: { name: 1 }\n\t};\n\n\tif (filter) {\n\t\tconst filterReg = new RegExp(s.escapeRegExp(filter), 'i');\n\t\treturn RocketChat.models.CustomSounds.findByName(filterReg, options);\n\t}\n\n\treturn RocketChat.models.CustomSounds.find({}, options);\n});\n","/* globals RocketChatFileCustomSoundsInstance */\nMeteor.methods({\n\tdeleteCustomSound(_id) {\n\t\tlet sound = null;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-sounds')) {\n\t\t\tsound = RocketChat.models.CustomSounds.findOneByID(_id);\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tif (sound == null) {\n\t\t\tthrow new Meteor.Error('Custom_Sound_Error_Invalid_Sound', 'Invalid sound', { method: 'deleteCustomSound' });\n\t\t}\n\n\t\tRocketChatFileCustomSoundsInstance.deleteFile(`${ sound._id }.${ sound.extension }`);\n\t\tRocketChat.models.CustomSounds.removeByID(_id);\n\t\tRocketChat.Notifications.notifyAll('deleteCustomSound', {soundData: sound});\n\n\t\treturn true;\n\t}\n});\n","/* globals RocketChatFileCustomSoundsInstance */\nimport s from 'underscore.string';\n\nMeteor.methods({\n\tinsertOrUpdateSound(soundData) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-sounds')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tif (!s.trim(soundData.name)) {\n\t\t\tthrow new Meteor.Error('error-the-field-is-required', 'The field Name is required', { method: 'insertOrUpdateSound', field: 'Name' });\n\t\t}\n\n\t\t//let nameValidation = new RegExp('^[0-9a-zA-Z-_+;.]+$');\n\n\t\t//allow all characters except colon, whitespace, comma, >, <, &, \", ', /, \\, (, )\n\t\t//more practical than allowing specific sets of characters; also allows foreign languages\n\t\tconst nameValidation = /[\\s,:><&\"'\\/\\\\\\(\\)]/;\n\n\t\t//silently strip colon; this allows for uploading :soundname: as soundname\n\t\tsoundData.name = soundData.name.replace(/:/g, '');\n\n\t\tif (nameValidation.test(soundData.name)) {\n\t\t\tthrow new Meteor.Error('error-input-is-not-a-valid-field', `${ soundData.name } is not a valid name`, { method: 'insertOrUpdateSound', input: soundData.name, field: 'Name' });\n\t\t}\n\n\t\tlet matchingResults = [];\n\n\t\tif (soundData._id) {\n\t\t\tmatchingResults = RocketChat.models.CustomSounds.findByNameExceptID(soundData.name, soundData._id).fetch();\n\t\t} else {\n\t\t\tmatchingResults = RocketChat.models.CustomSounds.findByName(soundData.name).fetch();\n\t\t}\n\n\t\tif (matchingResults.length > 0) {\n\t\t\tthrow new Meteor.Error('Custom_Sound_Error_Name_Already_In_Use', 'The custom sound name is already in use', { method: 'insertOrUpdateSound' });\n\t\t}\n\n\t\tif (!soundData._id) {\n\t\t\t//insert sound\n\t\t\tconst createSound = {\n\t\t\t\tname: soundData.name,\n\t\t\t\textension: soundData.extension\n\t\t\t};\n\n\t\t\tconst _id = RocketChat.models.CustomSounds.create(createSound);\n\t\t\tcreateSound._id = _id;\n\n\t\t\treturn _id;\n\t\t} else {\n\t\t\t//update sound\n\t\t\tif (soundData.newFile) {\n\t\t\t\tRocketChatFileCustomSoundsInstance.deleteFile(`${ soundData._id }.${ soundData.previousExtension }`);\n\t\t\t}\n\n\t\t\tif (soundData.name !== soundData.previousName) {\n\t\t\t\tRocketChat.models.CustomSounds.setName(soundData._id, soundData.name);\n\t\t\t\tRocketChat.Notifications.notifyAll('updateCustomSound', {soundData});\n\t\t\t}\n\n\t\t\treturn soundData._id;\n\t\t}\n\t}\n});\n","Meteor.methods({\n\tlistCustomSounds() {\n\t\treturn RocketChat.models.CustomSounds.find({}).fetch();\n\t}\n});\n","/* globals RocketChatFileCustomSoundsInstance */\nMeteor.methods({\n\tuploadCustomSound(binaryContent, contentType, soundData) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-sounds')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tconst file = new Buffer(binaryContent, 'binary');\n\n\t\tconst rs = RocketChatFile.bufferToStream(file);\n\t\tRocketChatFileCustomSoundsInstance.deleteFile(`${ soundData._id }.${ soundData.extension }`);\n\t\tconst ws = RocketChatFileCustomSoundsInstance.createWriteStream(`${ soundData._id }.${ soundData.extension }`, contentType);\n\t\tws.on('end', Meteor.bindEnvironment(() =>\n\t\t\tMeteor.setTimeout(() => RocketChat.Notifications.notifyAll('updateCustomSound', {soundData}), 500)\n\t\t));\n\n\t\trs.pipe(ws);\n\t}\n});\n"]}