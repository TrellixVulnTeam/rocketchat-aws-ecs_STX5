{"version":3,"sources":["meteor://ðŸ’»app/packages/steffo:meteor-accounts-saml/saml_server.js","meteor://ðŸ’»app/packages/steffo:meteor-accounts-saml/saml_utils.js","meteor://ðŸ’»app/packages/steffo:meteor-accounts-saml/saml_rocketchat.js"],"names":["_","module","watch","require","default","v","Accounts","saml","settings","debug","generateUsername","providers","fiber","Npm","connect","RoutePolicy","declare","getSamlProviderConfig","provider","Meteor","Error","method","samlProvider","element","filter","methods","samlLogout","userId","providerConfig","console","log","JSON","stringify","user","users","findOne","_id","nameID","services","sessionIndex","idpSession","_saml","SAML","request","generateLogoutRequest","update","$set","id","_syncRequestToUrl","wrapAsync","requestToUrl","result","registerLoginHandler","loginRequest","credentialToken","undefined","loginResult","retrieveCredential","type","error","LoginCancelledError","numericError","profile","email","RegExp","escape","emailRegex","newUser","name","cn","username","active","globalRoles","emails","address","verified","RocketChat","generateUsernameSuggestion","insertUserDoc","stampedToken","_generateStampedLoginToken","$push","samlLogin","RelayState","idp","issuer","token","_loginResultForCredentialToken","hasCredential","has","closePopup","res","err","writeHead","content","end","samlUrlToObject","url","splitUrl","split","splitPath","actionName","serviceName","middleware","req","next","samlObject","service","find","samlSetting","callbackUrl","absoluteUrl","write","generateServiceProviderMetadata","validateLogoutResponse","query","SAMLResponse","logOutUser","inResponseTo","loggedOutUser","fetch","length","$unset","run","redirect","getAuthorizeUrl","body","validateResponse","inResponseToId","InResponseTo","saml_idp_credentialToken","Random","WebApp","connectHandlers","use","bodyParser","zlib","xml2js","xmlCrypto","crypto","xmldom","querystring","xmlbuilder","options","initialize","prototype","protocol","path","identifierFormat","authnContext","generateUniqueID","chars","uniqueID","i","substr","Math","floor","random","generateInstant","Date","toISOString","signRequest","xml","signer","createSign","sign","privateKey","generateAuthorizeRequest","instant","headers","host","entryPoint","idpSLORedirectURL","operation","callback","self","deflateRaw","buffer","base64","toString","target","indexOf","relayState","samlRequest","SAMLRequest","privateCert","SigAlg","Signature","getLogoutUrl","certToPEM","cert","match","join","validateSignature","doc","DOMParser","parseFromString","signature","xpath","sig","SignedXml","keyInfoProvider","getKeyInfo","getKey","loadSignature","checkSignature","getElement","parentElement","elementName","samlResponse","compressedSAMLResponse","Buffer","inflateRaw","decoded","parser","Parser","explicitRoot","parseString","response","$","status","statusCode","Value","xmlns","assertion","subject","Format","nameIDFormat","authnStatement","SessionIndex","attributeStatement","attributes","forEach","attribute","value","Name","mail","logoutResponse","decryptionCert","metadata","replace","create","pretty","indent","newline","export","updateServices","configureSamlService","getSamlConfigs","debounce","logger","Logger","updated","addGroup","addSamlService","add","group","section","i18nLabel","multiline","buttonLabelText","get","key","buttonLabelColor","buttonColor","clientConfig","secret","publicCert","fn","delay","timer","clearTimeout","setTimeout","samlConfigs","map","ServiceConfiguration","configurations","upsert","toLowerCase","remove","e","startup","call"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAIA,CAAJ;;AAAMC,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,SAAQC,CAAR,EAAU;AAACL,MAAEK,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;;AAIN,IAAI,CAACC,SAASC,IAAd,EAAoB;AACnBD,UAASC,IAAT,GAAgB;AACfC,YAAU;AACTC,UAAO,IADE;AAETC,qBAAkB,KAFT;AAGTC,cAAW;AAHF;AADK,EAAhB;AAOA;;AAED,MAAMC,QAAQC,IAAIV,OAAJ,CAAY,QAAZ,CAAd;;AACA,MAAMW,UAAUD,IAAIV,OAAJ,CAAY,SAAZ,CAAhB;;AACAY,YAAYC,OAAZ,CAAoB,SAApB,EAA+B,SAA/B,E,CAEA;;;;AAGA,SAASC,qBAAT,CAA+BC,QAA/B,EAAyC;AACxC,KAAI,CAAEA,QAAN,EAAgB;AACf,QAAM,IAAIC,OAAOC,KAAX,CAAiB,kBAAjB,EACL,qBADK,EAEL;AAAEC,WAAQ;AAAV,GAFK,CAAN;AAGA;;AACD,OAAMC,eAAe,UAASC,OAAT,EAAkB;AACtC,SAAQA,QAAQL,QAAR,KAAqBA,QAA7B;AACA,EAFD;;AAGA,QAAOZ,SAASC,IAAT,CAAcC,QAAd,CAAuBG,SAAvB,CAAiCa,MAAjC,CAAwCF,YAAxC,EAAsD,CAAtD,CAAP;AACA;;AAEDH,OAAOM,OAAP,CAAe;AACdC,YAAWR,QAAX,EAAqB;AACpB;AACA,MAAI,CAACC,OAAOQ,MAAP,EAAL,EAAsB;AACrB,SAAM,IAAIR,OAAOC,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAEC,YAAQ;AAAV,IAAvD,CAAN;AACA;;AACD,QAAMO,iBAAiBX,sBAAsBC,QAAtB,CAAvB;;AAEA,MAAIZ,SAASC,IAAT,CAAcC,QAAd,CAAuBC,KAA3B,EAAkC;AACjCoB,WAAQC,GAAR,CAAa,uBAAuBC,KAAKC,SAAL,CAAeJ,cAAf,CAAgC,EAApE;AACA,GATmB,CAUpB;;;AACA,QAAMK,OAAOd,OAAOe,KAAP,CAAaC,OAAb,CAAqB;AACjCC,QAAKjB,OAAOQ,MAAP,EAD4B;AAEjC,6BAA0BT;AAFO,GAArB,EAGV;AACF,oBAAiB;AADf,GAHU,CAAb;AAMA,MAAImB,SAASJ,KAAKK,QAAL,CAAc/B,IAAd,CAAmB8B,MAAhC;AACA,QAAME,eAAeN,KAAKK,QAAL,CAAc/B,IAAd,CAAmBiC,UAAxC;AACAH,WAASE,YAAT;;AACA,MAAIjC,SAASC,IAAT,CAAcC,QAAd,CAAuBC,KAA3B,EAAkC;AACjCoB,WAAQC,GAAR,CAAa,mBAAmBX,OAAOQ,MAAP,EAAiB,WAAWI,KAAKC,SAAL,CAAeK,MAAf,CAAwB,EAApF;AACA;;AAED,QAAMI,QAAQ,IAAIC,IAAJ,CAASd,cAAT,CAAd;;AAEA,QAAMe,UAAUF,MAAMG,qBAAN,CAA4B;AAC3CP,SAD2C;AAE3CE;AAF2C,GAA5B,CAAhB,CA1BoB,CA+BpB;AACA;;;AAEApB,SAAOe,KAAP,CAAaW,MAAb,CAAoB;AACnBT,QAAKjB,OAAOQ,MAAP;AADc,GAApB,EAEG;AACFmB,SAAM;AACL,kCAA8BH,QAAQI;AADjC;AADJ,GAFH;;AAQA,QAAMC,oBAAoB7B,OAAO8B,SAAP,CAAiBR,MAAMS,YAAvB,EAAqCT,KAArC,CAA1B;;AACA,QAAMU,SAASH,kBAAkBL,QAAQA,OAA1B,EAAmC,QAAnC,CAAf;;AACA,MAAIrC,SAASC,IAAT,CAAcC,QAAd,CAAuBC,KAA3B,EAAkC;AACjCoB,WAAQC,GAAR,CAAa,uBAAuBqB,MAAQ,EAA5C;AACA;;AAGD,SAAOA,MAAP;AACA;;AAnDa,CAAf;AAsDA7C,SAAS8C,oBAAT,CAA8B,UAASC,YAAT,EAAuB;AACpD,KAAI,CAACA,aAAa9C,IAAd,IAAsB,CAAC8C,aAAaC,eAAxC,EAAyD;AACxD,SAAOC,SAAP;AACA;;AAED,OAAMC,cAAclD,SAASC,IAAT,CAAckD,kBAAd,CAAiCJ,aAAaC,eAA9C,CAApB;;AACA,KAAIhD,SAASC,IAAT,CAAcC,QAAd,CAAuBC,KAA3B,EAAkC;AACjCoB,UAAQC,GAAR,CAAa,WAAWC,KAAKC,SAAL,CAAewB,WAAf,CAA6B,EAArD;AACA;;AAED,KAAIA,gBAAgBD,SAApB,EAA+B;AAC9B,SAAO;AACNG,SAAM,MADA;AAENC,UAAO,IAAIxC,OAAOC,KAAX,CAAiBd,SAASsD,mBAAT,CAA6BC,YAA9C,EAA4D,iCAA5D;AAFD,GAAP;AAIA;;AAED,KAAIL,eAAeA,YAAYM,OAA3B,IAAsCN,YAAYM,OAAZ,CAAoBC,KAA9D,EAAqE;AACpE,QAAMA,QAAQC,OAAOC,MAAP,CAAcT,YAAYM,OAAZ,CAAoBC,KAAlC,CAAd;AACA,QAAMG,aAAa,IAAIF,MAAJ,CAAY,IAAID,KAAO,GAAvB,EAA2B,GAA3B,CAAnB;AACA,MAAI9B,OAAOd,OAAOe,KAAP,CAAaC,OAAb,CAAqB;AAC/B,qBAAkB+B;AADa,GAArB,CAAX;;AAIA,MAAI,CAACjC,IAAL,EAAW;AACV,SAAMkC,UAAU;AACfC,UAAMZ,YAAYM,OAAZ,CAAoBO,EAApB,IAA0Bb,YAAYM,OAAZ,CAAoBQ,QADrC;AAEfC,YAAQ,IAFO;AAGfC,iBAAa,CAAC,MAAD,CAHE;AAIfC,YAAQ,CAAC;AACRC,cAASlB,YAAYM,OAAZ,CAAoBC,KADrB;AAERY,eAAU;AAFF,KAAD;AAJO,IAAhB;;AAUA,OAAIrE,SAASC,IAAT,CAAcC,QAAd,CAAuBE,gBAAvB,KAA4C,IAAhD,EAAsD;AACrD,UAAM4D,WAAWM,WAAWC,0BAAX,CAAsCV,OAAtC,CAAjB;;AACA,QAAIG,QAAJ,EAAc;AACbH,aAAQG,QAAR,GAAmBA,QAAnB;AACA;AACD,IALD,MAKO,IAAId,YAAYM,OAAZ,CAAoBQ,QAAxB,EAAkC;AACxCH,YAAQG,QAAR,GAAmBd,YAAYM,OAAZ,CAAoBQ,QAAvC;AACA;;AAED,SAAM3C,SAASrB,SAASwE,aAAT,CAAuB,EAAvB,EAA2BX,OAA3B,CAAf;AACAlC,UAAOd,OAAOe,KAAP,CAAaC,OAAb,CAAqBR,MAArB,CAAP;AACA,GA7BmE,CA+BpE;;;AACA,QAAMoD,eAAezE,SAAS0E,0BAAT,EAArB;;AACA7D,SAAOe,KAAP,CAAaW,MAAb,CAAoBZ,IAApB,EAA0B;AACzBgD,UAAO;AACN,mCAA+BF;AADzB;AADkB,GAA1B;AAMA,QAAMG,YAAY;AACjBhE,aAAUZ,SAASC,IAAT,CAAc4E,UADP;AAEjBC,QAAK5B,YAAYM,OAAZ,CAAoBuB,MAFR;AAGjB7C,eAAYgB,YAAYM,OAAZ,CAAoBvB,YAHf;AAIjBF,WAAQmB,YAAYM,OAAZ,CAAoBzB;AAJX,GAAlB;AAOAlB,SAAOe,KAAP,CAAaW,MAAb,CAAoB;AACnBT,QAAKH,KAAKG;AADS,GAApB,EAEG;AACFU,SAAM;AACL;AACA,qBAAiBoC;AAFZ;AADJ,GAFH,EA9CoE,CAuDpE;;AACA,QAAM/B,SAAS;AACdxB,WAAQM,KAAKG,GADC;AAEdkD,UAAOP,aAAaO;AAFN,GAAf;AAKA,SAAOnC,MAAP;AAEA,EA/DD,MA+DO;AACN,QAAM,IAAI/B,KAAJ,CAAU,+CAAV,CAAN;AACA;AACD,CAnFD;AAqFAd,SAASC,IAAT,CAAcgF,8BAAd,GAA+C,EAA/C;;AAEAjF,SAASC,IAAT,CAAciF,aAAd,GAA8B,UAASlC,eAAT,EAA0B;AACvD,QAAOtD,EAAEyF,GAAF,CAAMnF,SAASC,IAAT,CAAcgF,8BAApB,EAAoDjC,eAApD,CAAP;AACA,CAFD;;AAIAhD,SAASC,IAAT,CAAckD,kBAAd,GAAmC,UAASH,eAAT,EAA0B;AAC5D;AACA,OAAMH,SAAS7C,SAASC,IAAT,CAAcgF,8BAAd,CAA6CjC,eAA7C,CAAf;AACA,QAAOhD,SAASC,IAAT,CAAcgF,8BAAd,CAA6CjC,eAA7C,CAAP;AACA,QAAOH,MAAP;AACA,CALD;;AAOA,MAAMuC,aAAa,UAASC,GAAT,EAAcC,GAAd,EAAmB;AACrCD,KAAIE,SAAJ,CAAc,GAAd,EAAmB;AAClB,kBAAgB;AADE,EAAnB;AAGA,KAAIC,UAAU,yFAAd;;AACA,KAAIF,GAAJ,EAAS;AACRE,YAAW,6DAA6DF,GAAK,mEAA7E;AACA;;AACDD,KAAII,GAAJ,CAAQD,OAAR,EAAiB,OAAjB;AACA,CATD;;AAWA,MAAME,kBAAkB,UAASC,GAAT,EAAc;AACrC;AACA,KAAI,CAACA,GAAL,EAAU;AACT,SAAO,IAAP;AACA;;AAED,OAAMC,WAAWD,IAAIE,KAAJ,CAAU,GAAV,CAAjB;AACA,OAAMC,YAAYF,SAAS,CAAT,EAAYC,KAAZ,CAAkB,GAAlB,CAAlB,CAPqC,CASrC;AACA;;AACA,KAAIC,UAAU,CAAV,MAAiB,OAArB,EAA8B;AAC7B,SAAO,IAAP;AACA;;AAED,OAAMjD,SAAS;AACdkD,cAAYD,UAAU,CAAV,CADE;AAEdE,eAAaF,UAAU,CAAV,CAFC;AAGd9C,mBAAiB8C,UAAU,CAAV;AAHH,EAAf;;AAKA,KAAI9F,SAASC,IAAT,CAAcC,QAAd,CAAuBC,KAA3B,EAAkC;AACjCoB,UAAQC,GAAR,CAAYqB,MAAZ;AACA;;AACD,QAAOA,MAAP;AACA,CAxBD;;AA0BA,MAAMoD,aAAa,UAASC,GAAT,EAAcb,GAAd,EAAmBc,IAAnB,EAAyB;AAC3C;AACA;AACA,KAAI;AACH,QAAMC,aAAaV,gBAAgBQ,IAAIP,GAApB,CAAnB;;AACA,MAAI,CAACS,UAAD,IAAe,CAACA,WAAWJ,WAA/B,EAA4C;AAC3CG;AACA;AACA;;AAED,MAAI,CAACC,WAAWL,UAAhB,EAA4B;AAC3B,SAAM,IAAIjF,KAAJ,CAAU,qBAAV,CAAN;AACA;;AAEDS,UAAQC,GAAR,CAAYxB,SAASC,IAAT,CAAcC,QAAd,CAAuBG,SAAnC;AACAkB,UAAQC,GAAR,CAAY4E,WAAWJ,WAAvB;;AACA,QAAMK,UAAU3G,EAAE4G,IAAF,CAAOtG,SAASC,IAAT,CAAcC,QAAd,CAAuBG,SAA9B,EAAyC,UAASkG,WAAT,EAAsB;AAC9E,UAAOA,YAAY3F,QAAZ,KAAyBwF,WAAWJ,WAA3C;AACA,GAFe,CAAhB,CAbG,CAiBH;;;AACA,MAAI,CAACK,OAAL,EAAc;AACb,SAAM,IAAIvF,KAAJ,CAAW,2BAA2BsF,WAAWJ,WAAa,EAA9D,CAAN;AACA;;AACD,MAAI7D,KAAJ;;AACA,UAAQiE,WAAWL,UAAnB;AACC,QAAK,UAAL;AACC5D,YAAQ,IAAIC,IAAJ,CAASiE,OAAT,CAAR;AACAA,YAAQG,WAAR,GAAsB3F,OAAO4F,WAAP,CAAoB,kBAAkBJ,QAAQzF,QAAU,EAAxD,CAAtB;AACAyE,QAAIE,SAAJ,CAAc,GAAd;AACAF,QAAIqB,KAAJ,CAAUvE,MAAMwE,+BAAN,CAAsCN,QAAQG,WAA9C,CAAV;AACAnB,QAAII,GAAJ,GALD,CAMC;;AACA;;AACD,QAAK,QAAL;AACC;AACAtD,YAAQ,IAAIC,IAAJ,CAASiE,OAAT,CAAR;;AACAlE,UAAMyE,sBAAN,CAA6BV,IAAIW,KAAJ,CAAUC,YAAvC,EAAqD,UAASxB,GAAT,EAAczC,MAAd,EAAsB;AAC1E,SAAI,CAACyC,GAAL,EAAU;AACT,YAAMyB,aAAa,UAASC,YAAT,EAAuB;AACzC,WAAIhH,SAASC,IAAT,CAAcC,QAAd,CAAuBC,KAA3B,EAAkC;AACjCoB,gBAAQC,GAAR,CAAa,qCAAqCwF,YAAc,EAAhE;AACA;;AACD,aAAMC,gBAAgBpG,OAAOe,KAAP,CAAa0E,IAAb,CAAkB;AACvC,sCAA8BU;AADS,QAAlB,EAEnBE,KAFmB,EAAtB;;AAGA,WAAID,cAAcE,MAAd,KAAyB,CAA7B,EAAgC;AAC/B,YAAInH,SAASC,IAAT,CAAcC,QAAd,CAAuBC,KAA3B,EAAkC;AACjCoB,iBAAQC,GAAR,CAAa,cAAcyF,cAAc,CAAd,EAAiBnF,GAAK,EAAjD;AACA;;AACDjB,eAAOe,KAAP,CAAaW,MAAb,CAAoB;AACnBT,cAAKmF,cAAc,CAAd,EAAiBnF;AADH,SAApB,EAEG;AACFU,eAAM;AACL,yCAA+B;AAD1B;AADJ,SAFH;AAOA3B,eAAOe,KAAP,CAAaW,MAAb,CAAoB;AACnBT,cAAKmF,cAAc,CAAd,EAAiBnF;AADH,SAApB,EAEG;AACFsF,iBAAQ;AACP,2BAAiB;AADV;AADN,SAFH;AAOA,QAlBD,MAkBO;AACN,cAAM,IAAIvG,OAAOC,KAAX,CAAiB,wDAAjB,CAAN;AACA;AACD,OA5BD;;AA8BAR,YAAM,YAAW;AAChByG,kBAAWlE,MAAX;AACA,OAFD,EAEGwE,GAFH;AAKAhC,UAAIE,SAAJ,CAAc,GAAd,EAAmB;AAClB,mBAAYW,IAAIW,KAAJ,CAAUhC;AADJ,OAAnB;AAGAQ,UAAII,GAAJ;AACA,MAzCyE,CA0C1E;AACA;AACA;;AACA,KA7CD;;AA8CA;;AACD,QAAK,aAAL;AACCJ,QAAIE,SAAJ,CAAc,GAAd,EAAmB;AAClB;AACA,iBAAYW,IAAIW,KAAJ,CAAUS;AAFJ,KAAnB;AAIAjC,QAAII,GAAJ;AACA;;AACD,QAAK,WAAL;AACCY,YAAQG,WAAR,GAAsB3F,OAAO4F,WAAP,CAAoB,kBAAkBJ,QAAQzF,QAAU,EAAxD,CAAtB;AACAyF,YAAQ5D,EAAR,GAAa2D,WAAWpD,eAAxB;AACAb,YAAQ,IAAIC,IAAJ,CAASiE,OAAT,CAAR;;AACAlE,UAAMoF,eAAN,CAAsBrB,GAAtB,EAA2B,UAASZ,GAAT,EAAcK,GAAd,EAAmB;AAC7C,SAAIL,GAAJ,EAAS;AACR,YAAM,IAAIxE,KAAJ,CAAU,kCAAV,CAAN;AACA;;AACDuE,SAAIE,SAAJ,CAAc,GAAd,EAAmB;AAClB,kBAAYI;AADM,MAAnB;AAGAN,SAAII,GAAJ;AACA,KARD;;AASA;;AACD,QAAK,UAAL;AACCtD,YAAQ,IAAIC,IAAJ,CAASiE,OAAT,CAAR;AACArG,aAASC,IAAT,CAAc4E,UAAd,GAA2BqB,IAAIsB,IAAJ,CAAS3C,UAApC;;AACA1C,UAAMsF,gBAAN,CAAuBvB,IAAIsB,IAAJ,CAASV,YAAhC,EAA8CZ,IAAIsB,IAAJ,CAAS3C,UAAvD,EAAmE,UAASS,GAAT,EAAc9B,OAAd,CAAqB,eAArB,EAAsC;AACxG,SAAI8B,GAAJ,EAAS;AACR,YAAM,IAAIxE,KAAJ,CAAW,oCAAoCwE,GAAK,EAApD,CAAN;AACA;;AAED,WAAMtC,kBAAkBQ,QAAQkE,cAAR,IAA0BlE,QAAQmE,YAAlC,IAAkDvB,WAAWpD,eAArF;;AACA,SAAI,CAACA,eAAL,EAAsB;AACrB;AACA,YAAM4E,2BAA2BC,OAAOpF,EAAP,EAAjC;AACAzC,eAASC,IAAT,CAAcgF,8BAAd,CAA6C2C,wBAA7C,IAAyE;AACxEpE;AADwE,OAAzE;AAGA,YAAMmC,MAAO,GAAG9E,OAAO4F,WAAP,CAAmB,MAAnB,CAA4B,6BAA6BmB,wBAA0B,EAAnG;AACAvC,UAAIE,SAAJ,CAAc,GAAd,EAAmB;AAClB,mBAAYI;AADM,OAAnB;AAGAN,UAAII,GAAJ;AACA,MAXD,MAWO;AACNzF,eAASC,IAAT,CAAcgF,8BAAd,CAA6CjC,eAA7C,IAAgE;AAC/DQ;AAD+D,OAAhE;AAGA4B,iBAAWC,GAAX;AACA;AACD,KAvBD;;AAwBA;;AACD;AACC,UAAM,IAAIvE,KAAJ,CAAW,0BAA0BsF,WAAWL,UAAY,EAA5D,CAAN;AA7GF;AAgHA,EAtID,CAsIE,OAAOT,GAAP,EAAY;AACbF,aAAWC,GAAX,EAAgBC,GAAhB;AACA;AACD,CA5ID,C,CA8IA;;;AACAwC,OAAOC,eAAP,CAAuBC,GAAvB,CAA2BxH,QAAQyH,UAAR,EAA3B,EAAiDD,GAAjD,CAAqD,UAAS9B,GAAT,EAAcb,GAAd,EAAmBc,IAAnB,EAAyB;AAC7E;AACA;AACA7F,OAAM,YAAW;AAChB2F,aAAWC,GAAX,EAAgBb,GAAhB,EAAqBc,IAArB;AACA,EAFD,EAEGkB,GAFH;AAGA,CAND,E;;;;;;;;;;;AC7WA,uBAEA,MAAMa,OAAO3H,IAAIV,OAAJ,CAAY,MAAZ,CAAb;;AACA,MAAMsI,SAAS5H,IAAIV,OAAJ,CAAY,QAAZ,CAAf;;AACA,MAAMuI,YAAY7H,IAAIV,OAAJ,CAAY,YAAZ,CAAlB;;AACA,MAAMwI,SAAS9H,IAAIV,OAAJ,CAAY,QAAZ,CAAf;;AACA,MAAMyI,SAAS/H,IAAIV,OAAJ,CAAY,QAAZ,CAAf;;AACA,MAAM0I,cAAchI,IAAIV,OAAJ,CAAY,aAAZ,CAApB;;AACA,MAAM2I,aAAajI,IAAIV,OAAJ,CAAY,YAAZ,CAAnB,C,CAEA;;;AAGAuC,OAAO,UAASqG,OAAT,EAAkB;AACxB,MAAKA,OAAL,GAAe,KAAKC,UAAL,CAAgBD,OAAhB,CAAf;AACA,CAFD,C,CAIA;AACA;AACA;;;AAEArG,KAAKuG,SAAL,CAAeD,UAAf,GAA4B,UAASD,OAAT,EAAkB;AAC7C,KAAI,CAACA,OAAL,EAAc;AACbA,YAAU,EAAV;AACA;;AAED,KAAI,CAACA,QAAQG,QAAb,EAAuB;AACtBH,UAAQG,QAAR,GAAmB,UAAnB;AACA;;AAED,KAAI,CAACH,QAAQI,IAAb,EAAmB;AAClBJ,UAAQI,IAAR,GAAe,eAAf;AACA;;AAED,KAAI,CAACJ,QAAQ1D,MAAb,EAAqB;AACpB0D,UAAQ1D,MAAR,GAAiB,eAAjB;AACA;;AAED,KAAI0D,QAAQK,gBAAR,KAA6B7F,SAAjC,EAA4C;AAC3CwF,UAAQK,gBAAR,GAA2B,wDAA3B;AACA;;AAED,KAAIL,QAAQM,YAAR,KAAyB9F,SAA7B,EAAwC;AACvCwF,UAAQM,YAAR,GAAuB,mEAAvB;AACA;;AAED,QAAON,OAAP;AACA,CA1BD;;AA4BArG,KAAKuG,SAAL,CAAeK,gBAAf,GAAkC,YAAW;AAC5C,OAAMC,QAAQ,kBAAd;AACA,KAAIC,WAAW,KAAf;;AACA,MAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAI,EAApB,EAAwBA,GAAxB,EAA6B;AAC5BD,cAAYD,MAAMG,MAAN,CAAaC,KAAKC,KAAL,CAAYD,KAAKE,MAAL,KAAgB,EAA5B,CAAb,EAA+C,CAA/C,CAAZ;AACA;;AACD,QAAOL,QAAP;AACA,CAPD;;AASA9G,KAAKuG,SAAL,CAAea,eAAf,GAAiC,YAAW;AAC3C,QAAO,IAAIC,IAAJ,GAAWC,WAAX,EAAP;AACA,CAFD;;AAIAtH,KAAKuG,SAAL,CAAegB,WAAf,GAA6B,UAASC,GAAT,EAAc;AAC1C,OAAMC,SAASxB,OAAOyB,UAAP,CAAkB,UAAlB,CAAf;AACAD,QAAOtH,MAAP,CAAcqH,GAAd;AACA,QAAOC,OAAOE,IAAP,CAAY,KAAKtB,OAAL,CAAauB,UAAzB,EAAqC,QAArC,CAAP;AACA,CAJD;;AAMA5H,KAAKuG,SAAL,CAAesB,wBAAf,GAA0C,UAAS/D,GAAT,EAAc;AACvD,KAAIzD,KAAM,IAAI,KAAKuG,gBAAL,EAAyB,EAAvC;AACA,OAAMkB,UAAU,KAAKV,eAAL,EAAhB,CAFuD,CAIvD;;AACA,KAAIhD,WAAJ;;AACA,KAAI,KAAKiC,OAAL,CAAajC,WAAjB,EAA8B;AAC7BA,gBAAc,KAAKiC,OAAL,CAAajC,WAA3B;AACA,EAFD,MAEO;AACNA,gBAAc,KAAKiC,OAAL,CAAaG,QAAb,GAAwB1C,IAAIiE,OAAJ,CAAYC,IAApC,GAA2C,KAAK3B,OAAL,CAAaI,IAAtE;AACA;;AAED,KAAI,KAAKJ,OAAL,CAAahG,EAAjB,EAAqB;AACpBA,OAAK,KAAKgG,OAAL,CAAahG,EAAlB;AACA;;AAED,KAAIJ,UACF,8EAA8EI,EAAI,iCAAiCyH,OACnH,mGAAmG1D,WAAa,kBAChH,KAAKiC,OAAL,CAAa4B,UAAY,IAF1B,GAGC,mEAAmE,KAAK5B,OAAL,CAAa1D,MAAQ,kBAJ1F;;AAMA,KAAI,KAAK0D,OAAL,CAAaK,gBAAjB,EAAmC;AAClCzG,aAAY,kFAAkF,KAAKoG,OAAL,CAAaK,gBAC1G,8CADD;AAEA;;AAEDzG,YACC,wGACA,6MADA,GAEA,uBAHD;AAKA,QAAOA,OAAP;AACA,CAjCD;;AAmCAD,KAAKuG,SAAL,CAAerG,qBAAf,GAAuC,UAASmG,OAAT,EAAkB;AACxD;AACA;AACA;AACA;AAEA,OAAMhG,KAAM,IAAI,KAAKuG,gBAAL,EAAyB,EAAzC;AACA,OAAMkB,UAAU,KAAKV,eAAL,EAAhB;AAEA,KAAInH,UAAW,GAAG,6EACjB,yDAA2D,GAAGI,EAAI,iCAAiCyH,OACnG,kBAAkB,KAAKzB,OAAL,CAAa6B,iBAAmB,IAFrC,GAGZ,mEAAmE,KAAK7B,OAAL,CAAa1D,MAAQ,gBAH5E,GAIZ,wBAAwB,KAAK0D,OAAL,CAAaK,gBAAkB,KAAKL,QAAQ1G,MAAQ,gBAJhE,GAKb,wBALD;AAOAM,WAAW,GAAG,8EACb,MAAQ,GAAGI,EAAI,IADN,GAET,gBAFS,GAGR,iBAAiByH,OAAS,IAHlB,GAIR,gBAAgB,KAAKzB,OAAL,CAAa6B,iBAAmB,IAJxC,GAKT,GALS,GAMR,mEAAmE,KAAK7B,OAAL,CAAa1D,MAAQ,gBANhF,GAOT,kEAPS,GAQT,kDARS,GASR,oBAAoB,KAAK0D,OAAL,CAAa1D,MAAQ,IATjC,GAUR,WAAW,KAAK0D,OAAL,CAAaK,gBAAkB,KAC1CL,QAAQ1G,MAAQ,gBAXR,GAYR,0EAA0E0G,QAAQxG,YAAc,uBAZxF,GAaT,wBAbD;;AAcA,KAAIpB,OAAOX,QAAP,CAAgBC,KAApB,EAA2B;AAC1BoB,UAAQC,GAAR,CAAY,yCAAZ;AACAD,UAAQC,GAAR,CAAYa,OAAZ;AACA;;AACD,QAAO;AACNA,SADM;AAENI;AAFM,EAAP;AAIA,CAtCD;;AAwCAL,KAAKuG,SAAL,CAAe/F,YAAf,GAA8B,UAASP,OAAT,EAAkBkI,SAAlB,EAA6BC,QAA7B,EAAuC;AACpE,OAAMC,OAAO,IAAb;AACAvC,MAAKwC,UAAL,CAAgBrI,OAAhB,EAAyB,UAASiD,GAAT,EAAcqF,MAAd,EAAsB;AAC9C,MAAIrF,GAAJ,EAAS;AACR,UAAOkF,SAASlF,GAAT,CAAP;AACA;;AAED,QAAMsF,SAASD,OAAOE,QAAP,CAAgB,QAAhB,CAAf;AACA,MAAIC,SAASL,KAAKhC,OAAL,CAAa4B,UAA1B;;AAEA,MAAIE,cAAc,QAAlB,EAA4B;AAC3B,OAAIE,KAAKhC,OAAL,CAAa6B,iBAAjB,EAAoC;AACnCQ,aAASL,KAAKhC,OAAL,CAAa6B,iBAAtB;AACA;AACD;;AAED,MAAIQ,OAAOC,OAAP,CAAe,GAAf,IAAsB,CAA1B,EAA6B;AAC5BD,aAAU,GAAV;AACA,GAFD,MAEO;AACNA,aAAU,GAAV;AACA,GAlB6C,CAoB9C;;;AACA,MAAIE,UAAJ;;AACA,MAAIT,cAAc,QAAlB,EAA4B;AAC3B;AACAS,gBAAanK,OAAO4F,WAAP,EAAb;AACA,GAHD,MAGO;AACNuE,gBAAaP,KAAKhC,OAAL,CAAa7H,QAA1B;AACA;;AAED,QAAMqK,cAAc;AACnBC,gBAAaN,MADM;AAEnB/F,eAAYmG;AAFO,GAApB;;AAKA,MAAIP,KAAKhC,OAAL,CAAa0C,WAAjB,EAA8B;AAC7BF,eAAYG,MAAZ,GAAqB,4CAArB;AACAH,eAAYI,SAAZ,GAAwBZ,KAAKd,WAAL,CAAiBpB,YAAY7G,SAAZ,CAAsBuJ,WAAtB,CAAjB,CAAxB;AACA;;AAEDH,YAAUvC,YAAY7G,SAAZ,CAAsBuJ,WAAtB,CAAV;;AAEA,MAAIpK,OAAOX,QAAP,CAAgBC,KAApB,EAA2B;AAC1BoB,WAAQC,GAAR,CAAa,iBAAiBsJ,MAAQ,EAAtC;AACA;;AACD,MAAIP,cAAc,QAAlB,EAA4B;AAC3B;AACA,UAAOC,SAAS,IAAT,EAAeM,MAAf,CAAP;AAEA,GAJD,MAIO;AACNN,YAAS,IAAT,EAAeM,MAAf;AACA;AACD,EAnDD;AAoDA,CAtDD;;AAwDA1I,KAAKuG,SAAL,CAAepB,eAAf,GAAiC,UAASrB,GAAT,EAAcsE,QAAd,EAAwB;AACxD,OAAMnI,UAAU,KAAK4H,wBAAL,CAA8B/D,GAA9B,CAAhB;AAEA,MAAKtD,YAAL,CAAkBP,OAAlB,EAA2B,WAA3B,EAAwCmI,QAAxC;AACA,CAJD;;AAMApI,KAAKuG,SAAL,CAAe2C,YAAf,GAA8B,UAASpF,GAAT,EAAcsE,QAAd,EAAwB;AACrD,OAAMnI,UAAU,KAAKC,qBAAL,CAA2B4D,GAA3B,CAAhB;AAEA,MAAKtD,YAAL,CAAkBP,OAAlB,EAA2B,QAA3B,EAAqCmI,QAArC;AACA,CAJD;;AAMApI,KAAKuG,SAAL,CAAe4C,SAAf,GAA2B,UAASC,IAAT,EAAe;AACzCA,QAAOA,KAAKC,KAAL,CAAW,UAAX,EAAuBC,IAAvB,CAA4B,IAA5B,CAAP;AACAF,QAAQ,gCAAgCA,IAAM,EAA9C;AACAA,QAAQ,GAAGA,IAAM,+BAAjB;AACA,QAAOA,IAAP;AACA,CALD,C,CAOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAEApJ,KAAKuG,SAAL,CAAegD,iBAAf,GAAmC,UAAS/B,GAAT,EAAc4B,IAAd,EAAoB;AACtD,OAAMf,OAAO,IAAb;AAEA,OAAMmB,MAAM,IAAItD,OAAOuD,SAAX,GAAuBC,eAAvB,CAAuClC,GAAvC,CAAZ;AACA,OAAMmC,YAAY3D,UAAU4D,KAAV,CAAgBJ,GAAhB,EAAqB,8FAArB,EAAqH,CAArH,CAAlB;AAEA,OAAMK,MAAM,IAAI7D,UAAU8D,SAAd,EAAZ;AAEAD,KAAIE,eAAJ,GAAsB;AACrBC,eAAW,OAAS;AACnB,UAAO,uBAAP;AACA,GAHoB;;AAIrBC,WAAO,WAAa;AACnB,UAAO5B,KAAKc,SAAL,CAAeC,IAAf,CAAP;AACA;;AANoB,EAAtB;AASAS,KAAIK,aAAJ,CAAkBP,SAAlB;AAEA,QAAOE,IAAIM,cAAJ,CAAmB3C,GAAnB,CAAP;AACA,CApBD;;AAsBAxH,KAAKuG,SAAL,CAAe6D,UAAf,GAA4B,UAASC,aAAT,EAAwBC,WAAxB,EAAqC;AAChE,KAAID,cAAe,QAAQC,WAAa,EAApC,CAAJ,EAA4C;AAC3C,SAAOD,cAAe,QAAQC,WAAa,EAApC,CAAP;AACA,EAFD,MAEO,IAAID,cAAe,SAASC,WAAa,EAArC,CAAJ,EAA6C;AACnD,SAAOD,cAAe,SAASC,WAAa,EAArC,CAAP;AACA,EAFM,MAEA,IAAID,cAAe,UAAUC,WAAa,EAAtC,CAAJ,EAA8C;AACpD,SAAOD,cAAe,UAAUC,WAAa,EAAtC,CAAP;AACA,EAFM,MAEA,IAAID,cAAe,SAASC,WAAa,EAArC,CAAJ,EAA6C;AACnD,SAAOD,cAAe,SAASC,WAAa,EAArC,CAAP;AACA,EAFM,MAEA,IAAID,cAAe,OAAOC,WAAa,EAAnC,CAAJ,EAA2C;AACjD,SAAOD,cAAe,OAAOC,WAAa,EAAnC,CAAP;AACA,EAFM,MAEA,IAAID,cAAe,OAAOC,WAAa,EAAnC,CAAJ,EAA2C;AACjD,SAAOD,cAAe,OAAOC,WAAa,EAAnC,CAAP;AACA;;AACD,QAAOD,cAAcC,WAAd,CAAP;AACA,CAfD;;AAiBAtK,KAAKuG,SAAL,CAAe/B,sBAAf,GAAwC,UAAS+F,YAAT,EAAuBnC,QAAvB,EAAiC;AACxE,OAAMC,OAAO,IAAb;AAEA,OAAMmC,yBAAyB,IAAIC,MAAJ,CAAWF,YAAX,EAAyB,QAAzB,CAA/B;AACAzE,MAAK4E,UAAL,CAAgBF,sBAAhB,EAAwC,UAAStH,GAAT,EAAcyH,OAAd,EAAuB;AAE9D,MAAIzH,GAAJ,EAAS;AACR,OAAIzE,OAAOX,QAAP,CAAgBC,KAApB,EAA2B;AAC1BoB,YAAQC,GAAR,CAAY8D,GAAZ;AACA;AACD,GAJD,MAIO;AACN,SAAM0H,SAAS,IAAI7E,OAAO8E,MAAX,CAAkB;AAChCC,kBAAc;AADkB,IAAlB,CAAf;AAGAF,UAAOG,WAAP,CAAmBJ,OAAnB,EAA4B,UAASzH,GAAT,EAAcsG,GAAd,EAAmB;AAC9C,UAAMwB,WAAW3C,KAAK+B,UAAL,CAAgBZ,GAAhB,EAAqB,gBAArB,CAAjB;;AAEA,QAAIwB,QAAJ,EAAc;AACb;AACA,WAAMpG,eAAeoG,SAASC,CAAT,CAAW1F,YAAhC;;AACA,SAAI9G,OAAOX,QAAP,CAAgBC,KAApB,EAA2B;AAC1BoB,cAAQC,GAAR,CAAa,mBAAmBwF,YAAc,EAA9C;AACA;;AACD,WAAMsG,SAAS7C,KAAK+B,UAAL,CAAgBY,QAAhB,EAA0B,QAA1B,CAAf;AACA,WAAMG,aAAa9C,KAAK+B,UAAL,CAAgBc,OAAO,CAAP,CAAhB,EAA2B,YAA3B,EAAyC,CAAzC,EAA4CD,CAA5C,CAA8CG,KAAjE;;AACA,SAAI3M,OAAOX,QAAP,CAAgBC,KAApB,EAA2B;AAC1BoB,cAAQC,GAAR,CAAa,eAAeC,KAAKC,SAAL,CAAe6L,UAAf,CAA4B,EAAxD;AACA;;AACD,SAAIA,eAAe,4CAAnB,EAAiE;AAChE;AACA;AACA/C,eAAS,IAAT,EAAexD,YAAf;AACA,MAJD,MAIO;AACNwD,eAAS,oCAAT,EAA+C,IAA/C;AACA;AACD,KAlBD,MAkBO;AACNA,cAAS,mBAAT,EAA8B,IAA9B;AACA;AACD,IAxBD;AAyBA;AAED,EArCD;AAsCA,CA1CD;;AA4CApI,KAAKuG,SAAL,CAAelB,gBAAf,GAAkC,UAASkF,YAAT,EAAuB3B,UAAvB,EAAmCR,QAAnC,EAA6C;AAC9E,OAAMC,OAAO,IAAb;AACA,OAAMb,MAAM,IAAIiD,MAAJ,CAAWF,YAAX,EAAyB,QAAzB,EAAmC9B,QAAnC,CAA4C,MAA5C,CAAZ,CAF8E,CAG9E;;AACA,KAAIhK,OAAOX,QAAP,CAAgBC,KAApB,EAA2B;AAC1BoB,UAAQC,GAAR,CAAa,yCAAyCoI,GAAK,EAA3D;AACA;;AACD,OAAMoD,SAAS,IAAI7E,OAAO8E,MAAX,CAAkB;AAChCC,gBAAc,IADkB;AAEhCO,SAAM;AAF0B,EAAlB,CAAf;AAKAT,QAAOG,WAAP,CAAmBvD,GAAnB,EAAwB,UAAStE,GAAT,EAAcsG,GAAd,EAAmB;AAC1C;AACA,MAAI/K,OAAOX,QAAP,CAAgBC,KAApB,EAA2B;AAC1BoB,WAAQC,GAAR,CAAY,kBAAZ;AACA;;AACD,MAAIiJ,KAAKhC,OAAL,CAAa+C,IAAb,IAAqB,CAACf,KAAKkB,iBAAL,CAAuB/B,GAAvB,EAA4Ba,KAAKhC,OAAL,CAAa+C,IAAzC,CAA1B,EAA0E;AACzE,OAAI3K,OAAOX,QAAP,CAAgBC,KAApB,EAA2B;AAC1BoB,YAAQC,GAAR,CAAY,iBAAZ;AACA;;AACD,UAAOgJ,SAAS,IAAI1J,KAAJ,CAAU,mBAAV,CAAT,EAAyC,IAAzC,EAA+C,KAA/C,CAAP;AACA;;AACD,MAAID,OAAOX,QAAP,CAAgBC,KAApB,EAA2B;AAC1BoB,WAAQC,GAAR,CAAY,cAAZ;AACA;;AACD,QAAM4L,WAAW3C,KAAK+B,UAAL,CAAgBZ,GAAhB,EAAqB,UAArB,CAAjB;;AACA,MAAI/K,OAAOX,QAAP,CAAgBC,KAApB,EAA2B;AAC1BoB,WAAQC,GAAR,CAAY,cAAZ;AACA;;AACD,MAAI4L,QAAJ,EAAc;AACb,SAAMM,YAAYjD,KAAK+B,UAAL,CAAgBY,QAAhB,EAA0B,WAA1B,CAAlB;;AACA,OAAI,CAACM,SAAL,EAAgB;AACf,WAAOlD,SAAS,IAAI1J,KAAJ,CAAU,wBAAV,CAAT,EAA8C,IAA9C,EAAoD,KAApD,CAAP;AACA;;AAED,SAAM0C,UAAU,EAAhB;;AAEA,OAAI4J,SAASC,CAAT,IAAcD,SAASC,CAAT,CAAW1F,YAA7B,EAA2C;AAC1CnE,YAAQkE,cAAR,GAAyB0F,SAASC,CAAT,CAAW1F,YAApC;AACA;;AAED,SAAM5C,SAAS0F,KAAK+B,UAAL,CAAgBkB,UAAU,CAAV,CAAhB,EAA8B,QAA9B,CAAf;;AACA,OAAI3I,MAAJ,EAAY;AACXvB,YAAQuB,MAAR,GAAiBA,OAAO,CAAP,EAAUrF,CAA3B;AACA;;AAED,SAAMiO,UAAUlD,KAAK+B,UAAL,CAAgBkB,UAAU,CAAV,CAAhB,EAA8B,SAA9B,CAAhB;;AAEA,OAAIC,OAAJ,EAAa;AACZ,UAAM5L,SAAS0I,KAAK+B,UAAL,CAAgBmB,QAAQ,CAAR,CAAhB,EAA4B,QAA5B,CAAf;;AACA,QAAI5L,MAAJ,EAAY;AACXyB,aAAQzB,MAAR,GAAiBA,OAAO,CAAP,EAAUrC,CAA3B;;AAEA,SAAIqC,OAAO,CAAP,EAAUsL,CAAV,CAAYO,MAAhB,EAAwB;AACvBpK,cAAQqK,YAAR,GAAuB9L,OAAO,CAAP,EAAUsL,CAAV,CAAYO,MAAnC;AACA;AACD;AACD;;AAED,SAAME,iBAAiBrD,KAAK+B,UAAL,CAAgBkB,UAAU,CAAV,CAAhB,EAA8B,gBAA9B,CAAvB;;AAEA,OAAII,cAAJ,EAAoB;AACnB,QAAIA,eAAe,CAAf,EAAkBT,CAAlB,CAAoBU,YAAxB,EAAsC;AAErCvK,aAAQvB,YAAR,GAAuB6L,eAAe,CAAf,EAAkBT,CAAlB,CAAoBU,YAA3C;;AACA,SAAIlN,OAAOX,QAAP,CAAgBC,KAApB,EAA2B;AAC1BoB,cAAQC,GAAR,CAAa,kBAAkBgC,QAAQvB,YAAc,EAArD;AACA;AACD,KAND,MAMO,IAAIpB,OAAOX,QAAP,CAAgBC,KAApB,EAA2B;AACjCoB,aAAQC,GAAR,CAAY,wBAAZ;AACA;AAGD,IAZD,MAYO,IAAIX,OAAOX,QAAP,CAAgBC,KAApB,EAA2B;AACjCoB,YAAQC,GAAR,CAAY,0BAAZ;AACA;;AAED,SAAMwM,qBAAqBvD,KAAK+B,UAAL,CAAgBkB,UAAU,CAAV,CAAhB,EAA8B,oBAA9B,CAA3B;;AACA,OAAIM,kBAAJ,EAAwB;AACvB,UAAMC,aAAaxD,KAAK+B,UAAL,CAAgBwB,mBAAmB,CAAnB,CAAhB,EAAuC,WAAvC,CAAnB;;AAEA,QAAIC,UAAJ,EAAgB;AACfA,gBAAWC,OAAX,CAAmB,UAASC,SAAT,EAAoB;AACtC,YAAMC,QAAQ3D,KAAK+B,UAAL,CAAgB2B,SAAhB,EAA2B,gBAA3B,CAAd;;AACA,UAAI,OAAOC,MAAM,CAAN,CAAP,KAAoB,QAAxB,EAAkC;AACjC5K,eAAQ2K,UAAUd,CAAV,CAAYgB,IAApB,IAA4BD,MAAM,CAAN,CAA5B;AACA,OAFD,MAEO;AACN5K,eAAQ2K,UAAUd,CAAV,CAAYgB,IAApB,IAA4BD,MAAM,CAAN,EAAS1O,CAArC;AACA;AACD,MAPD;AAQA;;AAED,QAAI,CAAC8D,QAAQ8K,IAAT,IAAiB9K,QAAQ,mCAAR,CAArB,EAAmE;AAClE;AACAA,aAAQ8K,IAAR,GAAe9K,QAAQ,mCAAR,CAAf;AACA;;AAED,QAAI,CAACA,QAAQC,KAAT,IAAkBD,QAAQ8K,IAA9B,EAAoC;AACnC9K,aAAQC,KAAR,GAAgBD,QAAQ8K,IAAxB;AACA;AACD;;AAED,OAAI,CAAC9K,QAAQC,KAAT,IAAkBD,QAAQzB,MAA1B,IAAoCyB,QAAQqK,YAA5C,IAA4DrK,QAAQqK,YAAR,CAAqB9C,OAArB,CAA6B,cAA7B,KAAgD,CAAhH,EAAmH;AAClHvH,YAAQC,KAAR,GAAgBD,QAAQzB,MAAxB;AACA;;AACD,OAAIlB,OAAOX,QAAP,CAAgBC,KAApB,EAA2B;AAC1BoB,YAAQC,GAAR,CAAa,WAAWC,KAAKC,SAAL,CAAe8B,OAAf,CAAyB,EAAjD;AACA;;AAEDgH,YAAS,IAAT,EAAehH,OAAf,EAAwB,KAAxB;AACA,GAjFD,MAiFO;AACN,SAAM+K,iBAAiB9D,KAAK+B,UAAL,CAAgBZ,GAAhB,EAAqB,gBAArB,CAAvB;;AAEA,OAAI2C,cAAJ,EAAoB;AACnB/D,aAAS,IAAT,EAAe,IAAf,EAAqB,IAArB;AACA,IAFD,MAEO;AACN,WAAOA,SAAS,IAAI1J,KAAJ,CAAU,+BAAV,CAAT,EAAqD,IAArD,EAA2D,KAA3D,CAAP;AACA;AAED;AACD,EA7GD;AA8GA,CA1HD;;AA4HA,IAAI0N,cAAJ;;AACApM,KAAKuG,SAAL,CAAehC,+BAAf,GAAiD,UAASH,WAAT,EAAsB;AAEtE,KAAI,CAACgI,cAAL,EAAqB;AACpBA,mBAAiB,KAAK/F,OAAL,CAAa0C,WAA9B;AACA;;AAED,KAAI,CAAC,KAAK1C,OAAL,CAAajC,WAAd,IAA6B,CAACA,WAAlC,EAA+C;AAC9C,QAAM,IAAI1F,KAAJ,CACL,iFADK,CAAN;AAEA;;AAED,OAAM2N,WAAW;AAChB,sBAAoB;AACnB,aAAU,sCADS;AAEnB,gBAAa,oCAFM;AAGnB,gBAAa,KAAKhG,OAAL,CAAa1D,MAHP;AAInB,sBAAmB;AAClB,mCAA+B,sCADb;AAElB,2BAAuB;AACtB,iBAAY,oDADU;AAEtB,kBAAc,GAAGlE,OAAO4F,WAAP,EAAsB,gBAAgB,KAAKgC,OAAL,CAAa7H,QAAU,GAFxD;AAGtB,0BAAsB,GAAGC,OAAO4F,WAAP,EAAsB,gBAAgB,KAAKgC,OAAL,CAAa7H,QAAU;AAHhE,KAFL;AAOlB,oBAAgB,KAAK6H,OAAL,CAAaK,gBAPX;AAQlB,gCAA4B;AAC3B,eAAU,GADiB;AAE3B,mBAAc,MAFa;AAG3B,iBAAY,gDAHe;AAI3B,kBAAatC;AAJc;AARV;AAJA;AADJ,EAAjB;;AAuBA,KAAI,KAAKiC,OAAL,CAAauB,UAAjB,EAA6B;AAC5B,MAAI,CAACwE,cAAL,EAAqB;AACpB,SAAM,IAAI1N,KAAJ,CACL,kFADK,CAAN;AAEA;;AAED0N,mBAAiBA,eAAeE,OAAf,CAAuB,6BAAvB,EAAsD,EAAtD,CAAjB;AACAF,mBAAiBA,eAAeE,OAAf,CAAuB,2BAAvB,EAAoD,EAApD,CAAjB;AACAF,mBAAiBA,eAAeE,OAAf,CAAuB,OAAvB,EAAgC,IAAhC,CAAjB;AAEAD,WAAS,kBAAT,EAA6B,iBAA7B,EAAgD,eAAhD,IAAmE;AAClE,iBAAc;AACb,mBAAe;AACd,2BAAsB;AACrB,eAASD;AADY;AADR;AADF,IADoD;AAQlE,YAAS,CACR;AACA;AACC,wBAAoB;AACnB,mBAAc;AADK;AADrB,IAFQ,EAOR;AACC,wBAAoB;AACnB,mBAAc;AADK;AADrB,IAPQ,EAYR;AACC,wBAAoB;AACnB,mBAAc;AADK;AADrB,IAZQ;AARyD,GAAnE;AA2BA;;AAED,QAAOhG,WAAWmG,MAAX,CAAkBF,QAAlB,EAA4BhJ,GAA5B,CAAgC;AACtCmJ,UAAQ,IAD8B;AAEtCC,UAAQ,IAF8B;AAGtCC,WAAS;AAH6B,EAAhC,CAAP;AAKA,CA9ED,C;;;;;;;;;;;ACrbAnP,OAAOoP,MAAP,CAAc;AAACC,iBAAe,MAAIA,cAApB;AAAmCC,uBAAqB,MAAIA,oBAA5D;AAAiFC,iBAAe,MAAIA,cAApG;AAAmHC,WAAS,MAAIA,QAAhI;AAAyIC,SAAO,MAAIA;AAApJ,CAAd;AAAA,MAAMA,SAAS,IAAIC,MAAJ,CAAW,6BAAX,EAA0C;AACxDlO,UAAS;AACRmO,WAAS;AACRlM,SAAM;AADE;AADD;AAD+C,CAA1C,CAAf;AAQAkB,WAAWpE,QAAX,CAAoBqP,QAApB,CAA6B,MAA7B;AAEA1O,OAAOM,OAAP,CAAe;AACdqO,gBAAe1L,IAAf,EAAqB;AACpBQ,aAAWpE,QAAX,CAAoBuP,GAApB,CAAyB,eAAe3L,IAAM,EAA9C,EAAiD,KAAjD,EAAwD;AACvDV,SAAM,SADiD;AAEvDsM,UAAO,MAFgD;AAGvDC,YAAS7L,IAH8C;AAIvD8L,cAAW;AAJ4C,GAAxD;AAMAtL,aAAWpE,QAAX,CAAoBuP,GAApB,CAAyB,eAAe3L,IAAM,WAA9C,EAA0D,eAA1D,EAA2E;AAC1EV,SAAM,QADoE;AAE1EsM,UAAO,MAFmE;AAG1EC,YAAS7L,IAHiE;AAI1E8L,cAAW;AAJ+D,GAA3E;AAMAtL,aAAWpE,QAAX,CAAoBuP,GAApB,CAAyB,eAAe3L,IAAM,cAA9C,EAA6D,yDAA7D,EAAwH;AACvHV,SAAM,QADiH;AAEvHsM,UAAO,MAFgH;AAGvHC,YAAS7L,IAH8G;AAIvH8L,cAAW;AAJ4G,GAAxH;AAMAtL,aAAWpE,QAAX,CAAoBuP,GAApB,CAAyB,eAAe3L,IAAM,uBAA9C,EAAsE,kEAAtE,EAA0I;AACzIV,SAAM,QADmI;AAEzIsM,UAAO,MAFkI;AAGzIC,YAAS7L,IAHgI;AAIzI8L,cAAW;AAJ8H,GAA1I;AAMAtL,aAAWpE,QAAX,CAAoBuP,GAApB,CAAyB,eAAe3L,IAAM,SAA9C,EAAwD,uDAAxD,EAAiH;AAChHV,SAAM,QAD0G;AAEhHsM,UAAO,MAFyG;AAGhHC,YAAS7L,IAHuG;AAIhH8L,cAAW;AAJqG,GAAjH;AAMAtL,aAAWpE,QAAX,CAAoBuP,GAApB,CAAyB,eAAe3L,IAAM,OAA9C,EAAsD,EAAtD,EAA0D;AACzDV,SAAM,QADmD;AAEzDsM,UAAO,MAFkD;AAGzDC,YAAS7L,IAHgD;AAIzD8L,cAAW,kBAJ8C;AAKzDC,cAAW;AAL8C,GAA1D;AAOAvL,aAAWpE,QAAX,CAAoBuP,GAApB,CAAyB,eAAe3L,IAAM,cAA9C,EAA6D,EAA7D,EAAiE;AAChEV,SAAM,QAD0D;AAEhEsM,UAAO,MAFyD;AAGhEC,YAAS7L,IAHuD;AAIhE+L,cAAW,IAJqD;AAKhED,cAAW;AALqD,GAAjE;AAOAtL,aAAWpE,QAAX,CAAoBuP,GAApB,CAAyB,eAAe3L,IAAM,cAA9C,EAA6D,EAA7D,EAAiE;AAChEV,SAAM,QAD0D;AAEhEsM,UAAO,MAFyD;AAGhEC,YAAS7L,IAHuD;AAIhE+L,cAAW,IAJqD;AAKhED,cAAW;AALqD,GAAjE;AAOAtL,aAAWpE,QAAX,CAAoBuP,GAApB,CAAyB,eAAe3L,IAAM,oBAA9C,EAAmE,EAAnE,EAAuE;AACtEV,SAAM,QADgE;AAEtEsM,UAAO,MAF+D;AAGtEC,YAAS7L,IAH6D;AAItE8L,cAAW;AAJ2D,GAAvE;AAMAtL,aAAWpE,QAAX,CAAoBuP,GAApB,CAAyB,eAAe3L,IAAM,qBAA9C,EAAoE,SAApE,EAA+E;AAC9EV,SAAM,QADwE;AAE9EsM,UAAO,MAFuE;AAG9EC,YAAS7L,IAHqE;AAI9E8L,cAAW;AAJmE,GAA/E;AAMAtL,aAAWpE,QAAX,CAAoBuP,GAApB,CAAyB,eAAe3L,IAAM,eAA9C,EAA8D,SAA9D,EAAyE;AACxEV,SAAM,QADkE;AAExEsM,UAAO,MAFiE;AAGxEC,YAAS7L,IAH+D;AAIxE8L,cAAW;AAJ6D,GAAzE;AAMAtL,aAAWpE,QAAX,CAAoBuP,GAApB,CAAyB,eAAe3L,IAAM,oBAA9C,EAAmE,KAAnE,EAA0E;AACzEV,SAAM,SADmE;AAEzEsM,UAAO,MAFkE;AAGzEC,YAAS7L,IAHgE;AAIzE8L,cAAW;AAJ8D,GAA1E;AAMA;;AA7Ea,CAAf;;AAgFA,MAAMV,iBAAiB,UAAS7I,OAAT,EAAkB;AACxC,QAAO;AACNyJ,mBAAiBxL,WAAWpE,QAAX,CAAoB6P,GAApB,CAAyB,GAAG1J,QAAQ2J,GAAK,oBAAzC,CADX;AAENC,oBAAkB3L,WAAWpE,QAAX,CAAoB6P,GAApB,CAAyB,GAAG1J,QAAQ2J,GAAK,qBAAzC,CAFZ;AAGNE,eAAa5L,WAAWpE,QAAX,CAAoB6P,GAApB,CAAyB,GAAG1J,QAAQ2J,GAAK,eAAzC,CAHP;AAING,gBAAc;AACbvP,aAAU0D,WAAWpE,QAAX,CAAoB6P,GAApB,CAAyB,GAAG1J,QAAQ2J,GAAK,WAAzC;AADG,GAJR;AAON3F,cAAY/F,WAAWpE,QAAX,CAAoB6P,GAApB,CAAyB,GAAG1J,QAAQ2J,GAAK,cAAzC,CAPN;AAQN1F,qBAAmBhG,WAAWpE,QAAX,CAAoB6P,GAApB,CAAyB,GAAG1J,QAAQ2J,GAAK,uBAAzC,CARb;AASN5P,oBAAkBkE,WAAWpE,QAAX,CAAoB6P,GAApB,CAAyB,GAAG1J,QAAQ2J,GAAK,oBAAzC,CATZ;AAUNjL,UAAQT,WAAWpE,QAAX,CAAoB6P,GAApB,CAAyB,GAAG1J,QAAQ2J,GAAK,SAAzC,CAVF;AAWNI,UAAQ;AACPpG,eAAY1F,WAAWpE,QAAX,CAAoB6P,GAApB,CAAyB,GAAG1J,QAAQ2J,GAAK,cAAzC,CADL;AAEPK,eAAY/L,WAAWpE,QAAX,CAAoB6P,GAApB,CAAyB,GAAG1J,QAAQ2J,GAAK,cAAzC,CAFL;AAGPxE,SAAMlH,WAAWpE,QAAX,CAAoB6P,GAApB,CAAyB,GAAG1J,QAAQ2J,GAAK,OAAzC;AAHC;AAXF,EAAP;AAiBA,CAlBD;;AAoBA,MAAMb,WAAW,CAACmB,EAAD,EAAKC,KAAL,KAAe;AAC/B,KAAIC,QAAQ,IAAZ;AACA,QAAO,MAAM;AACZ,MAAIA,SAAS,IAAb,EAAmB;AAClB3P,UAAO4P,YAAP,CAAoBD,KAApB;AACA;;AACD,SAAOA,QAAQ3P,OAAO6P,UAAP,CAAkBJ,EAAlB,EAAsBC,KAAtB,CAAf;AACA,EALD;AAMA,CARD;;AASA,MAAMvK,cAAc,MAApB;;AAEA,MAAMiJ,uBAAuB,UAAS0B,WAAT,EAAsB;AAClD,KAAIxF,cAAc,KAAlB;AACA,KAAInB,aAAa,KAAjB;;AACA,KAAI2G,YAAYP,MAAZ,CAAmBpG,UAAnB,IAAiC2G,YAAYP,MAAZ,CAAmBC,UAAxD,EAAoE;AACnErG,eAAa2G,YAAYP,MAAZ,CAAmBpG,UAAhC;AACAmB,gBAAcwF,YAAYP,MAAZ,CAAmBC,UAAjC;AACA,EAHD,MAGO,IAAIM,YAAYP,MAAZ,CAAmBpG,UAAnB,IAAiC2G,YAAYP,MAAZ,CAAmBC,UAAxD,EAAoE;AAC1EjB,SAAO/L,KAAP,CAAa,2CAAb;AACA,EARiD,CASlD;;;AACArD,UAASC,IAAT,CAAcC,QAAd,CAAuBE,gBAAvB,GAA0CuQ,YAAYvQ,gBAAtD;AACA,QAAO;AACNQ,YAAU+P,YAAYR,YAAZ,CAAyBvP,QAD7B;AAENyJ,cAAYsG,YAAYtG,UAFlB;AAGNC,qBAAmBqG,YAAYrG,iBAHzB;AAINvF,UAAQ4L,YAAY5L,MAJd;AAKNyG,QAAMmF,YAAYP,MAAZ,CAAmB5E,IALnB;AAMNL,aANM;AAONnB;AAPM,EAAP;AASA,CApBD;;AAsBA,MAAMgF,iBAAiBG,SAAS,MAAM;AACrC,OAAMnN,WAAWsC,WAAWpE,QAAX,CAAoB6P,GAApB,CAAwB,yBAAxB,CAAjB;AACA/P,UAASC,IAAT,CAAcC,QAAd,CAAuBG,SAAvB,GAAmC2B,SAAS4O,GAAT,CAAcvK,OAAD,IAAa;AAC5D,MAAIA,QAAQ+H,KAAR,KAAkB,IAAtB,EAA4B;AAC3B,SAAMuC,cAAczB,eAAe7I,OAAf,CAApB;AACA+I,UAAOE,OAAP,CAAejJ,QAAQ2J,GAAvB;AACAa,wBAAqBC,cAArB,CAAoCC,MAApC,CAA2C;AAC1C1K,aAASL,YAAYgL,WAAZ;AADiC,IAA3C,EAEG;AACFxO,UAAMmO;AADJ,IAFH;AAKA,UAAO1B,qBAAqB0B,WAArB,CAAP;AACA,GATD,MASO;AACNE,wBAAqBC,cAArB,CAAoCG,MAApC,CAA2C;AAC1C5K,aAASL,YAAYgL,WAAZ;AADiC,IAA3C;AAGA;AACD,EAfkC,EAehC9P,MAfgC,CAezBgQ,KAAKA,CAfoB,CAAnC;AAgBA,CAlBsB,EAkBpB,IAlBoB,CAAvB;AAqBA5M,WAAWpE,QAAX,CAAoB6P,GAApB,CAAwB,UAAxB,EAAoCf,cAApC;AAEAnO,OAAOsQ,OAAP,CAAe,MAAM;AACpB,QAAOtQ,OAAOuQ,IAAP,CAAY,gBAAZ,EAA8B,SAA9B,CAAP;AACA,CAFD,E","file":"/packages/steffo_meteor-accounts-saml.js","sourcesContent":["/* globals RoutePolicy, SAML */\n/* jshint newcap: false */\nimport _ from 'underscore';\n\nif (!Accounts.saml) {\n\tAccounts.saml = {\n\t\tsettings: {\n\t\t\tdebug: true,\n\t\t\tgenerateUsername: false,\n\t\t\tproviders: []\n\t\t}\n\t};\n}\n\nconst fiber = Npm.require('fibers');\nconst connect = Npm.require('connect');\nRoutePolicy.declare('/_saml/', 'network');\n\n/**\n * Fetch SAML provider configs for given 'provider'.\n */\nfunction getSamlProviderConfig(provider) {\n\tif (! provider) {\n\t\tthrow new Meteor.Error('no-saml-provider',\n\t\t\t'SAML internal error',\n\t\t\t{ method: 'getSamlProviderConfig' });\n\t}\n\tconst samlProvider = function(element) {\n\t\treturn (element.provider === provider);\n\t};\n\treturn Accounts.saml.settings.providers.filter(samlProvider)[0];\n}\n\nMeteor.methods({\n\tsamlLogout(provider) {\n\t\t// Make sure the user is logged in before initiate SAML SLO\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'samlLogout' });\n\t\t}\n\t\tconst providerConfig = getSamlProviderConfig(provider);\n\n\t\tif (Accounts.saml.settings.debug) {\n\t\t\tconsole.log(`Logout request from ${ JSON.stringify(providerConfig) }`);\n\t\t}\n\t\t// This query should respect upcoming array of SAML logins\n\t\tconst user = Meteor.users.findOne({\n\t\t\t_id: Meteor.userId(),\n\t\t\t'services.saml.provider': provider\n\t\t}, {\n\t\t\t'services.saml': 1\n\t\t});\n\t\tlet nameID = user.services.saml.nameID;\n\t\tconst sessionIndex = user.services.saml.idpSession;\n\t\tnameID = sessionIndex;\n\t\tif (Accounts.saml.settings.debug) {\n\t\t\tconsole.log(`NameID for user ${ Meteor.userId() } found: ${ JSON.stringify(nameID) }`);\n\t\t}\n\n\t\tconst _saml = new SAML(providerConfig);\n\n\t\tconst request = _saml.generateLogoutRequest({\n\t\t\tnameID,\n\t\t\tsessionIndex\n\t\t});\n\n\t\t// request.request: actual XML SAML Request\n\t\t// request.id: comminucation id which will be mentioned in the ResponseTo field of SAMLResponse\n\n\t\tMeteor.users.update({\n\t\t\t_id: Meteor.userId()\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\t'services.saml.inResponseTo': request.id\n\t\t\t}\n\t\t});\n\n\t\tconst _syncRequestToUrl = Meteor.wrapAsync(_saml.requestToUrl, _saml);\n\t\tconst result = _syncRequestToUrl(request.request, 'logout');\n\t\tif (Accounts.saml.settings.debug) {\n\t\t\tconsole.log(`SAML Logout Request ${ result }`);\n\t\t}\n\n\n\t\treturn result;\n\t}\n});\n\nAccounts.registerLoginHandler(function(loginRequest) {\n\tif (!loginRequest.saml || !loginRequest.credentialToken) {\n\t\treturn undefined;\n\t}\n\n\tconst loginResult = Accounts.saml.retrieveCredential(loginRequest.credentialToken);\n\tif (Accounts.saml.settings.debug) {\n\t\tconsole.log(`RESULT :${ JSON.stringify(loginResult) }`);\n\t}\n\n\tif (loginResult === undefined) {\n\t\treturn {\n\t\t\ttype: 'saml',\n\t\t\terror: new Meteor.Error(Accounts.LoginCancelledError.numericError, 'No matching login attempt found')\n\t\t};\n\t}\n\n\tif (loginResult && loginResult.profile && loginResult.profile.email) {\n\t\tconst email = RegExp.escape(loginResult.profile.email);\n\t\tconst emailRegex = new RegExp(`^${ email }$`, 'i');\n\t\tlet user = Meteor.users.findOne({\n\t\t\t'emails.address': emailRegex\n\t\t});\n\n\t\tif (!user) {\n\t\t\tconst newUser = {\n\t\t\t\tname: loginResult.profile.cn || loginResult.profile.username,\n\t\t\t\tactive: true,\n\t\t\t\tglobalRoles: ['user'],\n\t\t\t\temails: [{\n\t\t\t\t\taddress: loginResult.profile.email,\n\t\t\t\t\tverified: true\n\t\t\t\t}]\n\t\t\t};\n\n\t\t\tif (Accounts.saml.settings.generateUsername === true) {\n\t\t\t\tconst username = RocketChat.generateUsernameSuggestion(newUser);\n\t\t\t\tif (username) {\n\t\t\t\t\tnewUser.username = username;\n\t\t\t\t}\n\t\t\t} else if (loginResult.profile.username) {\n\t\t\t\tnewUser.username = loginResult.profile.username;\n\t\t\t}\n\n\t\t\tconst userId = Accounts.insertUserDoc({}, newUser);\n\t\t\tuser = Meteor.users.findOne(userId);\n\t\t}\n\n\t\t//creating the token and adding to the user\n\t\tconst stampedToken = Accounts._generateStampedLoginToken();\n\t\tMeteor.users.update(user, {\n\t\t\t$push: {\n\t\t\t\t'services.resume.loginTokens': stampedToken\n\t\t\t}\n\t\t});\n\n\t\tconst samlLogin = {\n\t\t\tprovider: Accounts.saml.RelayState,\n\t\t\tidp: loginResult.profile.issuer,\n\t\t\tidpSession: loginResult.profile.sessionIndex,\n\t\t\tnameID: loginResult.profile.nameID\n\t\t};\n\n\t\tMeteor.users.update({\n\t\t\t_id: user._id\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\t// TBD this should be pushed, otherwise we're only able to SSO into a single IDP at a time\n\t\t\t\t'services.saml': samlLogin\n\t\t\t}\n\t\t});\n\n\t\t//sending token along with the userId\n\t\tconst result = {\n\t\t\tuserId: user._id,\n\t\t\ttoken: stampedToken.token\n\t\t};\n\n\t\treturn result;\n\n\t} else {\n\t\tthrow new Error('SAML Profile did not contain an email address');\n\t}\n});\n\nAccounts.saml._loginResultForCredentialToken = {};\n\nAccounts.saml.hasCredential = function(credentialToken) {\n\treturn _.has(Accounts.saml._loginResultForCredentialToken, credentialToken);\n};\n\nAccounts.saml.retrieveCredential = function(credentialToken) {\n\t// The credentialToken in all these functions corresponds to SAMLs inResponseTo field and is mandatory to check.\n\tconst result = Accounts.saml._loginResultForCredentialToken[credentialToken];\n\tdelete Accounts.saml._loginResultForCredentialToken[credentialToken];\n\treturn result;\n};\n\nconst closePopup = function(res, err) {\n\tres.writeHead(200, {\n\t\t'Content-Type': 'text/html'\n\t});\n\tlet content = '<html><head><script>window.close()</script></head><body><H1>Verified</H1></body></html>';\n\tif (err) {\n\t\tcontent = `<html><body><h2>Sorry, an annoying error occured</h2><div>${ err }</div><a onclick=\"window.close();\">Close Window</a></body></html>`;\n\t}\n\tres.end(content, 'utf-8');\n};\n\nconst samlUrlToObject = function(url) {\n\t// req.url will be '/_saml/<action>/<service name>/<credentialToken>'\n\tif (!url) {\n\t\treturn null;\n\t}\n\n\tconst splitUrl = url.split('?');\n\tconst splitPath = splitUrl[0].split('/');\n\n\t// Any non-saml request will continue down the default\n\t// middlewares.\n\tif (splitPath[1] !== '_saml') {\n\t\treturn null;\n\t}\n\n\tconst result = {\n\t\tactionName: splitPath[2],\n\t\tserviceName: splitPath[3],\n\t\tcredentialToken: splitPath[4]\n\t};\n\tif (Accounts.saml.settings.debug) {\n\t\tconsole.log(result);\n\t}\n\treturn result;\n};\n\nconst middleware = function(req, res, next) {\n\t// Make sure to catch any exceptions because otherwise we'd crash\n\t// the runner\n\ttry {\n\t\tconst samlObject = samlUrlToObject(req.url);\n\t\tif (!samlObject || !samlObject.serviceName) {\n\t\t\tnext();\n\t\t\treturn;\n\t\t}\n\n\t\tif (!samlObject.actionName) {\n\t\t\tthrow new Error('Missing SAML action');\n\t\t}\n\n\t\tconsole.log(Accounts.saml.settings.providers);\n\t\tconsole.log(samlObject.serviceName);\n\t\tconst service = _.find(Accounts.saml.settings.providers, function(samlSetting) {\n\t\t\treturn samlSetting.provider === samlObject.serviceName;\n\t\t});\n\n\t\t// Skip everything if there's no service set by the saml middleware\n\t\tif (!service) {\n\t\t\tthrow new Error(`Unexpected SAML service ${ samlObject.serviceName }`);\n\t\t}\n\t\tlet _saml;\n\t\tswitch (samlObject.actionName) {\n\t\t\tcase 'metadata':\n\t\t\t\t_saml = new SAML(service);\n\t\t\t\tservice.callbackUrl = Meteor.absoluteUrl(`_saml/validate/${ service.provider }`);\n\t\t\t\tres.writeHead(200);\n\t\t\t\tres.write(_saml.generateServiceProviderMetadata(service.callbackUrl));\n\t\t\t\tres.end();\n\t\t\t\t//closePopup(res);\n\t\t\t\tbreak;\n\t\t\tcase 'logout':\n\t\t\t\t// This is where we receive SAML LogoutResponse\n\t\t\t\t_saml = new SAML(service);\n\t\t\t\t_saml.validateLogoutResponse(req.query.SAMLResponse, function(err, result) {\n\t\t\t\t\tif (!err) {\n\t\t\t\t\t\tconst logOutUser = function(inResponseTo) {\n\t\t\t\t\t\t\tif (Accounts.saml.settings.debug) {\n\t\t\t\t\t\t\t\tconsole.log(`Logging Out user via inResponseTo ${ inResponseTo }`);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tconst loggedOutUser = Meteor.users.find({\n\t\t\t\t\t\t\t\t'services.saml.inResponseTo': inResponseTo\n\t\t\t\t\t\t\t}).fetch();\n\t\t\t\t\t\t\tif (loggedOutUser.length === 1) {\n\t\t\t\t\t\t\t\tif (Accounts.saml.settings.debug) {\n\t\t\t\t\t\t\t\t\tconsole.log(`Found user ${ loggedOutUser[0]._id }`);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tMeteor.users.update({\n\t\t\t\t\t\t\t\t\t_id: loggedOutUser[0]._id\n\t\t\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t\t\t\t'services.resume.loginTokens': []\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tMeteor.users.update({\n\t\t\t\t\t\t\t\t\t_id: loggedOutUser[0]._id\n\t\t\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\t\t\t$unset: {\n\t\t\t\t\t\t\t\t\t\t'services.saml': ''\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthrow new Meteor.Error('Found multiple users matching SAML inResponseTo fields');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tfiber(function() {\n\t\t\t\t\t\t\tlogOutUser(result);\n\t\t\t\t\t\t}).run();\n\n\n\t\t\t\t\t\tres.writeHead(302, {\n\t\t\t\t\t\t\t'Location': req.query.RelayState\n\t\t\t\t\t\t});\n\t\t\t\t\t\tres.end();\n\t\t\t\t\t}\n\t\t\t\t\t//  else {\n\t\t\t\t\t// \t// TBD thinking of sth meaning full.\n\t\t\t\t\t// }\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\tcase 'sloRedirect':\n\t\t\t\tres.writeHead(302, {\n\t\t\t\t\t// credentialToken here is the SAML LogOut Request that we'll send back to IDP\n\t\t\t\t\t'Location': req.query.redirect\n\t\t\t\t});\n\t\t\t\tres.end();\n\t\t\t\tbreak;\n\t\t\tcase 'authorize':\n\t\t\t\tservice.callbackUrl = Meteor.absoluteUrl(`_saml/validate/${ service.provider }`);\n\t\t\t\tservice.id = samlObject.credentialToken;\n\t\t\t\t_saml = new SAML(service);\n\t\t\t\t_saml.getAuthorizeUrl(req, function(err, url) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tthrow new Error('Unable to generate authorize url');\n\t\t\t\t\t}\n\t\t\t\t\tres.writeHead(302, {\n\t\t\t\t\t\t'Location': url\n\t\t\t\t\t});\n\t\t\t\t\tres.end();\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\tcase 'validate':\n\t\t\t\t_saml = new SAML(service);\n\t\t\t\tAccounts.saml.RelayState = req.body.RelayState;\n\t\t\t\t_saml.validateResponse(req.body.SAMLResponse, req.body.RelayState, function(err, profile/*, loggedOut*/) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tthrow new Error(`Unable to validate response url: ${ err }`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst credentialToken = profile.inResponseToId || profile.InResponseTo || samlObject.credentialToken;\n\t\t\t\t\tif (!credentialToken) {\n\t\t\t\t\t\t// No credentialToken in IdP-initiated SSO\n\t\t\t\t\t\tconst saml_idp_credentialToken = Random.id();\n\t\t\t\t\t\tAccounts.saml._loginResultForCredentialToken[saml_idp_credentialToken] = {\n\t\t\t\t\t\t\tprofile\n\t\t\t\t\t\t};\n\t\t\t\t\t\tconst url = `${ Meteor.absoluteUrl('home') }?saml_idp_credentialToken=${ saml_idp_credentialToken }`;\n\t\t\t\t\t\tres.writeHead(302, {\n\t\t\t\t\t\t\t'Location': url\n\t\t\t\t\t\t});\n\t\t\t\t\t\tres.end();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tAccounts.saml._loginResultForCredentialToken[credentialToken] = {\n\t\t\t\t\t\t\tprofile\n\t\t\t\t\t\t};\n\t\t\t\t\t\tclosePopup(res);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`Unexpected SAML action ${ samlObject.actionName }`);\n\n\t\t}\n\t} catch (err) {\n\t\tclosePopup(res, err);\n\t}\n};\n\n// Listen to incoming SAML http requests\nWebApp.connectHandlers.use(connect.bodyParser()).use(function(req, res, next) {\n\t// Need to create a fiber since we're using synchronous http calls and nothing\n\t// else is wrapping this in a fiber automatically\n\tfiber(function() {\n\t\tmiddleware(req, res, next);\n\t}).run();\n});\n","/* globals SAML:true */\n\nconst zlib = Npm.require('zlib');\nconst xml2js = Npm.require('xml2js');\nconst xmlCrypto = Npm.require('xml-crypto');\nconst crypto = Npm.require('crypto');\nconst xmldom = Npm.require('xmldom');\nconst querystring = Npm.require('querystring');\nconst xmlbuilder = Npm.require('xmlbuilder');\n\n// var prefixMatch = new RegExp(/(?!xmlns)^.*:/);\n\n\nSAML = function(options) {\n\tthis.options = this.initialize(options);\n};\n\n// var stripPrefix = function(str) {\n// \treturn str.replace(prefixMatch, '');\n// };\n\nSAML.prototype.initialize = function(options) {\n\tif (!options) {\n\t\toptions = {};\n\t}\n\n\tif (!options.protocol) {\n\t\toptions.protocol = 'https://';\n\t}\n\n\tif (!options.path) {\n\t\toptions.path = '/saml/consume';\n\t}\n\n\tif (!options.issuer) {\n\t\toptions.issuer = 'onelogin_saml';\n\t}\n\n\tif (options.identifierFormat === undefined) {\n\t\toptions.identifierFormat = 'urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress';\n\t}\n\n\tif (options.authnContext === undefined) {\n\t\toptions.authnContext = 'urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport';\n\t}\n\n\treturn options;\n};\n\nSAML.prototype.generateUniqueID = function() {\n\tconst chars = 'abcdef0123456789';\n\tlet uniqueID = 'id-';\n\tfor (let i = 0; i < 20; i++) {\n\t\tuniqueID += chars.substr(Math.floor((Math.random() * 15)), 1);\n\t}\n\treturn uniqueID;\n};\n\nSAML.prototype.generateInstant = function() {\n\treturn new Date().toISOString();\n};\n\nSAML.prototype.signRequest = function(xml) {\n\tconst signer = crypto.createSign('RSA-SHA1');\n\tsigner.update(xml);\n\treturn signer.sign(this.options.privateKey, 'base64');\n};\n\nSAML.prototype.generateAuthorizeRequest = function(req) {\n\tlet id = `_${ this.generateUniqueID() }`;\n\tconst instant = this.generateInstant();\n\n\t// Post-auth destination\n\tlet callbackUrl;\n\tif (this.options.callbackUrl) {\n\t\tcallbackUrl = this.options.callbackUrl;\n\t} else {\n\t\tcallbackUrl = this.options.protocol + req.headers.host + this.options.path;\n\t}\n\n\tif (this.options.id) {\n\t\tid = this.options.id;\n\t}\n\n\tlet request =\n\t\t`<samlp:AuthnRequest xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\" ID=\"${ id }\" Version=\"2.0\" IssueInstant=\"${ instant\n\t\t}\" ProtocolBinding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST\" AssertionConsumerServiceURL=\"${ callbackUrl }\" Destination=\"${\n\t\t\tthis.options.entryPoint }\">` +\n\t\t`<saml:Issuer xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\">${ this.options.issuer }</saml:Issuer>\\n`;\n\n\tif (this.options.identifierFormat) {\n\t\trequest += `<samlp:NameIDPolicy xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\" Format=\"${ this.options.identifierFormat\n\t\t}\" AllowCreate=\"true\"></samlp:NameIDPolicy>\\n`;\n\t}\n\n\trequest +=\n\t\t'<samlp:RequestedAuthnContext xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\" Comparison=\"exact\">' +\n\t\t'<saml:AuthnContextClassRef xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\">urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport</saml:AuthnContextClassRef></samlp:RequestedAuthnContext>\\n' +\n\t\t'</samlp:AuthnRequest>';\n\n\treturn request;\n};\n\nSAML.prototype.generateLogoutRequest = function(options) {\n\t// options should be of the form\n\t// nameId: <nameId as submitted during SAML SSO>\n\t// sessionIndex: sessionIndex\n\t// --- NO SAMLsettings: <Meteor.setting.saml  entry for the provider you want to SLO from\n\n\tconst id = `_${ this.generateUniqueID() }`;\n\tconst instant = this.generateInstant();\n\n\tlet request = `${ '<samlp:LogoutRequest xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\" ' +\n\t\t'xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\" ID=\"' }${ id }\" Version=\"2.0\" IssueInstant=\"${ instant\n\t}\" Destination=\"${ this.options.idpSLORedirectURL }\">` +\n\t\t`<saml:Issuer xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\">${ this.options.issuer }</saml:Issuer>` +\n\t\t`<saml:NameID Format=\"${ this.options.identifierFormat }\">${ options.nameID }</saml:NameID>` +\n\t\t'</samlp:LogoutRequest>';\n\n\trequest = `${ '<samlp:LogoutRequest xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\"  ' +\n\t\t'ID=\"' }${ id }\" ` +\n\t\t'Version=\"2.0\" ' +\n\t\t`IssueInstant=\"${ instant }\" ` +\n\t\t`Destination=\"${ this.options.idpSLORedirectURL }\" ` +\n\t\t'>' +\n\t\t`<saml:Issuer xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\">${ this.options.issuer }</saml:Issuer>` +\n\t\t'<saml:NameID xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\" ' +\n\t\t'NameQualifier=\"http://id.init8.net:8080/openam\" ' +\n\t\t`SPNameQualifier=\"${ this.options.issuer }\" ` +\n\t\t`Format=\"${ this.options.identifierFormat }\">${\n\t\t\toptions.nameID }</saml:NameID>` +\n\t\t`<samlp:SessionIndex xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\">${ options.sessionIndex }</samlp:SessionIndex>` +\n\t\t'</samlp:LogoutRequest>';\n\tif (Meteor.settings.debug) {\n\t\tconsole.log('------- SAML Logout request -----------');\n\t\tconsole.log(request);\n\t}\n\treturn {\n\t\trequest,\n\t\tid\n\t};\n};\n\nSAML.prototype.requestToUrl = function(request, operation, callback) {\n\tconst self = this;\n\tzlib.deflateRaw(request, function(err, buffer) {\n\t\tif (err) {\n\t\t\treturn callback(err);\n\t\t}\n\n\t\tconst base64 = buffer.toString('base64');\n\t\tlet target = self.options.entryPoint;\n\n\t\tif (operation === 'logout') {\n\t\t\tif (self.options.idpSLORedirectURL) {\n\t\t\t\ttarget = self.options.idpSLORedirectURL;\n\t\t\t}\n\t\t}\n\n\t\tif (target.indexOf('?') > 0) {\n\t\t\ttarget += '&';\n\t\t} else {\n\t\t\ttarget += '?';\n\t\t}\n\n\t\t// TBD. We should really include a proper RelayState here\n\t\tlet relayState;\n\t\tif (operation === 'logout') {\n\t\t\t// in case of logout we want to be redirected back to the Meteor app.\n\t\t\trelayState = Meteor.absoluteUrl();\n\t\t} else {\n\t\t\trelayState = self.options.provider;\n\t\t}\n\n\t\tconst samlRequest = {\n\t\t\tSAMLRequest: base64,\n\t\t\tRelayState: relayState\n\t\t};\n\n\t\tif (self.options.privateCert) {\n\t\t\tsamlRequest.SigAlg = 'http://www.w3.org/2000/09/xmldsig#rsa-sha1';\n\t\t\tsamlRequest.Signature = self.signRequest(querystring.stringify(samlRequest));\n\t\t}\n\n\t\ttarget += querystring.stringify(samlRequest);\n\n\t\tif (Meteor.settings.debug) {\n\t\t\tconsole.log(`requestToUrl: ${ target }`);\n\t\t}\n\t\tif (operation === 'logout') {\n\t\t\t// in case of logout we want to be redirected back to the Meteor app.\n\t\t\treturn callback(null, target);\n\n\t\t} else {\n\t\t\tcallback(null, target);\n\t\t}\n\t});\n};\n\nSAML.prototype.getAuthorizeUrl = function(req, callback) {\n\tconst request = this.generateAuthorizeRequest(req);\n\n\tthis.requestToUrl(request, 'authorize', callback);\n};\n\nSAML.prototype.getLogoutUrl = function(req, callback) {\n\tconst request = this.generateLogoutRequest(req);\n\n\tthis.requestToUrl(request, 'logout', callback);\n};\n\nSAML.prototype.certToPEM = function(cert) {\n\tcert = cert.match(/.{1,64}/g).join('\\n');\n\tcert = `-----BEGIN CERTIFICATE-----\\n${ cert }`;\n\tcert = `${ cert }\\n-----END CERTIFICATE-----\\n`;\n\treturn cert;\n};\n\n// functionfindChilds(node, localName, namespace) {\n// \tvar res = [];\n// \tfor (var i = 0; i < node.childNodes.length; i++) {\n// \t\tvar child = node.childNodes[i];\n// \t\tif (child.localName === localName && (child.namespaceURI === namespace || !namespace)) {\n// \t\t\tres.push(child);\n// \t\t}\n// \t}\n// \treturn res;\n// }\n\nSAML.prototype.validateSignature = function(xml, cert) {\n\tconst self = this;\n\n\tconst doc = new xmldom.DOMParser().parseFromString(xml);\n\tconst signature = xmlCrypto.xpath(doc, '//*[local-name(.)=\\'Signature\\' and namespace-uri(.)=\\'http://www.w3.org/2000/09/xmldsig#\\']')[0];\n\n\tconst sig = new xmlCrypto.SignedXml();\n\n\tsig.keyInfoProvider = {\n\t\tgetKeyInfo(/*key*/) {\n\t\t\treturn '<X509Data></X509Data>';\n\t\t},\n\t\tgetKey(/*keyInfo*/) {\n\t\t\treturn self.certToPEM(cert);\n\t\t}\n\t};\n\n\tsig.loadSignature(signature);\n\n\treturn sig.checkSignature(xml);\n};\n\nSAML.prototype.getElement = function(parentElement, elementName) {\n\tif (parentElement[`saml:${ elementName }`]) {\n\t\treturn parentElement[`saml:${ elementName }`];\n\t} else if (parentElement[`samlp:${ elementName }`]) {\n\t\treturn parentElement[`samlp:${ elementName }`];\n\t} else if (parentElement[`saml2p:${ elementName }`]) {\n\t\treturn parentElement[`saml2p:${ elementName }`];\n\t} else if (parentElement[`saml2:${ elementName }`]) {\n\t\treturn parentElement[`saml2:${ elementName }`];\n\t} else if (parentElement[`ns0:${ elementName }`]) {\n\t\treturn parentElement[`ns0:${ elementName }`];\n\t} else if (parentElement[`ns1:${ elementName }`]) {\n\t\treturn parentElement[`ns1:${ elementName }`];\n\t}\n\treturn parentElement[elementName];\n};\n\nSAML.prototype.validateLogoutResponse = function(samlResponse, callback) {\n\tconst self = this;\n\n\tconst compressedSAMLResponse = new Buffer(samlResponse, 'base64');\n\tzlib.inflateRaw(compressedSAMLResponse, function(err, decoded) {\n\n\t\tif (err) {\n\t\t\tif (Meteor.settings.debug) {\n\t\t\t\tconsole.log(err);\n\t\t\t}\n\t\t} else {\n\t\t\tconst parser = new xml2js.Parser({\n\t\t\t\texplicitRoot: true\n\t\t\t});\n\t\t\tparser.parseString(decoded, function(err, doc) {\n\t\t\t\tconst response = self.getElement(doc, 'LogoutResponse');\n\n\t\t\t\tif (response) {\n\t\t\t\t\t// TBD. Check if this msg corresponds to one we sent\n\t\t\t\t\tconst inResponseTo = response.$.InResponseTo;\n\t\t\t\t\tif (Meteor.settings.debug) {\n\t\t\t\t\t\tconsole.log(`In Response to: ${ inResponseTo }`);\n\t\t\t\t\t}\n\t\t\t\t\tconst status = self.getElement(response, 'Status');\n\t\t\t\t\tconst statusCode = self.getElement(status[0], 'StatusCode')[0].$.Value;\n\t\t\t\t\tif (Meteor.settings.debug) {\n\t\t\t\t\t\tconsole.log(`StatusCode: ${ JSON.stringify(statusCode) }`);\n\t\t\t\t\t}\n\t\t\t\t\tif (statusCode === 'urn:oasis:names:tc:SAML:2.0:status:Success') {\n\t\t\t\t\t\t// In case of a successful logout at IDP we return inResponseTo value.\n\t\t\t\t\t\t// This is the only way how we can identify the Meteor user (as we don't use Session Cookies)\n\t\t\t\t\t\tcallback(null, inResponseTo);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcallback('Error. Logout not confirmed by IDP', null);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tcallback('No Response Found', null);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t});\n};\n\nSAML.prototype.validateResponse = function(samlResponse, relayState, callback) {\n\tconst self = this;\n\tconst xml = new Buffer(samlResponse, 'base64').toString('utf8');\n\t// We currently use RelayState to save SAML provider\n\tif (Meteor.settings.debug) {\n\t\tconsole.log(`Validating response with relay state: ${ xml }`);\n\t}\n\tconst parser = new xml2js.Parser({\n\t\texplicitRoot: true,\n\t\txmlns:true\n\t});\n\n\tparser.parseString(xml, function(err, doc) {\n\t\t// Verify signature\n\t\tif (Meteor.settings.debug) {\n\t\t\tconsole.log('Verify signature');\n\t\t}\n\t\tif (self.options.cert && !self.validateSignature(xml, self.options.cert)) {\n\t\t\tif (Meteor.settings.debug) {\n\t\t\t\tconsole.log('Signature WRONG');\n\t\t\t}\n\t\t\treturn callback(new Error('Invalid signature'), null, false);\n\t\t}\n\t\tif (Meteor.settings.debug) {\n\t\t\tconsole.log('Signature OK');\n\t\t}\n\t\tconst response = self.getElement(doc, 'Response');\n\t\tif (Meteor.settings.debug) {\n\t\t\tconsole.log('Got response');\n\t\t}\n\t\tif (response) {\n\t\t\tconst assertion = self.getElement(response, 'Assertion');\n\t\t\tif (!assertion) {\n\t\t\t\treturn callback(new Error('Missing SAML assertion'), null, false);\n\t\t\t}\n\n\t\t\tconst profile = {};\n\n\t\t\tif (response.$ && response.$.InResponseTo) {\n\t\t\t\tprofile.inResponseToId = response.$.InResponseTo;\n\t\t\t}\n\n\t\t\tconst issuer = self.getElement(assertion[0], 'Issuer');\n\t\t\tif (issuer) {\n\t\t\t\tprofile.issuer = issuer[0]._;\n\t\t\t}\n\n\t\t\tconst subject = self.getElement(assertion[0], 'Subject');\n\n\t\t\tif (subject) {\n\t\t\t\tconst nameID = self.getElement(subject[0], 'NameID');\n\t\t\t\tif (nameID) {\n\t\t\t\t\tprofile.nameID = nameID[0]._;\n\n\t\t\t\t\tif (nameID[0].$.Format) {\n\t\t\t\t\t\tprofile.nameIDFormat = nameID[0].$.Format;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst authnStatement = self.getElement(assertion[0], 'AuthnStatement');\n\n\t\t\tif (authnStatement) {\n\t\t\t\tif (authnStatement[0].$.SessionIndex) {\n\n\t\t\t\t\tprofile.sessionIndex = authnStatement[0].$.SessionIndex;\n\t\t\t\t\tif (Meteor.settings.debug) {\n\t\t\t\t\t\tconsole.log(`Session Index: ${ profile.sessionIndex }`);\n\t\t\t\t\t}\n\t\t\t\t} else if (Meteor.settings.debug) {\n\t\t\t\t\tconsole.log('No Session Index Found');\n\t\t\t\t}\n\n\n\t\t\t} else if (Meteor.settings.debug) {\n\t\t\t\tconsole.log('No AuthN Statement found');\n\t\t\t}\n\n\t\t\tconst attributeStatement = self.getElement(assertion[0], 'AttributeStatement');\n\t\t\tif (attributeStatement) {\n\t\t\t\tconst attributes = self.getElement(attributeStatement[0], 'Attribute');\n\n\t\t\t\tif (attributes) {\n\t\t\t\t\tattributes.forEach(function(attribute) {\n\t\t\t\t\t\tconst value = self.getElement(attribute, 'AttributeValue');\n\t\t\t\t\t\tif (typeof value[0] === 'string') {\n\t\t\t\t\t\t\tprofile[attribute.$.Name] = value[0];\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tprofile[attribute.$.Name] = value[0]._;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (!profile.mail && profile['urn:oid:0.9.2342.19200300.100.1.3']) {\n\t\t\t\t\t// See http://www.incommonfederation.org/attributesummary.html for definition of attribute OIDs\n\t\t\t\t\tprofile.mail = profile['urn:oid:0.9.2342.19200300.100.1.3'];\n\t\t\t\t}\n\n\t\t\t\tif (!profile.email && profile.mail) {\n\t\t\t\t\tprofile.email = profile.mail;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!profile.email && profile.nameID && profile.nameIDFormat && profile.nameIDFormat.indexOf('emailAddress') >= 0) {\n\t\t\t\tprofile.email = profile.nameID;\n\t\t\t}\n\t\t\tif (Meteor.settings.debug) {\n\t\t\t\tconsole.log(`NameID: ${ JSON.stringify(profile) }`);\n\t\t\t}\n\n\t\t\tcallback(null, profile, false);\n\t\t} else {\n\t\t\tconst logoutResponse = self.getElement(doc, 'LogoutResponse');\n\n\t\t\tif (logoutResponse) {\n\t\t\t\tcallback(null, null, true);\n\t\t\t} else {\n\t\t\t\treturn callback(new Error('Unknown SAML response message'), null, false);\n\t\t\t}\n\n\t\t}\n\t});\n};\n\nlet decryptionCert;\nSAML.prototype.generateServiceProviderMetadata = function(callbackUrl) {\n\n\tif (!decryptionCert) {\n\t\tdecryptionCert = this.options.privateCert;\n\t}\n\n\tif (!this.options.callbackUrl && !callbackUrl) {\n\t\tthrow new Error(\n\t\t\t'Unable to generate service provider metadata when callbackUrl option is not set');\n\t}\n\n\tconst metadata = {\n\t\t'EntityDescriptor': {\n\t\t\t'@xmlns': 'urn:oasis:names:tc:SAML:2.0:metadata',\n\t\t\t'@xmlns:ds': 'http://www.w3.org/2000/09/xmldsig#',\n\t\t\t'@entityID': this.options.issuer,\n\t\t\t'SPSSODescriptor': {\n\t\t\t\t'@protocolSupportEnumeration': 'urn:oasis:names:tc:SAML:2.0:protocol',\n\t\t\t\t'SingleLogoutService': {\n\t\t\t\t\t'@Binding': 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect',\n\t\t\t\t\t'@Location': `${ Meteor.absoluteUrl() }_saml/logout/${ this.options.provider }/`,\n\t\t\t\t\t'@ResponseLocation': `${ Meteor.absoluteUrl() }_saml/logout/${ this.options.provider }/`\n\t\t\t\t},\n\t\t\t\t'NameIDFormat': this.options.identifierFormat,\n\t\t\t\t'AssertionConsumerService': {\n\t\t\t\t\t'@index': '1',\n\t\t\t\t\t'@isDefault': 'true',\n\t\t\t\t\t'@Binding': 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST',\n\t\t\t\t\t'@Location': callbackUrl\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\n\tif (this.options.privateKey) {\n\t\tif (!decryptionCert) {\n\t\t\tthrow new Error(\n\t\t\t\t'Missing decryptionCert while generating metadata for decrypting service provider');\n\t\t}\n\n\t\tdecryptionCert = decryptionCert.replace(/-+BEGIN CERTIFICATE-+\\r?\\n?/, '');\n\t\tdecryptionCert = decryptionCert.replace(/-+END CERTIFICATE-+\\r?\\n?/, '');\n\t\tdecryptionCert = decryptionCert.replace(/\\r\\n/g, '\\n');\n\n\t\tmetadata['EntityDescriptor']['SPSSODescriptor']['KeyDescriptor'] = {\n\t\t\t'ds:KeyInfo': {\n\t\t\t\t'ds:X509Data': {\n\t\t\t\t\t'ds:X509Certificate': {\n\t\t\t\t\t\t'#text': decryptionCert\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t'#list': [\n\t\t\t\t// this should be the set that the xmlenc library supports\n\t\t\t\t{\n\t\t\t\t\t'EncryptionMethod': {\n\t\t\t\t\t\t'@Algorithm': 'http://www.w3.org/2001/04/xmlenc#aes256-cbc'\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t'EncryptionMethod': {\n\t\t\t\t\t\t'@Algorithm': 'http://www.w3.org/2001/04/xmlenc#aes128-cbc'\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t'EncryptionMethod': {\n\t\t\t\t\t\t'@Algorithm': 'http://www.w3.org/2001/04/xmlenc#tripledes-cbc'\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t]\n\t\t};\n\t}\n\n\treturn xmlbuilder.create(metadata).end({\n\t\tpretty: true,\n\t\tindent: '  ',\n\t\tnewline: '\\n'\n\t});\n};\n","const logger = new Logger('steffo:meteor-accounts-saml', {\n\tmethods: {\n\t\tupdated: {\n\t\t\ttype: 'info'\n\t\t}\n\t}\n});\n\nRocketChat.settings.addGroup('SAML');\n\nMeteor.methods({\n\taddSamlService(name) {\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }`, false, {\n\t\t\ttype: 'boolean',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'Accounts_OAuth_Custom_Enable'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_provider`, 'provider-name', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'SAML_Custom_Provider'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_entry_point`, 'https://example.com/simplesaml/saml2/idp/SSOService.php', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'SAML_Custom_Entry_point'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_idp_slo_redirect_url`, 'https://example.com/simplesaml/saml2/idp/SingleLogoutService.php', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'SAML_Custom_IDP_SLO_Redirect_URL'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_issuer`, 'https://your-rocket-chat/_saml/metadata/provider-name', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'SAML_Custom_Issuer'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_cert`, '', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'SAML_Custom_Cert',\n\t\t\tmultiline: true\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_public_cert`, '', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\tmultiline: true,\n\t\t\ti18nLabel: 'SAML_Custom_Public_Cert'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_private_key`, '', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\tmultiline: true,\n\t\t\ti18nLabel: 'SAML_Custom_Private_Key'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_button_label_text`, '', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'Accounts_OAuth_Custom_Button_Label_Text'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_button_label_color`, '#FFFFFF', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'Accounts_OAuth_Custom_Button_Label_Color'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_button_color`, '#13679A', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'Accounts_OAuth_Custom_Button_Color'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_generate_username`, false, {\n\t\t\ttype: 'boolean',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'SAML_Custom_Generate_Username'\n\t\t});\n\t}\n});\n\nconst getSamlConfigs = function(service) {\n\treturn {\n\t\tbuttonLabelText: RocketChat.settings.get(`${ service.key }_button_label_text`),\n\t\tbuttonLabelColor: RocketChat.settings.get(`${ service.key }_button_label_color`),\n\t\tbuttonColor: RocketChat.settings.get(`${ service.key }_button_color`),\n\t\tclientConfig: {\n\t\t\tprovider: RocketChat.settings.get(`${ service.key }_provider`)\n\t\t},\n\t\tentryPoint: RocketChat.settings.get(`${ service.key }_entry_point`),\n\t\tidpSLORedirectURL: RocketChat.settings.get(`${ service.key }_idp_slo_redirect_url`),\n\t\tgenerateUsername: RocketChat.settings.get(`${ service.key }_generate_username`),\n\t\tissuer: RocketChat.settings.get(`${ service.key }_issuer`),\n\t\tsecret: {\n\t\t\tprivateKey: RocketChat.settings.get(`${ service.key }_private_key`),\n\t\t\tpublicCert: RocketChat.settings.get(`${ service.key }_public_cert`),\n\t\t\tcert: RocketChat.settings.get(`${ service.key }_cert`)\n\t\t}\n\t};\n};\n\nconst debounce = (fn, delay) => {\n\tlet timer = null;\n\treturn () => {\n\t\tif (timer != null) {\n\t\t\tMeteor.clearTimeout(timer);\n\t\t}\n\t\treturn timer = Meteor.setTimeout(fn, delay);\n\t};\n};\nconst serviceName = 'saml';\n\nconst configureSamlService = function(samlConfigs) {\n\tlet privateCert = false;\n\tlet privateKey = false;\n\tif (samlConfigs.secret.privateKey && samlConfigs.secret.publicCert) {\n\t\tprivateKey = samlConfigs.secret.privateKey;\n\t\tprivateCert = samlConfigs.secret.publicCert;\n\t} else if (samlConfigs.secret.privateKey || samlConfigs.secret.publicCert) {\n\t\tlogger.error('You must specify both cert and key files.');\n\t}\n\t// TODO: the function configureSamlService is called many times and Accounts.saml.settings.generateUsername keeps just the last value\n\tAccounts.saml.settings.generateUsername = samlConfigs.generateUsername;\n\treturn {\n\t\tprovider: samlConfigs.clientConfig.provider,\n\t\tentryPoint: samlConfigs.entryPoint,\n\t\tidpSLORedirectURL: samlConfigs.idpSLORedirectURL,\n\t\tissuer: samlConfigs.issuer,\n\t\tcert: samlConfigs.secret.cert,\n\t\tprivateCert,\n\t\tprivateKey\n\t};\n};\n\nconst updateServices = debounce(() => {\n\tconst services = RocketChat.settings.get(/^(SAML_Custom_)[a-z]+$/i);\n\tAccounts.saml.settings.providers = services.map((service) => {\n\t\tif (service.value === true) {\n\t\t\tconst samlConfigs = getSamlConfigs(service);\n\t\t\tlogger.updated(service.key);\n\t\t\tServiceConfiguration.configurations.upsert({\n\t\t\t\tservice: serviceName.toLowerCase()\n\t\t\t}, {\n\t\t\t\t$set: samlConfigs\n\t\t\t});\n\t\t\treturn configureSamlService(samlConfigs);\n\t\t} else {\n\t\t\tServiceConfiguration.configurations.remove({\n\t\t\t\tservice: serviceName.toLowerCase()\n\t\t\t});\n\t\t}\n\t}).filter(e => e);\n}, 2000);\n\n\nRocketChat.settings.get(/^SAML_.+/, updateServices);\n\nMeteor.startup(() => {\n\treturn Meteor.call('addSamlService', 'Default');\n});\n\nexport {\n\tupdateServices,\n\tconfigureSamlService,\n\tgetSamlConfigs,\n\tdebounce,\n\tlogger\n};\n"]}