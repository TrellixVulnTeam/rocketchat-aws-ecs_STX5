{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:file/file.server.js"],"names":["Grid","module","watch","require","default","v","stream","fs","path","mkdirp","gm","exec","prototype","tryParseObjectId","RocketChatFile","enabled","undefined","enable","RocketChat","settings","updateOptionsById","alert","disable","detectGM","Meteor","bindEnvironment","error","stdout","indexOf","Info","GraphicsMagick","version","subClass","imageMagick","ImageMagick","methods","bufferToStream","buffer","bufferStream","PassThrough","end","dataURIParse","dataURI","imageData","split","image","contentType","replace","addPassThrough","st","fn","pass","GridFS","constructor","config","name","transformWrite","mongo","Package","MongoInternals","NpmModule","db","defaultRemoteCollectionDriver","store","findOneSync","wrapAsync","collection","findOne","bind","removeSync","remove","countSync","_col","count","getFileSync","getFile","fileName","_id","root","createWriteStream","self","ws","filename","mode","content_type","rs","file","on","emit","createReadStream","getFileWithReadStream","readStream","length","uploadDate","cb","data","chunk","push","Buffer","concat","deleteFile","FileSystem","absolutePath","sep","homepath","process","env","HOME","HOMEPATH","USERPROFILE","Error","resolve","sync","statSync","stat","unlinkSync","unlink","join","size","error1"],"mappings":"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","file":"/packages/rocketchat_file.js","sourcesContent":["import Grid from 'gridfs-stream';\nimport stream from 'stream';\nimport fs from 'fs';\nimport path from 'path';\nimport mkdirp from 'mkdirp';\nimport gm from 'gm';\nimport {exec} from 'child_process';\n\n// Fix problem with usernames being converted to object id\nGrid.prototype.tryParseObjectId = function() {\n\treturn false;\n};\n//TODO: REMOVE RocketChatFile from globals\nRocketChatFile = {\n\tgm,\n\tenabled: undefined,\n\tenable() {\n\t\tRocketChatFile.enabled = true;\n\t\treturn RocketChat.settings.updateOptionsById('Accounts_AvatarResize', {\n\t\t\talert: undefined\n\t\t});\n\t},\n\tdisable() {\n\t\tRocketChatFile.enabled = false;\n\t\treturn RocketChat.settings.updateOptionsById('Accounts_AvatarResize', {\n\t\t\talert: 'The_image_resize_will_not_work_because_we_can_not_detect_ImageMagick_or_GraphicsMagick_installed_in_your_server'\n\t\t});\n\t}\n};\n\nconst detectGM = function() {\n\treturn exec('gm version', Meteor.bindEnvironment(function(error, stdout) {\n\t\tif ((error == null) && stdout.indexOf('GraphicsMagick') > -1) {\n\t\t\tRocketChatFile.enable();\n\t\t\tRocketChat.Info.GraphicsMagick = {\n\t\t\t\tenabled: true,\n\t\t\t\tversion: stdout\n\t\t\t};\n\t\t} else {\n\t\t\tRocketChat.Info.GraphicsMagick = {\n\t\t\t\tenabled: false\n\t\t\t};\n\t\t}\n\t\treturn exec('convert -version', Meteor.bindEnvironment(function(error, stdout) {\n\t\t\tif ((error == null) && stdout.indexOf('ImageMagick') > -1) {\n\t\t\t\tif (RocketChatFile.enabled !== true) {\n\t\t\t\t\t// Enable GM to work with ImageMagick if no GraphicsMagick\n\t\t\t\t\tRocketChatFile.gm = RocketChatFile.gm.subClass({\n\t\t\t\t\t\timageMagick: true\n\t\t\t\t\t});\n\t\t\t\t\tRocketChatFile.enable();\n\t\t\t\t}\n\t\t\t\treturn RocketChat.Info.ImageMagick = {\n\t\t\t\t\tenabled: true,\n\t\t\t\t\tversion: stdout\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\tif (RocketChatFile.enabled !== true) {\n\t\t\t\t\tRocketChatFile.disable();\n\t\t\t\t}\n\t\t\t\treturn RocketChat.Info.ImageMagick = {\n\t\t\t\t\tenabled: false\n\t\t\t\t};\n\t\t\t}\n\t\t}));\n\t}));\n};\n\ndetectGM();\n\nMeteor.methods({\n\t'detectGM'() {\n\t\tdetectGM();\n\t}\n});\n\nRocketChatFile.bufferToStream = function(buffer) {\n\tconst bufferStream = new stream.PassThrough();\n\tbufferStream.end(buffer);\n\treturn bufferStream;\n};\n\nRocketChatFile.dataURIParse = function(dataURI) {\n\tconst imageData = dataURI.split(';base64,');\n\treturn {\n\t\timage: imageData[1],\n\t\tcontentType: imageData[0].replace('data:', '')\n\t};\n};\n\nRocketChatFile.addPassThrough = function(st, fn) {\n\tconst pass = new stream.PassThrough();\n\tfn(pass, st);\n\treturn pass;\n};\n\nRocketChatFile.GridFS = class {\n\tconstructor(config = {}) {\n\t\tconst {name = 'file', transformWrite} = config;\n\n\t\tthis.name = name;\n\t\tthis.transformWrite = transformWrite;\n\t\tconst mongo = Package.mongo.MongoInternals.NpmModule;\n\t\tconst db = Package.mongo.MongoInternals.defaultRemoteCollectionDriver().mongo.db;\n\t\tthis.store = new Grid(db, mongo);\n\t\tthis.findOneSync = Meteor.wrapAsync(this.store.collection(this.name).findOne.bind(this.store.collection(this.name)));\n\t\tthis.removeSync = Meteor.wrapAsync(this.store.remove.bind(this.store));\n\t\tthis.countSync = Meteor.wrapAsync(this.store._col.count.bind(this.store._col));\n\t\tthis.getFileSync = Meteor.wrapAsync(this.getFile.bind(this));\n\t}\n\n\tfindOne(fileName) {\n\t\treturn this.findOneSync({\n\t\t\t_id: fileName\n\t\t});\n\t}\n\n\tremove(fileName) {\n\t\treturn this.removeSync({\n\t\t\t_id: fileName,\n\t\t\troot: this.name\n\t\t});\n\t}\n\n\tcreateWriteStream(fileName, contentType) {\n\t\tconst self = this;\n\t\tlet ws = this.store.createWriteStream({\n\t\t\t_id: fileName,\n\t\t\tfilename: fileName,\n\t\t\tmode: 'w',\n\t\t\troot: this.name,\n\t\t\tcontent_type: contentType\n\t\t});\n\t\tif (self.transformWrite != null) {\n\t\t\tws = RocketChatFile.addPassThrough(ws, function(rs, ws) {\n\t\t\t\tconst file = {\n\t\t\t\t\tname: self.name,\n\t\t\t\t\tfileName,\n\t\t\t\t\tcontentType\n\t\t\t\t};\n\t\t\t\treturn self.transformWrite(file, rs, ws);\n\t\t\t});\n\t\t}\n\t\tws.on('close', function() {\n\t\t\treturn ws.emit('end');\n\t\t});\n\t\treturn ws;\n\t}\n\n\tcreateReadStream(fileName) {\n\t\treturn this.store.createReadStream({\n\t\t\t_id: fileName,\n\t\t\troot: this.name\n\t\t});\n\t}\n\n\tgetFileWithReadStream(fileName) {\n\t\tconst file = this.findOne(fileName);\n\t\tif (file == null) {\n\t\t\treturn null;\n\t\t}\n\t\tconst rs = this.createReadStream(fileName);\n\t\treturn {\n\t\t\treadStream: rs,\n\t\t\tcontentType: file.contentType,\n\t\t\tlength: file.length,\n\t\t\tuploadDate: file.uploadDate\n\t\t};\n\t}\n\n\tgetFile(fileName, cb) {\n\t\tconst file = this.getFileWithReadStream(fileName);\n\t\tif (!file) {\n\t\t\treturn cb();\n\t\t}\n\t\tconst data = [];\n\t\tfile.readStream.on('data', Meteor.bindEnvironment(function(chunk) {\n\t\t\treturn data.push(chunk);\n\t\t}));\n\t\treturn file.readStream.on('end', Meteor.bindEnvironment(function() {\n\t\t\treturn cb(null, {\n\t\t\t\tbuffer: Buffer.concat(data),\n\t\t\t\tcontentType: file.contentType,\n\t\t\t\tlength: file.length,\n\t\t\t\tuploadDate: file.uploadDate\n\t\t\t});\n\t\t}));\n\t}\n\n\tdeleteFile(fileName) {\n\t\tconst file = this.findOne(fileName);\n\t\tif (file == null) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn this.remove(fileName);\n\t}\n\n\n};\n\nRocketChatFile.FileSystem = class {\n\tconstructor(config = {}) {\n\t\tlet {absolutePath = '~/uploads'} = config;\n\t\tconst {transformWrite} = config;\n\n\t\tthis.transformWrite = transformWrite;\n\t\tif (absolutePath.split(path.sep)[0] === '~') {\n\t\t\tconst homepath = process.env.HOME || process.env.HOMEPATH || process.env.USERPROFILE;\n\t\t\tif (homepath != null) {\n\t\t\t\tabsolutePath = absolutePath.replace('~', homepath);\n\t\t\t} else {\n\t\t\t\tthrow new Error('Unable to resolve \"~\" in path');\n\t\t\t}\n\t\t}\n\t\tthis.absolutePath = path.resolve(absolutePath);\n\t\tmkdirp.sync(this.absolutePath);\n\t\tthis.statSync = Meteor.wrapAsync(fs.stat.bind(fs));\n\t\tthis.unlinkSync = Meteor.wrapAsync(fs.unlink.bind(fs));\n\t\tthis.getFileSync = Meteor.wrapAsync(this.getFile.bind(this));\n\t}\n\n\tcreateWriteStream(fileName, contentType) {\n\t\tconst self = this;\n\t\tlet ws = fs.createWriteStream(path.join(this.absolutePath, fileName));\n\t\tif (self.transformWrite != null) {\n\t\t\tws = RocketChatFile.addPassThrough(ws, function(rs, ws) {\n\t\t\t\tconst file = {\n\t\t\t\t\tfileName,\n\t\t\t\t\tcontentType\n\t\t\t\t};\n\t\t\t\treturn self.transformWrite(file, rs, ws);\n\t\t\t});\n\t\t}\n\t\tws.on('close', function() {\n\t\t\treturn ws.emit('end');\n\t\t});\n\t\treturn ws;\n\t}\n\n\tcreateReadStream(fileName) {\n\t\treturn fs.createReadStream(path.join(this.absolutePath, fileName));\n\t}\n\n\tstat(fileName) {\n\t\treturn this.statSync(path.join(this.absolutePath, fileName));\n\t}\n\n\tremove(fileName) {\n\t\treturn this.unlinkSync(path.join(this.absolutePath, fileName));\n\t}\n\n\tgetFileWithReadStream(fileName) {\n\t\ttry {\n\t\t\tconst stat = this.stat(fileName);\n\t\t\tconst rs = this.createReadStream(fileName);\n\t\t\treturn {\n\t\t\t\treadStream: rs,\n\t\t\t\t// contentType: file.contentType\n\t\t\t\tlength: stat.size\n\t\t\t};\n\t\t} catch (error1) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tgetFile(fileName, cb) {\n\t\tconst file = this.getFileWithReadStream(fileName);\n\t\tif (!file) {\n\t\t\treturn cb();\n\t\t}\n\t\tconst data = [];\n\t\tfile.readStream.on('data', Meteor.bindEnvironment(function(chunk) {\n\t\t\treturn data.push(chunk);\n\t\t}));\n\t\treturn file.readStream.on('end', Meteor.bindEnvironment(function() {\n\t\t\treturn {\n\t\t\t\tbuffer: Buffer.concat(data)({\n\t\t\t\t\tcontentType: file.contentType,\n\t\t\t\t\tlength: file.length,\n\t\t\t\t\tuploadDate: file.uploadDate\n\t\t\t\t})\n\t\t\t};\n\t\t}));\n\t}\n\n\tdeleteFile(fileName) {\n\t\ttry {\n\t\t\treturn this.remove(fileName);\n\t\t} catch (error1) {\n\t\t\treturn null;\n\t\t}\n\t}\n};\n"]}