{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:emoji-custom/function-isSet.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/startup/emoji-custom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/models/EmojiCustom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/publications/fullEmojiData.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/listEmojiCustom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/deleteEmojiCustom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/insertOrUpdateEmoji.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/uploadEmojiCustom.js"],"names":["isSet","fn","value","e","undefined","isSetNotNull","_","module","watch","require","default","v","Meteor","startup","storeType","RocketChat","settings","get","RocketChatStore","RocketChatFile","Error","console","log","green","path","trim","RocketChatFileEmojiCustomInstance","name","absolutePath","WebApp","connectHandlers","use","bindEnvironment","req","res","params","emoji","decodeURIComponent","url","replace","isEmpty","writeHead","write","end","file","getFileWithReadStream","encodeURIComponent","setHeader","reqModifiedHeader","headers","color","initials","svg","fileUploadDate","uploadDate","toUTCString","Date","test","split","pop","length","readStream","pipe","addGroup","add","type","values","key","i18nLabel","enableQuery","_id","EmojiCustom","models","_Base","constructor","tryEnsureIndex","findOneByID","options","findOne","findByNameOrAlias","query","$or","aliases","find","findByNameOrAliasExceptID","except","$nin","setName","update","$set","setAliases","setExtension","extension","create","data","insert","removeByID","remove","s","publish","filter","limit","userId","ready","fields","sort","filterReg","RegExp","escapeRegExp","methods","listEmojiCustom","fetch","deleteEmojiCustom","emojiID","authz","hasPermission","method","deleteFile","Notifications","notifyLogged","emojiData","insertOrUpdateEmoji","field","nameValidation","aliasValidation","input","Boolean","without","matchingResults","alias","concat","createEmoji","newFile","previousExtension","previousName","rs","ws","createWriteStream","contentType","on","uploadEmojiCustom","binaryContent","Buffer","bufferToStream","setTimeout"],"mappings":"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","file":"/packages/rocketchat_emoji-custom.js","sourcesContent":["/* globals isSet:true, isSetNotNull:true */\n//http://stackoverflow.com/a/26990347 function isSet() from Gajus\nisSet = function(fn) {\n\tlet value;\n\ttry {\n\t\tvalue = fn();\n\t} catch (e) {\n\t\tvalue = undefined;\n\t} finally {\n\t\treturn value !== undefined;\n\t}\n};\n\nisSetNotNull = function(fn) {\n\tlet value;\n\ttry {\n\t\tvalue = fn();\n\t} catch (e) {\n\t\tvalue = null;\n\t} finally {\n\t\treturn value !== null && value !== undefined;\n\t}\n};\n\n/* exported isSet, isSetNotNull */\n","/* globals RocketChatFileEmojiCustomInstance */\nimport _ from 'underscore';\n\nMeteor.startup(function() {\n\tlet storeType = 'GridFS';\n\n\tif (RocketChat.settings.get('EmojiUpload_Storage_Type')) {\n\t\tstoreType = RocketChat.settings.get('EmojiUpload_Storage_Type');\n\t}\n\n\tconst RocketChatStore = RocketChatFile[storeType];\n\n\tif (RocketChatStore == null) {\n\t\tthrow new Error(`Invalid RocketChatStore type [${ storeType }]`);\n\t}\n\n\tconsole.log(`Using ${ storeType } for custom emoji storage`.green);\n\n\tlet path = '~/uploads';\n\tif (RocketChat.settings.get('EmojiUpload_FileSystemPath') != null) {\n\t\tif (RocketChat.settings.get('EmojiUpload_FileSystemPath').trim() !== '') {\n\t\t\tpath = RocketChat.settings.get('EmojiUpload_FileSystemPath');\n\t\t}\n\t}\n\n\tthis.RocketChatFileEmojiCustomInstance = new RocketChatStore({\n\t\tname: 'custom_emoji',\n\t\tabsolutePath: path\n\t});\n\n\treturn WebApp.connectHandlers.use('/emoji-custom/', Meteor.bindEnvironment(function(req, res/*, next*/) {\n\t\tconst params =\n\t\t\t{emoji: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, ''))};\n\n\t\tif (_.isEmpty(params.emoji)) {\n\t\t\tres.writeHead(403);\n\t\t\tres.write('Forbidden');\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tconst file = RocketChatFileEmojiCustomInstance.getFileWithReadStream(encodeURIComponent(params.emoji));\n\n\t\tres.setHeader('Content-Disposition', 'inline');\n\n\t\tif (file == null) {\n\t\t\t//use code from username initials renderer until file upload is complete\n\t\t\tres.setHeader('Content-Type', 'image/svg+xml');\n\t\t\tres.setHeader('Cache-Control', 'public, max-age=0');\n\t\t\tres.setHeader('Expires', '-1');\n\t\t\tres.setHeader('Last-Modified', 'Thu, 01 Jan 2015 00:00:00 GMT');\n\n\t\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\t\tif (reqModifiedHeader != null) {\n\t\t\t\tif (reqModifiedHeader === 'Thu, 01 Jan 2015 00:00:00 GMT') {\n\t\t\t\t\tres.writeHead(304);\n\t\t\t\t\tres.end();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst color = '#000';\n\t\t\tconst initials = '?';\n\n\t\t\tconst svg = `<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg xmlns=\"http://www.w3.org/2000/svg\" pointer-events=\"none\" width=\"50\" height=\"50\" style=\"width: 50px; height: 50px; background-color: ${ color };\">\n\t<text text-anchor=\"middle\" y=\"50%\" x=\"50%\" dy=\"0.36em\" pointer-events=\"auto\" fill=\"#ffffff\" font-family=\"Helvetica, Arial, Lucida Grande, sans-serif\" style=\"font-weight: 400; font-size: 28px;\">\n\t\t${ initials }\n\t</text>\n</svg>`;\n\n\t\t\tres.write(svg);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tlet fileUploadDate = undefined;\n\t\tif (file.uploadDate != null) {\n\t\t\tfileUploadDate = file.uploadDate.toUTCString();\n\t\t}\n\n\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\tif (reqModifiedHeader != null) {\n\t\t\tif (reqModifiedHeader === fileUploadDate) {\n\t\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\t\tres.writeHead(304);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tres.setHeader('Cache-Control', 'public, max-age=0');\n\t\tres.setHeader('Expires', '-1');\n\t\tif (fileUploadDate != null) {\n\t\t\tres.setHeader('Last-Modified', fileUploadDate);\n\t\t} else {\n\t\t\tres.setHeader('Last-Modified', new Date().toUTCString());\n\t\t}\n\t\tif (/^svg$/i.test(params.emoji.split('.').pop())) {\n\t\t\tres.setHeader('Content-Type', 'image/svg+xml');\n\t\t} else {\n\t\t\tres.setHeader('Content-Type', 'image/jpeg');\n\t\t}\n\t\tres.setHeader('Content-Length', file.length);\n\n\t\tfile.readStream.pipe(res);\n\t}));\n});\n","RocketChat.settings.addGroup('EmojiCustomFilesystem', function() {\n\tthis.add('EmojiUpload_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS'\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem'\n\t\t}],\n\t\ti18nLabel: 'FileUpload_Storage_Type'\n\t});\n\n\tthis.add('EmojiUpload_FileSystemPath', '', {\n\t\ttype: 'string',\n\t\tenableQuery: {\n\t\t\t_id: 'EmojiUpload_Storage_Type',\n\t\t\tvalue: 'FileSystem'\n\t\t},\n\t\ti18nLabel: 'FileUpload_FileSystemPath'\n\t});\n});\n","class EmojiCustom extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('custom_emoji');\n\n\t\tthis.tryEnsureIndex({ 'name': 1 });\n\t\tthis.tryEnsureIndex({ 'aliases': 1 });\n\t\tthis.tryEnsureIndex({ 'extension': 1});\n\t}\n\n\t//find one\n\tfindOneByID(_id, options) {\n\t\treturn this.findOne(_id, options);\n\t}\n\n\t//find\n\tfindByNameOrAlias(name, options) {\n\t\tconst query = {\n\t\t\t$or: [\n\t\t\t\t{name},\n\t\t\t\t{aliases: name}\n\t\t\t]\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\tfindByNameOrAliasExceptID(name, except, options) {\n\t\tconst query = {\n\t\t\t_id: { $nin: [ except ] },\n\t\t\t$or: [\n\t\t\t\t{name},\n\t\t\t\t{aliases: name}\n\t\t\t]\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\n\t//update\n\tsetName(_id, name) {\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\tname\n\t\t\t}\n\t\t};\n\n\t\treturn this.update({_id}, update);\n\t}\n\n\tsetAliases(_id, aliases) {\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\taliases\n\t\t\t}\n\t\t};\n\n\t\treturn this.update({_id}, update);\n\t}\n\n\tsetExtension(_id, extension) {\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\textension\n\t\t\t}\n\t\t};\n\n\t\treturn this.update({_id}, update);\n\t}\n\n\t// INSERT\n\tcreate(data) {\n\t\treturn this.insert(data);\n\t}\n\n\n\t// REMOVE\n\tremoveByID(_id) {\n\t\treturn this.remove(_id);\n\t}\n}\n\nRocketChat.models.EmojiCustom = new EmojiCustom();\n","import s from 'underscore.string';\n\nMeteor.publish('fullEmojiData', function(filter, limit) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tconst fields = {\n\t\tname: 1,\n\t\taliases: 1,\n\t\textension: 1\n\t};\n\n\tfilter = s.trim(filter);\n\n\tconst options = {\n\t\tfields,\n\t\tlimit,\n\t\tsort: { name: 1 }\n\t};\n\n\tif (filter) {\n\t\tconst filterReg = new RegExp(s.escapeRegExp(filter), 'i');\n\t\treturn RocketChat.models.EmojiCustom.findByNameOrAlias(filterReg, options);\n\t}\n\n\treturn RocketChat.models.EmojiCustom.find({}, options);\n});\n","Meteor.methods({\n\tlistEmojiCustom() {\n\t\treturn RocketChat.models.EmojiCustom.find({}).fetch();\n\t}\n});\n","/* globals RocketChatFileEmojiCustomInstance */\nMeteor.methods({\n\tdeleteEmojiCustom(emojiID) {\n\t\tlet emoji = null;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-emoji')) {\n\t\t\temoji = RocketChat.models.EmojiCustom.findOneByID(emojiID);\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tif (emoji == null) {\n\t\t\tthrow new Meteor.Error('Custom_Emoji_Error_Invalid_Emoji', 'Invalid emoji', { method: 'deleteEmojiCustom' });\n\t\t}\n\n\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emoji.name }.${ emoji.extension }`));\n\t\tRocketChat.models.EmojiCustom.removeByID(emojiID);\n\t\tRocketChat.Notifications.notifyLogged('deleteEmojiCustom', {emojiData: emoji});\n\n\t\treturn true;\n\t}\n});\n","/* globals RocketChatFileEmojiCustomInstance */\nimport _ from 'underscore';\nimport s from 'underscore.string';\n\nMeteor.methods({\n\tinsertOrUpdateEmoji(emojiData) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-emoji')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tif (!s.trim(emojiData.name)) {\n\t\t\tthrow new Meteor.Error('error-the-field-is-required', 'The field Name is required', { method: 'insertOrUpdateEmoji', field: 'Name' });\n\t\t}\n\n\t\t//allow all characters except colon, whitespace, comma, >, <, &, \", ', /, \\, (, )\n\t\t//more practical than allowing specific sets of characters; also allows foreign languages\n\t\tconst nameValidation = /[\\s,:><&\"'\\/\\\\\\(\\)]/;\n\t\tconst aliasValidation = /[:><&\\|\"'\\/\\\\\\(\\)]/;\n\n\t\t//silently strip colon; this allows for uploading :emojiname: as emojiname\n\t\temojiData.name = emojiData.name.replace(/:/g, '');\n\t\temojiData.aliases = emojiData.aliases.replace(/:/g, '');\n\n\t\tif (nameValidation.test(emojiData.name)) {\n\t\t\tthrow new Meteor.Error('error-input-is-not-a-valid-field', `${ emojiData.name } is not a valid name`, { method: 'insertOrUpdateEmoji', input: emojiData.name, field: 'Name' });\n\t\t}\n\n\t\tif (emojiData.aliases) {\n\t\t\tif (aliasValidation.test(emojiData.aliases)) {\n\t\t\t\tthrow new Meteor.Error('error-input-is-not-a-valid-field', `${ emojiData.aliases } is not a valid alias set`, { method: 'insertOrUpdateEmoji', input: emojiData.aliases, field: 'Alias_Set' });\n\t\t\t}\n\t\t\temojiData.aliases = emojiData.aliases.split(/[\\s,]/);\n\t\t\temojiData.aliases = emojiData.aliases.filter(Boolean);\n\t\t\temojiData.aliases = _.without(emojiData.aliases, emojiData.name);\n\t\t} else {\n\t\t\temojiData.aliases = [];\n\t\t}\n\n\t\tlet matchingResults = [];\n\n\t\tif (emojiData._id) {\n\t\t\tmatchingResults = RocketChat.models.EmojiCustom.findByNameOrAliasExceptID(emojiData.name, emojiData._id).fetch();\n\t\t\tfor (const alias of emojiData.aliases) {\n\t\t\t\tmatchingResults = matchingResults.concat(RocketChat.models.EmojiCustom.findByNameOrAliasExceptID(alias, emojiData._id).fetch());\n\t\t\t}\n\t\t} else {\n\t\t\tmatchingResults = RocketChat.models.EmojiCustom.findByNameOrAlias(emojiData.name).fetch();\n\t\t\tfor (const alias of emojiData.aliases) {\n\t\t\t\tmatchingResults = matchingResults.concat(RocketChat.models.EmojiCustom.findByNameOrAlias(alias).fetch());\n\t\t\t}\n\t\t}\n\n\t\tif (matchingResults.length > 0) {\n\t\t\tthrow new Meteor.Error('Custom_Emoji_Error_Name_Or_Alias_Already_In_Use', 'The custom emoji or one of its aliases is already in use', { method: 'insertOrUpdateEmoji' });\n\t\t}\n\n\t\tif (!emojiData._id) {\n\t\t\t//insert emoji\n\t\t\tconst createEmoji = {\n\t\t\t\tname: emojiData.name,\n\t\t\t\taliases: emojiData.aliases,\n\t\t\t\textension: emojiData.extension\n\t\t\t};\n\n\t\t\tconst _id = RocketChat.models.EmojiCustom.create(createEmoji);\n\n\t\t\tRocketChat.Notifications.notifyLogged('updateEmojiCustom', {emojiData: createEmoji});\n\n\t\t\treturn _id;\n\t\t} else {\n\t\t\t//update emoji\n\t\t\tif (emojiData.newFile) {\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.name }.${ emojiData.extension }`));\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.name }.${ emojiData.previousExtension }`));\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.previousName }.${ emojiData.extension }`));\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.previousName }.${ emojiData.previousExtension }`));\n\n\t\t\t\tRocketChat.models.EmojiCustom.setExtension(emojiData._id, emojiData.extension);\n\t\t\t} else if (emojiData.name !== emojiData.previousName) {\n\t\t\t\tconst rs = RocketChatFileEmojiCustomInstance.getFileWithReadStream(encodeURIComponent(`${ emojiData.previousName }.${ emojiData.previousExtension }`));\n\t\t\t\tif (rs !== null) {\n\t\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.name }.${ emojiData.extension }`));\n\t\t\t\t\tconst ws = RocketChatFileEmojiCustomInstance.createWriteStream(encodeURIComponent(`${ emojiData.name }.${ emojiData.previousExtension }`), rs.contentType);\n\t\t\t\t\tws.on('end', Meteor.bindEnvironment(() =>\n\t\t\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.previousName }.${ emojiData.previousExtension }`))\n\t\t\t\t\t));\n\t\t\t\t\trs.readStream.pipe(ws);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (emojiData.name !== emojiData.previousName) {\n\t\t\t\tRocketChat.models.EmojiCustom.setName(emojiData._id, emojiData.name);\n\t\t\t}\n\n\t\t\tif (emojiData.aliases) {\n\t\t\t\tRocketChat.models.EmojiCustom.setAliases(emojiData._id, emojiData.aliases);\n\t\t\t} else {\n\t\t\t\tRocketChat.models.EmojiCustom.setAliases(emojiData._id, []);\n\t\t\t}\n\n\t\t\tRocketChat.Notifications.notifyLogged('updateEmojiCustom', {emojiData});\n\n\t\t\treturn true;\n\t\t}\n\t}\n});\n","/* globals RocketChatFileEmojiCustomInstance */\nMeteor.methods({\n\tuploadEmojiCustom(binaryContent, contentType, emojiData) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-emoji')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\t//delete aliases for notification purposes. here, it is a string rather than an array\n\t\tdelete emojiData.aliases;\n\t\tconst file = new Buffer(binaryContent, 'binary');\n\n\t\tconst rs = RocketChatFile.bufferToStream(file);\n\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.name }.${ emojiData.extension }`));\n\t\tconst ws = RocketChatFileEmojiCustomInstance.createWriteStream(encodeURIComponent(`${ emojiData.name }.${ emojiData.extension }`), contentType);\n\t\tws.on('end', Meteor.bindEnvironment(() =>\n\t\t\tMeteor.setTimeout(() => RocketChat.Notifications.notifyLogged('updateEmojiCustom', {emojiData}), 500)\n\t\t));\n\n\t\trs.pipe(ws);\n\t}\n});\n"]}