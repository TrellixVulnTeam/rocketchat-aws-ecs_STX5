{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:internal-hubot/hubot.js","meteor://ðŸ’»app/packages/rocketchat:internal-hubot/settings.js"],"names":["_","module","watch","require","default","v","s","CoffeeScript","Npm","register","Hubot","DEBUG","InternalHubot","sendHelper","Meteor","bindEnvironment","robot","envelope","strings","map","length","string","shift","err","console","error","logger","Response","prototype","priv","adapter","Robot","loadAdapter","bind","f","g","self","args","apply","Array","from","constructor","hear","respond","enter","leave","topic","catchAll","user","users","findOne","username","name","fields","regex","callback","RocketChatAdapter","Adapter","send","log","blue","room","id","RocketChat","sendMessage","msg","_id","emote","rid","u","message","private","call","action","settings","get","to","reply","str","play","run","emit","brain","mergeData","close","InternalHubotReceiver","models","Rooms","findOneById","t","InternalHubotUser","User","InternalHubotTextMessage","TextMessage","receive","HubotScripts","modulesToLoad","customPath","load","__meteor_bootstrap__","serverDir","split","path","scriptsToLoad","forEach","scriptFile","trim","fn","parseHelp","green","e","red","init","debounce","alias","callbacks","add","priority","LOW","remove","startup","Settings","findByIds","observe","changed","addGroup","type","i18nLabel","i18nDescription"],"mappings":"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","file":"/packages/rocketchat_internal-hubot.js","sourcesContent":["/* globals __meteor_bootstrap__ */\nimport _ from 'underscore';\nimport s from 'underscore.string';\n\nconst CoffeeScript = Npm.require('coffee-script');\nCoffeeScript.register();\nconst Hubot = Npm.require('hubot');\n// Start a hubot, connected to our chat room.\n// 'use strict'\n// Log messages?\nconst DEBUG = false;\n\nlet InternalHubot = {};\n\nconst sendHelper = Meteor.bindEnvironment((robot, envelope, strings, map) =>{\n\twhile (strings.length > 0) {\n\t\tconst string = strings.shift();\n\t\tif (typeof(string) === 'function') {\n\t\t\tstring();\n\t\t} else {\n\t\t\ttry {\n\t\t\t\tmap(string);\n\t\t\t} catch (err) {\n\t\t\t\tif (DEBUG) { console.error(`Hubot error: ${ err }`); }\n\t\t\t\trobot.logger.error(`RocketChat send error: ${ err }`);\n\t\t\t}\n\t\t}\n\t}\n});\n\n// Monkey-patch Hubot to support private messages\nHubot.Response.prototype.priv = (...strings) => this.robot.adapter.priv(this.envelope, ...strings);\n\n// More monkey-patching\nHubot.Robot.prototype.loadAdapter = () => {}; // disable\n\n// grrrr, Meteor.bindEnvironment doesn't preserve `this` apparently\nconst bind = function(f) {\n\tconst g = Meteor.bindEnvironment((self, ...args) => f.apply(self, args));\n\treturn function(...args) { return g(this, ...Array.from(args)); };\n};\n\nclass Robot extends Hubot.Robot {\n\tconstructor(...args) {\n\t\tsuper(...(args || []));\n\t\tthis.hear = bind(this.hear);\n\t\tthis.respond = bind(this.respond);\n\t\tthis.enter = bind(this.enter);\n\t\tthis.leave = bind(this.leave);\n\t\tthis.topic = bind(this.topic);\n\t\tthis.error = bind(this.error);\n\t\tthis.catchAll = bind(this.catchAll);\n\t\tthis.user = Meteor.users.findOne({username: this.name}, {fields: {username: 1}});\n\t}\n\tloadAdapter() { return false; }\n\thear(regex, callback) { return super.hear(regex, Meteor.bindEnvironment(callback)); }\n\trespond(regex, callback) { return super.respond(regex, Meteor.bindEnvironment(callback)); }\n\tenter(callback) { return super.enter(Meteor.bindEnvironment(callback)); }\n\tleave(callback) { return super.leave(Meteor.bindEnvironment(callback)); }\n\ttopic(callback) { return super.topic(Meteor.bindEnvironment(callback)); }\n\terror(callback) { return super.error(Meteor.bindEnvironment(callback)); }\n\tcatchAll(callback) { return super.catchAll(Meteor.bindEnvironment(callback)); }\n}\n\nclass RocketChatAdapter extends Hubot.Adapter {\n\t// Public: Raw method for sending data back to the chat source. Extend this.\n\t//\n\t// envelope - A Object with message, room and user details.\n\t// strings  - One or more Strings for each message to send.\n\t//\n\t// Returns nothing.\n\tsend(envelope, ...strings) {\n\t\tif (DEBUG) { console.log('ROCKETCHATADAPTER -> send'.blue); }\n\t\t// console.log envelope, strings\n\t\treturn sendHelper(this.robot, envelope, strings, string => {\n\t\t\tif (DEBUG) { console.log(`send ${ envelope.room }: ${ string } (${ envelope.user.id })`); }\n\t\t\treturn RocketChat.sendMessage(InternalHubot.user, { msg: string }, { _id: envelope.room });\n\t\t});\n\t}\n\n\t// Public: Raw method for sending emote data back to the chat source.\n\t//\n\t// envelope - A Object with message, room and user details.\n\t// strings  - One or more Strings for each message to send.\n\t//\n\t// Returns nothing.\n\temote(envelope, ...strings) {\n\t\tif (DEBUG) { console.log('ROCKETCHATADAPTER -> emote'.blue); }\n\t\treturn sendHelper(this.robot, envelope, strings, string => {\n\t\t\tif (DEBUG) { console.log(`emote ${ envelope.rid }: ${ string } (${ envelope.u.username })`); }\n\t\t\tif (envelope.message.private) { return this.priv(envelope, `*** ${ string } ***`); }\n\t\t\treturn Meteor.call('sendMessage', {\n\t\t\t\tmsg: string,\n\t\t\t\trid: envelope.rid,\n\t\t\t\taction: true\n\t\t\t}\n\t\t\t);\n\t\t});\n\t}\n\n\t// Priv: our extension -- send a PM to user\n\tpriv(envelope, ...strings) {\n\t\tif (DEBUG) { console.log('ROCKETCHATADAPTER -> priv'.blue); }\n\t\treturn sendHelper(this.robot, envelope, strings, function(string) {\n\t\t\tif (DEBUG) { console.log(`priv ${ envelope.room }: ${ string } (${ envelope.user.id })`); }\n\t\t\treturn Meteor.call('sendMessage', {\n\t\t\t\tu: {\n\t\t\t\t\tusername: RocketChat.settings.get('InternalHubot_Username')\n\t\t\t\t},\n\t\t\t\tto: `${ envelope.user.id }`,\n\t\t\t\tmsg: string,\n\t\t\t\trid: envelope.room\n\t\t\t});\n\t\t});\n\t}\n\n\t// Public: Raw method for building a reply and sending it back to the chat\n\t// source. Extend this.\n\t//\n\t// envelope - A Object with message, room and user details.\n\t// strings  - One or more Strings for each reply to send.\n\t//\n\t// Returns nothing.\n\treply(envelope, ...strings) {\n\t\tif (DEBUG) { console.log('ROCKETCHATADAPTER -> reply'.blue); }\n\t\tif (envelope.message.private) {\n\t\t\treturn this.priv(envelope, ...strings);\n\t\t} else {\n\t\t\treturn this.send(envelope, ...strings.map(str => `${ envelope.user.name }: ${ str }`));\n\t\t}\n\t}\n\n\t// Public: Raw method for setting a topic on the chat source. Extend this.\n\t//\n\t// envelope - A Object with message, room and user details.\n\t// strings  - One more more Strings to set as the topic.\n\t//\n\t// Returns nothing.\n\ttopic(/*envelope, ...strings*/) {\n\t\tif (DEBUG) { return console.log('ROCKETCHATADAPTER -> topic'.blue); }\n\t}\n\n\t// Public: Raw method for playing a sound in the chat source. Extend this.\n\t//\n\t// envelope - A Object with message, room and user details.\n\t// strings  - One or more strings for each play message to send.\n\t//\n\t// Returns nothing\n\tplay(/*envelope, ...strings*/) {\n\t\tif (DEBUG) { return console.log('ROCKETCHATADAPTER -> play'.blue); }\n\t}\n\n\t// Public: Raw method for invoking the bot to run. Extend this.\n\t//\n\t// Returns nothing.\n\trun() {\n\t\tif (DEBUG) { console.log('ROCKETCHATADAPTER -> run'.blue); }\n\t\tthis.robot.emit('connected');\n\t\treturn this.robot.brain.mergeData({});\n\t}\n\t// @robot.brain.emit 'loaded'\n\n\t// Public: Raw method for shutting the bot down. Extend this.\n\t//\n\t// Returns nothing.\n\tclose() {\n\t\tif (DEBUG) { return console.log('ROCKETCHATADAPTER -> close'.blue); }\n\t}\n}\n\nconst InternalHubotReceiver = (message) => {\n\tif (DEBUG) { console.log(message); }\n\tif (message.u.username !== InternalHubot.name) {\n\t\tconst room = RocketChat.models.Rooms.findOneById(message.rid);\n\n\t\tif (room.t === 'c') {\n\t\t\tconst InternalHubotUser = new Hubot.User(message.u.username, {room: message.rid});\n\t\t\tconst InternalHubotTextMessage = new Hubot.TextMessage(InternalHubotUser, message.msg, message._id);\n\t\t\tInternalHubot.adapter.receive(InternalHubotTextMessage);\n\t\t}\n\t}\n\treturn message;\n};\n\nclass HubotScripts {\n\tconstructor(robot) {\n\t\tconst modulesToLoad = [\n\t\t\t'hubot-help/src/help.coffee'\n\t\t];\n\t\tconst customPath = RocketChat.settings.get('InternalHubot_PathToLoadCustomScripts');\n\t\tHubotScripts.load(`${ __meteor_bootstrap__.serverDir }/npm/node_modules/meteor/rocketchat_internal-hubot/node_modules/`, modulesToLoad, robot);\n\t\tHubotScripts.load(customPath, RocketChat.settings.get('InternalHubot_ScriptsToLoad').split(',') || [], robot);\n\t}\n\n\tstatic load(path, scriptsToLoad, robot) {\n\t\tif (!path || !scriptsToLoad) {\n\t\t\treturn;\n\t\t}\n\t\tscriptsToLoad.forEach(scriptFile => {\n\t\t\ttry {\n\t\t\t\tscriptFile = s.trim(scriptFile);\n\t\t\t\tif (scriptFile === '') {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t// delete require.cache[require.resolve(path+scriptFile)];\n\t\t\t\tconst fn = Npm.require(path + scriptFile);\n\t\t\t\tif (typeof(fn) === 'function') {\n\t\t\t\t\tfn(robot);\n\t\t\t\t} else {\n\t\t\t\t\tfn.default(robot);\n\t\t\t\t}\n\t\t\t\trobot.parseHelp(path + scriptFile);\n\t\t\t\tconsole.log(`Loaded ${ scriptFile }`.green);\n\t\t\t} catch (e) {\n\t\t\t\tconsole.log(`Can't load ${ scriptFile }`.red);\n\t\t\t\tconsole.log(e);\n\t\t\t}\n\t\t});\n\t}\n}\n\nconst init = _.debounce(Meteor.bindEnvironment(() => {\n\tif (RocketChat.settings.get('InternalHubot_Enabled')) {\n\t\tInternalHubot = new Robot(null, null, false, RocketChat.settings.get('InternalHubot_Username'));\n\t\tInternalHubot.alias = 'bot';\n\t\tInternalHubot.adapter = new RocketChatAdapter(InternalHubot);\n\t\tnew HubotScripts(InternalHubot);\n\t\tInternalHubot.run();\n\t\treturn RocketChat.callbacks.add('afterSaveMessage', InternalHubotReceiver, RocketChat.callbacks.priority.LOW, 'InternalHubot');\n\t} else {\n\t\tInternalHubot = {};\n\t\treturn RocketChat.callbacks.remove('afterSaveMessage', 'InternalHubot');\n\t}\n}), 1000);\n\nMeteor.startup(function() {\n\tinit();\n\tRocketChat.models.Settings.findByIds([ 'InternalHubot_Username', 'InternalHubot_Enabled', 'InternalHubot_ScriptsToLoad', 'InternalHubot_PathToLoadCustomScripts']).observe({\n\t\tchanged() {\n\t\t\treturn init();\n\t\t}\n\t});\n\t// TODO useful when we have the ability to invalidate `require` cache\n\t// RocketChat.RateLimiter.limitMethod('reloadInternalHubot', 1, 5000, {\n\t// \tuserId(/*userId*/) { return true; }\n\t// });\n\t// Meteor.methods({\n\t// \treloadInternalHubot: () => init()\n\t// });\n});\n","RocketChat.settings.addGroup('InternalHubot', function() {\n\tthis.add('InternalHubot_Enabled', false, { type: 'boolean', i18nLabel: 'Enabled' });\n\tthis.add('InternalHubot_Username', 'rocket.cat', { type: 'string', i18nLabel: 'Username', i18nDescription: 'InternalHubot_Username_Description', 'public': true });\n\tthis.add('InternalHubot_ScriptsToLoad', '', { type: 'string'});\n\tthis.add('InternalHubot_PathToLoadCustomScripts', '', { type: 'string' });\n\t// this.add('InternalHubot_reload', 'reloadInternalHubot', {\n\t// \ttype: 'action',\n\t// \tactionText: 'reload'\n\t// });\n});\n"]}