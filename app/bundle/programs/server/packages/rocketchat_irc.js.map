{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:irc/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:irc/server/server.js"],"names":["Meteor","startup","RocketChat","settings","addGroup","add","type","i18nLabel","i18nDescription","alert","section","_","module","watch","require","default","v","net","Lru","IRC_AVAILABILITY","get","MESSAGE_CACHE_SIZE","ircReceiveMessageCache","ircSendMessageCache","IRC_PORT","IRC_HOST","ircClientMap","bind","f","g","bindEnvironment","self","args","apply","async","wrapAsync","IrcClient","constructor","loginReq","user","_id","ircPort","ircHost","msgBuf","isConnected","isDistroyed","socket","Socket","setNoDelay","setEncoding","setKeepAlive","connect","onConnect","onClose","onTimeout","onError","onReceiveRawMessage","on","isJoiningRoom","receiveMemberListBuf","pendingJoinRoomBuf","successLoginMessageRegex","RegExp","failedLoginMessageRegex","receiveMessageRegex","receiveMemberListRegex","endMemberListRegex","addMemberToRoomRegex","removeMemberFromRoomRegex","quitMemberRegex","loginCb","initRoomList","disconnect","destroy","console","log","yellow","username","write","name","messageBuf","forEach","msg","arguments","data","toString","split","line","trim","indexOf","replace","matchResult","exec","onReceiveMessage","onReceiveMemberList","onEndMemberList","onAddMemberToRoom","onRemoveMemberFromRoom","onQuitMember","onSuccessLoginMessage","onFailedLoginMessage","allowed","source","target","content","now","Date","timestamp","getTime","cacheKey","join","set","createUserWhenNotExist","room","models","Rooms","findOneByName","substring","createDirectRoomWhenNotExist","message","ts","sendMessage","roomName","members","concat","newMembers","findOneByNameAndType","oldMembers","usernames","appendMembers","difference","removeMembers","member","removeUsernamesById","addUsernamesById","shift","joinRoom","t","sendRawMessage","slice","push","u","roomsCursor","findByTypeContainingUsername","fields","rooms","fetch","leaveRoom","getMemberList","addUsernameByName","removeUsernameByName","removeUsernameFromAll","users","update","$set","status","findOne","call","email","pass","rid","sort","upsert","$setOnInsert","msgs","Subscriptions","$and","open","unread","userMentions","groupMentions","getByUid","uid","create","login","ircClient","IrcLoginer","IrcSender","findOneById","IrcRoomJoiner","IrcRoomLeaver","IrcLogoutCleanUper","callbacks","priority","LOW"],"mappings":"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","file":"/packages/rocketchat_irc.js","sourcesContent":["Meteor.startup(function() {\n\tRocketChat.settings.addGroup('IRC', function() {\n\n\t\t// Is this thing on?\n\t\tthis.add('IRC_Enabled', false, {\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Enabled',\n\t\t\ti18nDescription: 'IRC_Enabled',\n\t\t\talert: 'IRC Support is a work in progress. Use on a production system is not recommended at this time.'\n\t\t});\n\n\t\t// The IRC host server to talk to\n\t\tthis.add('IRC_Host', 'irc.freenode.net', {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Host',\n\t\t\ti18nDescription: 'IRC_Hostname'\n\t\t});\n\n\t\t// The port to connect on the remote server\n\t\tthis.add('IRC_Port', 6667, {\n\t\t\ttype: 'int',\n\t\t\ti18nLabel: 'Port',\n\t\t\ti18nDescription: 'IRC_Port'\n\t\t});\n\n\t\t// Cache size of the messages we send the host IRC server\n\t\tthis.add('IRC_Message_Cache_Size', 200, {\n\t\t\ttype: 'int',\n\t\t\ti18nLabel: 'Message Cache Size',\n\t\t\ti18nDescription: 'IRC_Message_Cache_Size'\n\t\t});\n\n\t\t// Expandable box for modifying regular expressions for IRC interaction\n\t\tthis.section('Regular_Expressions', function() {\n\t\t\tthis.add('IRC_RegEx_successLogin', 'Welcome to the freenode Internet Relay Chat Network', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Login Successful',\n\t\t\t\ti18nDescription: 'IRC_Login_Success'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_failedLogin', 'You have not registered', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Login Failed',\n\t\t\t\ti18nDescription: 'IRC_Login_Fail'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_receiveMessage', '^:(\\S+)!~\\S+ PRIVMSG (\\S+) :(.+)$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Private Message',\n\t\t\t\ti18nDescription: 'IRC_Private_Message'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_receiveMemberList', '^:\\S+ \\d+ \\S+ = #(\\S+) :(.*)$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Channel User List Start',\n\t\t\t\ti18nDescription: 'IRC_Channel_Users'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_endMemberList', '^.+#(\\S+) :End of \\/NAMES list.$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Channel User List End',\n\t\t\t\ti18nDescription: 'IRC_Channel_Users_End'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_addMemberToRoom', '^:(\\S+)!~\\S+ JOIN #(\\S+)$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Join Channel',\n\t\t\t\ti18nDescription: 'IRC_Channel_Join'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_removeMemberFromRoom', '^:(\\S+)!~\\S+ PART #(\\S+)$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Leave Channel',\n\t\t\t\ti18nDescription: 'IRC_Channel_Leave'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_quitMember', '^:(\\S+)!~\\S+ QUIT .*$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Quit IRC Session',\n\t\t\t\ti18nDescription: 'IRC_Quit'\n\t\t\t});\n\t\t});\n\n\t});\n});\n","import _ from 'underscore';\nimport net from 'net';\nimport Lru from 'lru-cache';\n\n///////\n// Assign values\n\n//Package availability\nconst IRC_AVAILABILITY = RocketChat.settings.get('IRC_Enabled');\n\n// Cache prep\nconst MESSAGE_CACHE_SIZE = RocketChat.settings.get('IRC_Message_Cache_Size');\nconst ircReceiveMessageCache = Lru(MESSAGE_CACHE_SIZE);//eslint-disable-line\nconst ircSendMessageCache = Lru(MESSAGE_CACHE_SIZE);//eslint-disable-line\n\n// IRC server\nconst IRC_PORT = RocketChat.settings.get('IRC_Port');\nconst IRC_HOST = RocketChat.settings.get('IRC_Host');\n\nconst ircClientMap = {};\n\n//////\n// Core functionality\n\nconst bind = function(f) {\n\tconst g = Meteor.bindEnvironment((self, ...args) => f.apply(self, args));\n\treturn function(...args) { g(this, ...args); };\n};\n\nconst async = (f, ...args) => Meteor.wrapAsync(f)(...args);\n\nclass IrcClient {\n\tconstructor(loginReq) {\n\t\tthis.loginReq = loginReq;\n\n\t\tthis.user = this.loginReq.user;\n\t\tircClientMap[this.user._id] = this;\n\t\tthis.ircPort = IRC_PORT;\n\t\tthis.ircHost = IRC_HOST;\n\t\tthis.msgBuf = [];\n\n\t\tthis.isConnected = false;\n\t\tthis.isDistroyed = false;\n\t\tthis.socket = new net.Socket;\n\t\tthis.socket.setNoDelay;\n\t\tthis.socket.setEncoding('utf-8');\n\t\tthis.socket.setKeepAlive(true);\n\t\tthis.connect = this.connect.bind(this);\n\t\tthis.onConnect = this.onConnect.bind(this);\n\t\tthis.onConnect = bind(this.onConnect);\n\t\tthis.onClose = bind(this.onClose);\n\t\tthis.onTimeout = bind(this.onTimeout);\n\t\tthis.onError = bind(this.onError);\n\t\tthis.onReceiveRawMessage = this.onReceiveRawMessage.bind(this);\n\t\tthis.onReceiveRawMessage = bind(this.onReceiveRawMessage);\n\t\tthis.socket.on('data', this.onReceiveRawMessage);\n\t\tthis.socket.on('close', this.onClose);\n\t\tthis.socket.on('timeout', this.onTimeout);\n\t\tthis.socket.on('error', this.onError);\n\n\t\tthis.isJoiningRoom = false;\n\t\tthis.receiveMemberListBuf = {};\n\t\tthis.pendingJoinRoomBuf = [];\n\n\t\tthis.successLoginMessageRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_successLogin'));\n\t\tthis.failedLoginMessageRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_failedLogin'));\n\t\tthis.receiveMessageRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_receiveMessage'));\n\t\tthis.receiveMemberListRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_receiveMemberList'));\n\t\tthis.endMemberListRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_endMemberList'));\n\t\tthis.addMemberToRoomRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_addMemberToRoom'));\n\t\tthis.removeMemberFromRoomRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_removeMemberFromRoom'));\n\t\tthis.quitMemberRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_quitMember'));\n\t}\n\n\tconnect(loginCb) {\n\t\tthis.loginCb = loginCb;\n\t\tthis.socket.connect(this.ircPort, this.ircHost, this.onConnect);\n\t\tthis.initRoomList();\n\t}\n\n\tdisconnect() {\n\t\tthis.isDistroyed = true;\n\t\tthis.socket.destroy();\n\t}\n\n\tonConnect() {\n\t\tconsole.log('[irc] onConnect -> '.yellow, this.user.username, 'connect success.');\n\t\tthis.socket.write(`NICK ${ this.user.username }\\r\\n`);\n\t\tthis.socket.write(`USER ${ this.user.username } 0 * :${ this.user.name }\\r\\n`);\n\t\t// message order could not make sure here\n\t\tthis.isConnected = true;\n\t\tconst messageBuf = this.msgBuf;\n\t\tmessageBuf.forEach(msg => this.socket.write(msg));\n\t}\n\n\tonClose() {\n\t\tconsole.log('[irc] onClose -> '.yellow, this.user.username, 'connection close.');\n\t\tthis.isConnected = false;\n\t\tif (this.isDistroyed) {\n\t\t\tdelete ircClientMap[this.user._id];\n\t\t} else {\n\t\t\tthis.connect();\n\t\t}\n\t}\n\n\tonTimeout() {\n\t\tconsole.log('[irc] onTimeout -> '.yellow, this.user.username, 'connection timeout.', arguments);\n\t}\n\n\tonError() {\n\t\tconsole.log('[irc] onError -> '.yellow, this.user.username, 'connection error.', arguments);\n\t}\n\n\tonReceiveRawMessage(data) {\n\t\tdata = data.toString().split('\\n');\n\n\t\tdata.forEach(line => {\n\t\t\tline = line.trim();\n\t\t\tconsole.log(`[${ this.ircHost }:${ this.ircPort }]:`, line);\n\n\t\t\t// Send heartbeat package to irc server\n\t\t\tif (line.indexOf('PING') === 0) {\n\t\t\t\tthis.socket.write(line.replace('PING :', 'PONG '));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tlet matchResult = this.receiveMessageRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onReceiveMessage(matchResult[1], matchResult[2], matchResult[3]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.receiveMemberListRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onReceiveMemberList(matchResult[1], matchResult[2].split(' '));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.endMemberListRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onEndMemberList(matchResult[1]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.addMemberToRoomRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onAddMemberToRoom(matchResult[1], matchResult[2]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.removeMemberFromRoomRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onRemoveMemberFromRoom(matchResult[1], matchResult[2]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.quitMemberRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onQuitMember(matchResult[1]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.successLoginMessageRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onSuccessLoginMessage();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.failedLoginMessageRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onFailedLoginMessage();\n\t\t\t\treturn;\n\t\t\t}\n\t\t});\n\t}\n\n\tonSuccessLoginMessage() {\n\t\tconsole.log('[irc] onSuccessLoginMessage -> '.yellow);\n\t\tif (this.loginCb) {\n\t\t\tthis.loginCb(null, this.loginReq);\n\t\t}\n\t}\n\n\tonFailedLoginMessage() {\n\t\tconsole.log('[irc] onFailedLoginMessage -> '.yellow);\n\t\tthis.loginReq.allowed = false;\n\t\tthis.disconnect();\n\t\tif (this.loginCb) {\n\t\t\tthis.loginCb(null, this.loginReq);\n\t\t}\n\t}\n\n\tonReceiveMessage(source, target, content) {\n\t\tconst now = new Date;\n\t\tconst timestamp = now.getTime();\n\t\tlet cacheKey = [source, target, content].join(',');\n\t\tconsole.log('[irc] ircSendMessageCache.get -> '.yellow, 'key:', cacheKey, 'value:', ircSendMessageCache.get(cacheKey), 'ts:', timestamp - 1000);\n\t\tif (ircSendMessageCache.get(cacheKey) > (timestamp - 1000)) {\n\t\t\treturn;\n\t\t} else {\n\t\t\tircSendMessageCache.set(cacheKey, timestamp);\n\t\t}\n\t\tconsole.log('[irc] onReceiveMessage -> '.yellow, 'source:', source, 'target:', target, 'content:', content);\n\t\tsource = this.createUserWhenNotExist(source);\n\t\tlet room;\n\t\tif (target[0] === '#') {\n\t\t\troom = RocketChat.models.Rooms.findOneByName(target.substring(1));\n\t\t} else {\n\t\t\troom = this.createDirectRoomWhenNotExist(source, this.user);\n\t\t}\n\t\tconst message = { msg: content, ts: now };\n\t\tcacheKey = `${ source.username }${ timestamp }`;\n\t\tircReceiveMessageCache.set(cacheKey, true);\n\t\tconsole.log('[irc] ircReceiveMessageCache.set -> '.yellow, 'key:', cacheKey);\n\t\tRocketChat.sendMessage(source, message, room);\n\t}\n\n\tonReceiveMemberList(roomName, members) {\n\t\tthis.receiveMemberListBuf[roomName] = this.receiveMemberListBuf[roomName].concat(members);\n\t}\n\n\tonEndMemberList(roomName) {\n\t\tconst newMembers = this.receiveMemberListBuf[roomName];\n\t\tconsole.log('[irc] onEndMemberList -> '.yellow, 'room:', roomName, 'members:', newMembers.join(','));\n\t\tconst room = RocketChat.models.Rooms.findOneByNameAndType(roomName, 'c');\n\t\tif (!room) {\n\t\t\treturn;\n\t\t}\n\t\tconst oldMembers = room.usernames;\n\t\tconst appendMembers = _.difference(newMembers, oldMembers);\n\t\tconst removeMembers = _.difference(oldMembers, newMembers);\n\t\tappendMembers.forEach(member => this.createUserWhenNotExist(member));\n\t\tRocketChat.models.Rooms.removeUsernamesById(room._id, removeMembers);\n\t\tRocketChat.models.Rooms.addUsernamesById(room._id, appendMembers);\n\n\t\tthis.isJoiningRoom = false;\n\t\troomName = this.pendingJoinRoomBuf.shift();\n\t\tif (roomName) {\n\t\t\tthis.joinRoom({\n\t\t\t\tt: 'c',\n\t\t\t\tname: roomName\n\t\t\t});\n\t\t}\n\t}\n\n\tsendRawMessage(msg) {\n\t\tconsole.log('[irc] sendRawMessage -> '.yellow, msg.slice(0, -2));\n\t\tif (this.isConnected) {\n\t\t\tthis.socket.write(msg);\n\t\t} else {\n\t\t\tthis.msgBuf.push(msg);\n\t\t}\n\t}\n\n\tsendMessage(room, message) {\n\t\tconsole.log('[irc] sendMessage -> '.yellow, 'userName:', message.u.username);\n\t\tlet target = '';\n\t\tif (room.t === 'c') {\n\t\t\ttarget = `#${ room.name }`;\n\t\t} else if (room.t === 'd') {\n\t\t\tconst usernames = room.usernames;\n\t\t\tusernames.forEach(name => {\n\t\t\t\tif (message.u.username !== name) {\n\t\t\t\t\ttarget = name;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tconst cacheKey = [this.user.username, target, message.msg].join(',');\n\t\tconsole.log('[irc] ircSendMessageCache.set -> '.yellow, 'key:', cacheKey, 'ts:', message.ts.getTime());\n\t\tircSendMessageCache.set(cacheKey, message.ts.getTime());\n\t\tconst msg = `PRIVMSG ${ target } :${ message.msg }\\r\\n`;\n\t\tthis.sendRawMessage(msg);\n\t}\n\n\tinitRoomList() {\n\t\tconst roomsCursor = RocketChat.models.Rooms.findByTypeContainingUsername('c', this.user.username, { fields: { name: 1, t: 1 }});\n\t\tconst rooms = roomsCursor.fetch();\n\t\trooms.forEach(room => this.joinRoom(room));\n\t}\n\n\tjoinRoom(room) {\n\t\tif (room.t !== 'c' || room.name === 'general') {\n\t\t\treturn;\n\t\t}\n\t\tif (this.isJoiningRoom) {\n\t\t\treturn this.pendingJoinRoomBuf.push(room.name);\n\t\t}\n\t\tconsole.log('[irc] joinRoom -> '.yellow, 'roomName:', room.name, 'pendingJoinRoomBuf:', this.pendingJoinRoomBuf.join(','));\n\t\tconst msg = `JOIN #${ room.name }\\r\\n`;\n\t\tthis.receiveMemberListBuf[room.name] = [];\n\t\tthis.sendRawMessage(msg);\n\t\tthis.isJoiningRoom = true;\n\t}\n\n\tleaveRoom(room) {\n\t\tif (room.t !== 'c') {\n\t\t\treturn;\n\t\t}\n\t\tconst msg = `PART #${ room.name }\\r\\n`;\n\t\tthis.sendRawMessage(msg);\n\t}\n\n\tgetMemberList(room) {\n\t\tif (room.t !== 'c') {\n\t\t\treturn;\n\t\t}\n\t\tconst msg = `NAMES #${ room.name }\\r\\n`;\n\t\tthis.receiveMemberListBuf[room.name] = [];\n\t\tthis.sendRawMessage(msg);\n\t}\n\n\tonAddMemberToRoom(member, roomName) {\n\t\tif (this.user.username === member) {\n\t\t\treturn;\n\t\t}\n\t\tconsole.log('[irc] onAddMemberToRoom -> '.yellow, 'roomName:', roomName, 'member:', member);\n\t\tthis.createUserWhenNotExist(member);\n\t\tRocketChat.models.Rooms.addUsernameByName(roomName, member);\n\t}\n\n\tonRemoveMemberFromRoom(member, roomName) {\n\t\tconsole.log('[irc] onRemoveMemberFromRoom -> '.yellow, 'roomName:', roomName, 'member:', member);\n\t\tRocketChat.models.Rooms.removeUsernameByName(roomName, member);\n\t}\n\n\tonQuitMember(member) {\n\t\tconsole.log('[irc] onQuitMember ->'.yellow, 'username:', member);\n\t\tRocketChat.models.Rooms.removeUsernameFromAll(member);\n\t\tMeteor.users.update({ name: member }, { $set: { status: 'offline' }});\n\t}\n\n\tcreateUserWhenNotExist(name) {\n\t\tconst user = Meteor.users.findOne({ name });\n\t\tif (user) {\n\t\t\treturn user;\n\t\t}\n\t\tconsole.log('[irc] createNotExistUser ->'.yellow, 'userName:', name);\n\t\tMeteor.call('registerUser', {\n\t\t\temail: `${ name }@rocketchat.org`,\n\t\t\tpass: 'rocketchat',\n\t\t\tname\n\t\t});\n\t\tMeteor.users.update({ name }, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'online',\n\t\t\t\tusername: name\n\t\t\t}\n\t\t});\n\t\treturn Meteor.users.findOne({ name });\n\t}\n\n\tcreateDirectRoomWhenNotExist(source, target) {\n\t\tconsole.log('[irc] createDirectRoomWhenNotExist -> '.yellow, 'source:', source, 'target:', target);\n\t\tconst rid = [source._id, target._id].sort().join('');\n\t\tconst now = new Date();\n\t\tRocketChat.models.Rooms.upsert({ _id: rid}, {\n\t\t\t$set: {\n\t\t\t\tusernames: [source.username, target.username]\n\t\t\t},\n\t\t\t$setOnInsert: {\n\t\t\t\tt: 'd',\n\t\t\t\tmsgs: 0,\n\t\t\t\tts: now\n\t\t\t}\n\t\t});\n\t\tRocketChat.models.Subscriptions.upsert({ rid, $and: [{ 'u._id': target._id}]}, {\n\t\t\t$setOnInsert: {\n\t\t\t\tname: source.username,\n\t\t\t\tt: 'd',\n\t\t\t\topen: false,\n\t\t\t\talert: false,\n\t\t\t\tunread: 0,\n\t\t\t\tuserMentions: 0,\n\t\t\t\tgroupMentions: 0,\n\t\t\t\tu: { _id: target._id, username: target.username }}\n\t\t});\n\t\treturn { t: 'd', _id: rid };\n\t}\n}\n\nIrcClient.getByUid = function(uid) {\n\treturn ircClientMap[uid];\n};\n\nIrcClient.create = function(login) {\n\tif (login.user == null) {\n\t\treturn login;\n\t}\n\tif (!(login.user._id in ircClientMap)) {\n\t\tconst ircClient = new IrcClient(login);\n\t\treturn async(ircClient.connect);\n\t}\n\treturn login;\n};\n\nfunction IrcLoginer(login) {\n\tconsole.log('[irc] validateLogin -> '.yellow, login);\n\treturn IrcClient.create(login);\n}\n\n\nfunction IrcSender(message) {\n\tconst name = message.u.username;\n\tconst timestamp = message.ts.getTime();\n\tconst cacheKey = `${ name }${ timestamp }`;\n\tif (ircReceiveMessageCache.get(cacheKey)) {\n\t\treturn message;\n\t}\n\tconst room = RocketChat.models.Rooms.findOneById(message.rid, { fields: { name: 1, usernames: 1, t: 1 }});\n\tconst ircClient = IrcClient.getByUid(message.u._id);\n\tircClient.sendMessage(room, message);\n\treturn message;\n}\n\n\nfunction IrcRoomJoiner(user, room) {\n\tconst ircClient = IrcClient.getByUid(user._id);\n\tircClient.joinRoom(room);\n\treturn room;\n}\n\n\nfunction IrcRoomLeaver(user, room) {\n\tconst ircClient = IrcClient.getByUid(user._id);\n\tircClient.leaveRoom(room);\n\treturn room;\n}\n\nfunction IrcLogoutCleanUper(user) {\n\tconst ircClient = IrcClient.getByUid(user._id);\n\tircClient.disconnect();\n\treturn user;\n}\n\n//////\n// Make magic happen\n\n// Only proceed if the package has been enabled\nif (IRC_AVAILABILITY === true) {\n\tRocketChat.callbacks.add('beforeValidateLogin', IrcLoginer, RocketChat.callbacks.priority.LOW, 'irc-loginer');\n\tRocketChat.callbacks.add('beforeSaveMessage', IrcSender, RocketChat.callbacks.priority.LOW, 'irc-sender');\n\tRocketChat.callbacks.add('beforeJoinRoom', IrcRoomJoiner, RocketChat.callbacks.priority.LOW, 'irc-room-joiner');\n\tRocketChat.callbacks.add('beforeCreateChannel', IrcRoomJoiner, RocketChat.callbacks.priority.LOW, 'irc-room-joiner-create-channel');\n\tRocketChat.callbacks.add('beforeLeaveRoom', IrcRoomLeaver, RocketChat.callbacks.priority.LOW, 'irc-room-leaver');\n\tRocketChat.callbacks.add('afterLogoutCleanUp', IrcLogoutCleanUper, RocketChat.callbacks.priority.LOW, 'irc-clean-up');\n}\n"]}