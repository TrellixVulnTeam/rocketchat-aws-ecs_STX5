{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:oembed/server/server.js","meteor://ðŸ’»app/packages/rocketchat:oembed/server/providers.js","meteor://ðŸ’»app/packages/rocketchat:oembed/server/jumpToMessage.js","meteor://ðŸ’»app/packages/rocketchat:oembed/server/models/OEmbedCache.js"],"names":["module1","module","_","watch","require","default","v","URL","Npm","querystring","request","HTTPInternals","NpmModules","iconv","ipRangeCheck","he","jschardet","OEmbed","getCharset","contentType","body","detectedCharset","httpHeaderCharset","htmlMetaCharset","result","binary","toString","detected","detect","confidence","encoding","toLowerCase","m1","match","m2","toUtf8","decode","getUrlContent","urlObj","redirectCount","callback","isString","parse","parsedUrl","pick","ignoredHosts","RocketChat","settings","get","replace","split","includes","hostname","safePorts","port","length","data","callbacks","run","attachments","url","format","opts","strictSSL","gzip","maxRedirects","headers","statusCode","error","chunks","chunksTotalLength","stream","on","response","abort","chunk","push","Meteor","bindEnvironment","buffer","Buffer","concat","err","getUrlMeta","withFragment","getUrlContentSync","wrapAsync","queryStringObj","query","_escaped_fragment_","stringify","path","pathname","content","metas","undefined","meta","title","pageTitle","unescape","name","value","name1","changeCase","camelCase","fragment","headerObj","Object","keys","forEach","header","getUrlMetaWithCache","cache","models","OEmbedCache","findOneById","createWithIdAndData","_error","console","getRelevantHeaders","headersObj","key","lowerCaseKey","trim","getRelevantMetaTags","metaObj","tags","test","rocketUrlParser","message","Array","isArray","urls","changed","item","ignoreParse","startsWith","sandstorm","grain","sandstormViewInfo","union","Messages","setMessageAttachments","_id","setUrlsById","add","priority","LOW","remove","QueryString","Providers","constructor","providers","getConsumerUrl","provider","endPoint","search","registerProvider","getProviders","getProviderForUrl","find","candidate","re","RegExp","oembed","consumerUrl","extend","host","MEDIUM","queryString","JSON","each","log","recursiveRemove","deep","map","msg","indexOf","absoluteUrl","jumpToMessage","translations","alias","u","username","getAvatarUrlFromUsername","ts","_Base","tryEnsureIndex","options","findOne","record","updatedAt","Date","insert","removeAfterDate","date","$lte"],"mappings":"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","file":"/packages/rocketchat_oembed.js","sourcesContent":["/*globals HTTPInternals, changeCase */\nimport _ from 'underscore';\n\nconst URL = Npm.require('url');\n\nconst querystring = Npm.require('querystring');\n\nconst request = HTTPInternals.NpmModules.request.module;\n\nconst iconv = Npm.require('iconv-lite');\n\nconst ipRangeCheck = Npm.require('ip-range-check');\n\nconst he = Npm.require('he');\n\nconst jschardet = Npm.require('jschardet');\n\nconst OEmbed = {};\n\n//  Detect encoding\n//  Priority:\n//  Detected == HTTP Header > Detected == HTML meta > HTTP Header > HTML meta > Detected > Default (utf-8)\n//  See also: https://www.w3.org/International/questions/qa-html-encoding-declarations.en#quickanswer\nconst getCharset = function(contentType, body) {\n\tlet detectedCharset;\n\tlet httpHeaderCharset;\n\tlet htmlMetaCharset;\n\tlet result;\n\n\tcontentType = contentType || '';\n\n\tconst binary = body.toString('binary');\n\tconst detected = jschardet.detect(binary);\n\tif (detected.confidence > 0.8) {\n\t\tdetectedCharset = detected.encoding.toLowerCase();\n\t}\n\tconst m1 = contentType.match(/charset=([\\w\\-]+)/i);\n\tif (m1) {\n\t\thttpHeaderCharset = m1[1].toLowerCase();\n\t}\n\tconst m2 = binary.match(/<meta\\b[^>]*charset=[\"']?([\\w\\-]+)/i);\n\tif (m2) {\n\t\thtmlMetaCharset = m2[1].toLowerCase();\n\t}\n\tif (detectedCharset) {\n\t\tif (detectedCharset === httpHeaderCharset) {\n\t\t\tresult = httpHeaderCharset;\n\t\t} else if (detectedCharset === htmlMetaCharset) {\n\t\t\tresult = htmlMetaCharset;\n\t\t}\n\t}\n\tif (!result) {\n\t\tresult = httpHeaderCharset || htmlMetaCharset || detectedCharset;\n\t}\n\treturn result || 'utf-8';\n};\n\nconst toUtf8 = function(contentType, body) {\n\treturn iconv.decode(body, getCharset(contentType, body));\n};\n\nconst getUrlContent = function(urlObj, redirectCount = 5, callback) {\n\n\tif (_.isString(urlObj)) {\n\t\turlObj = URL.parse(urlObj);\n\t}\n\n\tconst parsedUrl = _.pick(urlObj, ['host', 'hash', 'pathname', 'protocol', 'port', 'query', 'search', 'hostname']);\n\tconst ignoredHosts = RocketChat.settings.get('API_EmbedIgnoredHosts').replace(/\\s/g, '').split(',') || [];\n\tif (ignoredHosts.includes(parsedUrl.hostname) || ipRangeCheck(parsedUrl.hostname, ignoredHosts)) {\n\t\treturn callback();\n\t}\n\n\tconst safePorts = RocketChat.settings.get('API_EmbedSafePorts').replace(/\\s/g, '').split(',') || [];\n\tif (parsedUrl.port && safePorts.length > 0 && (!safePorts.includes(parsedUrl.port))) {\n\t\treturn callback();\n\t}\n\n\tconst data = RocketChat.callbacks.run('oembed:beforeGetUrlContent', {\n\t\turlObj,\n\t\tparsedUrl\n\t});\n\tif (data.attachments != null) {\n\t\treturn callback(null, data);\n\t}\n\tconst url = URL.format(data.urlObj);\n\tconst opts = {\n\t\turl,\n\t\tstrictSSL: !RocketChat.settings.get('Allow_Invalid_SelfSigned_Certs'),\n\t\tgzip: true,\n\t\tmaxRedirects: redirectCount,\n\t\theaders: {\n\t\t\t'User-Agent': RocketChat.settings.get('API_Embed_UserAgent')\n\t\t}\n\t};\n\tlet headers = null;\n\tlet statusCode = null;\n\tlet error = null;\n\tconst chunks = [];\n\tlet chunksTotalLength = 0;\n\tconst stream = request(opts);\n\tstream.on('response', function(response) {\n\t\tstatusCode = response.statusCode;\n\t\theaders = response.headers;\n\t\tif (response.statusCode !== 200) {\n\t\t\treturn stream.abort();\n\t\t}\n\t});\n\tstream.on('data', function(chunk) {\n\t\tchunks.push(chunk);\n\t\tchunksTotalLength += chunk.length;\n\t\tif (chunksTotalLength > 250000) {\n\t\t\treturn stream.abort();\n\t\t}\n\t});\n\tstream.on('end', Meteor.bindEnvironment(function() {\n\t\tif (error != null) {\n\t\t\treturn callback(null, {\n\t\t\t\terror,\n\t\t\t\tparsedUrl\n\t\t\t});\n\t\t}\n\t\tconst buffer = Buffer.concat(chunks);\n\t\treturn callback(null, {\n\t\t\theaders,\n\t\t\tbody: toUtf8(headers['content-type'], buffer),\n\t\t\tparsedUrl,\n\t\t\tstatusCode\n\t\t});\n\t}));\n\treturn stream.on('error', function(err) {\n\t\treturn error = err;\n\t});\n};\n\nOEmbed.getUrlMeta = function(url, withFragment) {\n\tconst getUrlContentSync = Meteor.wrapAsync(getUrlContent);\n\tconst urlObj = URL.parse(url);\n\tif (withFragment != null) {\n\t\tconst queryStringObj = querystring.parse(urlObj.query);\n\t\tqueryStringObj._escaped_fragment_ = '';\n\t\turlObj.query = querystring.stringify(queryStringObj);\n\t\tlet path = urlObj.pathname;\n\t\tif (urlObj.query != null) {\n\t\t\tpath += `?${ urlObj.query }`;\n\t\t}\n\t\turlObj.path = path;\n\t}\n\tconst content = getUrlContentSync(urlObj, 5);\n\tif (!content) {\n\t\treturn;\n\t}\n\tif (content.attachments != null) {\n\t\treturn content;\n\t}\n\tlet metas = undefined;\n\tif (content && content.body) {\n\t\tmetas = {};\n\t\tcontent.body.replace(/<title[^>]*>([^<]*)<\\/title>/gmi, function(meta, title) {\n\t\t\treturn metas.pageTitle != null ? metas.pageTitle : metas.pageTitle = he.unescape(title);\n\t\t});\n\t\tcontent.body.replace(/<meta[^>]*(?:name|property)=[']([^']*)['][^>]*\\scontent=[']([^']*)['][^>]*>/gmi, function(meta, name, value) {\n\t\t\tlet name1;\n\t\t\treturn metas[name1 = changeCase.camelCase(name)] != null ? metas[name1] : metas[name1] = he.unescape(value);\n\t\t});\n\t\tcontent.body.replace(/<meta[^>]*(?:name|property)=[\"]([^\"]*)[\"][^>]*\\scontent=[\"]([^\"]*)[\"][^>]*>/gmi, function(meta, name, value) {\n\t\t\tlet name1;\n\t\t\treturn metas[name1 = changeCase.camelCase(name)] != null ? metas[name1] : metas[name1] = he.unescape(value);\n\t\t});\n\t\tcontent.body.replace(/<meta[^>]*\\scontent=[']([^']*)['][^>]*(?:name|property)=[']([^']*)['][^>]*>/gmi, function(meta, value, name) {\n\t\t\tlet name1;\n\t\t\treturn metas[name1 = changeCase.camelCase(name)] != null ? metas[name1] : metas[name1] = he.unescape(value);\n\t\t});\n\t\tcontent.body.replace(/<meta[^>]*\\scontent=[\"]([^\"]*)[\"][^>]*(?:name|property)=[\"]([^\"]*)[\"][^>]*>/gmi, function(meta, value, name) {\n\t\t\tlet name1;\n\t\t\treturn metas[name1 = changeCase.camelCase(name)] != null ? metas[name1] : metas[name1] = he.unescape(value);\n\t\t});\n\t\tif (metas.fragment === '!' && (withFragment == null)) {\n\t\t\treturn OEmbed.getUrlMeta(url, true);\n\t\t}\n\t}\n\tlet headers = undefined;\n\tlet data = undefined;\n\n\n\tif (content && content.headers) {\n\t\theaders = {};\n\t\tconst headerObj = content.headers;\n\t\tObject.keys(headerObj).forEach((header) => {\n\t\t\theaders[changeCase.camelCase(header)] = headerObj[header];\n\t\t});\n\t}\n\tif (content && content.statusCode !== 200) {\n\t\treturn data;\n\t}\n\tdata = RocketChat.callbacks.run('oembed:afterParseContent', {\n\t\tmeta: metas,\n\t\theaders,\n\t\tparsedUrl: content.parsedUrl,\n\t\tcontent\n\t});\n\treturn data;\n};\n\nOEmbed.getUrlMetaWithCache = function(url, withFragment) {\n\tconst cache = RocketChat.models.OEmbedCache.findOneById(url);\n\tif (cache != null) {\n\t\treturn cache.data;\n\t}\n\tconst data = OEmbed.getUrlMeta(url, withFragment);\n\tif (data != null) {\n\t\ttry {\n\t\t\tRocketChat.models.OEmbedCache.createWithIdAndData(url, data);\n\t\t} catch (_error) {\n\t\t\tconsole.error('OEmbed duplicated record', url);\n\t\t}\n\t\treturn data;\n\t}\n};\n\nconst getRelevantHeaders = function(headersObj) {\n\tconst headers = {};\n\tObject.keys(headersObj).forEach((key) => {\n\t\tconst value = headersObj[key];\n\t\tconst lowerCaseKey = key.toLowerCase();\n\t\tif ((lowerCaseKey === 'contenttype' || lowerCaseKey === 'contentlength') && (value && value.trim() !== '')) {\n\t\t\theaders[key] = value;\n\t\t}\n\t});\n\n\tif (Object.keys(headers).length > 0) {\n\t\treturn headers;\n\t}\n};\n\nconst getRelevantMetaTags = function(metaObj) {\n\tconst tags = {};\n\tObject.keys(metaObj).forEach((key) => {\n\t\tconst value = metaObj[key];\n\t\tif (/^(og|fb|twitter|oembed|msapplication).+|description|title|pageTitle$/.test(key.toLowerCase()) && (value && value.trim() !== '')) {\n\t\t\ttags[key] = value;\n\t\t}\n\t});\n\n\tif (Object.keys(tags).length > 0) {\n\t\treturn tags;\n\t}\n};\n\nOEmbed.rocketUrlParser = function(message) {\n\tif (Array.isArray(message.urls)) {\n\t\tlet attachments = [];\n\t\tlet changed = false;\n\t\tmessage.urls.forEach(function(item) {\n\t\t\tif (item.ignoreParse === true) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (item.url.startsWith('grain://')) {\n\t\t\t\tchanged = true;\n\t\t\t\titem.meta = {\n\t\t\t\t\tsandstorm: {\n\t\t\t\t\t\tgrain: item.sandstormViewInfo\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (!/^https?:\\/\\//i.test(item.url)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst data = OEmbed.getUrlMetaWithCache(item.url);\n\t\t\tif (data != null) {\n\t\t\t\tif (data.attachments) {\n\t\t\t\t\treturn attachments = _.union(attachments, data.attachments);\n\t\t\t\t} else {\n\t\t\t\t\tif (data.meta != null) {\n\t\t\t\t\t\titem.meta = getRelevantMetaTags(data.meta);\n\t\t\t\t\t}\n\t\t\t\t\tif (data.headers != null) {\n\t\t\t\t\t\titem.headers = getRelevantHeaders(data.headers);\n\t\t\t\t\t}\n\t\t\t\t\titem.parsedUrl = data.parsedUrl;\n\t\t\t\t\treturn changed = true;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\tif (attachments.length) {\n\t\t\tRocketChat.models.Messages.setMessageAttachments(message._id, attachments);\n\t\t}\n\t\tif (changed === true) {\n\t\t\tRocketChat.models.Messages.setUrlsById(message._id, message.urls);\n\t\t}\n\t}\n\treturn message;\n};\n\nRocketChat.settings.get('API_Embed', function(key, value) {\n\tif (value) {\n\t\treturn RocketChat.callbacks.add('afterSaveMessage', OEmbed.rocketUrlParser, RocketChat.callbacks.priority.LOW, 'API_Embed');\n\t} else {\n\t\treturn RocketChat.callbacks.remove('afterSaveMessage', 'API_Embed');\n\t}\n});\n","/*globals changeCase */\nimport _ from 'underscore';\n\nconst URL = Npm.require('url');\n\nconst QueryString = Npm.require('querystring');\n\nclass Providers {\n\tconstructor() {\n\t\tthis.providers = [];\n\t}\n\n\tstatic getConsumerUrl(provider, url) {\n\t\tconst urlObj = URL.parse(provider.endPoint, true);\n\t\turlObj.query['url'] = url;\n\t\tdelete urlObj.search;\n\t\treturn URL.format(urlObj);\n\t}\n\n\tregisterProvider(provider) {\n\t\treturn this.providers.push(provider);\n\t}\n\n\tgetProviders() {\n\t\treturn this.providers;\n\t}\n\n\tgetProviderForUrl(url) {\n\t\treturn _.find(this.providers, function(provider) {\n\t\t\tconst candidate = _.find(provider.urls, function(re) {\n\t\t\t\treturn re.test(url);\n\t\t\t});\n\t\t\treturn candidate != null;\n\t\t});\n\t}\n}\n\nconst providers = new Providers();\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://soundcloud.com/\\\\S+')],\n\tendPoint: 'https://soundcloud.com/oembed?format=json&maxheight=150'\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://vimeo.com/[^/]+'), new RegExp('https?://vimeo.com/channels/[^/]+/[^/]+'), new RegExp('https://vimeo.com/groups/[^/]+/videos/[^/]+')],\n\tendPoint: 'https://vimeo.com/api/oembed.json?maxheight=200'\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www.youtube.com/\\\\S+'), new RegExp('https?://youtu.be/\\\\S+')],\n\tendPoint: 'https://www.youtube.com/oembed?maxheight=200'\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www.rdio.com/\\\\S+'), new RegExp('https?://rd.io/\\\\S+')],\n\tendPoint: 'https://www.rdio.com/api/oembed/?format=json&maxheight=150'\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www.slideshare.net/[^/]+/[^/]+')],\n\tendPoint: 'https://www.slideshare.net/api/oembed/2?format=json&maxheight=200'\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www.dailymotion.com/video/\\\\S+')],\n\tendPoint: 'https://www.dailymotion.com/services/oembed?maxheight=200'\n});\n\nRocketChat.oembed = {};\n\nRocketChat.oembed.providers = providers;\n\nRocketChat.callbacks.add('oembed:beforeGetUrlContent', function(data) {\n\tif (data.parsedUrl != null) {\n\t\tconst url = URL.format(data.parsedUrl);\n\t\tconst provider = providers.getProviderForUrl(url);\n\t\tif (provider != null) {\n\t\t\tlet consumerUrl = Providers.getConsumerUrl(provider, url);\n\t\t\tconsumerUrl = URL.parse(consumerUrl, true);\n\t\t\t_.extend(data.parsedUrl, consumerUrl);\n\t\t\tdata.urlObj.port = consumerUrl.port;\n\t\t\tdata.urlObj.hostname = consumerUrl.hostname;\n\t\t\tdata.urlObj.pathname = consumerUrl.pathname;\n\t\t\tdata.urlObj.query = consumerUrl.query;\n\t\t\tdelete data.urlObj.search;\n\t\t\tdelete data.urlObj.host;\n\t\t}\n\t}\n\treturn data;\n}, RocketChat.callbacks.priority.MEDIUM, 'oembed-providers-before');\n\nRocketChat.callbacks.add('oembed:afterParseContent', function(data) {\n\tif (data.parsedUrl && data.parsedUrl.query) {\n\t\tlet queryString = data.parsedUrl.query;\n\t\tif (_.isString(data.parsedUrl.query)) {\n\t\t\tqueryString = QueryString.parse(data.parsedUrl.query);\n\t\t}\n\t\tif (queryString.url != null) {\n\t\t\tconst url = queryString.url;\n\t\t\tconst provider = providers.getProviderForUrl(url);\n\t\t\tif (provider != null) {\n\t\t\t\tif (data.content && data.content.body) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst metas = JSON.parse(data.content.body);\n\t\t\t\t\t\t_.each(metas, function(value, key) {\n\t\t\t\t\t\t\tif (_.isString(value)) {\n\t\t\t\t\t\t\t\treturn data.meta[changeCase.camelCase(`oembed_${ key }`)] = value;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\tdata.meta['oembedUrl'] = url;\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\tconsole.log(error);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn data;\n}, RocketChat.callbacks.priority.MEDIUM, 'oembed-providers-after');\n","/* globals getAvatarUrlFromUsername */\nimport _ from 'underscore';\n\nconst URL = Npm.require('url');\nconst QueryString = Npm.require('querystring');\nconst recursiveRemove = (message, deep = 1) => {\n\tif (message) {\n\t\tif ('attachments' in message && deep < RocketChat.settings.get('Message_QuoteChainLimit')) {\n\t\t\tmessage.attachments.map((msg) => recursiveRemove(msg, deep + 1));\n\t\t} else {\n\t\t\tdelete(message.attachments);\n\t\t}\n\t}\n\treturn message;\n};\n\nRocketChat.callbacks.add('beforeSaveMessage', (msg) => {\n\tif (msg && msg.urls) {\n\t\tmsg.urls.forEach((item) => {\n\t\t\tif (item.url.indexOf(Meteor.absoluteUrl()) === 0) {\n\t\t\t\tconst urlObj = URL.parse(item.url);\n\t\t\t\tif (urlObj.query) {\n\t\t\t\t\tconst queryString = QueryString.parse(urlObj.query);\n\t\t\t\t\tif (_.isString(queryString.msg)) { // Jump-to query param\n\t\t\t\t\t\tconst jumpToMessage = recursiveRemove(RocketChat.models.Messages.findOneById(queryString.msg));\n\t\t\t\t\t\tif (jumpToMessage) {\n\t\t\t\t\t\t\tmsg.attachments = msg.attachments || [];\n\t\t\t\t\t\t\tmsg.attachments.push({\n\t\t\t\t\t\t\t\t'text' : jumpToMessage.msg,\n\t\t\t\t\t\t\t\t'translations': jumpToMessage.translations,\n\t\t\t\t\t\t\t\t'author_name' : jumpToMessage.alias || jumpToMessage.u.username,\n\t\t\t\t\t\t\t\t'author_icon' : getAvatarUrlFromUsername(jumpToMessage.u.username),\n\t\t\t\t\t\t\t\t'message_link' : item.url,\n\t\t\t\t\t\t\t\t'attachments' : jumpToMessage.attachments || [],\n\t\t\t\t\t\t\t\t'ts': jumpToMessage.ts\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\titem.ignoreParse = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\treturn msg;\n}, RocketChat.callbacks.priority.LOW, 'jumpToMessage');\n","\nRocketChat.models.OEmbedCache = new class extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('oembed_cache');\n\t\tthis.tryEnsureIndex({ 'updatedAt': 1 });\n\t}\n\n\t//FIND ONE\n\tfindOneById(_id, options) {\n\t\tconst query = {\n\t\t\t_id\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\t//INSERT\n\tcreateWithIdAndData(_id, data) {\n\t\tconst record = {\n\t\t\t_id,\n\t\t\tdata,\n\t\t\tupdatedAt: new Date\n\t\t};\n\t\trecord._id = this.insert(record);\n\t\treturn record;\n\t}\n\n\t//REMOVE\n\tremoveAfterDate(date) {\n\t\tconst query = {\n\t\t\tupdatedAt: {\n\t\t\t\t$lte: date\n\t\t\t}\n\t\t};\n\t\treturn this.remove(query);\n\t}\n};\n\n\n"]}