{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:authorization/lib/rocketchat.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/models/Permissions.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/models/Roles.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/models/Base.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/models/Users.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/models/Subscriptions.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/addUserRoles.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/canAccessRoom.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/getRoles.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/getUsersInRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/hasPermission.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/hasRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/removeUserFromRoles.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/publications/permissions.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/publications/roles.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/publications/usersInRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/addUserToRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/deleteRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/removeUserFromRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/saveRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/addPermissionToRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/removeRoleFromPermission.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/startup.js"],"names":["RocketChat","authz","ModelPermissions","models","_Base","constructor","arguments","findByRole","role","options","query","roles","find","findOneById","_id","findOne","createOrUpdate","name","upsert","$set","addRole","permission","update","$addToSet","removeRole","$pull","Permissions","cache","load","ModelRoles","tryEnsureIndex","findUsersInRole","scope","roleScope","model","findUsersInRoles","isUserInRoles","userId","concat","some","roleName","isUserInRole","description","protectedRole","updateData","protected","addUserRoles","addRolesByUserId","removeUserRoles","removeRolesByUserId","Roles","_","module","watch","require","default","v","prototype","roleBaseQuery","findRolesByUserId","fields","isUndefined","$each","$pullAll","Meteor","Error","Users","$in","Subscriptions","rid","subscriptions","fetch","users","compact","map","subscription","u","roleNames","user","db","function","existingRoleNames","pluck","getRoles","invalidRoleNames","difference","isEmpty","roomAccessValidators","room","t","settings","get","hasPermission","findOneByRoomIdAndUserId","_room","canAccessRoom","validator","call","addRoomAccessValidator","push","getUsersInRole","atLeastOne","permissions","permissionId","all","every","strategy","hasAllPermission","hasAtLeastOnePermission","hasRole","removeUserFromRoles","methods","updatedAt","unblock","records","Date","filter","record","_updatedAt","remove","trashFindDeletedAfter","_deletedAt","on","type","Notifications","notifyLoggedInThisInstance","publish","ready","limit","error","sort","username","method","action","isString","findOneByUsername","add","notifyLogged","existingUsers","count","adminCount","userIsAdmin","indexOf","roleData","includes","startup","defaultRoles","$setOnInsert"],"mappings":"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","file":"/packages/rocketchat_authorization.js","sourcesContent":["RocketChat.authz = {};\n","class ModelPermissions extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper(...arguments);\n\t}\n\n\t// FIND\n\tfindByRole(role, options) {\n\t\tconst query = {\n\t\t\troles: role\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\tfindOneById(_id) {\n\t\treturn this.findOne(_id);\n\t}\n\n\tcreateOrUpdate(name, roles) {\n\t\tthis.upsert({ _id: name }, { $set: { roles } });\n\t}\n\n\taddRole(permission, role) {\n\t\tthis.update({ _id: permission }, { $addToSet: { roles: role } });\n\t}\n\n\tremoveRole(permission, role) {\n\t\tthis.update({ _id: permission }, { $pull: { roles: role } });\n\t}\n}\n\nRocketChat.models.Permissions = new ModelPermissions('permissions', true);\nRocketChat.models.Permissions.cache.load();\n","class ModelRoles extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper(...arguments);\n\t\tthis.tryEnsureIndex({ 'name': 1 });\n\t\tthis.tryEnsureIndex({ 'scope': 1 });\n\t}\n\n\tfindUsersInRole(name, scope, options) {\n\t\tconst role = this.findOne(name);\n\t\tconst roleScope = (role && role.scope) || 'Users';\n\t\tconst model = RocketChat.models[roleScope];\n\n\t\treturn model && model.findUsersInRoles && model.findUsersInRoles(name, scope, options);\n\t}\n\n\tisUserInRoles(userId, roles, scope) {\n\t\troles = [].concat(roles);\n\t\treturn roles.some((roleName) => {\n\t\t\tconst role = this.findOne(roleName);\n\t\t\tconst roleScope = (role && role.scope) || 'Users';\n\t\t\tconst model = RocketChat.models[roleScope];\n\n\t\t\treturn model && model.isUserInRole && model.isUserInRole(userId, roleName, scope);\n\t\t});\n\t}\n\n\tcreateOrUpdate(name, scope = 'Users', description, protectedRole) {\n\t\tconst updateData = {};\n\t\tupdateData.name = name;\n\t\tupdateData.scope = scope;\n\n\t\tif (description != null) {\n\t\t\tupdateData.description = description;\n\t\t}\n\n\t\tif (protectedRole) {\n\t\t\tupdateData.protected = protectedRole;\n\t\t}\n\n\t\tthis.upsert({ _id: name }, { $set: updateData });\n\t}\n\n\taddUserRoles(userId, roles, scope) {\n\t\troles = [].concat(roles);\n\t\tfor (const roleName of roles) {\n\t\t\tconst role = this.findOne(roleName);\n\t\t\tconst roleScope = (role && role.scope) || 'Users';\n\t\t\tconst model = RocketChat.models[roleScope];\n\n\t\t\tmodel && model.addRolesByUserId && model.addRolesByUserId(userId, roleName, scope);\n\t\t}\n\t\treturn true;\n\t}\n\n\tremoveUserRoles(userId, roles, scope) {\n\t\troles = [].concat(roles);\n\t\tfor (const roleName of roles) {\n\t\t\tconst role = this.findOne(roleName);\n\t\t\tconst roleScope = (role && role.scope) || 'Users';\n\t\t\tconst model = RocketChat.models[roleScope];\n\n\t\t\tmodel && model.removeRolesByUserId && model.removeRolesByUserId(userId, roleName, scope);\n\t\t}\n\t\treturn true;\n\t}\n}\n\nRocketChat.models.Roles = new ModelRoles('roles', true);\nRocketChat.models.Roles.cache.load();\n","import _ from 'underscore';\n\nRocketChat.models._Base.prototype.roleBaseQuery = function(/*userId, scope*/) {\n\treturn;\n};\n\nRocketChat.models._Base.prototype.findRolesByUserId = function(userId/*, options*/) {\n\tconst query = this.roleBaseQuery(userId);\n\treturn this.find(query, { fields: { roles: 1 } });\n};\n\nRocketChat.models._Base.prototype.isUserInRole = function(userId, roleName, scope) {\n\tconst query = this.roleBaseQuery(userId, scope);\n\n\tif (query == null) {\n\t\treturn false;\n\t}\n\n\tquery.roles = roleName;\n\treturn !_.isUndefined(this.findOne(query));\n};\n\nRocketChat.models._Base.prototype.addRolesByUserId = function(userId, roles, scope) {\n\troles = [].concat(roles);\n\tconst query = this.roleBaseQuery(userId, scope);\n\tconst update = {\n\t\t$addToSet: {\n\t\t\troles: { $each: roles }\n\t\t}\n\t};\n\treturn this.update(query, update);\n};\n\nRocketChat.models._Base.prototype.removeRolesByUserId = function(userId, roles, scope) {\n\troles = [].concat(roles);\n\tconst query = this.roleBaseQuery(userId, scope);\n\tconst update = {\n\t\t$pullAll: {\n\t\t\troles\n\t\t}\n\t};\n\treturn this.update(query, update);\n};\n\nRocketChat.models._Base.prototype.findUsersInRoles = function() {\n\tthrow new Meteor.Error('overwrite-function', 'You must overwrite this function in the extended classes');\n};\n","RocketChat.models.Users.roleBaseQuery = function(userId) {\n\treturn { _id: userId };\n};\n\nRocketChat.models.Users.findUsersInRoles = function(roles, scope, options) {\n\troles = [].concat(roles);\n\n\tconst query = {\n\t\troles: { $in: roles }\n\t};\n\n\treturn this.find(query, options);\n};\n","import _ from 'underscore';\n\nRocketChat.models.Subscriptions.roleBaseQuery = function(userId, scope) {\n\tif (scope == null) {\n\t\treturn;\n\t}\n\n\tconst query = { 'u._id': userId };\n\tif (!_.isUndefined(scope)) {\n\t\tquery.rid = scope;\n\t}\n\treturn query;\n};\n\nRocketChat.models.Subscriptions.findUsersInRoles = function(roles, scope, options) {\n\troles = [].concat(roles);\n\n\tconst query = {\n\t\troles: { $in: roles }\n\t};\n\n\tif (scope) {\n\t\tquery.rid = scope;\n\t}\n\n\tconst subscriptions = this.find(query).fetch();\n\n\tconst users = _.compact(_.map(subscriptions, function(subscription) {\n\t\tif ('undefined' !== typeof subscription.u && 'undefined' !== typeof subscription.u._id) {\n\t\t\treturn subscription.u._id;\n\t\t}\n\t}));\n\n\treturn RocketChat.models.Users.find({ _id: { $in: users } }, options);\n};\n","import _ from 'underscore';\n\nRocketChat.authz.addUserRoles = function(userId, roleNames, scope) {\n\tif (!userId || !roleNames) {\n\t\treturn false;\n\t}\n\n\tconst user = RocketChat.models.Users.db.findOneById(userId);\n\tif (!user) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\tfunction: 'RocketChat.authz.addUserRoles'\n\t\t});\n\t}\n\n\troleNames = [].concat(roleNames);\n\tconst existingRoleNames = _.pluck(RocketChat.authz.getRoles(), '_id');\n\tconst invalidRoleNames = _.difference(roleNames, existingRoleNames);\n\n\tif (!_.isEmpty(invalidRoleNames)) {\n\t\tfor (const role of invalidRoleNames) {\n\t\t\tRocketChat.models.Roles.createOrUpdate(role);\n\t\t}\n\t}\n\n\tRocketChat.models.Roles.addUserRoles(userId, roleNames, scope);\n\n\treturn true;\n};\n","/* globals RocketChat */\nRocketChat.authz.roomAccessValidators = [\n\tfunction(room, user = {}) {\n\t\tif (room.t === 'c') {\n\t\t\tif (!user._id && RocketChat.settings.get('Accounts_AllowAnonymousRead') === true) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\treturn RocketChat.authz.hasPermission(user._id, 'view-c-room');\n\t\t}\n\t},\n\tfunction(room, user = {}) {\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(room._id, user._id);\n\t\tif (subscription) {\n\t\t\treturn subscription._room;\n\t\t}\n\t}\n];\n\nRocketChat.authz.canAccessRoom = function(room, user) {\n\treturn RocketChat.authz.roomAccessValidators.some((validator) => {\n\t\treturn validator.call(this, room, user);\n\t});\n};\n\nRocketChat.authz.addRoomAccessValidator = function(validator) {\n\tRocketChat.authz.roomAccessValidators.push(validator);\n};\n","RocketChat.authz.getRoles = function() {\n\treturn RocketChat.models.Roles.find().fetch();\n};\n","RocketChat.authz.getUsersInRole = function(roleName, scope, options) {\n\treturn RocketChat.models.Roles.findUsersInRole(roleName, scope, options);\n};\n","function atLeastOne(userId, permissions = [], scope) {\n\treturn permissions.some((permissionId) => {\n\t\tconst permission = RocketChat.models.Permissions.findOne(permissionId);\n\t\treturn RocketChat.models.Roles.isUserInRoles(userId, permission.roles, scope);\n\t});\n}\n\nfunction all(userId, permissions = [], scope) {\n\treturn permissions.every((permissionId) => {\n\t\tconst permission = RocketChat.models.Permissions.findOne(permissionId);\n\t\treturn RocketChat.models.Roles.isUserInRoles(userId, permission.roles, scope);\n\t});\n}\n\nfunction hasPermission(userId, permissions, scope, strategy) {\n\tif (!userId) {\n\t\treturn false;\n\t}\n\n\tpermissions = [].concat(permissions);\n\treturn strategy(userId, permissions, scope);\n}\n\nRocketChat.authz.hasAllPermission = function(userId, permissions, scope) {\n\treturn hasPermission(userId, permissions, scope, all);\n};\n\nRocketChat.authz.hasPermission = RocketChat.authz.hasAllPermission;\n\nRocketChat.authz.hasAtLeastOnePermission = function(userId, permissions, scope) {\n\treturn hasPermission(userId, permissions, scope, atLeastOne);\n};\n","RocketChat.authz.hasRole = function(userId, roleNames, scope) {\n\troleNames = [].concat(roleNames);\n\treturn RocketChat.models.Roles.isUserInRoles(userId, roleNames, scope);\n};\n","import _ from 'underscore';\n\nRocketChat.authz.removeUserFromRoles = function(userId, roleNames, scope) {\n\tif (!userId || !roleNames) {\n\t\treturn false;\n\t}\n\n\tconst user = RocketChat.models.Users.findOneById(userId);\n\n\tif (!user) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\tfunction: 'RocketChat.authz.removeUserFromRoles'\n\t\t});\n\t}\n\n\troleNames = [].concat(roleNames);\n\tconst existingRoleNames = _.pluck(RocketChat.authz.getRoles(), '_id');\n\tconst invalidRoleNames = _.difference(roleNames, existingRoleNames);\n\n\tif (!_.isEmpty(invalidRoleNames)) {\n\t\tthrow new Meteor.Error('error-invalid-role', 'Invalid role', {\n\t\t\tfunction: 'RocketChat.authz.removeUserFromRoles'\n\t\t});\n\t}\n\n\tRocketChat.models.Roles.removeUserRoles(userId, roleNames, scope);\n\n\treturn true;\n};\n","Meteor.methods({\n\t'permissions/get'(updatedAt) {\n\t\tthis.unblock();\n\n\t\tconst records = RocketChat.models.Permissions.find().fetch();\n\n\t\tif (updatedAt instanceof Date) {\n\t\t\treturn {\n\t\t\t\tupdate: records.filter((record) => {\n\t\t\t\t\treturn record._updatedAt > updatedAt;\n\t\t\t\t}),\n\t\t\t\tremove: RocketChat.models.Permissions.trashFindDeletedAfter(updatedAt, {}, {fields: {_id: 1, _deletedAt: 1}}).fetch()\n\t\t\t};\n\t\t}\n\n\t\treturn records;\n\t}\n});\n\n\nRocketChat.models.Permissions.on('changed', (type, permission) => {\n\tRocketChat.Notifications.notifyLoggedInThisInstance('permissions-changed', type, permission);\n});\n","Meteor.publish('roles', function() {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\treturn RocketChat.models.Roles.find();\n});\n","Meteor.publish('usersInRole', function(roleName, scope, limit = 50) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'access-permissions')) {\n\t\treturn this.error(new Meteor.Error('error-not-allowed', 'Not allowed', {\n\t\t\tpublish: 'usersInRole'\n\t\t}));\n\t}\n\n\tconst options = {\n\t\tlimit,\n\t\tsort: {\n\t\t\tname: 1\n\t\t}\n\t};\n\n\treturn RocketChat.authz.getUsersInRole(roleName, scope, options);\n});\n","import _ from 'underscore';\n\nMeteor.methods({\n\t'authorization:addUserToRole'(roleName, username, scope) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Accessing permissions is not allowed', {\n\t\t\t\tmethod: 'authorization:addUserToRole',\n\t\t\t\taction: 'Accessing_permissions'\n\t\t\t});\n\t\t}\n\n\t\tif (!roleName || !_.isString(roleName) || !username || !_.isString(username)) {\n\t\t\tthrow new Meteor.Error('error-invalid-arguments', 'Invalid arguments', {\n\t\t\t\tmethod: 'authorization:addUserToRole'\n\t\t\t});\n\t\t}\n\n\t\tif (roleName === 'admin' && !RocketChat.authz.hasPermission(Meteor.userId(), 'assign-admin-role')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Assigning admin is not allowed', {\n\t\t\t\tmethod: 'authorization:addUserToRole',\n\t\t\t\taction: 'Assign_admin'\n\t\t\t});\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, {\n\t\t\tfields: {\n\t\t\t\t_id: 1\n\t\t\t}\n\t\t});\n\n\t\tif (!user || !user._id) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'authorization:addUserToRole'\n\t\t\t});\n\t\t}\n\n\t\tconst add = RocketChat.models.Roles.addUserRoles(user._id, roleName, scope);\n\n\t\tif (RocketChat.settings.get('UI_DisplayRoles')) {\n\t\t\tRocketChat.Notifications.notifyLogged('roles-change', {\n\t\t\t\ttype: 'added',\n\t\t\t\t_id: roleName,\n\t\t\t\tu: {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tusername\n\t\t\t\t},\n\t\t\t\tscope\n\t\t\t});\n\t\t}\n\n\t\treturn add;\n\t}\n});\n","Meteor.methods({\n\t'authorization:deleteRole'(roleName) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Accessing permissions is not allowed', {\n\t\t\t\tmethod: 'authorization:deleteRole',\n\t\t\t\taction: 'Accessing_permissions'\n\t\t\t});\n\t\t}\n\n\t\tconst role = RocketChat.models.Roles.findOne(roleName);\n\t\tif (!role) {\n\t\t\tthrow new Meteor.Error('error-invalid-role', 'Invalid role', {\n\t\t\t\tmethod: 'authorization:deleteRole'\n\t\t\t});\n\t\t}\n\n\t\tif (role.protected) {\n\t\t\tthrow new Meteor.Error('error-delete-protected-role', 'Cannot delete a protected role', {\n\t\t\t\tmethod: 'authorization:deleteRole'\n\t\t\t});\n\t\t}\n\n\t\tconst roleScope = role.scope || 'Users';\n\t\tconst model = RocketChat.models[roleScope];\n\t\tconst existingUsers = model && model.findUsersInRoles && model.findUsersInRoles(roleName);\n\n\t\tif (existingUsers && existingUsers.count() > 0) {\n\t\t\tthrow new Meteor.Error('error-role-in-use', 'Cannot delete role because it\\'s in use', {\n\t\t\t\tmethod: 'authorization:deleteRole'\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.models.Roles.remove(role.name);\n\t}\n});\n","import _ from 'underscore';\n\nMeteor.methods({\n\t'authorization:removeUserFromRole'(roleName, username, scope) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Access permissions is not allowed', {\n\t\t\t\tmethod: 'authorization:removeUserFromRole',\n\t\t\t\taction: 'Accessing_permissions'\n\t\t\t});\n\t\t}\n\n\t\tif (!roleName || !_.isString(roleName) || !username || !_.isString(username)) {\n\t\t\tthrow new Meteor.Error('error-invalid-arguments', 'Invalid arguments', {\n\t\t\t\tmethod: 'authorization:removeUserFromRole'\n\t\t\t});\n\t\t}\n\n\t\tconst user = Meteor.users.findOne({\n\t\t\tusername\n\t\t}, {\n\t\t\tfields: {\n\t\t\t\t_id: 1,\n\t\t\t\troles: 1\n\t\t\t}\n\t\t});\n\n\t\tif (!user || !user._id) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'authorization:removeUserFromRole'\n\t\t\t});\n\t\t}\n\n\t\t// prevent removing last user from admin role\n\t\tif (roleName === 'admin') {\n\t\t\tconst adminCount = Meteor.users.find({\n\t\t\t\troles: {\n\t\t\t\t\t$in: ['admin']\n\t\t\t\t}\n\t\t\t}).count();\n\n\t\t\tconst userIsAdmin = user.roles.indexOf('admin') > -1;\n\t\t\tif (adminCount === 1 && userIsAdmin) {\n\t\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Leaving the app without admins is not allowed', {\n\t\t\t\t\tmethod: 'removeUserFromRole',\n\t\t\t\t\taction: 'Remove_last_admin'\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tconst remove = RocketChat.models.Roles.removeUserRoles(user._id, roleName, scope);\n\t\tif (RocketChat.settings.get('UI_DisplayRoles')) {\n\t\t\tRocketChat.Notifications.notifyLogged('roles-change', {\n\t\t\t\ttype: 'removed',\n\t\t\t\t_id: roleName,\n\t\t\t\tu: {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tusername\n\t\t\t\t},\n\t\t\t\tscope\n\t\t\t});\n\t\t}\n\n\t\treturn remove;\n\t}\n});\n","Meteor.methods({\n\t'authorization:saveRole'(roleData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Accessing permissions is not allowed', {\n\t\t\t\tmethod: 'authorization:saveRole',\n\t\t\t\taction: 'Accessing_permissions'\n\t\t\t});\n\t\t}\n\n\t\tif (!roleData.name) {\n\t\t\tthrow new Meteor.Error('error-role-name-required', 'Role name is required', {\n\t\t\t\tmethod: 'authorization:saveRole'\n\t\t\t});\n\t\t}\n\n\t\tif (['Users', 'Subscriptions'].includes(roleData.scope) === false) {\n\t\t\troleData.scope = 'Users';\n\t\t}\n\n\t\tconst update = RocketChat.models.Roles.createOrUpdate(roleData.name, roleData.scope, roleData.description);\n\t\tif (RocketChat.settings.get('UI_DisplayRoles')) {\n\t\t\tRocketChat.Notifications.notifyLogged('roles-change', {\n\t\t\t\ttype: 'changed',\n\t\t\t\t_id: roleData.name\n\t\t\t});\n\t\t}\n\n\t\treturn update;\n\t}\n});\n","Meteor.methods({\n\t'authorization:addPermissionToRole'(permission, role) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Adding permission is not allowed', {\n\t\t\t\tmethod: 'authorization:addPermissionToRole',\n\t\t\t\taction: 'Adding_permission'\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.models.Permissions.addRole(permission, role);\n\t}\n});\n","Meteor.methods({\n\t'authorization:removeRoleFromPermission'(permission, role) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Accessing permissions is not allowed', {\n\t\t\t\tmethod: 'authorization:removeRoleFromPermission',\n\t\t\t\taction: 'Accessing_permissions'\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.models.Permissions.removeRole(permission, role);\n\t}\n});\n","/* eslint no-multi-spaces: 0 */\n\nMeteor.startup(function() {\n\t// Note:\n\t// 1.if we need to create a role that can only edit channel message, but not edit group message\n\t// then we can define edit-<type>-message instead of edit-message\n\t// 2. admin, moderator, and user roles should not be deleted as they are referened in the code.\n\tconst permissions = [\n\t\t{ _id: 'access-permissions',            roles : ['admin'] },\n\t\t{ _id: 'add-oauth-service',             roles : ['admin'] },\n\t\t{ _id: 'add-user-to-joined-room',       roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'add-user-to-any-c-room',        roles : ['admin'] },\n\t\t{ _id: 'add-user-to-any-p-room',        roles : [] },\n\t\t{ _id: 'archive-room',                  roles : ['admin', 'owner'] },\n\t\t{ _id: 'assign-admin-role',             roles : ['admin'] },\n\t\t{ _id: 'ban-user',                      roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'bulk-create-c',                 roles : ['admin'] },\n\t\t{ _id: 'bulk-register-user',            roles : ['admin'] },\n\t\t{ _id: 'create-c',                      roles : ['admin', 'user', 'bot'] },\n\t\t{ _id: 'create-d',                      roles : ['admin', 'user', 'bot'] },\n\t\t{ _id: 'create-p',                      roles : ['admin', 'user', 'bot'] },\n\t\t{ _id: 'create-user',                   roles : ['admin'] },\n\t\t{ _id: 'clean-channel-history',         roles : ['admin'] }, // special permission to bulk delete a channel's mesages\n\t\t{ _id: 'delete-c',                      roles : ['admin'] },\n\t\t{ _id: 'delete-d',                      roles : ['admin'] },\n\t\t{ _id: 'delete-message',                roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'delete-p',                      roles : ['admin'] },\n\t\t{ _id: 'delete-user',                   roles : ['admin'] },\n\t\t{ _id: 'edit-message',                  roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'edit-other-user-active-status', roles : ['admin'] },\n\t\t{ _id: 'edit-other-user-info',          roles : ['admin'] },\n\t\t{ _id: 'edit-other-user-password',      roles : ['admin'] },\n\t\t{ _id: 'edit-privileged-setting',       roles : ['admin'] },\n\t\t{ _id: 'edit-room',                     roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'force-delete-message',          roles : ['admin', 'owner'] },\n\t\t{ _id: 'join-without-join-code',        roles : ['admin', 'bot'] },\n\t\t{ _id: 'manage-assets',                 roles : ['admin'] },\n\t\t{ _id: 'manage-emoji',                  roles : ['admin'] },\n\t\t{ _id: 'manage-integrations',           roles : ['admin'] },\n\t\t{ _id: 'manage-own-integrations',       roles : ['admin', 'bot'] },\n\t\t{ _id: 'manage-oauth-apps',             roles : ['admin'] },\n\t\t{ _id: 'mention-all',                   roles : ['admin', 'owner', 'moderator', 'user'] },\n\t\t{ _id: 'mute-user',                     roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'remove-user',                   roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'run-import',                    roles : ['admin'] },\n\t\t{ _id: 'run-migration',                 roles : ['admin'] },\n\t\t{ _id: 'set-moderator',                 roles : ['admin', 'owner'] },\n\t\t{ _id: 'set-owner',                     roles : ['admin', 'owner'] },\n\t\t{ _id: 'send-many-messages',            roles : ['admin', 'bot'] },\n\t\t{ _id: 'set-leader',                    roles : ['admin', 'owner'] },\n\t\t{ _id: 'unarchive-room',                roles : ['admin'] },\n\t\t{ _id: 'view-c-room',                   roles : ['admin', 'user', 'bot', 'anonymous'] },\n\t\t{ _id: 'user-generate-access-token',    roles : ['admin'] },\n\t\t{ _id: 'view-d-room',                   roles : ['admin', 'user', 'bot'] },\n\t\t{ _id: 'view-full-other-user-info',     roles : ['admin'] },\n\t\t{ _id: 'view-history',                  roles : ['admin', 'user', 'anonymous'] },\n\t\t{ _id: 'view-joined-room',              roles : ['guest', 'bot', 'anonymous'] },\n\t\t{ _id: 'view-join-code',                roles : ['admin'] },\n\t\t{ _id: 'view-logs',                     roles : ['admin'] },\n\t\t{ _id: 'view-other-user-channels',      roles : ['admin'] },\n\t\t{ _id: 'view-p-room',                   roles : ['admin', 'user', 'anonymous'] },\n\t\t{ _id: 'view-privileged-setting',       roles : ['admin'] },\n\t\t{ _id: 'view-room-administration',      roles : ['admin'] },\n\t\t{ _id: 'view-statistics',               roles : ['admin'] },\n\t\t{ _id: 'view-user-administration',      roles : ['admin'] },\n\t\t{ _id: 'preview-c-room',                roles : ['admin', 'user', 'anonymous'] },\n\t\t{ _id: 'view-outside-room',             roles : ['admin', 'owner', 'moderator', 'user'] }\n\t];\n\n\tfor (const permission of permissions) {\n\t\tif (!RocketChat.models.Permissions.findOneById(permission._id)) {\n\t\t\tRocketChat.models.Permissions.upsert(permission._id, {$set: permission });\n\t\t}\n\t}\n\n\tconst defaultRoles = [\n\t\t{ name: 'admin',     scope: 'Users',         description: 'Admin' },\n\t\t{ name: 'moderator', scope: 'Subscriptions', description: 'Moderator' },\n\t\t{ name: 'leader',    scope: 'Subscriptions', description: 'Leader' },\n\t\t{ name: 'owner',     scope: 'Subscriptions', description: 'Owner' },\n\t\t{ name: 'user',      scope: 'Users',         description: '' },\n\t\t{ name: 'bot',       scope: 'Users',         description: '' },\n\t\t{ name: 'guest',     scope: 'Users',         description: '' },\n\t\t{ name: 'anonymous', scope: 'Users',         description: '' }\n\t];\n\n\tfor (const role of defaultRoles) {\n\t\tRocketChat.models.Roles.upsert({ _id: role.name }, { $setOnInsert: { scope: role.scope, description: role.description || '', protected: true } });\n\t}\n});\n"]}