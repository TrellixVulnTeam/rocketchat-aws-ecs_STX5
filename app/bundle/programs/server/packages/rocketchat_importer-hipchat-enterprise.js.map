{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:importer-hipchat-enterprise/info.js","meteor://ðŸ’»app/packages/rocketchat:importer-hipchat-enterprise/server/importer.js","meteor://ðŸ’»app/packages/rocketchat:importer-hipchat-enterprise/server/adder.js"],"names":["module","export","HipChatEnterpriseImporterInfo","ImporterInfo","watch","require","v","constructor","text","href","HipChatEnterpriseImporter","Base","ProgressStep","Selection","SelectionChannel","SelectionUser","info","Readable","zlib","tarStream","Npm","extract","path","messages","Map","directMessages","prepare","dataURI","sentContentType","fileName","tempUsers","tempRooms","tempMessages","tempDirectMessages","promise","Promise","resolve","reject","on","Meteor","bindEnvironment","header","stream","next","name","indexOf","parse","chunk","logger","debug","file","JSON","base","updateProgress","PREPARING_USERS","u","push","id","User","email","username","mention_name","avatar","replace","timezone","isDeleted","is_deleted","PREPARING_CHANNELS","r","Room","creator","owner","created","Date","toLowerCase","isPrivate","privacy","isArchived","is_archived","topic","dirSplit","dir","split","roomIdentifier","msgs","m","PrivateUserMessage","type","senderId","sender","receiverId","receiver","message","ts","timestamp","set","roomMsgs","UserMessage","userId","TopicRoomMessage","warn","err","usersId","collection","insert","importRecord","_id","users","findOne","updateRecord","length","addCountToTotal","channelsId","channels","PREPARING_MESSAGES","messagesCount","channel","entries","get","getBSONSize","getMaxBSONSize","getBSONSafeArraysFromAnArray","forEach","splitMsg","i","messagesId","directMsgUser","ERROR","selectionUsers","map","selectionChannels","selectionMessages","count","USER_SELECTION","s","Buffer","pipe","createGunzip","startImport","importSelection","started","now","user","user_id","do_import","update","$set","c","channel_id","startedByUserId","defer","IMPORTING_USERS","runAsUser","existantUser","RocketChat","models","Users","findOneByEmailAddress","findOneByUsername","rocketId","$addToSet","importIds","Accounts","createUser","password","toUpperCase","call","joinDefaultChannelsSilenced","setName","deleted","addCountCompleted","IMPORTING_CHANNELS","existantRoom","Rooms","findOneByName","creatorId","roomInfo","rid","IMPORTING_MESSAGES","ch","messagesMap","hipChannel","getChannelFromRoomIdentifier","room","findOneById","fields","usernames","t","msgGroupData","msg","isNaN","getRocketUserFromUserId","sendMessage","Messages","createRoomSettingsChangedWithTypeRoomIdMessageAndUser","directMsgRoom","directMessagesMap","hipUser","getUserFromDirectMessageIdentifier","sort","join","FINISHING","DONE","e","error","timeTook","log","getProgress","getSelection","directIdentifier","Importers","add"],"mappings":"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","file":"/packages/rocketchat_importer-hipchat-enterprise.js","sourcesContent":["import { ImporterInfo } from 'meteor/rocketchat:importer';\n\nexport class HipChatEnterpriseImporterInfo extends ImporterInfo {\n\tconstructor() {\n\t\tsuper('hipchatenterprise', 'HipChat Enterprise', 'application/gzip', [\n\t\t\t{\n\t\t\t\ttext: 'Importer_HipChatEnterprise_Information',\n\t\t\t\thref: 'https://rocket.chat/docs/administrator-guides/import/hipchat/enterprise/'\n\t\t\t}, {\n\t\t\t\ttext: 'Importer_HipChatEnterprise_BetaWarning',\n\t\t\t\thref: 'https://github.com/RocketChat/Rocket.Chat/issues/new'\n\t\t\t}\n\t\t]);\n\t}\n}\n","import {\n\tBase,\n\tProgressStep,\n\tSelection,\n\tSelectionChannel,\n\tSelectionUser\n} from 'meteor/rocketchat:importer';\n\nexport class HipChatEnterpriseImporter extends Base {\n\tconstructor(info) {\n\t\tsuper(info);\n\n\t\tthis.Readable = require('stream').Readable;\n\t\tthis.zlib = require('zlib');\n\t\tthis.tarStream = Npm.require('tar-stream');\n\t\tthis.extract = this.tarStream.extract();\n\t\tthis.path = require('path');\n\t\tthis.messages = new Map();\n\t\tthis.directMessages = new Map();\n\t}\n\n\tprepare(dataURI, sentContentType, fileName) {\n\t\tsuper.prepare(dataURI, sentContentType, fileName);\n\n\t\tconst tempUsers = [];\n\t\tconst tempRooms = [];\n\t\tconst tempMessages = new Map();\n\t\tconst tempDirectMessages = new Map();\n\t\tconst promise = new Promise((resolve, reject) => {\n\t\t\tthis.extract.on('entry', Meteor.bindEnvironment((header, stream, next) => {\n\t\t\t\tif (header.name.indexOf('.json') !== -1) {\n\t\t\t\t\tconst info = this.path.parse(header.name);\n\n\t\t\t\t\tstream.on('data', Meteor.bindEnvironment((chunk) => {\n\t\t\t\t\t\tthis.logger.debug(`Processing the file: ${ header.name }`);\n\t\t\t\t\t\tconst file = JSON.parse(chunk);\n\n\t\t\t\t\t\tif (info.base === 'users.json') {\n\t\t\t\t\t\t\tsuper.updateProgress(ProgressStep.PREPARING_USERS);\n\t\t\t\t\t\t\tfor (const u of file) {\n\t\t\t\t\t\t\t\ttempUsers.push({\n\t\t\t\t\t\t\t\t\tid: u.User.id,\n\t\t\t\t\t\t\t\t\temail: u.User.email,\n\t\t\t\t\t\t\t\t\tname: u.User.name,\n\t\t\t\t\t\t\t\t\tusername: u.User.mention_name,\n\t\t\t\t\t\t\t\t\tavatar: u.User.avatar.replace(/\\n/g, ''),\n\t\t\t\t\t\t\t\t\ttimezone: u.User.timezone,\n\t\t\t\t\t\t\t\t\tisDeleted: u.User.is_deleted\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (info.base === 'rooms.json') {\n\t\t\t\t\t\t\tsuper.updateProgress(ProgressStep.PREPARING_CHANNELS);\n\t\t\t\t\t\t\tfor (const r of file) {\n\t\t\t\t\t\t\t\ttempRooms.push({\n\t\t\t\t\t\t\t\t\tid: r.Room.id,\n\t\t\t\t\t\t\t\t\tcreator: r.Room.owner,\n\t\t\t\t\t\t\t\t\tcreated: new Date(r.Room.created),\n\t\t\t\t\t\t\t\t\tname: r.Room.name.replace(/ /g, '_').toLowerCase(),\n\t\t\t\t\t\t\t\t\tisPrivate: r.Room.privacy === 'private',\n\t\t\t\t\t\t\t\t\tisArchived: r.Room.is_archived,\n\t\t\t\t\t\t\t\t\ttopic: r.Room.topic\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (info.base === 'history.json') {\n\t\t\t\t\t\t\tconst dirSplit = info.dir.split('/'); //['.', 'users', '1']\n\t\t\t\t\t\t\tconst roomIdentifier = `${ dirSplit[1] }/${ dirSplit[2] }`;\n\n\t\t\t\t\t\t\tif (dirSplit[1] === 'users') {\n\t\t\t\t\t\t\t\tconst msgs = [];\n\t\t\t\t\t\t\t\tfor (const m of file) {\n\t\t\t\t\t\t\t\t\tif (m.PrivateUserMessage) {\n\t\t\t\t\t\t\t\t\t\tmsgs.push({\n\t\t\t\t\t\t\t\t\t\t\ttype: 'user',\n\t\t\t\t\t\t\t\t\t\t\tid: `hipchatenterprise-${ m.PrivateUserMessage.id }`,\n\t\t\t\t\t\t\t\t\t\t\tsenderId: m.PrivateUserMessage.sender.id,\n\t\t\t\t\t\t\t\t\t\t\treceiverId: m.PrivateUserMessage.receiver.id,\n\t\t\t\t\t\t\t\t\t\t\ttext: m.PrivateUserMessage.message.indexOf('/me ') === -1 ? m.PrivateUserMessage.message : `${ m.PrivateUserMessage.message.replace(/\\/me /, '_') }_`,\n\t\t\t\t\t\t\t\t\t\t\tts: new Date(m.PrivateUserMessage.timestamp.split(' ')[0])\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\ttempDirectMessages.set(roomIdentifier, msgs);\n\t\t\t\t\t\t\t} else if (dirSplit[1] === 'rooms') {\n\t\t\t\t\t\t\t\tconst roomMsgs = [];\n\n\t\t\t\t\t\t\t\tfor (const m of file) {\n\t\t\t\t\t\t\t\t\tif (m.UserMessage) {\n\t\t\t\t\t\t\t\t\t\troomMsgs.push({\n\t\t\t\t\t\t\t\t\t\t\ttype: 'user',\n\t\t\t\t\t\t\t\t\t\t\tid: `hipchatenterprise-${ dirSplit[2] }-${ m.UserMessage.id }`,\n\t\t\t\t\t\t\t\t\t\t\tuserId: m.UserMessage.sender.id,\n\t\t\t\t\t\t\t\t\t\t\ttext: m.UserMessage.message.indexOf('/me ') === -1 ? m.UserMessage.message : `${ m.UserMessage.message.replace(/\\/me /, '_') }_`,\n\t\t\t\t\t\t\t\t\t\t\tts: new Date(m.UserMessage.timestamp.split(' ')[0])\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t} else if (m.TopicRoomMessage) {\n\t\t\t\t\t\t\t\t\t\troomMsgs.push({\n\t\t\t\t\t\t\t\t\t\t\ttype: 'topic',\n\t\t\t\t\t\t\t\t\t\t\tid: `hipchatenterprise-${ dirSplit[2] }-${ m.TopicRoomMessage.id }`,\n\t\t\t\t\t\t\t\t\t\t\tuserId: m.TopicRoomMessage.sender.id,\n\t\t\t\t\t\t\t\t\t\t\tts: new Date(m.TopicRoomMessage.timestamp.split(' ')[0]),\n\t\t\t\t\t\t\t\t\t\t\ttext: m.TopicRoomMessage.message\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tthis.logger.warn('HipChat Enterprise importer isn\\'t configured to handle this message:', m);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\ttempMessages.set(roomIdentifier, roomMsgs);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthis.logger.warn(`HipChat Enterprise importer isn't configured to handle \"${ dirSplit[1] }\" files.`);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t//What are these files!?\n\t\t\t\t\t\t\tthis.logger.warn(`HipChat Enterprise importer doesn't know what to do with the file \"${ header.name }\" :o`, info);\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\n\t\t\t\t\tstream.on('end', () => next());\n\t\t\t\t\tstream.on('error', () => next());\n\t\t\t\t} else {\n\t\t\t\t\tnext();\n\t\t\t\t}\n\t\t\t}));\n\n\t\t\tthis.extract.on('error', (err) => {\n\t\t\t\tthis.logger.warn('extract error:', err);\n\t\t\t\treject();\n\t\t\t});\n\n\t\t\tthis.extract.on('finish', Meteor.bindEnvironment(() => {\n\t\t\t\t// Insert the users record, eventually this might have to be split into several ones as well\n\t\t\t\t// if someone tries to import a several thousands users instance\n\t\t\t\tconst usersId = this.collection.insert({ 'import': this.importRecord._id, 'importer': this.name, 'type': 'users', 'users': tempUsers });\n\t\t\t\tthis.users = this.collection.findOne(usersId);\n\t\t\t\tsuper.updateRecord({ 'count.users': tempUsers.length });\n\t\t\t\tsuper.addCountToTotal(tempUsers.length);\n\n\t\t\t\t// Insert the channels records.\n\t\t\t\tconst channelsId = this.collection.insert({ 'import': this.importRecord._id, 'importer': this.name, 'type': 'channels', 'channels': tempRooms });\n\t\t\t\tthis.channels = this.collection.findOne(channelsId);\n\t\t\t\tsuper.updateRecord({ 'count.channels': tempRooms.length });\n\t\t\t\tsuper.addCountToTotal(tempRooms.length);\n\n\t\t\t\t// Save the messages records to the import record for `startImport` usage\n\t\t\t\tsuper.updateProgress(ProgressStep.PREPARING_MESSAGES);\n\t\t\t\tlet messagesCount = 0;\n\t\t\t\tfor (const [channel, msgs] of tempMessages.entries()) {\n\t\t\t\t\tif (!this.messages.get(channel)) {\n\t\t\t\t\t\tthis.messages.set(channel, new Map());\n\t\t\t\t\t}\n\n\t\t\t\t\tmessagesCount += msgs.length;\n\t\t\t\t\tsuper.updateRecord({ 'messagesstatus': channel });\n\n\t\t\t\t\tif (Base.getBSONSize(msgs) > Base.getMaxBSONSize()) {\n\t\t\t\t\t\tBase.getBSONSafeArraysFromAnArray(msgs).forEach((splitMsg, i) => {\n\t\t\t\t\t\t\tconst messagesId = this.collection.insert({ 'import': this.importRecord._id, 'importer': this.name, 'type': 'messages', 'name': `${ channel }/${ i }`, 'messages': splitMsg });\n\t\t\t\t\t\t\tthis.messages.get(channel).set(`${ channel }.${ i }`, this.collection.findOne(messagesId));\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst messagesId = this.collection.insert({ 'import': this.importRecord._id, 'importer': this.name, 'type': 'messages', 'name': `${ channel }`, 'messages': msgs });\n\t\t\t\t\t\tthis.messages.get(channel).set(channel, this.collection.findOne(messagesId));\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tfor (const [directMsgUser, msgs] of tempDirectMessages.entries()) {\n\t\t\t\t\tthis.logger.debug(`Preparing the direct messages for: ${ directMsgUser }`);\n\t\t\t\t\tif (!this.directMessages.get(directMsgUser)) {\n\t\t\t\t\t\tthis.directMessages.set(directMsgUser, new Map());\n\t\t\t\t\t}\n\n\t\t\t\t\tmessagesCount += msgs.length;\n\t\t\t\t\tsuper.updateRecord({ 'messagesstatus': directMsgUser });\n\n\t\t\t\t\tif (Base.getBSONSize(msgs) > Base.getMaxBSONSize()) {\n\t\t\t\t\t\tBase.getBSONSafeArraysFromAnArray(msgs).forEach((splitMsg, i) => {\n\t\t\t\t\t\t\tconst messagesId = this.collection.insert({ 'import': this.importRecord._id, 'importer': this.name, 'type': 'directMessages', 'name': `${ directMsgUser }/${ i }`, 'messages': splitMsg });\n\t\t\t\t\t\t\tthis.directMessages.get(directMsgUser).set(`${ directMsgUser }.${ i }`, this.collection.findOne(messagesId));\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst messagesId = this.collection.insert({ 'import': this.importRecord._id, 'importer': this.name, 'type': 'directMessages', 'name': `${ directMsgUser }`, 'messages': msgs });\n\t\t\t\t\t\tthis.directMessages.get(directMsgUser).set(directMsgUser, this.collection.findOne(messagesId));\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tsuper.updateRecord({ 'count.messages': messagesCount, 'messagesstatus': null });\n\t\t\t\tsuper.addCountToTotal(messagesCount);\n\n\t\t\t\t//Ensure we have some users, channels, and messages\n\t\t\t\tif (tempUsers.length === 0 || tempRooms.length === 0 || messagesCount === 0) {\n\t\t\t\t\tthis.logger.warn(`The loaded users count ${ tempUsers.length }, the loaded rooms ${ tempRooms.length }, and the loaded messages ${ messagesCount }`);\n\t\t\t\t\tsuper.updateProgress(ProgressStep.ERROR);\n\t\t\t\t\treject();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst selectionUsers = tempUsers.map((u) => new SelectionUser(u.id, u.username, u.email, u.isDeleted, false, true));\n\t\t\t\tconst selectionChannels = tempRooms.map((r) => new SelectionChannel(r.id, r.name, r.isArchived, true, r.isPrivate));\n\t\t\t\tconst selectionMessages = this.importRecord.count.messages;\n\n\t\t\t\tsuper.updateProgress(ProgressStep.USER_SELECTION);\n\n\t\t\t\tresolve(new Selection(this.name, selectionUsers, selectionChannels, selectionMessages));\n\t\t\t}));\n\n\t\t\t//Wish I could make this cleaner :(\n\t\t\tconst split = dataURI.split(',');\n\t\t\tconst s = new this.Readable;\n\t\t\ts.push(new Buffer(split[split.length - 1], 'base64'));\n\t\t\ts.push(null);\n\t\t\ts.pipe(this.zlib.createGunzip()).pipe(this.extract);\n\t\t});\n\n\t\treturn promise;\n\t}\n\n\tstartImport(importSelection) {\n\t\tsuper.startImport(importSelection);\n\t\tconst started = Date.now();\n\n\t\t//Ensure we're only going to import the users that the user has selected\n\t\tfor (const user of importSelection.users) {\n\t\t\tfor (const u of this.users.users) {\n\t\t\t\tif (u.id === user.user_id) {\n\t\t\t\t\tu.do_import = user.do_import;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthis.collection.update({ _id: this.users._id }, { $set: { 'users': this.users.users }});\n\n\t\t//Ensure we're only importing the channels the user has selected.\n\t\tfor (const channel of importSelection.channels) {\n\t\t\tfor (const c of this.channels.channels) {\n\t\t\t\tif (c.id === channel.channel_id) {\n\t\t\t\t\tc.do_import = channel.do_import;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthis.collection.update({ _id: this.channels._id }, { $set: { 'channels': this.channels.channels }});\n\n\t\tconst startedByUserId = Meteor.userId();\n\t\tMeteor.defer(() => {\n\t\t\tsuper.updateProgress(ProgressStep.IMPORTING_USERS);\n\n\t\t\ttry {\n\t\t\t\t//Import the users\n\t\t\t\tfor (const u of this.users.users) {\n\t\t\t\t\tthis.logger.debug(`Starting the user import: ${ u.username } and are we importing them? ${ u.do_import }`);\n\t\t\t\t\tif (!u.do_import) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\t\tlet existantUser = RocketChat.models.Users.findOneByEmailAddress(u.email);\n\n\t\t\t\t\t\t//If we couldn't find one by their email address, try to find an existing user by their username\n\t\t\t\t\t\tif (!existantUser) {\n\t\t\t\t\t\t\texistantUser = RocketChat.models.Users.findOneByUsername(u.username);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (existantUser) {\n\t\t\t\t\t\t\t//since we have an existing user, let's try a few things\n\t\t\t\t\t\t\tu.rocketId = existantUser._id;\n\t\t\t\t\t\t\tRocketChat.models.Users.update({ _id: u.rocketId }, { $addToSet: { importIds: u.id } });\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconst userId = Accounts.createUser({ email: u.email, password: Date.now() + u.name + u.email.toUpperCase() });\n\t\t\t\t\t\t\tMeteor.runAsUser(userId, () => {\n\t\t\t\t\t\t\t\tMeteor.call('setUsername', u.username, {joinDefaultChannelsSilenced: true});\n\t\t\t\t\t\t\t\t//TODO: Use moment timezone to calc the time offset - Meteor.call 'userSetUtcOffset', user.tz_offset / 3600\n\t\t\t\t\t\t\t\tRocketChat.models.Users.setName(userId, u.name);\n\t\t\t\t\t\t\t\t//TODO: Think about using a custom field for the users \"title\" field\n\n\t\t\t\t\t\t\t\tif (u.avatar) {\n\t\t\t\t\t\t\t\t\tMeteor.call('setAvatarFromService', `data:image/png;base64,${ u.avatar }`);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t//Deleted users are 'inactive' users in Rocket.Chat\n\t\t\t\t\t\t\t\tif (u.deleted) {\n\t\t\t\t\t\t\t\t\tMeteor.call('setUserActiveStatus', userId, false);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tRocketChat.models.Users.update({ _id: userId }, { $addToSet: { importIds: u.id } });\n\t\t\t\t\t\t\t\tu.rocketId = userId;\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tsuper.addCountCompleted(1);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tthis.collection.update({ _id: this.users._id }, { $set: { 'users': this.users.users }});\n\n\t\t\t\t//Import the channels\n\t\t\t\tsuper.updateProgress(ProgressStep.IMPORTING_CHANNELS);\n\t\t\t\tfor (const c of this.channels.channels) {\n\t\t\t\t\tif (!c.do_import) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\t\tconst existantRoom = RocketChat.models.Rooms.findOneByName(c.name);\n\t\t\t\t\t\t//If the room exists or the name of it is 'general', then we don't need to create it again\n\t\t\t\t\t\tif (existantRoom || c.name.toUpperCase() === 'GENERAL') {\n\t\t\t\t\t\t\tc.rocketId = c.name.toUpperCase() === 'GENERAL' ? 'GENERAL' : existantRoom._id;\n\t\t\t\t\t\t\tRocketChat.models.Rooms.update({ _id: c.rocketId }, { $addToSet: { importIds: c.id } });\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t//Find the rocketchatId of the user who created this channel\n\t\t\t\t\t\t\tlet creatorId = startedByUserId;\n\t\t\t\t\t\t\tfor (const u of this.users.users) {\n\t\t\t\t\t\t\t\tif (u.id === c.creator && u.do_import) {\n\t\t\t\t\t\t\t\t\tcreatorId = u.rocketId;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t//Create the channel\n\t\t\t\t\t\t\tMeteor.runAsUser(creatorId, () => {\n\t\t\t\t\t\t\t\tconst roomInfo = Meteor.call(c.isPrivate ? 'createPrivateGroup' : 'createChannel', c.name, []);\n\t\t\t\t\t\t\t\tc.rocketId = roomInfo.rid;\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tRocketChat.models.Rooms.update({ _id: c.rocketId }, { $set: { ts: c.created, topic: c.topic }, $addToSet: { importIds: c.id } });\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tsuper.addCountCompleted(1);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tthis.collection.update({ _id: this.channels._id }, { $set: { 'channels': this.channels.channels }});\n\n\t\t\t\t//Import the Messages\n\t\t\t\tsuper.updateProgress(ProgressStep.IMPORTING_MESSAGES);\n\t\t\t\tfor (const [ch, messagesMap] of this.messages.entries()) {\n\t\t\t\t\tconst hipChannel = this.getChannelFromRoomIdentifier(ch);\n\t\t\t\t\tif (!hipChannel.do_import) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst room = RocketChat.models.Rooms.findOneById(hipChannel.rocketId, { fields: { usernames: 1, t: 1, name: 1 } });\n\t\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\t\tfor (const [msgGroupData, msgs] of messagesMap.entries()) {\n\t\t\t\t\t\t\tsuper.updateRecord({ 'messagesstatus': `${ ch }/${ msgGroupData }.${ msgs.messages.length }` });\n\t\t\t\t\t\t\tfor (const msg of msgs.messages) {\n\t\t\t\t\t\t\t\tif (isNaN(msg.ts)) {\n\t\t\t\t\t\t\t\t\tthis.logger.warn(`Timestamp on a message in ${ ch }/${ msgGroupData } is invalid`);\n\t\t\t\t\t\t\t\t\tsuper.addCountCompleted(1);\n\t\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tconst creator = this.getRocketUserFromUserId(msg.userId);\n\t\t\t\t\t\t\t\tif (creator) {\n\t\t\t\t\t\t\t\t\tswitch (msg.type) {\n\t\t\t\t\t\t\t\t\t\tcase 'user':\n\t\t\t\t\t\t\t\t\t\t\tRocketChat.sendMessage(creator, {\n\t\t\t\t\t\t\t\t\t\t\t\t_id: msg.id,\n\t\t\t\t\t\t\t\t\t\t\t\tts: msg.ts,\n\t\t\t\t\t\t\t\t\t\t\t\tmsg: msg.text,\n\t\t\t\t\t\t\t\t\t\t\t\trid: room._id,\n\t\t\t\t\t\t\t\t\t\t\t\tu: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t_id: creator._id,\n\t\t\t\t\t\t\t\t\t\t\t\t\tusername: creator.username\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}, room, true);\n\t\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\t\tcase 'topic':\n\t\t\t\t\t\t\t\t\t\t\tRocketChat.models.Messages.createRoomSettingsChangedWithTypeRoomIdMessageAndUser('room_changed_topic', room._id, msg.text, creator, { _id: msg.id, ts: msg.ts });\n\t\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tsuper.addCountCompleted(1);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\t//Import the Direct Messages\n\t\t\t\tfor (const [directMsgRoom, directMessagesMap] of this.directMessages.entries()) {\n\t\t\t\t\tconst hipUser = this.getUserFromDirectMessageIdentifier(directMsgRoom);\n\t\t\t\t\tif (!hipUser.do_import) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\t//Verify this direct message user's room is valid (confusing but idk how else to explain it)\n\t\t\t\t\tif (!this.getRocketUserFromUserId(hipUser.id)) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tfor (const [msgGroupData, msgs] of directMessagesMap.entries()) {\n\t\t\t\t\t\tsuper.updateRecord({ 'messagesstatus': `${ directMsgRoom }/${ msgGroupData }.${ msgs.messages.length }` });\n\t\t\t\t\t\tfor (const msg of msgs.messages) {\n\t\t\t\t\t\t\tif (isNaN(msg.ts)) {\n\t\t\t\t\t\t\t\tthis.logger.warn(`Timestamp on a message in ${ directMsgRoom }/${ msgGroupData } is invalid`);\n\t\t\t\t\t\t\t\tsuper.addCountCompleted(1);\n\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t//make sure the message sender is a valid user inside rocket.chat\n\t\t\t\t\t\t\tconst sender = this.getRocketUserFromUserId(msg.senderId);\n\t\t\t\t\t\t\tif (!sender) {\n\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t//make sure the receiver of the message is a valid rocket.chat user\n\t\t\t\t\t\t\tconst receiver = this.getRocketUserFromUserId(msg.receiverId);\n\t\t\t\t\t\t\tif (!receiver) {\n\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tlet room = RocketChat.models.Rooms.findOneById([receiver._id, sender._id].sort().join(''));\n\t\t\t\t\t\t\tif (!room) {\n\t\t\t\t\t\t\t\tMeteor.runAsUser(sender._id, () => {\n\t\t\t\t\t\t\t\t\tconst roomInfo = Meteor.call('createDirectMessage', receiver.username);\n\t\t\t\t\t\t\t\t\troom = RocketChat.models.Rooms.findOneById(roomInfo.rid);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tMeteor.runAsUser(sender._id, () => {\n\t\t\t\t\t\t\t\tRocketChat.sendMessage(sender, {\n\t\t\t\t\t\t\t\t\t_id: msg.id,\n\t\t\t\t\t\t\t\t\tts: msg.ts,\n\t\t\t\t\t\t\t\t\tmsg: msg.text,\n\t\t\t\t\t\t\t\t\trid: room._id,\n\t\t\t\t\t\t\t\t\tu: {\n\t\t\t\t\t\t\t\t\t\t_id: sender._id,\n\t\t\t\t\t\t\t\t\t\tusername: sender.username\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}, room, true);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tsuper.updateProgress(ProgressStep.FINISHING);\n\t\t\t\tsuper.updateProgress(ProgressStep.DONE);\n\t\t\t} catch (e) {\n\t\t\t\tthis.logger.error(e);\n\t\t\t\tsuper.updateProgress(ProgressStep.ERROR);\n\t\t\t}\n\n\t\t\tconst timeTook = Date.now() - started;\n\t\t\tthis.logger.log(`HipChat Enterprise Import took ${ timeTook } milliseconds.`);\n\t\t});\n\n\t\treturn super.getProgress();\n\t}\n\n\tgetSelection() {\n\t\tconst selectionUsers = this.users.users.map((u) => new SelectionUser(u.id, u.username, u.email, false, false, true));\n\t\tconst selectionChannels = this.channels.channels.map((c) => new SelectionChannel(c.id, c.name, false, true, c.isPrivate));\n\t\tconst selectionMessages = this.importRecord.count.messages;\n\n\t\treturn new Selection(this.name, selectionUsers, selectionChannels, selectionMessages);\n\t}\n\n\tgetChannelFromRoomIdentifier(roomIdentifier) {\n\t\tfor (const ch of this.channels.channels) {\n\t\t\tif (`rooms/${ ch.id }` === roomIdentifier) {\n\t\t\t\treturn ch;\n\t\t\t}\n\t\t}\n\t}\n\n\tgetUserFromDirectMessageIdentifier(directIdentifier) {\n\t\tfor (const u of this.users.users) {\n\t\t\tif (`users/${ u.id }` === directIdentifier) {\n\t\t\t\treturn u;\n\t\t\t}\n\t\t}\n\t}\n\n\tgetRocketUserFromUserId(userId) {\n\t\tfor (const u of this.users.users) {\n\t\t\tif (u.id === userId) {\n\t\t\t\treturn RocketChat.models.Users.findOneById(u.rocketId, { fields: { username: 1 }});\n\t\t\t}\n\t\t}\n\t}\n}\n","import { Importers } from 'meteor/rocketchat:importer';\nimport { HipChatEnterpriseImporterInfo } from '../info';\nimport { HipChatEnterpriseImporter } from './importer';\n\nImporters.add(new HipChatEnterpriseImporterInfo(), HipChatEnterpriseImporter);\n"]}