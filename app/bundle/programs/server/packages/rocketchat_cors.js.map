{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:cors/cors.js","meteor://ðŸ’»app/packages/rocketchat:cors/common.js"],"names":["_","module","watch","require","default","v","url","tls","DEFAULT_ECDH_CURVE","WebApp","rawConnectHandlers","use","Meteor","bindEnvironment","req","res","next","_body","headers","undefined","isNaN","indexOf","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","buf","setEncoding","on","chunk","RocketChat","debugLevel","console","log","green","method","body","JSON","parse","error","test","setHeader","key","val","toLowerCase","apply","arguments","_staticFilesMiddleware","WebAppInternals","staticFilesMiddleware","staticFiles","oldHttpServerListeners","httpServer","listeners","slice","removeAllListeners","addListener","oldListener","settings","get","remoteAddress","connection","socket","localhostRegexp","localhostTest","x","isLocal","all","split","isSsl","pair","host","absoluteUrl","hostname","replace","writeHead","end","startup","onload","value","defaultOptions","secure"],"mappings":"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","file":"/packages/rocketchat_cors.js","sourcesContent":["/* globals WebAppInternals */\nimport _ from 'underscore';\n\nimport url from 'url';\n\nimport tls from 'tls';\n// FIX For TLS error see more here https://github.com/RocketChat/Rocket.Chat/issues/9316\n// TODO: Remove after NodeJS fix it, more information https://github.com/nodejs/node/issues/16196 https://github.com/nodejs/node/pull/16853\ntls.DEFAULT_ECDH_CURVE = 'auto';\n\nWebApp.rawConnectHandlers.use(Meteor.bindEnvironment(function(req, res, next) {\n\tif (req._body) {\n\t\treturn next();\n\t}\n\tif (req.headers['transfer-encoding'] === undefined && isNaN(req.headers['content-length'])) {\n\t\treturn next();\n\t}\n\tif (req.headers['content-type'] !== '' && req.headers['content-type'] !== undefined) {\n\t\treturn next();\n\t}\n\tif (req.url.indexOf(`${ __meteor_runtime_config__.ROOT_URL_PATH_PREFIX }/ufs/`) === 0) {\n\t\treturn next();\n\t}\n\n\tlet buf = '';\n\treq.setEncoding('utf8');\n\treq.on('data', function(chunk) {\n\t\treturn buf += chunk;\n\t});\n\n\treq.on('end', function() {\n\t\tif (RocketChat && RocketChat.debugLevel === 'debug') {\n\t\t\tconsole.log('[request]'.green, req.method, req.url, '\\nheaders ->', req.headers, '\\nbody ->', buf);\n\t\t}\n\n\t\ttry {\n\t\t\treq.body = JSON.parse(buf);\n\t\t} catch (error) {\n\t\t\treq.body = buf;\n\t\t}\n\t\treq._body = true;\n\n\t\treturn next();\n\t});\n}));\n\nWebApp.rawConnectHandlers.use(function(req, res, next) {\n\tif (/^\\/(api|_timesync|sockjs|tap-i18n|__cordova)(\\/|$)/.test(req.url)) {\n\t\tres.setHeader('Access-Control-Allow-Origin', '*');\n\t}\n\n\tconst setHeader = res.setHeader;\n\tres.setHeader = function(key, val) {\n\t\tif (key.toLowerCase() === 'access-control-allow-origin' && val === 'http://meteor.local') {\n\t\t\treturn;\n\t\t}\n\t\treturn setHeader.apply(this, arguments);\n\t};\n\treturn next();\n});\n\nconst _staticFilesMiddleware = WebAppInternals.staticFilesMiddleware;\n\nWebAppInternals._staticFilesMiddleware = function(staticFiles, req, res, next) {\n\tres.setHeader('Access-Control-Allow-Origin', '*');\n\treturn _staticFilesMiddleware(staticFiles, req, res, next);\n};\n\nconst oldHttpServerListeners = WebApp.httpServer.listeners('request').slice(0);\n\nWebApp.httpServer.removeAllListeners('request');\n\nWebApp.httpServer.addListener('request', function(req, res) {\n\tconst next = () => {\n\t\tfor (const oldListener of oldHttpServerListeners) {\n\t\t\toldListener.apply(WebApp.httpServer, arguments);\n\t\t}\n\t};\n\n\tif (RocketChat.settings.get('Force_SSL') !== true) {\n\t\tnext();\n\t\treturn;\n\t}\n\n\tconst remoteAddress = req.connection.remoteAddress || req.socket.remoteAddress;\n\tconst localhostRegexp = /^\\s*(127\\.0\\.0\\.1|::1)\\s*$/;\n\tconst localhostTest = function(x) {\n\t\treturn localhostRegexp.test(x);\n\t};\n\n\tconst isLocal = localhostRegexp.test(remoteAddress) && (!req.headers['x-forwarded-for'] || _.all(req.headers['x-forwarded-for'].split(','), localhostTest));\n\tconst isSsl = req.connection.pair || (req.headers['x-forwarded-proto'] && req.headers['x-forwarded-proto'].indexOf('https') !== -1);\n\n\tif (RocketChat && RocketChat.debugLevel === 'debug') {\n\t\tconsole.log('req.url', req.url);\n\t\tconsole.log('remoteAddress', remoteAddress);\n\t\tconsole.log('isLocal', isLocal);\n\t\tconsole.log('isSsl', isSsl);\n\t\tconsole.log('req.headers', req.headers);\n\t}\n\n\tif (!isLocal && !isSsl) {\n\t\tlet host = req.headers['host'] || url.parse(Meteor.absoluteUrl()).hostname;\n\t\thost = host.replace(/:\\d+$/, '');\n\t\tres.writeHead(302, {\n\t\t\t'Location': `https://${ host }${ req.url }`\n\t\t});\n\t\tres.end();\n\t\treturn;\n\t}\n\n\treturn next();\n});\n","Meteor.startup(function() {\n\tRocketChat.settings.onload('Force_SSL', function(key, value) {\n\t\tMeteor.absoluteUrl.defaultOptions.secure = value;\n\t});\n});\n"]}