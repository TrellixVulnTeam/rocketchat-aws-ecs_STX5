{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:file-upload/globalFileRestrictions.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUploadBase.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/proxy.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/requests.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/_configUploadStorage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/AmazonS3.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/FileSystem.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/GoogleStorage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/GridFS.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/Slingshot_DEPRECATED.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/methods/sendFileMessage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/methods/getS3FileUrl.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/ufs/AmazonS3/server.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/ufs/GoogleStorage/server.js"],"names":["filesize","module","watch","require","default","v","slingShotConfig","authorize","file","userId","Meteor","Error","RocketChat","fileUploadIsValidContentType","type","TAPi18n","__","maxFileSize","settings","get","size","maxSize","allowedFileTypes","Slingshot","fileRestrictions","FileUpload","validateFileUpload","Match","test","rid","String","user","room","models","Rooms","findOneById","directMessageAllow","fileUploadAllowed","authz","canAccessRoom","reason","language","t","parseInt","key","value","_","UploadFS","config","defaultStorePermissions","StorePermissions","insert","doc","message_id","indexOf","update","hasPermission","remove","FileUploadBase","constructor","store","meta","id","Random","getProgress","getFileName","name","start","callback","handler","Uploader","data","onError","err","onComplete","fileData","pick","url","replace","absoluteUrl","options","onProgress","progress","stop","export","FileUploadClass","fs","stream","mime","Future","Cookies","cookie","Object","assign","handlers","configureUploadsStore","split","pop","stores","getStores","defaultUploads","collection","Uploads","model","filter","Filter","onCheck","getPath","_id","onValidate","uploadsOnValidate","onRead","fileId","req","res","requestCanAccessFiles","writeHead","setHeader","encodeURIComponent","defaultAvatars","Avatars","avatarsOnValidate","onFinishUpload","avatarsOnFinishUpload","avatarTransformWrite","readStream","writeStream","RocketChatFile","enabled","pipe","height","width","Info","GraphicsMagick","alpha","gm","background","resize","gravity","crop","extent","tempFilePath","getTempFilePath","future","setFormat","write","bindEnvironment","console","error","lstatSync","getCollection","direct","$set","return","wait","uploadsTransformWrite","undefined","identify","format","Orientation","includes","autoOrient","tmpFile","fut","Users","oldAvatar","findOneByName","username","deleteFile","updateFileNameById","headers","query","rc_uid","rc_token","findOneByIdAndLoginToken","addExtensionTo","lookup","ext","extension","RegExp","getStore","modelName","storageType","handlerName","getStoreByName","next","end","getModelFromName","_store","delete","deleteById","deleteByName","fileName","streamOrBuffer","cb","getFilter","check","create","token","createToken","createWriteStream","Buffer","writeFileSync","call","e","http","URL","logger","Logger","WebApp","connectHandlers","stack","unshift","route","handle","storesPath","debug","method","parsedUrl","parse","path","pathname","substr","length","regExp","match","exec","findOne","instanceId","InstanceStatus","instance","extraInformation","host","process","env","INSTANCE_IP","isDocker","port","hostname","originalUrl","proxy","request","proxy_res","use","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","public","sandstorm","configStore","debounce","log","fileUrl","getRedirectURL","AmazonS3Uploads","AmazonS3Avatars","configure","Bucket","Acl","AWSAccessKeyId","AWSSecretAccessKey","URLExpiryTimeSpan","Region","SignatureVersion","ForcePathStyle","BucketURL","connection","accessKeyId","secretAccessKey","signatureVersion","s3ForcePathStyle","params","ACL","region","endpoint","FileSystemUploads","filePath","getFilePath","stat","wrapAsync","isFile","uploadedAt","toUTCString","getReadStream","FileSystemAvatars","reqModifiedHeader","createFileSystemStore","GoogleCloudStorageUploads","GoogleCloudStorageAvatars","bucket","accessId","secret","credentials","client_email","private_key","zlib","util","ExtractRange","bytes_read","Transform","inherits","prototype","_transform","chunk","enc","newchunk","slice","push","getByteRange","header","matches","readFromGridFS","storeName","rs","ws","PassThrough","forEach","on","onReadError","emit","accept","transformRead","range","out_of_range","createGzip","createDeflate","collectionName","configureSlingshot","acl","accessKey","secretKey","cdn","bucketUrl","_directives","isEmpty","metaContext","upload","AmazonS3","insertFileInit","createDirective","S3Storage","message","createGoogleStorageDirective","GoogleAccessId","GoogleSecretKey","GoogleStorage","GoogleCloud","methods","roomId","msgData","avatar","Optional","emoji","alias","groupable","Boolean","msg","updateFileComplete","omit","encodeURI","attachment","title","description","title_link","title_link_download","image_url","image_type","image_size","image_dimensions","audio_url","audio_type","audio_size","video_url","video_type","video_size","ts","Date","attachments","defer","callbacks","run","protectedFiles","getS3FileUrl","addGroup","add","i18nDescription","values","i18nLabel","section","enableQuery","private","multiline","AmazonS3Store","S3","Store","extend","httpOptions","timeout","agent","classOptions","s3","Key","Expires","getSignedUrl","deleteObject","Range","getObject","createReadStream","getWriteStream","event","listener","nextTick","removeListener","putObject","Body","ContentType","ContentDisposition","GoogleStorageStore","gcStorage","gcs","googleCloudStorage","action","responseDisposition","expires","now","gzip","metadata","contentType","contentDisposition"],"mappings":"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","file":"/packages/rocketchat_file-upload.js","sourcesContent":["/* globals Slingshot */\n\nimport filesize from 'filesize';\n\nconst slingShotConfig = {\n\tauthorize(file/*, metaContext*/) {\n\t\t//Deny uploads if user is not logged in.\n\t\tif (!this.userId) {\n\t\t\tthrow new Meteor.Error('login-required', 'Please login before posting files');\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('error-invalid-file-type'));\n\t\t}\n\n\t\tconst maxFileSize = RocketChat.settings.get('FileUpload_MaxFileSize');\n\n\t\tif (maxFileSize && maxFileSize < file.size) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('File_exceeds_allowed_size_of_bytes', { size: filesize(maxFileSize) }));\n\t\t}\n\n\t\treturn true;\n\t},\n\tmaxSize: 0,\n\tallowedFileTypes: null\n};\n\nSlingshot.fileRestrictions('rocketchat-uploads', slingShotConfig);\nSlingshot.fileRestrictions('rocketchat-uploads-gs', slingShotConfig);\n","/* globals FileUpload:true */\n/* exported FileUpload */\n\nimport filesize from 'filesize';\n\nlet maxFileSize = 0;\n\nFileUpload = {\n\tvalidateFileUpload(file) {\n\t\tif (!Match.test(file.rid, String)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\t\tconst room = RocketChat.models.Rooms.findOneById(file.rid);\n\t\tconst directMessageAllow = RocketChat.settings.get('FileUpload_Enabled_Direct');\n\t\tconst fileUploadAllowed = RocketChat.settings.get('FileUpload_Enabled');\n\n\t\tif (RocketChat.authz.canAccessRoom(room, user) !== true) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!fileUploadAllowed) {\n\t\t\tconst reason = TAPi18n.__('FileUpload_Disabled', user.language);\n\t\t\tthrow new Meteor.Error('error-file-upload-disabled', reason);\n\t\t}\n\n\t\tif (!directMessageAllow && room.t === 'd') {\n\t\t\tconst reason = TAPi18n.__('File_not_allowed_direct_messages', user.language);\n\t\t\tthrow new Meteor.Error('error-direct-message-file-upload-not-allowed', reason);\n\t\t}\n\n\t\tif (file.size > maxFileSize) {\n\t\t\tconst reason = TAPi18n.__('File_exceeds_allowed_size_of_bytes', {\n\t\t\t\tsize: filesize(maxFileSize)\n\t\t\t}, user.language);\n\t\t\tthrow new Meteor.Error('error-file-too-large', reason);\n\t\t}\n\n\t\tif (parseInt(maxFileSize) > 0) {\n\t\t\tif (file.size > maxFileSize) {\n\t\t\t\tconst reason = TAPi18n.__('File_exceeds_allowed_size_of_bytes', {\n\t\t\t\t\tsize: filesize(maxFileSize)\n\t\t\t\t}, user.language);\n\t\t\t\tthrow new Meteor.Error('error-file-too-large', reason);\n\t\t\t}\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tconst reason = TAPi18n.__('File_type_is_not_accepted', user.language);\n\t\t\tthrow new Meteor.Error('error-invalid-file-type', reason);\n\t\t}\n\n\t\treturn true;\n\t}\n};\n\nRocketChat.settings.get('FileUpload_MaxFileSize', function(key, value) {\n\tmaxFileSize = value;\n});\n","/* globals FileUploadBase:true, UploadFS */\n/* exported FileUploadBase */\nimport _ from 'underscore';\n\nUploadFS.config.defaultStorePermissions = new UploadFS.StorePermissions({\n\tinsert(userId, doc) {\n\t\treturn userId || (doc && doc.message_id && doc.message_id.indexOf('slack-') === 0); // allow inserts from slackbridge (message_id = slack-timestamp-milli)\n\t},\n\tupdate(userId, doc) {\n\t\treturn RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', doc.rid) || (RocketChat.settings.get('Message_AllowDeleting') && userId === doc.userId);\n\t},\n\tremove(userId, doc) {\n\t\treturn RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', doc.rid) || (RocketChat.settings.get('Message_AllowDeleting') && userId === doc.userId);\n\t}\n});\n\n\nFileUploadBase = class FileUploadBase {\n\tconstructor(store, meta, file) {\n\t\tthis.id = Random.id();\n\t\tthis.meta = meta;\n\t\tthis.file = file;\n\t\tthis.store = store;\n\t}\n\n\tgetProgress() {\n\n\t}\n\n\tgetFileName() {\n\t\treturn this.meta.name;\n\t}\n\n\tstart(callback) {\n\t\tthis.handler = new UploadFS.Uploader({\n\t\t\tstore: this.store,\n\t\t\tdata: this.file,\n\t\t\tfile: this.meta,\n\t\t\tonError: (err) => {\n\t\t\t\treturn callback(err);\n\t\t\t},\n\t\t\tonComplete: (fileData) => {\n\t\t\t\tconst file = _.pick(fileData, '_id', 'type', 'size', 'name', 'identify', 'description');\n\n\t\t\t\tfile.url = fileData.url.replace(Meteor.absoluteUrl(), '/');\n\t\t\t\treturn callback(null, file, this.store.options.name);\n\t\t\t}\n\t\t});\n\n\t\tthis.handler.onProgress = (file, progress) => {\n\t\t\tthis.onProgress(progress);\n\t\t};\n\n\t\treturn this.handler.start();\n\t}\n\n\tonProgress() {}\n\n\tstop() {\n\t\treturn this.handler.stop();\n\t}\n};\n","/* globals UploadFS */\n\nimport fs from 'fs';\nimport stream from 'stream';\nimport mime from 'mime-type/with-db';\nimport Future from 'fibers/future';\nimport { Cookies } from 'meteor/ostrio:cookies';\n\nconst cookie = new Cookies();\n\nObject.assign(FileUpload, {\n\thandlers: {},\n\n\tconfigureUploadsStore(store, name, options) {\n\t\tconst type = name.split(':').pop();\n\t\tconst stores = UploadFS.getStores();\n\t\tdelete stores[name];\n\n\t\treturn new UploadFS.store[store](Object.assign({\n\t\t\tname\n\t\t}, options, FileUpload[`default${ type }`]()));\n\t},\n\n\tdefaultUploads() {\n\t\treturn {\n\t\t\tcollection: RocketChat.models.Uploads.model,\n\t\t\tfilter: new UploadFS.Filter({\n\t\t\t\tonCheck: FileUpload.validateFileUpload\n\t\t\t}),\n\t\t\tgetPath(file) {\n\t\t\t\treturn `${ RocketChat.settings.get('uniqueID') }/uploads/${ file.rid }/${ file.userId }/${ file._id }`;\n\t\t\t},\n\t\t\t// transformWrite: FileUpload.uploadsTransformWrite\n\t\t\tonValidate: FileUpload.uploadsOnValidate,\n\t\t\tonRead(fileId, file, req, res) {\n\t\t\t\tif (!FileUpload.requestCanAccessFiles(req)) {\n\t\t\t\t\tres.writeHead(403);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tres.setHeader('content-disposition', `attachment; filename=\"${ encodeURIComponent(file.name) }\"`);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t};\n\t},\n\n\tdefaultAvatars() {\n\t\treturn {\n\t\t\tcollection: RocketChat.models.Avatars.model,\n\t\t\t// filter: new UploadFS.Filter({\n\t\t\t// \tonCheck: FileUpload.validateFileUpload\n\t\t\t// }),\n\t\t\t// transformWrite: FileUpload.avatarTransformWrite,\n\t\t\tgetPath(file) {\n\t\t\t\treturn `${ RocketChat.settings.get('uniqueID') }/avatars/${ file.userId }`;\n\t\t\t},\n\t\t\tonValidate: FileUpload.avatarsOnValidate,\n\t\t\tonFinishUpload: FileUpload.avatarsOnFinishUpload\n\t\t};\n\t},\n\n\tavatarTransformWrite(readStream, writeStream/*, fileId, file*/) {\n\t\tif (RocketChatFile.enabled === false || RocketChat.settings.get('Accounts_AvatarResize') !== true) {\n\t\t\treturn readStream.pipe(writeStream);\n\t\t}\n\t\tconst height = RocketChat.settings.get('Accounts_AvatarSize');\n\t\tconst width = height;\n\t\treturn (file => RocketChat.Info.GraphicsMagick.enabled ? file: file.alpha('remove'))(RocketChatFile.gm(readStream).background('#FFFFFF')).resize(width, `${ height }^`).gravity('Center').crop(width, height).extent(width, height).stream('jpeg').pipe(writeStream);\n\t},\n\n\tavatarsOnValidate(file) {\n\t\tif (RocketChatFile.enabled === false || RocketChat.settings.get('Accounts_AvatarResize') !== true) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst tempFilePath = UploadFS.getTempFilePath(file._id);\n\n\t\tconst height = RocketChat.settings.get('Accounts_AvatarSize');\n\t\tconst width = height;\n\t\tconst future = new Future();\n\n\t\t(file => RocketChat.Info.GraphicsMagick.enabled ? file: file.alpha('remove'))(RocketChatFile.gm(tempFilePath).background('#FFFFFF')).resize(width, `${ height }^`).gravity('Center').crop(width, height).extent(width, height).setFormat('jpeg').write(tempFilePath, Meteor.bindEnvironment(err => {\n\t\t\tif (err != null) {\n\t\t\t\tconsole.error(err);\n\t\t\t}\n\t\t\tconst size = fs.lstatSync(tempFilePath).size;\n\t\t\tthis.getCollection().direct.update({_id: file._id}, {$set: {size}});\n\t\t\tfuture.return();\n\t\t}));\n\t\treturn future.wait();\n\t},\n\n\tuploadsTransformWrite(readStream, writeStream, fileId, file) {\n\t\tif (RocketChatFile.enabled === false || !/^image\\/.+/.test(file.type)) {\n\t\t\treturn readStream.pipe(writeStream);\n\t\t}\n\n\t\tlet stream = undefined;\n\n\t\tconst identify = function(err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn stream.pipe(writeStream);\n\t\t\t}\n\n\t\t\tfile.identify = {\n\t\t\t\tformat: data.format,\n\t\t\t\tsize: data.size\n\t\t\t};\n\n\t\t\tif (data.Orientation && !['', 'Unknown', 'Undefined'].includes(data.Orientation)) {\n\t\t\t\tRocketChatFile.gm(stream).autoOrient().stream().pipe(writeStream);\n\t\t\t} else {\n\t\t\t\tstream.pipe(writeStream);\n\t\t\t}\n\t\t};\n\n\t\tstream = RocketChatFile.gm(readStream).identify(identify).stream();\n\t},\n\n\tuploadsOnValidate(file) {\n\t\tif (RocketChatFile.enabled === false || !/^image\\/((x-windows-)?bmp|p?jpeg|png)$/.test(file.type)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst tmpFile = UploadFS.getTempFilePath(file._id);\n\n\t\tconst fut = new Future();\n\n\t\tconst identify = Meteor.bindEnvironment((err, data) => {\n\t\t\tif (err != null) {\n\t\t\t\tconsole.error(err);\n\t\t\t\treturn fut.return();\n\t\t\t}\n\n\t\t\tfile.identify = {\n\t\t\t\tformat: data.format,\n\t\t\t\tsize: data.size\n\t\t\t};\n\n\t\t\tif ([null, undefined, '', 'Unknown', 'Undefined'].includes(data.Orientation)) {\n\t\t\t\treturn fut.return();\n\t\t\t}\n\n\t\t\tRocketChatFile.gm(tmpFile).autoOrient().write(tmpFile, Meteor.bindEnvironment((err) => {\n\t\t\t\tif (err != null) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tconst size = fs.lstatSync(tmpFile).size;\n\t\t\t\tthis.getCollection().direct.update({_id: file._id}, {$set: {size}});\n\t\t\t\tfut.return();\n\t\t\t}));\n\t\t});\n\n\t\tRocketChatFile.gm(tmpFile).identify(identify);\n\n\t\treturn fut.wait();\n\t},\n\n\tavatarsOnFinishUpload(file) {\n\t\t// update file record to match user's username\n\t\tconst user = RocketChat.models.Users.findOneById(file.userId);\n\t\tconst oldAvatar = RocketChat.models.Avatars.findOneByName(user.username);\n\t\tif (oldAvatar) {\n\t\t\tRocketChat.models.Avatars.deleteFile(oldAvatar._id);\n\t\t}\n\t\tRocketChat.models.Avatars.updateFileNameById(file._id, user.username);\n\t\t// console.log('upload finished ->', file);\n\t},\n\n\trequestCanAccessFiles({ headers = {}, query = {} }) {\n\t\tif (!RocketChat.settings.get('FileUpload_ProtectFiles')) {\n\t\t\treturn true;\n\t\t}\n\n\t\tlet { rc_uid, rc_token } = query;\n\n\t\tif (!rc_uid && headers.cookie) {\n\t\t\trc_uid = cookie.get('rc_uid', headers.cookie) ;\n\t\t\trc_token = cookie.get('rc_token', headers.cookie);\n\t\t}\n\n\t\tif (!rc_uid || !rc_token || !RocketChat.models.Users.findOneByIdAndLoginToken(rc_uid, rc_token)) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t},\n\n\taddExtensionTo(file) {\n\t\tif (mime.lookup(file.name) === file.type) {\n\t\t\treturn file;\n\t\t}\n\n\t\tconst ext = mime.extension(file.type);\n\t\tif (ext && false === new RegExp(`\\.${ ext }$`, 'i').test(file.name)) {\n\t\t\tfile.name = `${ file.name }.${ ext }`;\n\t\t}\n\n\t\treturn file;\n\t},\n\n\tgetStore(modelName) {\n\t\tconst storageType = RocketChat.settings.get('FileUpload_Storage_Type');\n\t\tconst handlerName = `${ storageType }:${ modelName }`;\n\n\t\treturn this.getStoreByName(handlerName);\n\t},\n\n\tgetStoreByName(handlerName) {\n\t\tif (this.handlers[handlerName] == null) {\n\t\t\tconsole.error(`Upload handler \"${ handlerName }\" does not exists`);\n\t\t}\n\t\treturn this.handlers[handlerName];\n\t},\n\n\tget(file, req, res, next) {\n\t\tconst store = this.getStoreByName(file.store);\n\t\tif (store && store.get) {\n\t\t\treturn store.get(file, req, res, next);\n\t\t}\n\t\tres.writeHead(404);\n\t\tres.end();\n\t}\n});\n\n\nexport class FileUploadClass {\n\tconstructor({ name, model, store, get, insert, getStore }) {\n\t\tthis.name = name;\n\t\tthis.model = model || this.getModelFromName();\n\t\tthis._store = store || UploadFS.getStore(name);\n\t\tthis.get = get;\n\n\t\tif (insert) {\n\t\t\tthis.insert = insert;\n\t\t}\n\n\t\tif (getStore) {\n\t\t\tthis.getStore = getStore;\n\t\t}\n\n\t\tFileUpload.handlers[name] = this;\n\t}\n\n\tgetStore() {\n\t\treturn this._store;\n\t}\n\n\tget store() {\n\t\treturn this.getStore();\n\t}\n\n\tset store(store) {\n\t\tthis._store = store;\n\t}\n\n\tgetModelFromName() {\n\t\treturn RocketChat.models[this.name.split(':')[1]];\n\t}\n\n\tdelete(fileId) {\n\t\tif (this.store && this.store.delete) {\n\t\t\tthis.store.delete(fileId);\n\t\t}\n\n\t\treturn this.model.deleteFile(fileId);\n\t}\n\n\tdeleteById(fileId) {\n\t\tconst file = this.model.findOneById(fileId);\n\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst store = FileUpload.getStoreByName(file.store);\n\n\t\treturn store.delete(file._id);\n\t}\n\n\tdeleteByName(fileName) {\n\t\tconst file = this.model.findOneByName(fileName);\n\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst store = FileUpload.getStoreByName(file.store);\n\n\t\treturn store.delete(file._id);\n\t}\n\n\tinsert(fileData, streamOrBuffer, cb) {\n\t\tfileData.size = parseInt(fileData.size) || 0;\n\n\t\t// Check if the fileData matches store filter\n\t\tconst filter = this.store.getFilter();\n\t\tif (filter && filter.check) {\n\t\t\tfilter.check(fileData);\n\t\t}\n\n\t\tconst fileId = this.store.create(fileData);\n\t\tconst token = this.store.createToken(fileId);\n\t\tconst tmpFile = UploadFS.getTempFilePath(fileId);\n\n\t\ttry {\n\t\t\tif (streamOrBuffer instanceof stream) {\n\t\t\t\tstreamOrBuffer.pipe(fs.createWriteStream(tmpFile));\n\t\t\t} else if (streamOrBuffer instanceof Buffer) {\n\t\t\t\tfs.writeFileSync(tmpFile, streamOrBuffer);\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid file type');\n\t\t\t}\n\n\t\t\tconst file = Meteor.call('ufsComplete', fileId, this.name, token);\n\n\t\t\tif (cb) {\n\t\t\t\tcb(null, file);\n\t\t\t}\n\n\t\t\treturn file;\n\t\t} catch (e) {\n\t\t\tif (cb) {\n\t\t\t\tcb(e);\n\t\t\t} else {\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t}\n\t}\n}\n","/* globals UploadFS, InstanceStatus */\n\nimport http from 'http';\nimport URL from 'url';\n\nconst logger = new Logger('UploadProxy');\n\nWebApp.connectHandlers.stack.unshift({\n\troute: '',\n\thandle: Meteor.bindEnvironment(function(req, res, next) {\n\t\t// Quick check to see if request should be catch\n\t\tif (req.url.indexOf(UploadFS.config.storesPath) === -1) {\n\t\t\treturn next();\n\t\t}\n\n\t\tlogger.debug('Upload URL:', req.url);\n\n\t\tif (req.method !== 'POST') {\n\t\t\treturn next();\n\t\t}\n\n\t\t// Remove store path\n\t\tconst parsedUrl = URL.parse(req.url);\n\t\tconst path = parsedUrl.pathname.substr(UploadFS.config.storesPath.length + 1);\n\n\t\t// Get store\n\t\tconst regExp = new RegExp('^\\/([^\\/\\?]+)\\/([^\\/\\?]+)$');\n\t\tconst match = regExp.exec(path);\n\n\t\t// Request is not valid\n\t\tif (match === null) {\n\t\t\tres.writeHead(400);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get store\n\t\tconst store = UploadFS.getStore(match[1]);\n\t\tif (!store) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get file\n\t\tconst fileId = match[2];\n\t\tconst file = store.getCollection().findOne({_id: fileId});\n\t\tif (file === undefined) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (file.instanceId === InstanceStatus.id()) {\n\t\t\tlogger.debug('Correct instance');\n\t\t\treturn next();\n\t\t}\n\n\t\t// Proxy to other instance\n\t\tconst instance = InstanceStatus.getCollection().findOne({_id: file.instanceId});\n\n\t\tif (instance == null) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (instance.extraInformation.host === process.env.INSTANCE_IP && RocketChat.isDocker() === false) {\n\t\t\tinstance.extraInformation.host = 'localhost';\n\t\t}\n\n\t\tlogger.debug('Wrong instance, proxing to:', `${ instance.extraInformation.host }:${ instance.extraInformation.port }`);\n\n\t\tconst options = {\n\t\t\thostname: instance.extraInformation.host,\n\t\t\tport: instance.extraInformation.port,\n\t\t\tpath: req.originalUrl,\n\t\t\tmethod: 'POST'\n\t\t};\n\n\t\tconst proxy = http.request(options, function(proxy_res) {\n\t\t\tproxy_res.pipe(res, {\n\t\t\t\tend: true\n\t\t\t});\n\t\t});\n\n\t\treq.pipe(proxy, {\n\t\t\tend: true\n\t\t});\n\t})\n});\n","/* globals FileUpload, WebApp */\n\nWebApp.connectHandlers.use(`${ __meteor_runtime_config__.ROOT_URL_PATH_PREFIX }/file-upload/`,\tfunction(req, res, next) {\n\n\tconst match = /^\\/([^\\/]+)\\/(.*)/.exec(req.url);\n\n\tif (match[1]) {\n\t\tconst file = RocketChat.models.Uploads.findOneById(match[1]);\n\n\t\tif (file) {\n\t\t\tif (!Meteor.settings.public.sandstorm && !FileUpload.requestCanAccessFiles(req)) {\n\t\t\t\tres.writeHead(403);\n\t\t\t\treturn res.end();\n\t\t\t}\n\n\t\t\tres.setHeader('Content-Security-Policy', 'default-src \\'none\\'');\n\t\t\treturn FileUpload.get(file, req, res, next);\n\t\t}\n\t}\n\n\tres.writeHead(404);\n\tres.end();\n});\n","/* globals UploadFS */\n\nimport _ from 'underscore';\nimport './AmazonS3.js';\nimport './FileSystem.js';\nimport './GoogleStorage.js';\nimport './GridFS.js';\nimport './Slingshot_DEPRECATED.js';\n\nconst configStore = _.debounce(() => {\n\tconst store = RocketChat.settings.get('FileUpload_Storage_Type');\n\n\tif (store) {\n\t\tconsole.log('Setting default file store to', store);\n\t\tUploadFS.getStores().Avatars = UploadFS.getStore(`${ store }:Avatars`);\n\t\tUploadFS.getStores().Uploads = UploadFS.getStore(`${ store }:Uploads`);\n\t}\n}, 1000);\n\nRocketChat.settings.get(/^FileUpload_/, configStore);\n","/* globals FileUpload */\n\nimport _ from 'underscore';\nimport { FileUploadClass } from '../lib/FileUpload';\nimport '../../ufs/AmazonS3/server.js';\n\nconst get = function(file, req, res) {\n\tconst fileUrl = this.store.getRedirectURL(file);\n\n\tif (fileUrl) {\n\t\tres.setHeader('Location', fileUrl);\n\t\tres.writeHead(302);\n\t}\n\tres.end();\n};\n\nconst AmazonS3Uploads = new FileUploadClass({\n\tname: 'AmazonS3:Uploads',\n\tget\n\t// store setted bellow\n});\n\nconst AmazonS3Avatars = new FileUploadClass({\n\tname: 'AmazonS3:Avatars',\n\tget\n\t// store setted bellow\n});\n\nconst configure = _.debounce(function() {\n\tconst Bucket = RocketChat.settings.get('FileUpload_S3_Bucket');\n\tconst Acl = RocketChat.settings.get('FileUpload_S3_Acl');\n\tconst AWSAccessKeyId = RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId');\n\tconst AWSSecretAccessKey = RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tconst URLExpiryTimeSpan = RocketChat.settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\tconst Region = RocketChat.settings.get('FileUpload_S3_Region');\n\tconst SignatureVersion = RocketChat.settings.get('FileUpload_S3_SignatureVersion');\n\tconst ForcePathStyle = RocketChat.settings.get('FileUpload_S3_ForcePathStyle');\n\t// const CDN = RocketChat.settings.get('FileUpload_S3_CDN');\n\tconst BucketURL = RocketChat.settings.get('FileUpload_S3_BucketURL');\n\n\tif (!Bucket || !AWSAccessKeyId || !AWSSecretAccessKey) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\taccessKeyId: AWSAccessKeyId,\n\t\t\tsecretAccessKey: AWSSecretAccessKey,\n\t\t\tsignatureVersion: SignatureVersion,\n\t\t\ts3ForcePathStyle: ForcePathStyle,\n\t\t\tparams: {\n\t\t\t\tBucket,\n\t\t\t\tACL: Acl\n\t\t\t},\n\t\t\tregion: Region\n\t\t},\n\t\tURLExpiryTimeSpan\n\t};\n\n\tif (BucketURL) {\n\t\tconfig.connection.endpoint = BucketURL;\n\t}\n\n\tAmazonS3Uploads.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Uploads.name, config);\n\tAmazonS3Avatars.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Avatars.name, config);\n}, 500);\n\nRocketChat.settings.get(/^FileUpload_S3_/, configure);\n","/* globals FileUpload, UploadFS */\n\nimport _ from 'underscore';\nimport fs from 'fs';\nimport { FileUploadClass } from '../lib/FileUpload';\n\nconst FileSystemUploads = new FileUploadClass({\n\tname: 'FileSystem:Uploads',\n\t// store setted bellow\n\n\tget(file, req, res) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`);\n\t\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type);\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n});\n\nconst FileSystemAvatars = new FileUploadClass({\n\tname: 'FileSystem:Avatars',\n\t// store setted bellow\n\n\tget(file, req, res) {\n\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\tif (reqModifiedHeader) {\n\t\t\tif (reqModifiedHeader === (file.uploadedAt && file.uploadedAt.toUTCString())) {\n\t\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\t\tres.writeHead(304);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', 'inline');\n\t\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type);\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n});\n\n\nconst createFileSystemStore = _.debounce(function() {\n\tconst options = {\n\t\tpath: RocketChat.settings.get('FileUpload_FileSystemPath') //'/tmp/uploads/photos',\n\t};\n\n\tFileSystemUploads.store = FileUpload.configureUploadsStore('Local', FileSystemUploads.name, options);\n\tFileSystemAvatars.store = FileUpload.configureUploadsStore('Local', FileSystemAvatars.name, options);\n\n\t// DEPRECATED backwards compatibililty (remove)\n\tUploadFS.getStores()['fileSystem'] = UploadFS.getStores()[FileSystemUploads.name];\n}, 500);\n\nRocketChat.settings.get('FileUpload_FileSystemPath', createFileSystemStore);\n","/* globals FileUpload */\n\nimport _ from 'underscore';\nimport { FileUploadClass } from '../lib/FileUpload';\nimport '../../ufs/GoogleStorage/server.js';\n\n\nconst get = function(file, req, res) {\n\tthis.store.getRedirectURL(file, (err, fileUrl) => {\n\t\tif (err) {\n\t\t\tconsole.error(err);\n\t\t}\n\n\t\tif (fileUrl) {\n\t\t\tres.setHeader('Location', fileUrl);\n\t\t\tres.writeHead(302);\n\t\t}\n\t\tres.end();\n\t});\n};\n\nconst GoogleCloudStorageUploads = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Uploads',\n\tget\n\t// store setted bellow\n});\n\nconst GoogleCloudStorageAvatars = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Avatars',\n\tget\n\t// store setted bellow\n});\n\nconst configure = _.debounce(function() {\n\tconst bucket = RocketChat.settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst accessId = RocketChat.settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = RocketChat.settings.get('FileUpload_GoogleStorage_Secret');\n\tconst URLExpiryTimeSpan = RocketChat.settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\n\tif (!bucket || !accessId || !secret) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\tcredentials: {\n\t\t\t\tclient_email: accessId,\n\t\t\t\tprivate_key: secret\n\t\t\t}\n\t\t},\n\t\tbucket,\n\t\tURLExpiryTimeSpan\n\t};\n\n\tGoogleCloudStorageUploads.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUploads.name, config);\n\tGoogleCloudStorageAvatars.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageAvatars.name, config);\n}, 500);\n\nRocketChat.settings.get(/^FileUpload_GoogleStorage_/, configure);\n","/* globals FileUpload, UploadFS */\nimport stream from 'stream';\nimport zlib from 'zlib';\nimport util from 'util';\n\nimport { FileUploadClass } from '../lib/FileUpload';\n\nconst logger = new Logger('FileUpload');\n\nfunction ExtractRange(options) {\n\tif (!(this instanceof ExtractRange)) {\n\t\treturn new ExtractRange(options);\n\t}\n\n\tthis.start = options.start;\n\tthis.stop = options.stop;\n\tthis.bytes_read = 0;\n\n\tstream.Transform.call(this, options);\n}\nutil.inherits(ExtractRange, stream.Transform);\n\n\nExtractRange.prototype._transform = function(chunk, enc, cb) {\n\tif (this.bytes_read > this.stop) {\n\t\t// done reading\n\t\tthis.end();\n\t} else if (this.bytes_read + chunk.length < this.start) {\n\t\t// this chunk is still before the start byte\n\t} else {\n\t\tlet start;\n\t\tlet stop;\n\n\t\tif (this.start <= this.bytes_read) {\n\t\t\tstart = 0;\n\t\t} else {\n\t\t\tstart = this.start - this.bytes_read;\n\t\t}\n\t\tif ((this.stop - this.bytes_read + 1) < chunk.length) {\n\t\t\tstop = this.stop - this.bytes_read + 1;\n\t\t} else {\n\t\t\tstop = chunk.length;\n\t\t}\n\t\tconst newchunk = chunk.slice(start, stop);\n\t\tthis.push(newchunk);\n\t}\n\tthis.bytes_read += chunk.length;\n\tcb();\n};\n\n\nconst getByteRange = function(header) {\n\tif (header) {\n\t\tconst matches = header.match(/(\\d+)-(\\d+)/);\n\t\tif (matches) {\n\t\t\treturn {\n\t\t\t\tstart: parseInt(matches[1], 10),\n\t\t\t\tstop: parseInt(matches[2], 10)\n\t\t\t};\n\t\t}\n\t}\n\treturn null;\n};\n\n\n// code from: https://github.com/jalik/jalik-ufs/blob/master/ufs-server.js#L310\nconst readFromGridFS = function(storeName, fileId, file, headers, req, res) {\n\tconst store = UploadFS.getStore(storeName);\n\tconst rs = store.getReadStream(fileId, file);\n\tconst ws = new stream.PassThrough();\n\n\t[rs, ws].forEach(stream => stream.on('error', function(err) {\n\t\tstore.onReadError.call(store, err, fileId, file);\n\t\tres.end();\n\t}));\n\n\tws.on('close', function() {\n\t\t// Close output stream at the end\n\t\tws.emit('end');\n\t});\n\n\tconst accept = req.headers['accept-encoding'] || '';\n\n\t// Transform stream\n\tstore.transformRead(rs, ws, fileId, file, req, headers);\n\tconst range = getByteRange(req.headers.range);\n\tlet out_of_range = false;\n\tif (range) {\n\t\tout_of_range = (range.start > file.size) || (range.stop <= range.start) || (range.stop > file.size);\n\t}\n\n\t// Compress data using gzip\n\tif (accept.match(/\\bgzip\\b/) && range === null) {\n\t\theaders['Content-Encoding'] = 'gzip';\n\t\tdelete headers['Content-Length'];\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(zlib.createGzip()).pipe(res);\n\t} else if (accept.match(/\\bdeflate\\b/) && range === null) {\n\t\t// Compress data using deflate\n\t\theaders['Content-Encoding'] = 'deflate';\n\t\tdelete headers['Content-Length'];\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(zlib.createDeflate()).pipe(res);\n\t} else if (range && out_of_range) {\n\t\t// out of range request, return 416\n\t\tdelete headers['Content-Length'];\n\t\tdelete headers['Content-Type'];\n\t\tdelete headers['Content-Disposition'];\n\t\tdelete headers['Last-Modified'];\n\t\theaders['Content-Range'] = `bytes */${ file.size }`;\n\t\tres.writeHead(416, headers);\n\t\tres.end();\n\t} else if (range) {\n\t\theaders['Content-Range'] = `bytes ${ range.start }-${ range.stop }/${ file.size }`;\n\t\tdelete headers['Content-Length'];\n\t\theaders['Content-Length'] = range.stop - range.start + 1;\n\t\tres.writeHead(206, headers);\n\t\tlogger.debug('File upload extracting range');\n\t\tws.pipe(new ExtractRange({ start: range.start, stop: range.stop })).pipe(res);\n\t} else {\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(res);\n\t}\n};\n\nFileUpload.configureUploadsStore('GridFS', 'GridFS:Uploads', {\n\tcollectionName: 'rocketchat_uploads'\n});\n\n// DEPRECATED: backwards compatibility (remove)\nUploadFS.getStores()['rocketchat_uploads'] = UploadFS.getStores()['GridFS:Uploads'];\n\nFileUpload.configureUploadsStore('GridFS', 'GridFS:Avatars', {\n\tcollectionName: 'rocketchat_avatars'\n});\n\n\nnew FileUploadClass({\n\tname: 'GridFS:Uploads',\n\n\tget(file, req, res) {\n\t\tfile = FileUpload.addExtensionTo(file);\n\t\tconst headers = {\n\t\t\t'Content-Disposition': `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`,\n\t\t\t'Last-Modified': file.uploadedAt.toUTCString(),\n\t\t\t'Content-Type': file.type,\n\t\t\t'Content-Length': file.size\n\t\t};\n\t\treturn readFromGridFS(file.store, file._id, file, headers, req, res);\n\t}\n});\n\nnew FileUploadClass({\n\tname: 'GridFS:Avatars',\n\n\tget(file, req, res) {\n\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\tif (reqModifiedHeader && reqModifiedHeader === (file.uploadedAt && file.uploadedAt.toUTCString())) {\n\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\tres.writeHead(304);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t\tfile = FileUpload.addExtensionTo(file);\n\t\tconst headers = {\n\t\t\t'Cache-Control': 'public, max-age=0',\n\t\t\t'Expires': '-1',\n\t\t\t'Content-Disposition': 'inline',\n\t\t\t'Last-Modified': file.uploadedAt.toUTCString(),\n\t\t\t'Content-Type': file.type,\n\t\t\t'Content-Length': file.size\n\t\t};\n\t\treturn readFromGridFS(file.store, file._id, file, headers, req, res);\n\t}\n});\n","/* globals Slingshot, FileUpload */\nimport _ from 'underscore';\n\nconst configureSlingshot = _.debounce(() => {\n\tconst type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tconst bucket = RocketChat.settings.get('FileUpload_S3_Bucket');\n\tconst acl = RocketChat.settings.get('FileUpload_S3_Acl');\n\tconst accessKey = RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId');\n\tconst secretKey = RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tconst cdn = RocketChat.settings.get('FileUpload_S3_CDN');\n\tconst region = RocketChat.settings.get('FileUpload_S3_Region');\n\tconst bucketUrl = RocketChat.settings.get('FileUpload_S3_BucketURL');\n\n\tdelete Slingshot._directives['rocketchat-uploads'];\n\n\tif (type === 'AmazonS3' && !_.isEmpty(bucket) && !_.isEmpty(accessKey) && !_.isEmpty(secretKey)) {\n\t\tif (Slingshot._directives['rocketchat-uploads']) {\n\t\t\tdelete Slingshot._directives['rocketchat-uploads'];\n\t\t}\n\t\tconst config = {\n\t\t\tbucket,\n\t\t\tkey(file, metaContext) {\n\t\t\t\tconst id = Random.id();\n\t\t\t\tconst path = `${ RocketChat.settings.get('uniqueID') }/uploads/${ metaContext.rid }/${ this.userId }/${ id }`;\n\n\t\t\t\tconst upload = {\n\t\t\t\t\t_id: id,\n\t\t\t\t\trid: metaContext.rid,\n\t\t\t\t\tAmazonS3: {\n\t\t\t\t\t\tpath\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tRocketChat.models.Uploads.insertFileInit(this.userId, 'AmazonS3:Uploads', file, upload);\n\n\t\t\t\treturn path;\n\t\t\t},\n\t\t\tAWSAccessKeyId: accessKey,\n\t\t\tAWSSecretAccessKey: secretKey\n\t\t};\n\n\t\tif (!_.isEmpty(acl)) {\n\t\t\tconfig.acl = acl;\n\t\t}\n\n\t\tif (!_.isEmpty(cdn)) {\n\t\t\tconfig.cdn = cdn;\n\t\t}\n\n\t\tif (!_.isEmpty(region)) {\n\t\t\tconfig.region = region;\n\t\t}\n\n\t\tif (!_.isEmpty(bucketUrl)) {\n\t\t\tconfig.bucketUrl = bucketUrl;\n\t\t}\n\n\t\ttry {\n\t\t\tSlingshot.createDirective('rocketchat-uploads', Slingshot.S3Storage, config);\n\t\t} catch (e) {\n\t\t\tconsole.error('Error configuring S3 ->', e.message);\n\t\t}\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', configureSlingshot);\nRocketChat.settings.get(/^FileUpload_S3_/, configureSlingshot);\n\n\n\nconst createGoogleStorageDirective = _.debounce(() => {\n\tconst type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tconst bucket = RocketChat.settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst accessId = RocketChat.settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = RocketChat.settings.get('FileUpload_GoogleStorage_Secret');\n\n\tdelete Slingshot._directives['rocketchat-uploads-gs'];\n\n\tif (type === 'GoogleCloudStorage' && !_.isEmpty(secret) && !_.isEmpty(accessId) && !_.isEmpty(bucket)) {\n\t\tif (Slingshot._directives['rocketchat-uploads-gs']) {\n\t\t\tdelete Slingshot._directives['rocketchat-uploads-gs'];\n\t\t}\n\n\t\tconst config = {\n\t\t\tbucket,\n\t\t\tGoogleAccessId: accessId,\n\t\t\tGoogleSecretKey: secret,\n\t\t\tkey(file, metaContext) {\n\t\t\t\tconst id = Random.id();\n\t\t\t\tconst path = `${ RocketChat.settings.get('uniqueID') }/uploads/${ metaContext.rid }/${ this.userId }/${ id }`;\n\n\t\t\t\tconst upload = {\n\t\t\t\t\t_id: id,\n\t\t\t\t\trid: metaContext.rid,\n\t\t\t\t\tGoogleStorage: {\n\t\t\t\t\t\tpath\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tRocketChat.models.Uploads.insertFileInit(this.userId, 'GoogleCloudStorage:Uploads', file, upload);\n\n\t\t\t\treturn path;\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\tSlingshot.createDirective('rocketchat-uploads-gs', Slingshot.GoogleCloud, config);\n\t\t} catch (e) {\n\t\t\tconsole.error('Error configuring GoogleCloudStorage ->', e.message);\n\t\t}\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', createGoogleStorageDirective);\nRocketChat.settings.get(/^FileUpload_GoogleStorage_/, createGoogleStorageDirective);\n","import _ from 'underscore';\n\nMeteor.methods({\n\t'sendFileMessage'(roomId, store, file, msgData = {}) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'sendFileMessage' });\n\t\t}\n\n\t\tconst room = Meteor.call('canAccessRoom', roomId, Meteor.userId());\n\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tcheck(msgData, {\n\t\t\tavatar: Match.Optional(String),\n\t\t\temoji: Match.Optional(String),\n\t\t\talias: Match.Optional(String),\n\t\t\tgroupable: Match.Optional(Boolean),\n\t\t\tmsg: Match.Optional(String)\n\t\t});\n\n\t\tRocketChat.models.Uploads.updateFileComplete(file._id, Meteor.userId(), _.omit(file, '_id'));\n\n\t\tconst fileUrl = `/file-upload/${ file._id }/${ encodeURI(file.name) }`;\n\n\t\tconst attachment = {\n\t\t\ttitle: file.name,\n\t\t\ttype: 'file',\n\t\t\tdescription: file.description,\n\t\t\ttitle_link: fileUrl,\n\t\t\ttitle_link_download: true\n\t\t};\n\n\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\tattachment.image_url = fileUrl;\n\t\t\tattachment.image_type = file.type;\n\t\t\tattachment.image_size = file.size;\n\t\t\tif (file.identify && file.identify.size) {\n\t\t\t\tattachment.image_dimensions = file.identify.size;\n\t\t\t}\n\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\tattachment.audio_url = fileUrl;\n\t\t\tattachment.audio_type = file.type;\n\t\t\tattachment.audio_size = file.size;\n\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\tattachment.video_url = fileUrl;\n\t\t\tattachment.video_type = file.type;\n\t\t\tattachment.video_size = file.size;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\t\tlet msg = Object.assign({\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId,\n\t\t\tts: new Date(),\n\t\t\tmsg: '',\n\t\t\tfile: {\n\t\t\t\t_id: file._id,\n\t\t\t\tname: file.name,\n\t\t\t\ttype: file.type\n\t\t\t},\n\t\t\tgroupable: false,\n\t\t\tattachments: [attachment]\n\t\t}, msgData);\n\n\t\tmsg = Meteor.call('sendMessage', msg);\n\n\t\tMeteor.defer(() => RocketChat.callbacks.run('afterFileUpload', { user, room, message: msg }));\n\n\t\treturn msg;\n\t}\n});\n","/* globals UploadFS */\n\nlet protectedFiles;\n\nRocketChat.settings.get('FileUpload_ProtectFiles', function(key, value) {\n\tprotectedFiles = value;\n});\n\nMeteor.methods({\n\tgetS3FileUrl(fileId) {\n\t\tif (protectedFiles && !Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'sendFileMessage' });\n\t\t}\n\t\tconst file = RocketChat.models.Uploads.findOneById(fileId);\n\n\t\treturn UploadFS.getStore('AmazonS3:Uploads').getRedirectURL(file);\n\t}\n});\n","RocketChat.settings.addGroup('FileUpload', function() {\n\tthis.add('FileUpload_Enabled', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MaxFileSize', 2097152, {\n\t\ttype: 'int',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MediaTypeWhiteList', 'image/*,audio/*,video/*,application/zip,application/x-rar-compressed,application/pdf,text/plain,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document', {\n\t\ttype: 'string',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_MediaTypeWhiteListDescription'\n\t});\n\n\tthis.add('FileUpload_ProtectFiles', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_ProtectFilesDescription'\n\t});\n\n\tthis.add('FileUpload_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS'\n\t\t}, {\n\t\t\tkey: 'AmazonS3',\n\t\t\ti18nLabel: 'AmazonS3'\n\t\t}, {\n\t\t\tkey: 'GoogleCloudStorage',\n\t\t\ti18nLabel: 'GoogleCloudStorage'\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem'\n\t\t}],\n\t\tpublic: true\n\t});\n\n\tthis.section('Amazon S3', function() {\n\t\tthis.add('FileUpload_S3_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Acl', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSAccessKeyId', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSSecretAccessKey', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_CDN', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Region', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_BucketURL', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'Override_URL_to_which_files_are_uploaded_This_url_also_used_for_downloads_unless_a_CDN_is_given.'\n\t\t});\n\t\tthis.add('FileUpload_S3_SignatureVersion', 'v4', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_ForcePathStyle', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_URLExpiryTimeSpan', 120, {\n\t\t\ttype: 'int',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'FileUpload_S3_URLExpiryTimeSpan_Description'\n\t\t});\n\t});\n\n\tthis.section('Google Cloud Storage', function() {\n\t\tthis.add('FileUpload_GoogleStorage_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_AccessId', '', {\n\t\t\ttype: 'string',\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_Secret', '', {\n\t\t\ttype: 'string',\n\t\t\tmultiline: true,\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.section('File System', function() {\n\t\tthis.add('FileUpload_FileSystemPath', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'FileSystem'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.add('FileUpload_Enabled_Direct', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n});\n","import {UploadFS} from 'meteor/jalik:ufs';\nimport _ from 'underscore';\nimport S3 from 'aws-sdk/clients/s3';\nimport stream from 'stream';\n\n/**\n * AmazonS3 store\n * @param options\n * @constructor\n */\nexport class AmazonS3Store extends UploadFS.Store {\n\n\tconstructor(options) {\n\t\t// Default options\n\t\t// options.secretAccessKey,\n\t\t// options.accessKeyId,\n\t\t// options.region,\n\t\t// options.sslEnabled // optional\n\n\t\toptions = _.extend({\n\t\t\thttpOptions: {\n\t\t\t\ttimeout: 6000,\n\t\t\t\tagent: false\n\t\t\t}\n\t\t}, options);\n\n\t\tsuper(options);\n\n\t\tconst classOptions = options;\n\n\t\tconst s3 = new S3(options.connection);\n\n\t\toptions.getPath = options.getPath || function(file) {\n\t\t\treturn file._id;\n\t\t};\n\n\t\tthis.getPath = function(file) {\n\t\t\tif (file.AmazonS3) {\n\t\t\t\treturn file.AmazonS3.path;\n\t\t\t}\n\t\t\t// Compatibility\n\t\t\t// TODO: Migration\n\t\t\tif (file.s3) {\n\t\t\t\treturn file.s3.path + file._id;\n\t\t\t}\n\t\t};\n\n\t\tthis.getRedirectURL = function(file) {\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file),\n\t\t\t\tExpires: classOptions.URLExpiryTimeSpan\n\t\t\t};\n\n\t\t\treturn s3.getSignedUrl('getObject', params);\n\t\t};\n\n\t\t/**\n\t\t * Creates the file in the collection\n\t\t * @param file\n\t\t * @param callback\n\t\t * @return {string}\n\t\t */\n\t\tthis.create = function(file, callback) {\n\t\t\tcheck(file, Object);\n\n\t\t\tif (file._id == null) {\n\t\t\t\tfile._id = Random.id();\n\t\t\t}\n\n\t\t\tfile.AmazonS3 = {\n\t\t\t\tpath: this.options.getPath(file)\n\t\t\t};\n\n\t\t\tfile.store = this.options.name; // assign store to file\n\t\t\treturn this.getCollection().insert(file, callback);\n\t\t};\n\n\t\t/**\n\t\t * Removes the file\n\t\t * @param fileId\n\t\t * @param callback\n\t\t */\n\t\tthis.delete = function(fileId, callback) {\n\t\t\tconst file = this.getCollection().findOne({_id: fileId});\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file)\n\t\t\t};\n\n\t\t\ts3.deleteObject(params, (err, data) => {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tcallback && callback(err, data);\n\t\t\t});\n\t\t};\n\n\t\t/**\n\t\t * Returns the file read stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getReadStream = function(fileId, file, options = {}) {\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file)\n\t\t\t};\n\n\t\t\tif (options.start && options.end) {\n\t\t\t\tparams.Range = `${ options.start } - ${ options.end }`;\n\t\t\t}\n\n\t\t\treturn s3.getObject(params).createReadStream();\n\t\t};\n\n\t\t/**\n\t\t * Returns the file write stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getWriteStream = function(fileId, file/*, options*/) {\n\t\t\tconst writeStream = new stream.PassThrough();\n\t\t\twriteStream.length = file.size;\n\n\t\t\twriteStream.on('newListener', (event, listener) => {\n\t\t\t\tif (event === 'finish') {\n\t\t\t\t\tprocess.nextTick(() => {\n\t\t\t\t\t\twriteStream.removeListener(event, listener);\n\t\t\t\t\t\twriteStream.on('real_finish', listener);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\ts3.putObject({\n\t\t\t\tKey: this.getPath(file),\n\t\t\t\tBody: writeStream,\n\t\t\t\tContentType: file.type,\n\t\t\t\tContentDisposition: `inline; filename=\"${ encodeURI(file.name) }\"`\n\n\t\t\t}, (error) => {\n\t\t\t\tif (error) {\n\t\t\t\t\tconsole.error(error);\n\t\t\t\t}\n\n\t\t\t\twriteStream.emit('real_finish');\n\t\t\t});\n\n\t\t\treturn writeStream;\n\t\t};\n\t}\n}\n\n// Add store to UFS namespace\nUploadFS.store.AmazonS3 = AmazonS3Store;\n","import {UploadFS} from 'meteor/jalik:ufs';\nimport gcStorage from '@google-cloud/storage';\n\n/**\n * GoogleStorage store\n * @param options\n * @constructor\n */\nexport class GoogleStorageStore extends UploadFS.Store {\n\n\tconstructor(options) {\n\t\tsuper(options);\n\n\t\tconst gcs = gcStorage(options.connection);\n\t\tthis.bucket = gcs.bucket(options.bucket);\n\n\t\toptions.getPath = options.getPath || function(file) {\n\t\t\treturn file._id;\n\t\t};\n\n\t\tthis.getPath = function(file) {\n\t\t\tif (file.GoogleStorage) {\n\t\t\t\treturn file.GoogleStorage.path;\n\t\t\t}\n\t\t\t// Compatibility\n\t\t\t// TODO: Migration\n\t\t\tif (file.googleCloudStorage) {\n\t\t\t\treturn file.googleCloudStorage.path + file._id;\n\t\t\t}\n\t\t};\n\n\t\tthis.getRedirectURL = function(file, callback) {\n\t\t\tconst params = {\n\t\t\t\taction: 'read',\n\t\t\t\tresponseDisposition: 'inline',\n\t\t\t\texpires: Date.now()+this.options.URLExpiryTimeSpan*1000\n\t\t\t};\n\n\t\t\tthis.bucket.file(this.getPath(file)).getSignedUrl(params, callback);\n\t\t};\n\n\t\t/**\n\t\t * Creates the file in the collection\n\t\t * @param file\n\t\t * @param callback\n\t\t * @return {string}\n\t\t */\n\t\tthis.create = function(file, callback) {\n\t\t\tcheck(file, Object);\n\n\t\t\tif (file._id == null) {\n\t\t\t\tfile._id = Random.id();\n\t\t\t}\n\n\t\t\tfile.GoogleStorage = {\n\t\t\t\tpath: this.options.getPath(file)\n\t\t\t};\n\n\t\t\tfile.store = this.options.name; // assign store to file\n\t\t\treturn this.getCollection().insert(file, callback);\n\t\t};\n\n\t\t/**\n\t\t * Removes the file\n\t\t * @param fileId\n\t\t * @param callback\n\t\t */\n\t\tthis.delete = function(fileId, callback) {\n\t\t\tconst file = this.getCollection().findOne({_id: fileId});\n\t\t\tthis.bucket.file(this.getPath(file)).delete(function(err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tcallback && callback(err, data);\n\t\t\t});\n\t\t};\n\n\t\t/**\n\t\t * Returns the file read stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getReadStream = function(fileId, file, options = {}) {\n\t\t\tconst config = {};\n\n\t\t\tif (options.start != null) {\n\t\t\t\tconfig.start = options.start;\n\t\t\t}\n\n\t\t\tif (options.end != null) {\n\t\t\t\tconfig.end = options.end;\n\t\t\t}\n\n\t\t\treturn this.bucket.file(this.getPath(file)).createReadStream(config);\n\t\t};\n\n\t\t/**\n\t\t * Returns the file write stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getWriteStream = function(fileId, file/*, options*/) {\n\t\t\treturn this.bucket.file(this.getPath(file)).createWriteStream({\n\t\t\t\tgzip: false,\n\t\t\t\tmetadata: {\n\t\t\t\t\tcontentType: file.type,\n\t\t\t\t\tcontentDisposition: `inline; filename=${ file.name }`\n\t\t\t\t\t// metadata: {\n\t\t\t\t\t// \tcustom: 'metadata'\n\t\t\t\t\t// }\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\t}\n}\n\n// Add store to UFS namespace\nUploadFS.store.GoogleStorage = GoogleStorageStore;\n"]}