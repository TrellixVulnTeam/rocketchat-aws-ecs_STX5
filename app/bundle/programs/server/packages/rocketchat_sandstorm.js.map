{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:sandstorm/server/lib.js","meteor://ðŸ’»app/packages/rocketchat:sandstorm/server/events.js","meteor://ðŸ’»app/packages/rocketchat:sandstorm/server/powerbox.js"],"names":["RocketChat","Sandstorm","process","env","SANDSTORM","Future","Npm","require","Capnp","SandstormHttpBridge","importSystem","capnpConnection","httpBridge","getHttpBridge","connect","restore","promiseToFuture","promise","result","then","return","bind","throw","waitPromise","wait","UploadFS","Store","prototype","getURL","path","getRelativeURL","_","module","watch","default","v","notify","ACTIVITY_TYPES","message","userIds","caption","type","sessionId","sandstormSessionId","activity","notification","defaultText","users","map","userId","user","Meteor","findOne","_id","fields","identity","getSavedIdentity","services","sandstorm","id","mentioned","getSessionContext","context","offerUiView","Powerbox","Grain","token","serializedDescriptor","session","api","getSandstormApi","cap","Buffer","offer","undefined","tags","value","methods","sandstormClaimRequest","descriptor","parsePacked","PowerboxDescriptor","grainTitle","parse","UiView","PowerboxTag","title","connection","claimRequest","castAs","newToken","save","toString","viewInfo","getViewInfo","appTitle","asset","grainIcon","getUrl","appIconUrl","protocol","hostPath","sandstormOffer"],"mappings":"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","file":"/packages/rocketchat_sandstorm.js","sourcesContent":["/* globals getHttpBridge, waitPromise, UploadFS */\n/* exported getHttpBridge, waitPromise */\n\nRocketChat.Sandstorm = {};\n\nif (process.env.SANDSTORM === '1') {\n\tconst Future = Npm.require('fibers/future');\n\tconst Capnp = Npm.require('/node_modules/capnp.js');\n\tconst SandstormHttpBridge = Capnp.importSystem('sandstorm/sandstorm-http-bridge.capnp').SandstormHttpBridge;\n\n\tlet capnpConnection = null;\n\tlet httpBridge = null;\n\n\tgetHttpBridge = function() {\n\t\tif (!httpBridge) {\n\t\t\tcapnpConnection = Capnp.connect('unix:/tmp/sandstorm-api');\n\t\t\thttpBridge = capnpConnection.restore(null, SandstormHttpBridge);\n\t\t}\n\t\treturn httpBridge;\n\t};\n\n\tconst promiseToFuture = function(promise) {\n\t\tconst result = new Future();\n\t\tpromise.then(result.return.bind(result), result.throw.bind(result));\n\t\treturn result;\n\t};\n\n\twaitPromise = function(promise) {\n\t\treturn promiseToFuture(promise).wait();\n\t};\n\n\t// This usual implementation of this method returns an absolute URL that is invalid\n\t// under Sandstorm.\n\tUploadFS.Store.prototype.getURL = function(path) {\n\t\treturn this.getRelativeURL(path);\n\t};\n}\n","/* globals getHttpBridge, waitPromise */\n\nimport _ from 'underscore';\n\nRocketChat.Sandstorm.notify = function() {};\n\nif (process.env.SANDSTORM === '1') {\n\tconst ACTIVITY_TYPES = {\n\t\t'message': 0,\n\t\t'privateMessage': 1\n\t};\n\n\tRocketChat.Sandstorm.notify = function(message, userIds, caption, type) {\n\t\tconst sessionId = message.sandstormSessionId;\n\t\tif (!sessionId) {\n\t\t\treturn;\n\t\t}\n\t\tconst httpBridge = getHttpBridge();\n\t\tconst activity = {};\n\n\t\tif (type) {\n\t\t\tactivity.type = ACTIVITY_TYPES[type];\n\t\t}\n\n\t\tif (caption) {\n\t\t\tactivity.notification = {caption: {defaultText: caption}};\n\t\t}\n\n\t\tif (userIds) {\n\t\t\tactivity.users = _.map(userIds, function(userId) {\n\t\t\t\tconst user = Meteor.users.findOne({_id: userId}, {fields: {'services.sandstorm.id': 1}});\n\t\t\t\treturn {\n\t\t\t\t\tidentity: waitPromise(httpBridge.getSavedIdentity(user.services.sandstorm.id)).identity,\n\t\t\t\t\tmentioned: true\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t\treturn waitPromise(httpBridge.getSessionContext(sessionId).context.activity(activity));\n\t};\n}\n","/* globals getHttpBridge, waitPromise */\n\nRocketChat.Sandstorm.offerUiView = function() {};\n\nif (process.env.SANDSTORM === '1') {\n\tconst Capnp = Npm.require('/node_modules/capnp.js');\n\tconst Powerbox = Capnp.importSystem('sandstorm/powerbox.capnp');\n\tconst Grain = Capnp.importSystem('sandstorm/grain.capnp');\n\n\tRocketChat.Sandstorm.offerUiView = function(token, serializedDescriptor, sessionId) {\n\t\tconst httpBridge = getHttpBridge();\n\t\tconst session = httpBridge.getSessionContext(sessionId).context;\n\t\tconst api = httpBridge.getSandstormApi(sessionId).api;\n\t\tconst cap = waitPromise(api.restore(new Buffer(token, 'base64'))).cap;\n\t\treturn waitPromise(session.offer(cap, undefined, {tags: [{\n\t\t\tid: '15831515641881813735',\n\t\t\tvalue: new Buffer(serializedDescriptor, 'base64')\n\t\t}]}));\n\t};\n\n\tMeteor.methods({\n\t\tsandstormClaimRequest(token, serializedDescriptor) {\n\t\t\tconst descriptor = Capnp.parsePacked(Powerbox.PowerboxDescriptor, new Buffer(serializedDescriptor, 'base64'));\n\t\t\tconst grainTitle = Capnp.parse(Grain.UiView.PowerboxTag, descriptor.tags[0].value).title;\n\t\t\tconst sessionId = this.connection.sandstormSessionId();\n\t\t\tconst httpBridge = getHttpBridge();\n\t\t\tconst session = httpBridge.getSessionContext(sessionId).context;\n\t\t\tconst cap = waitPromise(session.claimRequest(token)).cap.castAs(Grain.UiView);\n\t\t\tconst api = httpBridge.getSandstormApi(sessionId).api;\n\t\t\tconst newToken = waitPromise(api.save(cap)).token.toString('base64');\n\t\t\tconst viewInfo = waitPromise(cap.getViewInfo());\n\t\t\tconst appTitle = viewInfo.appTitle;\n\t\t\tconst asset = waitPromise(viewInfo.grainIcon.getUrl());\n\t\t\tconst appIconUrl = `${ asset.protocol }://${ asset.hostPath }`;\n\t\t\treturn {\n\t\t\t\ttoken: newToken,\n\t\t\t\tappTitle,\n\t\t\t\tappIconUrl,\n\t\t\t\tgrainTitle,\n\t\t\t\tdescriptor: descriptor.tags[0].value.toString('base64')\n\t\t\t};\n\t\t},\n\t\tsandstormOffer(token, serializedDescriptor) {\n\t\t\tRocketChat.Sandstorm.offerUiView(token, serializedDescriptor,\n\t\t\t\tthis.connection.sandstormSessionId());\n\t\t}\n\t});\n}\n"]}