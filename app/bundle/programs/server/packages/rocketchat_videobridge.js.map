{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:videobridge/lib/messageType.js","meteor://ðŸ’»app/packages/rocketchat:videobridge/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:videobridge/server/models/Rooms.js","meteor://ðŸ’»app/packages/rocketchat:videobridge/server/methods/jitsiSetTimeout.js","meteor://ðŸ’»app/packages/rocketchat:videobridge/server/actionLink.js"],"names":["Meteor","startup","RocketChat","MessageTypes","registerType","id","system","message","TAPi18n","__","settings","addGroup","add","type","i18nLabel","alert","public","enableQuery","_id","value","models","Rooms","setJitsiTimeout","time","query","update","$set","jitsiTimeout","methods","rid","userId","Error","method","room","findOneById","currentTime","Date","getTime","Messages","createWithTypeRoomIdMessageAndUser","user","actionLinks","icon","label","method_id","params","msg","mentions","username","callbacks","run","register"],"mappings":"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","file":"/packages/rocketchat_videobridge.js","sourcesContent":["Meteor.startup(function() {\n\tRocketChat.MessageTypes.registerType({\n\t\tid: 'jitsi_call_started',\n\t\tsystem: true,\n\t\tmessage: TAPi18n.__('Started_a_video_call')\n\t});\n});\n","Meteor.startup(function() {\n\tRocketChat.settings.addGroup('Video Conference', function() {\n\t\tthis.add('Jitsi_Enabled', false, {\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Enabled',\n\t\t\talert: 'This Feature is currently in beta! Please report bugs to github.com/RocketChat/Rocket.Chat/issues',\n\t\t\tpublic: true\n\t\t});\n\n\t\tthis.add('Jitsi_Domain', 'meet.jit.si', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'Jitsi_Enabled',\n\t\t\t\tvalue: true\n\t\t\t},\n\t\t\ti18nLabel: 'Domain',\n\t\t\tpublic: true\n\t\t});\n\n\t\tthis.add('Jitsi_URL_Room_Prefix', 'RocketChat', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'Jitsi_Enabled',\n\t\t\t\tvalue: true\n\t\t\t},\n\t\t\ti18nLabel: 'URL_room_prefix',\n\t\t\tpublic: true\n\t\t});\n\n\t\tthis.add('Jitsi_SSL', true, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'Jitsi_Enabled',\n\t\t\t\tvalue: true\n\t\t\t},\n\t\t\ti18nLabel: 'SSL',\n\t\t\tpublic: true\n\t\t});\n\n\t\tthis.add('Jitsi_Open_New_Window', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'Jitsi_Enabled',\n\t\t\t\tvalue: true\n\t\t\t},\n\t\t\ti18nLabel: 'Always_open_in_new_window',\n\t\t\tpublic: true\n\t\t});\n\n\t\tthis.add('Jitsi_Enable_Channels', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'Jitsi_Enabled',\n\t\t\t\tvalue: true\n\t\t\t},\n\t\t\ti18nLabel: 'Jitsi_Enable_Channels',\n\t\t\tpublic: true\n\t\t});\n\n\t\tthis.add('Jitsi_Chrome_Extension', 'nocfbnnmjnndkbipkabodnheejiegccf', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'Jitsi_Enabled',\n\t\t\t\tvalue: true\n\t\t\t},\n\t\t\ti18nLabel: 'Jitsi_Chrome_Extension',\n\t\t\tpublic: true\n\t\t});\n\t});\n});\n","/**\n * sets jitsiTimeout to indicate a call is in progress\n * @param {string} _id - Room id\n * @parm {number} time - time to set\n */\nRocketChat.models.Rooms.setJitsiTimeout = function(_id, time) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tjitsiTimeout: time\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n","\nMeteor.methods({\n\t'jitsi:updateTimeout': (rid) => {\n\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'jitsi:updateTimeout' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\t\tconst currentTime = new Date().getTime();\n\n\t\tconst jitsiTimeout = new Date((room && room.jitsiTimeout) || currentTime).getTime();\n\n\t\tif (jitsiTimeout <= currentTime) {\n\t\t\tRocketChat.models.Rooms.setJitsiTimeout(rid, new Date(currentTime + 35*1000));\n\t\t\tconst message = RocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('jitsi_call_started', rid, '', Meteor.user(), {\n\t\t\t\tactionLinks : [\n\t\t\t\t\t{ icon: 'icon-videocam', label: TAPi18n.__('Click_to_join'), method_id: 'joinJitsiCall', params: ''}\n\t\t\t\t]\n\t\t\t});\n\t\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\t\t\tmessage.msg = TAPi18n.__('Started_a_video_call');\n\t\t\tmessage.mentions = [\n\t\t\t\t{\n\t\t\t\t\t_id:'here',\n\t\t\t\t\tusername:'here'\n\t\t\t\t}\n\t\t\t];\n\t\t\tRocketChat.callbacks.run('afterSaveMessage', message, room);\n\t\t} else if ((jitsiTimeout - currentTime) / 1000 <= 15) {\n\t\t\tRocketChat.models.Rooms.setJitsiTimeout(rid, new Date(jitsiTimeout + 25*1000));\n\t\t}\n\t}\n});\n","RocketChat.actionLinks.register('joinJitsiCall', function(/*message, params*/) {\n\n});\n"]}