{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/autotranslate.js","meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/permissions.js","meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/models/Messages.js","meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/models/Subscriptions.js","meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/methods/saveSettings.js","meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/methods/translateMessage.js","meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/methods/getSupportedLanguages.js"],"names":["Meteor","startup","RocketChat","settings","add","type","group","section","public","enableQuery","_id","value","_","module","watch","require","default","v","s","AutoTranslate","constructor","languages","enabled","get","apiKey","supportedLanguages","callbacks","translateMessage","bind","priority","MEDIUM","key","tokenize","message","tokens","Array","isArray","tokenizeEmojis","tokenizeCode","tokenizeURLs","tokenizeMentions","count","length","msg","replace","match","token","push","text","schemes","split","join","RegExp","pre","post","pretoken","posttoken","html","Markdown","parseMessageNotEscaped","tokenIndex","hasOwnProperty","indexOf","newToken","mentions","forEach","mention","username","channels","channel","name","deTokenize","noHtml","room","targetLanguage","targetLanguages","models","Subscriptions","getAutoTranslateLanguagesByRoomAndNotUser","u","defer","translations","targetMessage","Object","assign","escapeHTML","String","msgs","map","encodeURIComponent","query","getSupportedLanguages","language","findWhere","substr","result","HTTP","params","target","e","console","log","statusCode","data","txt","translation","translatedText","isEmpty","Messages","addTranslations","attachments","index","attachment","description","addAttachmentTranslations","response","error","status","Permissions","findOne","insert","roles","messageId","updateObj","keys","update","$set","attachmentIndex","updateAutoTranslateById","autoTranslate","$unset","updateAutoTranslateLanguageById","autoTranslateLanguage","rid","userId","subscriptionsRaw","model","rawCollection","distinct","wrapAsync","$ne","methods","field","options","Error","method","authz","hasPermission","check","subscription","findOneByRoomIdAndUserId","defaultLanguage","Rooms","findOneById","DDPRateLimiter","addRule"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,OAAOC,OAAP,CAAe,YAAW;AACzBC,YAAWC,QAAX,CAAoBC,GAApB,CAAwB,uBAAxB,EAAiD,KAAjD,EAAwD;AAAEC,QAAM,SAAR;AAAmBC,SAAO,SAA1B;AAAqCC,WAAS,eAA9C;AAA+DC,UAAQ;AAAvE,EAAxD;AACAN,YAAWC,QAAX,CAAoBC,GAApB,CAAwB,4BAAxB,EAAsD,EAAtD,EAA0D;AAAEC,QAAM,QAAR;AAAkBC,SAAO,SAAzB;AAAoCC,WAAS,eAA7C;AAA8DE,eAAa;AAAEC,QAAK,uBAAP;AAAgCC,UAAO;AAAvC;AAA3E,EAA1D;AACA,CAHD,E;;;;;;;;;;;ACAA,IAAIC,CAAJ;;AAAMC,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,SAAQC,CAAR,EAAU;AAACL,MAAEK,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAAwD,IAAIC,CAAJ;AAAML,OAAOC,KAAP,CAAaC,QAAQ,mBAAR,CAAb,EAA0C;AAACC,SAAQC,CAAR,EAAU;AAACC,MAAED,CAAF;AAAI;;AAAhB,CAA1C,EAA4D,CAA5D;;AAGpE,MAAME,aAAN,CAAoB;AACnBC,eAAc;AACb,OAAKC,SAAL,GAAiB,EAAjB;AACA,OAAKC,OAAL,GAAepB,WAAWC,QAAX,CAAoBoB,GAApB,CAAwB,uBAAxB,CAAf;AACA,OAAKC,MAAL,GAActB,WAAWC,QAAX,CAAoBoB,GAApB,CAAwB,4BAAxB,CAAd;AACA,OAAKE,kBAAL,GAA0B,EAA1B;AACAvB,aAAWwB,SAAX,CAAqBtB,GAArB,CAAyB,kBAAzB,EAA6C,KAAKuB,gBAAL,CAAsBC,IAAtB,CAA2B,IAA3B,CAA7C,EAA+E1B,WAAWwB,SAAX,CAAqBG,QAArB,CAA8BC,MAA7G,EAAqH,eAArH;AAEA5B,aAAWC,QAAX,CAAoBoB,GAApB,CAAwB,uBAAxB,EAAiD,CAACQ,GAAD,EAAMpB,KAAN,KAAgB;AAChE,QAAKW,OAAL,GAAeX,KAAf;AACA,GAFD;AAGAT,aAAWC,QAAX,CAAoBoB,GAApB,CAAwB,4BAAxB,EAAsD,CAACQ,GAAD,EAAMpB,KAAN,KAAgB;AACrE,QAAKa,MAAL,GAAcb,KAAd;AACA,GAFD;AAGA;;AAEDqB,UAASC,OAAT,EAAkB;AACjB,MAAI,CAACA,QAAQC,MAAT,IAAmB,CAACC,MAAMC,OAAN,CAAcH,QAAQC,MAAtB,CAAxB,EAAuD;AACtDD,WAAQC,MAAR,GAAiB,EAAjB;AACA;;AACDD,YAAU,KAAKI,cAAL,CAAoBJ,OAApB,CAAV;AACAA,YAAU,KAAKK,YAAL,CAAkBL,OAAlB,CAAV;AACAA,YAAU,KAAKM,YAAL,CAAkBN,OAAlB,CAAV;AACAA,YAAU,KAAKO,gBAAL,CAAsBP,OAAtB,CAAV;AACA,SAAOA,OAAP;AACA;;AAEDI,gBAAeJ,OAAf,EAAwB;AACvB,MAAIQ,QAAQR,QAAQC,MAAR,CAAeQ,MAA3B;AACAT,UAAQU,GAAR,GAAcV,QAAQU,GAAR,CAAYC,OAAZ,CAAoB,aAApB,EAAmC,UAASC,KAAT,EAAgB;AAChE,SAAMC,QAAS,yBAAyBL,OAAS,OAAjD;AACAR,WAAQC,MAAR,CAAea,IAAf,CAAoB;AACnBD,SADmB;AAEnBE,UAAMH;AAFa,IAApB;AAIA,UAAOC,KAAP;AACA,GAPa,CAAd;AASA,SAAOb,OAAP;AACA;;AAEDM,cAAaN,OAAb,EAAsB;AACrB,MAAIQ,QAAQR,QAAQC,MAAR,CAAeQ,MAA3B;AAEA,QAAMO,UAAU/C,WAAWC,QAAX,CAAoBoB,GAApB,CAAwB,gCAAxB,EAA0D2B,KAA1D,CAAgE,GAAhE,EAAqEC,IAArE,CAA0E,GAA1E,CAAhB,CAHqB,CAKrB;;AACAlB,UAAQU,GAAR,GAAcV,QAAQU,GAAR,CAAYC,OAAZ,CAAoB,IAAIQ,MAAJ,CAAY,6BAA6BH,OAAS,qBAAlD,EAAwE,IAAxE,CAApB,EAAmG,UAASJ,KAAT,EAAgBQ,GAAhB,EAAqBL,IAArB,EAA2BM,IAA3B,EAAiC;AACjJ,SAAMC,WAAY,yBAAyBd,OAAS,OAApD;AACAR,WAAQC,MAAR,CAAea,IAAf,CAAoB;AACnBD,WAAOS,QADY;AAEnBP,UAAMK;AAFa,IAApB;AAKA,SAAMG,YAAa,yBAAyBf,OAAS,OAArD;AACAR,WAAQC,MAAR,CAAea,IAAf,CAAoB;AACnBD,WAAOU,SADY;AAEnBR,UAAMM;AAFa,IAApB;AAKA,UAAOC,WAAWP,IAAX,GAAkBQ,SAAzB;AACA,GAda,CAAd,CANqB,CAsBrB;;AACAvB,UAAQU,GAAR,GAAcV,QAAQU,GAAR,CAAYC,OAAZ,CAAoB,IAAIQ,MAAJ,CAAY,iBAAiBH,OAAS,gDAAtC,EAAuF,IAAvF,CAApB,EAAkH,UAASJ,KAAT,EAAgBQ,GAAhB,EAAqBL,IAArB,EAA2BM,IAA3B,EAAiC;AAChK,SAAMC,WAAY,yBAAyBd,OAAS,OAApD;AACAR,WAAQC,MAAR,CAAea,IAAf,CAAoB;AACnBD,WAAOS,QADY;AAEnBP,UAAMK;AAFa,IAApB;AAKA,SAAMG,YAAa,yBAAyBf,OAAS,OAArD;AACAR,WAAQC,MAAR,CAAea,IAAf,CAAoB;AACnBD,WAAOU,SADY;AAEnBR,UAAMM;AAFa,IAApB;AAKA,UAAOC,WAAWP,IAAX,GAAkBQ,SAAzB;AACA,GAda,CAAd;AAgBA,SAAOvB,OAAP;AACA;;AAEDK,cAAaL,OAAb,EAAsB;AACrB,MAAIQ,QAAQR,QAAQC,MAAR,CAAeQ,MAA3B;AAEAT,UAAQwB,IAAR,GAAexB,QAAQU,GAAvB;AACAV,YAAU/B,WAAWwD,QAAX,CAAoBC,sBAApB,CAA2C1B,OAA3C,CAAV;AACAA,UAAQU,GAAR,GAAcV,QAAQwB,IAAtB;;AAEA,OAAK,MAAMG,UAAX,IAAyB3B,QAAQC,MAAjC,EAAyC;AACxC,OAAID,QAAQC,MAAR,CAAe2B,cAAf,CAA8BD,UAA9B,CAAJ,EAA+C;AAC9C,UAAMd,QAAQb,QAAQC,MAAR,CAAe0B,UAAf,EAA2Bd,KAAzC;;AACA,QAAIA,MAAMgB,OAAN,CAAc,aAAd,MAAiC,CAAC,CAAtC,EAAyC;AACxC,WAAMC,WAAY,yBAAyBtB,OAAS,OAApD;AACAR,aAAQU,GAAR,GAAcV,QAAQU,GAAR,CAAYC,OAAZ,CAAoBE,KAApB,EAA2BiB,QAA3B,CAAd;AACA9B,aAAQC,MAAR,CAAe0B,UAAf,EAA2Bd,KAA3B,GAAmCiB,QAAnC;AACA;AACD;AACD;;AAED,SAAO9B,OAAP;AACA;;AAEDO,kBAAiBP,OAAjB,EAA0B;AACzB,MAAIQ,QAAQR,QAAQC,MAAR,CAAeQ,MAA3B;;AAEA,MAAIT,QAAQ+B,QAAR,IAAoB/B,QAAQ+B,QAAR,CAAiBtB,MAAjB,GAA0B,CAAlD,EAAqD;AACpDT,WAAQ+B,QAAR,CAAiBC,OAAjB,CAAyBC,WAAW;AACnCjC,YAAQU,GAAR,GAAcV,QAAQU,GAAR,CAAYC,OAAZ,CAAoB,IAAIQ,MAAJ,CAAY,KAAKc,QAAQC,QAAU,GAAnC,EAAuC,IAAvC,CAApB,EAAkEtB,SAAS;AACxF,WAAMC,QAAS,yBAAyBL,OAAS,OAAjD;AACAR,aAAQC,MAAR,CAAea,IAAf,CAAoB;AACnBD,WADmB;AAEnBE,YAAMH;AAFa,MAApB;AAIA,YAAOC,KAAP;AACA,KAPa,CAAd;AAQA,IATD;AAUA;;AAED,MAAIb,QAAQmC,QAAR,IAAoBnC,QAAQmC,QAAR,CAAiB1B,MAAjB,GAA0B,CAAlD,EAAqD;AACpDT,WAAQmC,QAAR,CAAiBH,OAAjB,CAAyBI,WAAW;AACnCpC,YAAQU,GAAR,GAAcV,QAAQU,GAAR,CAAYC,OAAZ,CAAoB,IAAIQ,MAAJ,CAAY,KAAKiB,QAAQC,IAAM,GAA/B,EAAmC,IAAnC,CAApB,EAA8DzB,SAAS;AACpF,WAAMC,QAAS,yBAAyBL,OAAS,OAAjD;AACAR,aAAQC,MAAR,CAAea,IAAf,CAAoB;AACnBD,WADmB;AAEnBE,YAAMH;AAFa,MAApB;AAIA,YAAOC,KAAP;AACA,KAPa,CAAd;AAQA,IATD;AAUA;;AAED,SAAOb,OAAP;AACA;;AAEDsC,YAAWtC,OAAX,EAAoB;AACnB,MAAIA,QAAQC,MAAR,IAAkBD,QAAQC,MAAR,CAAeQ,MAAf,GAAwB,CAA9C,EAAiD;AAChD,sBAAoCT,QAAQC,MAA5C,EAAoD;AAAA,UAAzC;AAACY,UAAD;AAAQE,SAAR;AAAcwB;AAAd,KAAyC;AACnDvC,YAAQU,GAAR,GAAcV,QAAQU,GAAR,CAAYC,OAAZ,CAAoBE,KAApB,EAA2B,MAAM0B,SAASA,MAAT,GAAkBxB,IAAnD,CAAd;AACA;AACD;;AACD,SAAOf,QAAQU,GAAf;AACA;;AAEDhB,kBAAiBM,OAAjB,EAA0BwC,IAA1B,EAAgCC,cAAhC,EAAgD;AAC/C,MAAI,KAAKpD,OAAL,IAAgB,KAAKE,MAAzB,EAAiC;AAChC,OAAImD,eAAJ;;AACA,OAAID,cAAJ,EAAoB;AACnBC,sBAAkB,CAAED,cAAF,CAAlB;AACA,IAFD,MAEO;AACNC,sBAAkBzE,WAAW0E,MAAX,CAAkBC,aAAlB,CAAgCC,yCAAhC,CAA0EL,KAAK/D,GAA/E,EAAoFuB,QAAQ8C,CAAR,IAAa9C,QAAQ8C,CAAR,CAAUrE,GAA3G,CAAlB;AACA;;AACD,OAAIuB,QAAQU,GAAZ,EAAiB;AAChB3C,WAAOgF,KAAP,CAAa,MAAM;AAClB,WAAMC,eAAe,EAArB;AACA,SAAIC,gBAAgBC,OAAOC,MAAP,CAAc,EAAd,EAAkBnD,OAAlB,CAApB;AAEAiD,mBAAczB,IAAd,GAAqBvC,EAAEmE,UAAF,CAAaC,OAAOJ,cAAcvC,GAArB,CAAb,CAArB;AACAuC,qBAAgB,KAAKlD,QAAL,CAAckD,aAAd,CAAhB;AAEA,SAAIK,OAAOL,cAAcvC,GAAd,CAAkBO,KAAlB,CAAwB,IAAxB,CAAX;AACAqC,YAAOA,KAAKC,GAAL,CAAS7C,OAAO8C,mBAAmB9C,GAAnB,CAAhB,CAAP;AACA,WAAM+C,QAAS,KAAKH,KAAKpC,IAAL,CAAU,KAAV,CAAkB,EAAtC;AAEA,WAAM1B,qBAAqB,KAAKkE,qBAAL,CAA2B,IAA3B,CAA3B;AACAhB,qBAAgBV,OAAhB,CAAwB2B,YAAY;AACnC,UAAIA,SAAS9B,OAAT,CAAiB,GAAjB,MAA0B,CAAC,CAA3B,IAAgC,CAAClD,EAAEiF,SAAF,CAAYpE,kBAAZ,EAAgC;AAAEmE;AAAF,OAAhC,CAArC,EAAoF;AACnFA,kBAAWA,SAASE,MAAT,CAAgB,CAAhB,EAAmB,CAAnB,CAAX;AACA;;AACD,UAAIC,MAAJ;;AACA,UAAI;AACHA,gBAASC,KAAKzE,GAAL,CAAS,0DAAT,EAAqE;AAAE0E,gBAAQ;AAAElE,cAAK,KAAKP,MAAZ;AAAoB0E,iBAAQN;AAA5B,SAAV;AAAkDF;AAAlD,QAArE,CAAT;AACA,OAFD,CAEE,OAAOS,CAAP,EAAU;AACXC,eAAQC,GAAR,CAAY,2BAAZ,EAAyCF,CAAzC;AACA,cAAOlE,OAAP;AACA;;AACD,UAAI8D,OAAOO,UAAP,KAAsB,GAAtB,IAA6BP,OAAOQ,IAApC,IAA4CR,OAAOQ,IAAP,CAAYA,IAAxD,IAAgER,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAAjF,IAAiG9C,MAAMC,OAAN,CAAc2D,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAA/B,CAAjG,IAAiJc,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAAjB,CAA8BvC,MAA9B,GAAuC,CAA5L,EAA+L;AAC9L,aAAM8D,MAAMT,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAAjB,CAA8BO,GAA9B,CAAkCiB,eAAeA,YAAYC,cAA7D,EAA6EvD,IAA7E,CAAkF,IAAlF,CAAZ;AACA8B,oBAAaW,QAAb,IAAyB,KAAKrB,UAAL,CAAgBY,OAAOC,MAAP,CAAc,EAAd,EAAkBF,aAAlB,EAAiC;AAAEvC,aAAK6D;AAAP,QAAjC,CAAhB,CAAzB;AACA;AACD,MAfD;;AAgBA,SAAI,CAAC5F,EAAE+F,OAAF,CAAU1B,YAAV,CAAL,EAA8B;AAC7B/E,iBAAW0E,MAAX,CAAkBgC,QAAlB,CAA2BC,eAA3B,CAA2C5E,QAAQvB,GAAnD,EAAwDuE,YAAxD;AACA;AACD,KA/BD;AAgCA;;AAED,OAAIhD,QAAQ6E,WAAR,IAAuB7E,QAAQ6E,WAAR,CAAoBpE,MAApB,GAA6B,CAAxD,EAA2D;AAC1D1C,WAAOgF,KAAP,CAAa,MAAM;AAClB,UAAK,MAAM+B,KAAX,IAAoB9E,QAAQ6E,WAA5B,EAAyC;AACxC,UAAI7E,QAAQ6E,WAAR,CAAoBjD,cAApB,CAAmCkD,KAAnC,CAAJ,EAA+C;AAC9C,aAAMC,aAAa/E,QAAQ6E,WAAR,CAAoBC,KAApB,CAAnB;AACA,aAAM9B,eAAe,EAArB;;AACA,WAAI+B,WAAWC,WAAX,IAA0BD,WAAWhE,IAAzC,EAA+C;AAC9C,cAAM0C,QAAS,KAAKD,mBAAmBuB,WAAWC,WAAX,IAA0BD,WAAWhE,IAAxD,CAA+D,EAAnF;AACA,cAAMvB,qBAAqB,KAAKkE,qBAAL,CAA2B,IAA3B,CAA3B;AACAhB,wBAAgBV,OAAhB,CAAwB2B,YAAY;AACnC,aAAIA,SAAS9B,OAAT,CAAiB,GAAjB,MAA0B,CAAC,CAA3B,IAAgC,CAAClD,EAAEiF,SAAF,CAAYpE,kBAAZ,EAAgC;AAAEmE;AAAF,UAAhC,CAArC,EAAoF;AACnFA,qBAAWA,SAASE,MAAT,CAAgB,CAAhB,EAAmB,CAAnB,CAAX;AACA;;AACD,eAAMC,SAASC,KAAKzE,GAAL,CAAS,0DAAT,EAAqE;AAAE0E,kBAAQ;AAAElE,gBAAK,KAAKP,MAAZ;AAAoB0E,mBAAQN;AAA5B,WAAV;AAAkDF;AAAlD,UAArE,CAAf;;AACA,aAAIK,OAAOO,UAAP,KAAsB,GAAtB,IAA6BP,OAAOQ,IAApC,IAA4CR,OAAOQ,IAAP,CAAYA,IAAxD,IAAgER,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAAjF,IAAiG9C,MAAMC,OAAN,CAAc2D,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAA/B,CAAjG,IAAiJc,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAAjB,CAA8BvC,MAA9B,GAAuC,CAA5L,EAA+L;AAC9L,gBAAM8D,MAAMT,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAAjB,CAA8BO,GAA9B,CAAkCiB,eAAeA,YAAYC,cAA7D,EAA6EvD,IAA7E,CAAkF,IAAlF,CAAZ;AACA8B,uBAAaW,QAAb,IAAyBY,GAAzB;AACA;AACD,SATD;;AAUA,YAAI,CAAC5F,EAAE+F,OAAF,CAAU1B,YAAV,CAAL,EAA8B;AAC7B/E,oBAAW0E,MAAX,CAAkBgC,QAAlB,CAA2BM,yBAA3B,CAAqDjF,QAAQvB,GAA7D,EAAkEqG,KAAlE,EAAyE9B,YAAzE;AACA;AACD;AACD;AACD;AACD,KAxBD;AAyBA;AACD;;AACD,SAAOhD,OAAP;AACA;;AAED0D,uBAAsBO,MAAtB,EAA8B;AAC7B,MAAI,KAAK5E,OAAL,IAAgB,KAAKE,MAAzB,EAAiC;AAChC,OAAI,KAAKC,kBAAL,CAAwByE,MAAxB,CAAJ,EAAqC;AACpC,WAAO,KAAKzE,kBAAL,CAAwByE,MAAxB,CAAP;AACA;;AAED,OAAIH,MAAJ;AACA,SAAME,SAAS;AAAElE,SAAK,KAAKP;AAAZ,IAAf;;AACA,OAAI0E,MAAJ,EAAY;AACXD,WAAOC,MAAP,GAAgBA,MAAhB;AACA;;AAED,OAAI;AACHH,aAASC,KAAKzE,GAAL,CAAS,oEAAT,EAA+E;AAAE0E;AAAF,KAA/E,CAAT;AACA,IAFD,CAEE,OAAOE,CAAP,EAAU;AACX,QAAIA,EAAEgB,QAAF,IAAchB,EAAEgB,QAAF,CAAWb,UAAX,KAA0B,GAAxC,IAA+CH,EAAEgB,QAAF,CAAWZ,IAA1D,IAAkEJ,EAAEgB,QAAF,CAAWZ,IAAX,CAAgBa,KAAlF,IAA2FjB,EAAEgB,QAAF,CAAWZ,IAAX,CAAgBa,KAAhB,CAAsBC,MAAtB,KAAiC,kBAAhI,EAAoJ;AACnJpB,YAAOC,MAAP,GAAgB,IAAhB;AACAA,cAAS,IAAT;;AACA,SAAI,CAAC,KAAKzE,kBAAL,CAAwByE,MAAxB,CAAL,EAAsC;AACrCH,eAASC,KAAKzE,GAAL,CAAS,oEAAT,EAA+E;AAAE0E;AAAF,OAA/E,CAAT;AACA;AACD;AACD,IAVD,SAUU;AACT,QAAI,KAAKxE,kBAAL,CAAwByE,MAAxB,CAAJ,EAAqC;AACpC,YAAO,KAAKzE,kBAAL,CAAwByE,MAAxB,CAAP;AACA,KAFD,MAEO;AACN,UAAKzE,kBAAL,CAAwByE,UAAU,IAAlC,IAA0CH,UAAUA,OAAOQ,IAAjB,IAAyBR,OAAOQ,IAAP,CAAYA,IAArC,IAA6CR,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBlF,SAAxG;AACA,YAAO,KAAKI,kBAAL,CAAwByE,UAAU,IAAlC,CAAP;AACA;AACD;AACD;AACD;;AA1PkB;;AA6PpBhG,WAAWiB,aAAX,GAA2B,IAAIA,aAAJ,EAA3B,C;;;;;;;;;;;AChQAnB,OAAOC,OAAP,CAAe,MAAM;AACpB,KAAIC,WAAW0E,MAAX,IAAqB1E,WAAW0E,MAAX,CAAkB0C,WAA3C,EAAwD;AACvD,MAAI,CAACpH,WAAW0E,MAAX,CAAkB0C,WAAlB,CAA8BC,OAA9B,CAAsC;AAAE7G,QAAK;AAAP,GAAtC,CAAL,EAAuE;AACtER,cAAW0E,MAAX,CAAkB0C,WAAlB,CAA8BE,MAA9B,CAAqC;AAAE9G,SAAK,gBAAP;AAAyB+G,WAAO,CAAC,OAAD;AAAhC,IAArC;AACA;AACD;AACD,CAND,E;;;;;;;;;;;ACAAvH,WAAW0E,MAAX,CAAkBgC,QAAlB,CAA2BC,eAA3B,GAA6C,UAASa,SAAT,EAAoBzC,YAApB,EAAkC;AAC9E,OAAM0C,YAAY,EAAlB;AACAxC,QAAOyC,IAAP,CAAY3C,YAAZ,EAA0BhB,OAA1B,CAAmClC,GAAD,IAAS;AAC1C,QAAM0E,cAAcxB,aAAalD,GAAb,CAApB;AACA4F,YAAW,gBAAgB5F,GAAK,EAAhC,IAAqC0E,WAArC;AACA,EAHD;AAIA,QAAO,KAAKoB,MAAL,CAAY;AAAEnH,OAAKgH;AAAP,EAAZ,EAAgC;AAAEI,QAAMH;AAAR,EAAhC,CAAP;AACA,CAPD;;AASAzH,WAAW0E,MAAX,CAAkBgC,QAAlB,CAA2BM,yBAA3B,GAAuD,UAASQ,SAAT,EAAoBK,eAApB,EAAqC9C,YAArC,EAAmD;AACzG,OAAM0C,YAAY,EAAlB;AACAxC,QAAOyC,IAAP,CAAY3C,YAAZ,EAA0BhB,OAA1B,CAAmClC,GAAD,IAAS;AAC1C,QAAM0E,cAAcxB,aAAalD,GAAb,CAApB;AACA4F,YAAW,eAAeI,eAAiB,iBAAiBhG,GAAK,EAAjE,IAAsE0E,WAAtE;AACA,EAHD;AAIA,QAAO,KAAKoB,MAAL,CAAY;AAAEnH,OAAKgH;AAAP,EAAZ,EAAgC;AAAEI,QAAMH;AAAR,EAAhC,CAAP;AACA,CAPD,C;;;;;;;;;;;ACTAzH,WAAW0E,MAAX,CAAkBC,aAAlB,CAAgCmD,uBAAhC,GAA0D,UAAStH,GAAT,EAAcuH,aAAd,EAA6B;AACtF,OAAMvC,QAAQ;AACbhF;AADa,EAAd;AAIA,KAAImH,MAAJ;;AACA,KAAII,aAAJ,EAAmB;AAClBJ,WAAS;AACRC,SAAM;AACLG;AADK;AADE,GAAT;AAKA,EAND,MAMO;AACNJ,WAAS;AACRK,WAAQ;AACPD,mBAAe;AADR;AADA,GAAT;AAKA;;AAED,QAAO,KAAKJ,MAAL,CAAYnC,KAAZ,EAAmBmC,MAAnB,CAAP;AACA,CArBD;;AAuBA3H,WAAW0E,MAAX,CAAkBC,aAAlB,CAAgCsD,+BAAhC,GAAkE,UAASzH,GAAT,EAAc0H,qBAAd,EAAqC;AACtG,OAAM1C,QAAQ;AACbhF;AADa,EAAd;AAIA,OAAMmH,SAAS;AACdC,QAAM;AACLM;AADK;AADQ,EAAf;AAMA,QAAO,KAAKP,MAAL,CAAYnC,KAAZ,EAAmBmC,MAAnB,CAAP;AACA,CAZD;;AAcA3H,WAAW0E,MAAX,CAAkBC,aAAlB,CAAgCC,yCAAhC,GAA4E,UAASuD,GAAT,EAAcC,MAAd,EAAsB;AACjG,OAAMC,mBAAmBrI,WAAW0E,MAAX,CAAkBC,aAAlB,CAAgC2D,KAAhC,CAAsCC,aAAtC,EAAzB;AACA,OAAMC,WAAW1I,OAAO2I,SAAP,CAAiBJ,iBAAiBG,QAAlC,EAA4CH,gBAA5C,CAAjB;AACA,OAAM7C,QAAQ;AACb2C,KADa;AAEb,WAAS;AAAEO,QAAKN;AAAP,GAFI;AAGbL,iBAAe;AAHF,EAAd;AAKA,QAAOS,SAAS,uBAAT,EAAkChD,KAAlC,CAAP;AACA,CATD,C;;;;;;;;;;;ACrCA1F,OAAO6I,OAAP,CAAe;AACd,8BAA6BR,GAA7B,EAAkCS,KAAlC,EAAyCnI,KAAzC,EAAgDoI,OAAhD,EAAyD;AACxD,MAAI,CAAC/I,OAAOsI,MAAP,EAAL,EAAsB;AACrB,SAAM,IAAItI,OAAOgJ,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAEC,YAAQ;AAAV,IAAvD,CAAN;AACA;;AAED,MAAI,CAAC/I,WAAWgJ,KAAX,CAAiBC,aAAjB,CAA+BnJ,OAAOsI,MAAP,EAA/B,EAAgD,gBAAhD,CAAL,EAAwE;AACvE,SAAM,IAAItI,OAAOgJ,KAAX,CAAiB,0BAAjB,EAA6C,+BAA7C,EAA8E;AAAEC,YAAQ;AAAV,IAA9E,CAAN;AACA;;AAEDG,QAAMf,GAAN,EAAW/C,MAAX;AACA8D,QAAMN,KAAN,EAAaxD,MAAb;AACA8D,QAAMzI,KAAN,EAAa2E,MAAb;;AAEA,MAAI,CAAC,eAAD,EAAkB,uBAAlB,EAA2CxB,OAA3C,CAAmDgF,KAAnD,MAA8D,CAAC,CAAnE,EAAsE;AACrE,SAAM,IAAI9I,OAAOgJ,KAAX,CAAiB,wBAAjB,EAA2C,wBAA3C,EAAqE;AAAEC,YAAQ;AAAV,IAArE,CAAN;AACA;;AAED,QAAMI,eAAenJ,WAAW0E,MAAX,CAAkBC,aAAlB,CAAgCyE,wBAAhC,CAAyDjB,GAAzD,EAA8DrI,OAAOsI,MAAP,EAA9D,CAArB;;AACA,MAAI,CAACe,YAAL,EAAmB;AAClB,SAAM,IAAIrJ,OAAOgJ,KAAX,CAAiB,4BAAjB,EAA+C,sBAA/C,EAAuE;AAAEC,YAAQ;AAAV,IAAvE,CAAN;AACA;;AAED,UAAQH,KAAR;AACC,QAAK,eAAL;AACC5I,eAAW0E,MAAX,CAAkBC,aAAlB,CAAgCmD,uBAAhC,CAAwDqB,aAAa3I,GAArE,EAA0EC,UAAU,GAAV,GAAgB,IAAhB,GAAuB,KAAjG;;AACA,QAAI,CAAC0I,aAAajB,qBAAd,IAAuCW,QAAQQ,eAAnD,EAAoE;AACnErJ,gBAAW0E,MAAX,CAAkBC,aAAlB,CAAgCsD,+BAAhC,CAAgEkB,aAAa3I,GAA7E,EAAkFqI,QAAQQ,eAA1F;AACA;;AACD;;AACD,QAAK,uBAAL;AACCrJ,eAAW0E,MAAX,CAAkBC,aAAlB,CAAgCsD,+BAAhC,CAAgEkB,aAAa3I,GAA7E,EAAkFC,KAAlF;AACA;AATF;;AAYA,SAAO,IAAP;AACA;;AApCa,CAAf,E;;;;;;;;;;;ACAAX,OAAO6I,OAAP,CAAe;AACd,kCAAiC5G,OAAjC,EAA0CyC,cAA1C,EAA0D;AACzD,QAAMD,OAAOvE,WAAW0E,MAAX,CAAkB4E,KAAlB,CAAwBC,WAAxB,CAAoCxH,WAAWA,QAAQoG,GAAvD,CAAb;;AACA,MAAIpG,WAAWwC,IAAX,IAAmBvE,WAAWiB,aAAlC,EAAiD;AAChD,UAAOjB,WAAWiB,aAAX,CAAyBQ,gBAAzB,CAA0CM,OAA1C,EAAmDwC,IAAnD,EAAyDC,cAAzD,CAAP;AACA;AACD;;AANa,CAAf,E;;;;;;;;;;;ACAA1E,OAAO6I,OAAP,CAAe;AACd,uCAAsCnE,cAAtC,EAAsD;AACrD,MAAI,CAACxE,WAAWgJ,KAAX,CAAiBC,aAAjB,CAA+BnJ,OAAOsI,MAAP,EAA/B,EAAgD,gBAAhD,CAAL,EAAwE;AACvE,SAAM,IAAItI,OAAOgJ,KAAX,CAAiB,0BAAjB,EAA6C,+BAA7C,EAA8E;AAAEC,YAAQ;AAAV,IAA9E,CAAN;AACA;;AAED,SAAO/I,WAAWiB,aAAX,CAAyBwE,qBAAzB,CAA+CjB,cAA/C,CAAP;AACA;;AAPa,CAAf;AAUAgF,eAAeC,OAAf,CAAuB;AACtBtJ,OAAM,QADgB;AAEtBiE,OAAM,qCAFgB;;AAGtBgE,UAAO,UAAY;AAClB,SAAO,IAAP;AACA;;AALqB,CAAvB,EAMG,CANH,EAMM,KANN,E","file":"/packages/rocketchat_autotranslate.js","sourcesContent":["Meteor.startup(function() {\n\tRocketChat.settings.add('AutoTranslate_Enabled', false, { type: 'boolean', group: 'Message', section: 'AutoTranslate', public: true });\n\tRocketChat.settings.add('AutoTranslate_GoogleAPIKey', '', { type: 'string', group: 'Message', section: 'AutoTranslate', enableQuery: { _id: 'AutoTranslate_Enabled', value: true } });\n});\n","import _ from 'underscore';\nimport s from 'underscore.string';\n\nclass AutoTranslate {\n\tconstructor() {\n\t\tthis.languages = [];\n\t\tthis.enabled = RocketChat.settings.get('AutoTranslate_Enabled');\n\t\tthis.apiKey = RocketChat.settings.get('AutoTranslate_GoogleAPIKey');\n\t\tthis.supportedLanguages = {};\n\t\tRocketChat.callbacks.add('afterSaveMessage', this.translateMessage.bind(this), RocketChat.callbacks.priority.MEDIUM, 'AutoTranslate');\n\n\t\tRocketChat.settings.get('AutoTranslate_Enabled', (key, value) => {\n\t\t\tthis.enabled = value;\n\t\t});\n\t\tRocketChat.settings.get('AutoTranslate_GoogleAPIKey', (key, value) => {\n\t\t\tthis.apiKey = value;\n\t\t});\n\t}\n\n\ttokenize(message) {\n\t\tif (!message.tokens || !Array.isArray(message.tokens)) {\n\t\t\tmessage.tokens = [];\n\t\t}\n\t\tmessage = this.tokenizeEmojis(message);\n\t\tmessage = this.tokenizeCode(message);\n\t\tmessage = this.tokenizeURLs(message);\n\t\tmessage = this.tokenizeMentions(message);\n\t\treturn message;\n\t}\n\n\ttokenizeEmojis(message) {\n\t\tlet count = message.tokens.length;\n\t\tmessage.msg = message.msg.replace(/:[+\\w\\d]+:/g, function(match) {\n\t\t\tconst token = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\tmessage.tokens.push({\n\t\t\t\ttoken,\n\t\t\t\ttext: match\n\t\t\t});\n\t\t\treturn token;\n\t\t});\n\n\t\treturn message;\n\t}\n\n\ttokenizeURLs(message) {\n\t\tlet count = message.tokens.length;\n\n\t\tconst schemes = RocketChat.settings.get('Markdown_SupportSchemesForLink').split(',').join('|');\n\n\t\t// Support ![alt text](http://image url) and [text](http://link)\n\t\tmessage.msg = message.msg.replace(new RegExp(`(!?\\\\[)([^\\\\]]+)(\\\\]\\\\((?:${ schemes }):\\\\/\\\\/[^\\\\)]+\\\\))`, 'gm'), function(match, pre, text, post) {\n\t\t\tconst pretoken = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\tmessage.tokens.push({\n\t\t\t\ttoken: pretoken,\n\t\t\t\ttext: pre\n\t\t\t});\n\n\t\t\tconst posttoken = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\tmessage.tokens.push({\n\t\t\t\ttoken: posttoken,\n\t\t\t\ttext: post\n\t\t\t});\n\n\t\t\treturn pretoken + text + posttoken;\n\t\t});\n\n\t\t// Support <http://link|Text>\n\t\tmessage.msg = message.msg.replace(new RegExp(`((?:<|&lt;)(?:${ schemes }):\\\\/\\\\/[^\\\\|]+\\\\|)(.+?)(?=>|&gt;)((?:>|&gt;))`, 'gm'), function(match, pre, text, post) {\n\t\t\tconst pretoken = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\tmessage.tokens.push({\n\t\t\t\ttoken: pretoken,\n\t\t\t\ttext: pre\n\t\t\t});\n\n\t\t\tconst posttoken = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\tmessage.tokens.push({\n\t\t\t\ttoken: posttoken,\n\t\t\t\ttext: post\n\t\t\t});\n\n\t\t\treturn pretoken + text + posttoken;\n\t\t});\n\n\t\treturn message;\n\t}\n\n\ttokenizeCode(message) {\n\t\tlet count = message.tokens.length;\n\n\t\tmessage.html = message.msg;\n\t\tmessage = RocketChat.Markdown.parseMessageNotEscaped(message);\n\t\tmessage.msg = message.html;\n\n\t\tfor (const tokenIndex in message.tokens) {\n\t\t\tif (message.tokens.hasOwnProperty(tokenIndex)) {\n\t\t\t\tconst token = message.tokens[tokenIndex].token;\n\t\t\t\tif (token.indexOf('notranslate') === -1) {\n\t\t\t\t\tconst newToken = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\t\t\tmessage.msg = message.msg.replace(token, newToken);\n\t\t\t\t\tmessage.tokens[tokenIndex].token = newToken;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn message;\n\t}\n\n\ttokenizeMentions(message) {\n\t\tlet count = message.tokens.length;\n\n\t\tif (message.mentions && message.mentions.length > 0) {\n\t\t\tmessage.mentions.forEach(mention => {\n\t\t\t\tmessage.msg = message.msg.replace(new RegExp(`(@${ mention.username })`, 'gm'), match => {\n\t\t\t\t\tconst token = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\t\t\tmessage.tokens.push({\n\t\t\t\t\t\ttoken,\n\t\t\t\t\t\ttext: match\n\t\t\t\t\t});\n\t\t\t\t\treturn token;\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tif (message.channels && message.channels.length > 0) {\n\t\t\tmessage.channels.forEach(channel => {\n\t\t\t\tmessage.msg = message.msg.replace(new RegExp(`(#${ channel.name })`, 'gm'), match => {\n\t\t\t\t\tconst token = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\t\t\tmessage.tokens.push({\n\t\t\t\t\t\ttoken,\n\t\t\t\t\t\ttext: match\n\t\t\t\t\t});\n\t\t\t\t\treturn token;\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\treturn message;\n\t}\n\n\tdeTokenize(message) {\n\t\tif (message.tokens && message.tokens.length > 0) {\n\t\t\tfor (const {token, text, noHtml} of message.tokens) {\n\t\t\t\tmessage.msg = message.msg.replace(token, () => noHtml ? noHtml : text);\n\t\t\t}\n\t\t}\n\t\treturn message.msg;\n\t}\n\n\ttranslateMessage(message, room, targetLanguage) {\n\t\tif (this.enabled && this.apiKey) {\n\t\t\tlet targetLanguages;\n\t\t\tif (targetLanguage) {\n\t\t\t\ttargetLanguages = [ targetLanguage ];\n\t\t\t} else {\n\t\t\t\ttargetLanguages = RocketChat.models.Subscriptions.getAutoTranslateLanguagesByRoomAndNotUser(room._id, message.u && message.u._id);\n\t\t\t}\n\t\t\tif (message.msg) {\n\t\t\t\tMeteor.defer(() => {\n\t\t\t\t\tconst translations = {};\n\t\t\t\t\tlet targetMessage = Object.assign({}, message);\n\n\t\t\t\t\ttargetMessage.html = s.escapeHTML(String(targetMessage.msg));\n\t\t\t\t\ttargetMessage = this.tokenize(targetMessage);\n\n\t\t\t\t\tlet msgs = targetMessage.msg.split('\\n');\n\t\t\t\t\tmsgs = msgs.map(msg => encodeURIComponent(msg));\n\t\t\t\t\tconst query = `q=${ msgs.join('&q=') }`;\n\n\t\t\t\t\tconst supportedLanguages = this.getSupportedLanguages('en');\n\t\t\t\t\ttargetLanguages.forEach(language => {\n\t\t\t\t\t\tif (language.indexOf('-') !== -1 && !_.findWhere(supportedLanguages, { language })) {\n\t\t\t\t\t\t\tlanguage = language.substr(0, 2);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlet result;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tresult = HTTP.get('https://translation.googleapis.com/language/translate/v2', { params: { key: this.apiKey, target: language }, query });\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\tconsole.log('Error translating message', e);\n\t\t\t\t\t\t\treturn message;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (result.statusCode === 200 && result.data && result.data.data && result.data.data.translations && Array.isArray(result.data.data.translations) && result.data.data.translations.length > 0) {\n\t\t\t\t\t\t\tconst txt = result.data.data.translations.map(translation => translation.translatedText).join('\\n');\n\t\t\t\t\t\t\ttranslations[language] = this.deTokenize(Object.assign({}, targetMessage, { msg: txt }));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\tif (!_.isEmpty(translations)) {\n\t\t\t\t\t\tRocketChat.models.Messages.addTranslations(message._id, translations);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (message.attachments && message.attachments.length > 0) {\n\t\t\t\tMeteor.defer(() => {\n\t\t\t\t\tfor (const index in message.attachments) {\n\t\t\t\t\t\tif (message.attachments.hasOwnProperty(index)) {\n\t\t\t\t\t\t\tconst attachment = message.attachments[index];\n\t\t\t\t\t\t\tconst translations = {};\n\t\t\t\t\t\t\tif (attachment.description || attachment.text) {\n\t\t\t\t\t\t\t\tconst query = `q=${ encodeURIComponent(attachment.description || attachment.text) }`;\n\t\t\t\t\t\t\t\tconst supportedLanguages = this.getSupportedLanguages('en');\n\t\t\t\t\t\t\t\ttargetLanguages.forEach(language => {\n\t\t\t\t\t\t\t\t\tif (language.indexOf('-') !== -1 && !_.findWhere(supportedLanguages, { language })) {\n\t\t\t\t\t\t\t\t\t\tlanguage = language.substr(0, 2);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tconst result = HTTP.get('https://translation.googleapis.com/language/translate/v2', { params: { key: this.apiKey, target: language }, query });\n\t\t\t\t\t\t\t\t\tif (result.statusCode === 200 && result.data && result.data.data && result.data.data.translations && Array.isArray(result.data.data.translations) && result.data.data.translations.length > 0) {\n\t\t\t\t\t\t\t\t\t\tconst txt = result.data.data.translations.map(translation => translation.translatedText).join('\\n');\n\t\t\t\t\t\t\t\t\t\ttranslations[language] = txt;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tif (!_.isEmpty(translations)) {\n\t\t\t\t\t\t\t\t\tRocketChat.models.Messages.addAttachmentTranslations(message._id, index, translations);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\treturn message;\n\t}\n\n\tgetSupportedLanguages(target) {\n\t\tif (this.enabled && this.apiKey) {\n\t\t\tif (this.supportedLanguages[target]) {\n\t\t\t\treturn this.supportedLanguages[target];\n\t\t\t}\n\n\t\t\tlet result;\n\t\t\tconst params = { key: this.apiKey };\n\t\t\tif (target) {\n\t\t\t\tparams.target = target;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tresult = HTTP.get('https://translation.googleapis.com/language/translate/v2/languages', { params });\n\t\t\t} catch (e) {\n\t\t\t\tif (e.response && e.response.statusCode === 400 && e.response.data && e.response.data.error && e.response.data.error.status === 'INVALID_ARGUMENT') {\n\t\t\t\t\tparams.target = 'en';\n\t\t\t\t\ttarget = 'en';\n\t\t\t\t\tif (!this.supportedLanguages[target]) {\n\t\t\t\t\t\tresult = HTTP.get('https://translation.googleapis.com/language/translate/v2/languages', { params });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tif (this.supportedLanguages[target]) {\n\t\t\t\t\treturn this.supportedLanguages[target];\n\t\t\t\t} else {\n\t\t\t\t\tthis.supportedLanguages[target || 'en'] = result && result.data && result.data.data && result.data.data.languages;\n\t\t\t\t\treturn this.supportedLanguages[target || 'en'];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nRocketChat.AutoTranslate = new AutoTranslate;\n","Meteor.startup(() => {\n\tif (RocketChat.models && RocketChat.models.Permissions) {\n\t\tif (!RocketChat.models.Permissions.findOne({ _id: 'auto-translate' })) {\n\t\t\tRocketChat.models.Permissions.insert({ _id: 'auto-translate', roles: ['admin'] });\n\t\t}\n\t}\n});\n","RocketChat.models.Messages.addTranslations = function(messageId, translations) {\n\tconst updateObj = {};\n\tObject.keys(translations).forEach((key) => {\n\t\tconst translation = translations[key];\n\t\tupdateObj[`translations.${ key }`] = translation;\n\t});\n\treturn this.update({ _id: messageId }, { $set: updateObj });\n};\n\nRocketChat.models.Messages.addAttachmentTranslations = function(messageId, attachmentIndex, translations) {\n\tconst updateObj = {};\n\tObject.keys(translations).forEach((key) => {\n\t\tconst translation = translations[key];\n\t\tupdateObj[`attachments.${ attachmentIndex }.translations.${ key }`] = translation;\n\t});\n\treturn this.update({ _id: messageId }, { $set: updateObj });\n};\n","RocketChat.models.Subscriptions.updateAutoTranslateById = function(_id, autoTranslate) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tlet update;\n\tif (autoTranslate) {\n\t\tupdate = {\n\t\t\t$set: {\n\t\t\t\tautoTranslate\n\t\t\t}\n\t\t};\n\t} else {\n\t\tupdate = {\n\t\t\t$unset: {\n\t\t\t\tautoTranslate: 1\n\t\t\t}\n\t\t};\n\t}\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Subscriptions.updateAutoTranslateLanguageById = function(_id, autoTranslateLanguage) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tautoTranslateLanguage\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Subscriptions.getAutoTranslateLanguagesByRoomAndNotUser = function(rid, userId) {\n\tconst subscriptionsRaw = RocketChat.models.Subscriptions.model.rawCollection();\n\tconst distinct = Meteor.wrapAsync(subscriptionsRaw.distinct, subscriptionsRaw);\n\tconst query = {\n\t\trid,\n\t\t'u._id': { $ne: userId },\n\t\tautoTranslate: true\n\t};\n\treturn distinct('autoTranslateLanguage', query);\n};\n","Meteor.methods({\n\t'autoTranslate.saveSettings'(rid, field, value, options) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'saveAutoTranslateSettings' });\n\t\t}\n\n\t\tif (!RocketChat.authz.hasPermission(Meteor.userId(), 'auto-translate')) {\n\t\t\tthrow new Meteor.Error('error-action-now-allowed', 'Auto-Translate is not allowed', { method: 'autoTranslate.saveSettings'});\n\t\t}\n\n\t\tcheck(rid, String);\n\t\tcheck(field, String);\n\t\tcheck(value, String);\n\n\t\tif (['autoTranslate', 'autoTranslateLanguage'].indexOf(field) === -1) {\n\t\t\tthrow new Meteor.Error('error-invalid-settings', 'Invalid settings field', { method: 'saveAutoTranslateSettings' });\n\t\t}\n\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(rid, Meteor.userId());\n\t\tif (!subscription) {\n\t\t\tthrow new Meteor.Error('error-invalid-subscription', 'Invalid subscription', { method: 'saveAutoTranslateSettings' });\n\t\t}\n\n\t\tswitch (field) {\n\t\t\tcase 'autoTranslate':\n\t\t\t\tRocketChat.models.Subscriptions.updateAutoTranslateById(subscription._id, value === '1' ? true : false);\n\t\t\t\tif (!subscription.autoTranslateLanguage && options.defaultLanguage) {\n\t\t\t\t\tRocketChat.models.Subscriptions.updateAutoTranslateLanguageById(subscription._id, options.defaultLanguage);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'autoTranslateLanguage':\n\t\t\t\tRocketChat.models.Subscriptions.updateAutoTranslateLanguageById(subscription._id, value);\n\t\t\t\tbreak;\n\t\t}\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\t'autoTranslate.translateMessage'(message, targetLanguage) {\n\t\tconst room = RocketChat.models.Rooms.findOneById(message && message.rid);\n\t\tif (message && room && RocketChat.AutoTranslate) {\n\t\t\treturn RocketChat.AutoTranslate.translateMessage(message, room, targetLanguage);\n\t\t}\n\t}\n});\n","Meteor.methods({\n\t'autoTranslate.getSupportedLanguages'(targetLanguage) {\n\t\tif (!RocketChat.authz.hasPermission(Meteor.userId(), 'auto-translate')) {\n\t\t\tthrow new Meteor.Error('error-action-now-allowed', 'Auto-Translate is not allowed', { method: 'autoTranslate.saveSettings'});\n\t\t}\n\n\t\treturn RocketChat.AutoTranslate.getSupportedLanguages(targetLanguage);\n\t}\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'autoTranslate.getSupportedLanguages',\n\tuserId(/*userId*/) {\n\t\treturn true;\n\t}\n}, 5, 60000);\n"]}