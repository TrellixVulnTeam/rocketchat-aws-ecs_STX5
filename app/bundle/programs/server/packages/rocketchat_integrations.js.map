{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:integrations/lib/rocketchat.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/logger.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/lib/validation.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/lib/triggerHandler.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/models/Integrations.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/models/IntegrationHistory.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/publications/integrations.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/publications/integrationHistory.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/incoming/addIncomingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/incoming/updateIncomingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/incoming/deleteIncomingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/addOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/updateOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/replayOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/deleteOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/clearIntegrationHistory.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/api/api.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/triggers.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/processWebhookMessage.js"],"names":["RocketChat","integrations","outgoingEvents","sendMessage","label","value","use","channel","triggerWords","targetRoom","fileUploaded","roomArchived","roomCreated","roomJoined","roomLeft","userCreated","logger","Logger","sections","incoming","outgoing","_","module","watch","require","default","v","s","scopedChannels","validChannelChars","_verifyRequiredFields","integration","event","Match","test","String","trim","Meteor","Error","function","username","urls","index","url","entries","without","undefined","length","_verifyUserHasPermissionForChannels","userId","channels","includes","authz","hasPermission","record","channelType","substr","models","Rooms","findOne","$or","_id","name","Users","usernames","user","_verifyRetryInformation","retryFailedCalls","retryCount","parseInt","retryDelay","toLowerCase","validateOutgoing","_validateOutgoing","map","split","forEach","word","scriptEnabled","script","babelOptions","Object","assign","Babel","getDefaultOptions","runtime","compact","minified","comments","scriptCompiled","compile","code","scriptError","e","pick","runOnEdits","type","moment","triggerHandler","RocketChatIntegrationHandler","constructor","vm","Npm","successResults","compiledScripts","triggers","Integrations","find","observe","added","addIntegration","changed","removeIntegration","removed","debug","isEmpty","concat","trigger","values","isTriggerEnabled","trig","enabled","updateHistory","historyId","step","data","triggerWord","ranPrepareScript","prepareSentMessage","processSentMessage","resultMessage","finished","httpCallData","httpError","httpResult","error","errorStack","history","omit","room","JSON","stringify","IntegrationHistory","update","$set","_createdAt","Date","insert","Random","id","nameOrId","message","impersonateUser","findOneByUsername","user_name","tmpRoom","getRoomByNameOrIdWithOptionToJoin","currentUserId","errorOnEmpty","warn","t","bot","i","defaultValues","alias","avatar","emoji","processWebhookMessage","buildSandbox","store","sandbox","console","Store","set","key","val","get","HTTP","method","options","result","call","keys","filter","k","startsWith","getIntegrationScript","compiledScript","_updatedAt","vmScript","info","createScript","runInNewContext","Script","replace","stack","hasScriptAndMethod","executeScript","params","timeout","eventNameArgumentsToObject","argObject","arguments","arghhh","owner","mapEventArgsToData","channel_id","channel_name","message_id","timestamp","ts","user_id","u","text","msg","editedAt","isEdited","createdAt","executeTriggers","triggersToExecute","push","all_direct_messages","all_public_channels","all_private_groups","__any","triggerToExecute","executeTrigger","executeTriggerUrl","theHistoryId","tries","triggerWordAnywhere","indexOf","token","trigger_word","opts","auth","npmRequestOptions","rejectUnauthorized","settings","strictSSL","headers","request","prepareMessage","statusCode","response","status_code","content","content_raw","scriptResult","waitTime","Math","pow","er","setTimeout","attachments","resultMsg","replay","Messages","findOneById","_Base","findByType","disableByUserId","multi","findByIntegrationId","findByIntegrationIdAndCreatedBy","creatorId","findOneByIntegrationIdAndHistoryId","integrationId","findByEventName","findFailed","removeByIntegrationId","remove","publish","_integrationPublication","ready","_integrationHistoryPublication","limit","sort","methods","addIncomingIntegration","isString","extend","_createdBy","fields","Roles","addUserRoles","updateIncomingIntegration","currentIntegration","_updatedBy","deleteIncomingIntegration","addOutgoingIntegration","updateOutgoingIntegration","replayOutgoingIntegration","deleteOutgoingIntegration","clearIntegrationHistory","Livechat","API","v1","failure","Api","Restivus","enableCors","apiPath","payloadKeys","bodyParams","payloadIsWrapped","payload","parse","body","success","decodeURIComponent","createIntegration","runAsUser","target_url","trigger_words","integrationToRemove","executeIntegrationRest","urlParams","hash","_parsedUrl","search","query","queryParams","pathname","path","url_raw","url_params","_readableState","buffer","toString","scriptResponse","addIntegrationRest","removeIntegrationRest","integrationSampleRest","integrationInfoRest","addRoute","authRequired","post","callbackHandler","_callbackHandler","eventType","_wrapperFunction","callbacks","add","priority","LOW","messageObj","mustBeJoined","sentData","roomId","channelValue","joinChannel","tryDirectByUserIdOnly","isArray","log","red","parseUrls","groupable","icon_url","icon_emoji","attachment","messageReturn"],"mappings":"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","file":"/packages/rocketchat_integrations.js","sourcesContent":["RocketChat.integrations = {\n\toutgoingEvents: {\n\t\tsendMessage: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_SendMessage',\n\t\t\tvalue: 'sendMessage',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: true,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\tfileUploaded: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_FileUploaded',\n\t\t\tvalue: 'fileUploaded',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomArchived: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomArchived',\n\t\t\tvalue: 'roomArchived',\n\t\t\tuse: {\n\t\t\t\tchannel: false,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomCreated: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomCreated',\n\t\t\tvalue: 'roomCreated',\n\t\t\tuse: {\n\t\t\t\tchannel: false,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomJoined: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomJoined',\n\t\t\tvalue: 'roomJoined',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomLeft: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomLeft',\n\t\t\tvalue: 'roomLeft',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\tuserCreated: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_UserCreated',\n\t\t\tvalue: 'userCreated',\n\t\t\tuse: {\n\t\t\t\tchannel: false,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: true\n\t\t\t}\n\t\t}\n\t}\n};\n","/* globals logger:true */\n/* exported logger */\n\nlogger = new Logger('Integrations', {\n\tsections: {\n\t\tincoming: 'Incoming WebHook',\n\t\toutgoing: 'Outgoing WebHook'\n\t}\n});\n","/* global Babel */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nconst scopedChannels = ['all_public_channels', 'all_private_groups', 'all_direct_messages'];\nconst validChannelChars = ['@', '#'];\n\nfunction _verifyRequiredFields(integration) {\n\tif (!integration.event || !Match.test(integration.event, String) || integration.event.trim() === '' || !RocketChat.integrations.outgoingEvents[integration.event]) {\n\t\tthrow new Meteor.Error('error-invalid-event-type', 'Invalid event type', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tif (!integration.username || !Match.test(integration.username, String) || integration.username.trim() === '') {\n\t\tthrow new Meteor.Error('error-invalid-username', 'Invalid username', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tif (RocketChat.integrations.outgoingEvents[integration.event].use.targetRoom && !integration.targetRoom) {\n\t\tthrow new Meteor.Error('error-invalid-targetRoom', 'Invalid Target Room', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tif (!Match.test(integration.urls, [String])) {\n\t\tthrow new Meteor.Error('error-invalid-urls', 'Invalid URLs', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tfor (const [index, url] of integration.urls.entries()) {\n\t\tif (url.trim() === '') {\n\t\t\tdelete integration.urls[index];\n\t\t}\n\t}\n\n\tintegration.urls = _.without(integration.urls, [undefined]);\n\n\tif (integration.urls.length === 0) {\n\t\tthrow new Meteor.Error('error-invalid-urls', 'Invalid URLs', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n}\n\nfunction _verifyUserHasPermissionForChannels(integration, userId, channels) {\n\tfor (let channel of channels) {\n\t\tif (scopedChannels.includes(channel)) {\n\t\t\tif (channel === 'all_public_channels') {\n\t\t\t\t// No special permissions needed to add integration to public channels\n\t\t\t} else if (!RocketChat.authz.hasPermission(userId, 'manage-integrations')) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { function: 'validateOutgoing._verifyUserHasPermissionForChannels' });\n\t\t\t}\n\t\t} else {\n\t\t\tlet record;\n\t\t\tconst channelType = channel[0];\n\t\t\tchannel = channel.substr(1);\n\n\t\t\tswitch (channelType) {\n\t\t\t\tcase '#':\n\t\t\t\t\trecord = RocketChat.models.Rooms.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{name: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase '@':\n\t\t\t\t\trecord = RocketChat.models.Users.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{username: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!record) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { function: 'validateOutgoing._verifyUserHasPermissionForChannels' });\n\t\t\t}\n\n\t\t\tif (record.usernames && !RocketChat.authz.hasPermission(userId, 'manage-integrations') && RocketChat.authz.hasPermission(userId, 'manage-own-integrations') && !record.usernames.includes(Meteor.user().username)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { function: 'validateOutgoing._verifyUserHasPermissionForChannels' });\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction _verifyRetryInformation(integration) {\n\tif (!integration.retryFailedCalls) {\n\t\treturn;\n\t}\n\n\t// Don't allow negative retry counts\n\tintegration.retryCount = integration.retryCount && parseInt(integration.retryCount) > 0 ? parseInt(integration.retryCount) : 4;\n\tintegration.retryDelay = !integration.retryDelay || !integration.retryDelay.trim() ? 'powers-of-ten' : integration.retryDelay.toLowerCase();\n}\n\nRocketChat.integrations.validateOutgoing = function _validateOutgoing(integration, userId) {\n\tif (integration.channel && Match.test(integration.channel, String) && integration.channel.trim() === '') {\n\t\tdelete integration.channel;\n\t}\n\n\t//Moved to it's own function to statisfy the complexity rule\n\t_verifyRequiredFields(integration);\n\n\tlet channels = [];\n\tif (RocketChat.integrations.outgoingEvents[integration.event].use.channel) {\n\t\tif (!Match.test(integration.channel, String)) {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { function: 'validateOutgoing' });\n\t\t} else {\n\t\t\tchannels = _.map(integration.channel.split(','), (channel) => s.trim(channel));\n\n\t\t\tfor (const channel of channels) {\n\t\t\t\tif (!validChannelChars.includes(channel[0]) && !scopedChannels.includes(channel.toLowerCase())) {\n\t\t\t\t\tthrow new Meteor.Error('error-invalid-channel-start-with-chars', 'Invalid channel. Start with @ or #', { function: 'validateOutgoing' });\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else if (!RocketChat.authz.hasPermission(userId, 'manage-integrations')) {\n\t\tthrow new Meteor.Error('error-invalid-permissions', 'Invalid permission for required Integration creation.', { function: 'validateOutgoing' });\n\t}\n\n\tif (RocketChat.integrations.outgoingEvents[integration.event].use.triggerWords && integration.triggerWords) {\n\t\tif (!Match.test(integration.triggerWords, [String])) {\n\t\t\tthrow new Meteor.Error('error-invalid-triggerWords', 'Invalid triggerWords', { function: 'validateOutgoing' });\n\t\t}\n\n\t\tintegration.triggerWords.forEach((word, index) => {\n\t\t\tif (!word || word.trim() === '') {\n\t\t\t\tdelete integration.triggerWords[index];\n\t\t\t}\n\t\t});\n\n\t\tintegration.triggerWords = _.without(integration.triggerWords, [undefined]);\n\t} else {\n\t\tdelete integration.triggerWords;\n\t}\n\n\tif (integration.scriptEnabled === true && integration.script && integration.script.trim() !== '') {\n\t\ttry {\n\t\t\tconst babelOptions = Object.assign(Babel.getDefaultOptions({ runtime: false }), { compact: true, minified: true, comments: false });\n\n\t\t\tintegration.scriptCompiled = Babel.compile(integration.script, babelOptions).code;\n\t\t\tintegration.scriptError = undefined;\n\t\t} catch (e) {\n\t\t\tintegration.scriptCompiled = undefined;\n\t\t\tintegration.scriptError = _.pick(e, 'name', 'message', 'stack');\n\t\t}\n\t}\n\n\tif (typeof integration.runOnEdits !== 'undefined') {\n\t\t// Verify this value is only true/false\n\t\tintegration.runOnEdits = integration.runOnEdits === true;\n\t}\n\n\t_verifyUserHasPermissionForChannels(integration, userId, channels);\n\t_verifyRetryInformation(integration);\n\n\tconst user = RocketChat.models.Users.findOne({ username: integration.username });\n\n\tif (!user) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user (did you delete the `rocket.cat` user?)', { function: 'validateOutgoing' });\n\t}\n\n\tintegration.type = 'webhook-outgoing';\n\tintegration.userId = user._id;\n\tintegration.channel = channels;\n\n\treturn integration;\n};\n","/* global logger, processWebhookMessage */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nimport moment from 'moment';\n\nRocketChat.integrations.triggerHandler = new class RocketChatIntegrationHandler {\n\tconstructor() {\n\t\tthis.vm = Npm.require('vm');\n\t\tthis.successResults = [200, 201, 202];\n\t\tthis.compiledScripts = {};\n\t\tthis.triggers = {};\n\n\t\tRocketChat.models.Integrations.find({type: 'webhook-outgoing'}).observe({\n\t\t\tadded: (record) => {\n\t\t\t\tthis.addIntegration(record);\n\t\t\t},\n\n\t\t\tchanged: (record) => {\n\t\t\t\tthis.removeIntegration(record);\n\t\t\t\tthis.addIntegration(record);\n\t\t\t},\n\n\t\t\tremoved: (record) => {\n\t\t\t\tthis.removeIntegration(record);\n\t\t\t}\n\t\t});\n\t}\n\n\taddIntegration(record) {\n\t\tlogger.outgoing.debug(`Adding the integration ${ record.name } of the event ${ record.event }!`);\n\t\tlet channels;\n\t\tif (record.event && !RocketChat.integrations.outgoingEvents[record.event].use.channel) {\n\t\t\tlogger.outgoing.debug('The integration doesnt rely on channels.');\n\t\t\t//We don't use any channels, so it's special ;)\n\t\t\tchannels = ['__any'];\n\t\t} else if (_.isEmpty(record.channel)) {\n\t\t\tlogger.outgoing.debug('The integration had an empty channel property, so it is going on all the public channels.');\n\t\t\tchannels = ['all_public_channels'];\n\t\t} else {\n\t\t\tlogger.outgoing.debug('The integration is going on these channels:', record.channel);\n\t\t\tchannels = [].concat(record.channel);\n\t\t}\n\n\t\tfor (const channel of channels) {\n\t\t\tif (!this.triggers[channel]) {\n\t\t\t\tthis.triggers[channel] = {};\n\t\t\t}\n\n\t\t\tthis.triggers[channel][record._id] = record;\n\t\t}\n\t}\n\n\tremoveIntegration(record) {\n\t\tfor (const trigger of Object.values(this.triggers)) {\n\t\t\tdelete trigger[record._id];\n\t\t}\n\t}\n\n\tisTriggerEnabled(trigger) {\n\t\tfor (const trig of Object.values(this.triggers)) {\n\t\t\tif (trig[trigger._id]) {\n\t\t\t\treturn trig[trigger._id].enabled;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tupdateHistory({ historyId, step, integration, event, data, triggerWord, ranPrepareScript, prepareSentMessage, processSentMessage, resultMessage, finished, url, httpCallData, httpError, httpResult, error, errorStack }) {\n\t\tconst history = {\n\t\t\ttype: 'outgoing-webhook',\n\t\t\tstep\n\t\t};\n\n\t\t// Usually is only added on initial insert\n\t\tif (integration) {\n\t\t\thistory.integration = integration;\n\t\t}\n\n\t\t// Usually is only added on initial insert\n\t\tif (event) {\n\t\t\thistory.event = event;\n\t\t}\n\n\t\tif (data) {\n\t\t\thistory.data = data;\n\n\t\t\tif (data.user) {\n\t\t\t\thistory.data.user = _.omit(data.user, ['meta', '$loki', 'services']);\n\t\t\t}\n\n\t\t\tif (data.room) {\n\t\t\t\thistory.data.room = _.omit(data.room, ['meta', '$loki', 'usernames']);\n\t\t\t\thistory.data.room.usernames = ['this_will_be_filled_in_with_usernames_when_replayed'];\n\t\t\t}\n\t\t}\n\n\t\tif (triggerWord) {\n\t\t\thistory.triggerWord = triggerWord;\n\t\t}\n\n\t\tif (typeof ranPrepareScript !== 'undefined') {\n\t\t\thistory.ranPrepareScript = ranPrepareScript;\n\t\t}\n\n\t\tif (prepareSentMessage) {\n\t\t\thistory.prepareSentMessage = prepareSentMessage;\n\t\t}\n\n\t\tif (processSentMessage) {\n\t\t\thistory.processSentMessage = processSentMessage;\n\t\t}\n\n\t\tif (resultMessage) {\n\t\t\thistory.resultMessage = resultMessage;\n\t\t}\n\n\t\tif (typeof finished !== 'undefined') {\n\t\t\thistory.finished = finished;\n\t\t}\n\n\t\tif (url) {\n\t\t\thistory.url = url;\n\t\t}\n\n\t\tif (typeof httpCallData !== 'undefined') {\n\t\t\thistory.httpCallData = httpCallData;\n\t\t}\n\n\t\tif (httpError) {\n\t\t\thistory.httpError = httpError;\n\t\t}\n\n\t\tif (typeof httpResult !== 'undefined') {\n\t\t\thistory.httpResult = JSON.stringify(httpResult, null, 2);\n\t\t}\n\n\t\tif (typeof error !== 'undefined') {\n\t\t\thistory.error = error;\n\t\t}\n\n\t\tif (typeof errorStack !== 'undefined') {\n\t\t\thistory.errorStack = errorStack;\n\t\t}\n\n\t\tif (historyId) {\n\t\t\tRocketChat.models.IntegrationHistory.update({ _id: historyId }, { $set: history });\n\t\t\treturn historyId;\n\t\t} else {\n\t\t\thistory._createdAt = new Date();\n\t\t\treturn RocketChat.models.IntegrationHistory.insert(Object.assign({ _id: Random.id() }, history));\n\t\t}\n\t}\n\n\t//Trigger is the trigger, nameOrId is a string which is used to try and find a room, room is a room, message is a message, and data contains \"user_name\" if trigger.impersonateUser is truthful.\n\tsendMessage({ trigger, nameOrId = '', room, message, data }) {\n\t\tlet user;\n\t\t//Try to find the user who we are impersonating\n\t\tif (trigger.impersonateUser) {\n\t\t\tuser = RocketChat.models.Users.findOneByUsername(data.user_name);\n\t\t}\n\n\t\t//If they don't exist (aka the trigger didn't contain a user) then we set the user based upon the\n\t\t//configured username for the integration since this is required at all times.\n\t\tif (!user) {\n\t\t\tuser = RocketChat.models.Users.findOneByUsername(trigger.username);\n\t\t}\n\n\t\tlet tmpRoom;\n\t\tif (nameOrId || trigger.targetRoom || message.channel) {\n\t\t\ttmpRoom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: nameOrId || message.channel || trigger.targetRoom, errorOnEmpty: false }) || room;\n\t\t} else {\n\t\t\ttmpRoom = room;\n\t\t}\n\n\t\t//If no room could be found, we won't be sending any messages but we'll warn in the logs\n\t\tif (!tmpRoom) {\n\t\t\tlogger.outgoing.warn(`The Integration \"${ trigger.name }\" doesn't have a room configured nor did it provide a room to send the message to.`);\n\t\t\treturn;\n\t\t}\n\n\t\tlogger.outgoing.debug(`Found a room for ${ trigger.name } which is: ${ tmpRoom.name } with a type of ${ tmpRoom.t }`);\n\n\t\tmessage.bot = { i: trigger._id };\n\n\t\tconst defaultValues = {\n\t\t\talias: trigger.alias,\n\t\t\tavatar: trigger.avatar,\n\t\t\temoji: trigger.emoji\n\t\t};\n\n\t\tif (tmpRoom.t === 'd') {\n\t\t\tmessage.channel = `@${ tmpRoom._id }`;\n\t\t} else {\n\t\t\tmessage.channel = `#${ tmpRoom._id }`;\n\t\t}\n\n\t\tmessage = processWebhookMessage(message, user, defaultValues);\n\t\treturn message;\n\t}\n\n\tbuildSandbox(store = {}) {\n\t\tconst sandbox = {\n\t\t\t_, s, console, moment,\n\t\t\tStore: {\n\t\t\t\tset: (key, val) => store[key] = val,\n\t\t\t\tget: (key) => store[key]\n\t\t\t},\n\t\t\tHTTP: (method, url, options) => {\n\t\t\t\ttry {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tresult: HTTP.call(method, url, options)\n\t\t\t\t\t};\n\t\t\t\t} catch (error) {\n\t\t\t\t\treturn { error };\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tObject.keys(RocketChat.models).filter(k => !k.startsWith('_')).forEach(k => {\n\t\t\tsandbox[k] = RocketChat.models[k];\n\t\t});\n\n\t\treturn { store, sandbox };\n\t}\n\n\tgetIntegrationScript(integration) {\n\t\tconst compiledScript = this.compiledScripts[integration._id];\n\t\tif (compiledScript && +compiledScript._updatedAt === +integration._updatedAt) {\n\t\t\treturn compiledScript.script;\n\t\t}\n\n\t\tconst script = integration.scriptCompiled;\n\t\tconst { store, sandbox } = this.buildSandbox();\n\n\t\tlet vmScript;\n\t\ttry {\n\t\t\tlogger.outgoing.info('Will evaluate script of Trigger', integration.name);\n\t\t\tlogger.outgoing.debug(script);\n\n\t\t\tvmScript = this.vm.createScript(script, 'script.js');\n\n\t\t\tvmScript.runInNewContext(sandbox);\n\n\t\t\tif (sandbox.Script) {\n\t\t\t\tthis.compiledScripts[integration._id] = {\n\t\t\t\t\tscript: new sandbox.Script(),\n\t\t\t\t\tstore,\n\t\t\t\t\t_updatedAt: integration._updatedAt\n\t\t\t\t};\n\n\t\t\t\treturn this.compiledScripts[integration._id].script;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tlogger.outgoing.error(`Error evaluating Script in Trigger ${ integration.name }:`);\n\t\t\tlogger.outgoing.error(script.replace(/^/gm, '  '));\n\t\t\tlogger.outgoing.error('Stack Trace:');\n\t\t\tlogger.outgoing.error(e.stack.replace(/^/gm, '  '));\n\t\t\tthrow new Meteor.Error('error-evaluating-script');\n\t\t}\n\n\t\tif (!sandbox.Script) {\n\t\t\tlogger.outgoing.error(`Class \"Script\" not in Trigger ${ integration.name }:`);\n\t\t\tthrow new Meteor.Error('class-script-not-found');\n\t\t}\n\t}\n\n\thasScriptAndMethod(integration, method) {\n\t\tif (integration.scriptEnabled !== true || !integration.scriptCompiled || integration.scriptCompiled.trim() === '') {\n\t\t\treturn false;\n\t\t}\n\n\t\tlet script;\n\t\ttry {\n\t\t\tscript = this.getIntegrationScript(integration);\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn typeof script[method] !== 'undefined';\n\t}\n\n\texecuteScript(integration, method, params, historyId) {\n\t\tlet script;\n\t\ttry {\n\t\t\tscript = this.getIntegrationScript(integration);\n\t\t} catch (e) {\n\t\t\tthis.updateHistory({ historyId, step: 'execute-script-getting-script', error: true, errorStack: e });\n\t\t\treturn;\n\t\t}\n\n\t\tif (!script[method]) {\n\t\t\tlogger.outgoing.error(`Method \"${ method }\" no found in the Integration \"${ integration.name }\"`);\n\t\t\tthis.updateHistory({ historyId, step: `execute-script-no-method-${ method }` });\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tconst { sandbox } = this.buildSandbox(this.compiledScripts[integration._id].store);\n\t\t\tsandbox.script = script;\n\t\t\tsandbox.method = method;\n\t\t\tsandbox.params = params;\n\n\t\t\tthis.updateHistory({ historyId, step: `execute-script-before-running-${ method }` });\n\t\t\tconst result = this.vm.runInNewContext('script[method](params)', sandbox, { timeout: 3000 });\n\n\t\t\tlogger.outgoing.debug(`Script method \"${ method }\" result of the Integration \"${ integration.name }\" is:`);\n\t\t\tlogger.outgoing.debug(result);\n\n\t\t\treturn result;\n\t\t} catch (e) {\n\t\t\tthis.updateHistory({ historyId, step: `execute-script-error-running-${ method }`, error: true, errorStack: e.stack.replace(/^/gm, '  ') });\n\t\t\tlogger.outgoing.error(`Error running Script in the Integration ${ integration.name }:`);\n\t\t\tlogger.outgoing.debug(integration.scriptCompiled.replace(/^/gm, '  ')); // Only output the compiled script if debugging is enabled, so the logs don't get spammed.\n\t\t\tlogger.outgoing.error('Stack:');\n\t\t\tlogger.outgoing.error(e.stack.replace(/^/gm, '  '));\n\t\t\treturn;\n\t\t}\n\t}\n\n\teventNameArgumentsToObject() {\n\t\tconst argObject = {\n\t\t\tevent: arguments[0]\n\t\t};\n\n\t\tswitch (argObject.event) {\n\t\t\tcase 'sendMessage':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.message = arguments[1];\n\t\t\t\t\targObject.room = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'fileUploaded':\n\t\t\t\tif (arguments.length >= 2) {\n\t\t\t\t\tconst arghhh = arguments[1];\n\t\t\t\t\targObject.user = arghhh.user;\n\t\t\t\t\targObject.room = arghhh.room;\n\t\t\t\t\targObject.message = arghhh.message;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomArchived':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.room = arguments[1];\n\t\t\t\t\targObject.user = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomCreated':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.owner = arguments[1];\n\t\t\t\t\targObject.room = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomJoined':\n\t\t\tcase 'roomLeft':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.user = arguments[1];\n\t\t\t\t\targObject.room = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'userCreated':\n\t\t\t\tif (arguments.length >= 2) {\n\t\t\t\t\targObject.user = arguments[1];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tlogger.outgoing.warn(`An Unhandled Trigger Event was called: ${ argObject.event }`);\n\t\t\t\targObject.event = undefined;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tlogger.outgoing.debug(`Got the event arguments for the event: ${ argObject.event }`, argObject);\n\n\t\treturn argObject;\n\t}\n\n\tmapEventArgsToData(data, { event, message, room, owner, user }) {\n\t\tswitch (event) {\n\t\t\tcase 'sendMessage':\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.message_id = message._id;\n\t\t\t\tdata.timestamp = message.ts;\n\t\t\t\tdata.user_id = message.u._id;\n\t\t\t\tdata.user_name = message.u.username;\n\t\t\t\tdata.text = message.msg;\n\n\t\t\t\tif (message.alias) {\n\t\t\t\t\tdata.alias = message.alias;\n\t\t\t\t}\n\n\t\t\t\tif (message.bot) {\n\t\t\t\t\tdata.bot = message.bot;\n\t\t\t\t}\n\n\t\t\t\tif (message.editedAt) {\n\t\t\t\t\tdata.isEdited = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'fileUploaded':\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.message_id = message._id;\n\t\t\t\tdata.timestamp = message.ts;\n\t\t\t\tdata.user_id = message.u._id;\n\t\t\t\tdata.user_name = message.u.username;\n\t\t\t\tdata.text = message.msg;\n\t\t\t\tdata.user = user;\n\t\t\t\tdata.room = room;\n\t\t\t\tdata.message = message;\n\n\t\t\t\tif (message.alias) {\n\t\t\t\t\tdata.alias = message.alias;\n\t\t\t\t}\n\n\t\t\t\tif (message.bot) {\n\t\t\t\t\tdata.bot = message.bot;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomCreated':\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.timestamp = room.ts;\n\t\t\t\tdata.user_id = owner._id;\n\t\t\t\tdata.user_name = owner.username;\n\t\t\t\tdata.owner = owner;\n\t\t\t\tdata.room = room;\n\t\t\t\tbreak;\n\t\t\tcase 'roomArchived':\n\t\t\tcase 'roomJoined':\n\t\t\tcase 'roomLeft':\n\t\t\t\tdata.timestamp = new Date();\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.user_id = user._id;\n\t\t\t\tdata.user_name = user.username;\n\t\t\t\tdata.user = user;\n\t\t\t\tdata.room = room;\n\n\t\t\t\tif (user.type === 'bot') {\n\t\t\t\t\tdata.bot = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'userCreated':\n\t\t\t\tdata.timestamp = user.createdAt;\n\t\t\t\tdata.user_id = user._id;\n\t\t\t\tdata.user_name = user.username;\n\t\t\t\tdata.user = user;\n\n\t\t\t\tif (user.type === 'bot') {\n\t\t\t\t\tdata.bot = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\texecuteTriggers() {\n\t\tlogger.outgoing.debug('Execute Trigger:', arguments[0]);\n\n\t\tconst argObject = this.eventNameArgumentsToObject(...arguments);\n\t\tconst { event, message, room } = argObject;\n\n\t\t//Each type of event should have an event and a room attached, otherwise we\n\t\t//wouldn't know how to handle the trigger nor would we have anywhere to send the\n\t\t//result of the integration\n\t\tif (!event) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst triggersToExecute = [];\n\n\t\tlogger.outgoing.debug('Starting search for triggers for the room:', room ? room._id : '__any');\n\t\tif (room) {\n\t\t\tswitch (room.t) {\n\t\t\t\tcase 'd':\n\t\t\t\t\tconst id = room._id.replace(message.u._id, '');\n\t\t\t\t\tconst username = _.without(room.usernames, message.u.username)[0];\n\n\t\t\t\t\tif (this.triggers[`@${ id }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`@${ id }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.triggers.all_direct_messages) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers.all_direct_messages)) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (id !== username && this.triggers[`@${ username }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`@${ username }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'c':\n\t\t\t\t\tif (this.triggers.all_public_channels) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers.all_public_channels)) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.triggers[`#${ room._id }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room._id }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (room._id !== room.name && this.triggers[`#${ room.name }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room.name }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tif (this.triggers.all_private_groups) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers.all_private_groups)) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.triggers[`#${ room._id }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room._id }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (room._id !== room.name && this.triggers[`#${ room.name }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room.name }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (this.triggers.__any) {\n\t\t\t//For outgoing integration which don't rely on rooms.\n\t\t\tfor (const trigger of Object.values(this.triggers.__any)) {\n\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t}\n\t\t}\n\n\t\tlogger.outgoing.debug(`Found ${ triggersToExecute.length } to iterate over and see if the match the event.`);\n\n\t\tfor (const triggerToExecute of triggersToExecute) {\n\t\t\tlogger.outgoing.debug(`Is \"${ triggerToExecute.name }\" enabled, ${ triggerToExecute.enabled }, and what is the event? ${ triggerToExecute.event }`);\n\t\t\tif (triggerToExecute.enabled === true && triggerToExecute.event === event) {\n\t\t\t\tthis.executeTrigger(triggerToExecute, argObject);\n\t\t\t}\n\t\t}\n\t}\n\n\texecuteTrigger(trigger, argObject) {\n\t\tfor (const url of trigger.urls) {\n\t\t\tthis.executeTriggerUrl(url, trigger, argObject, 0);\n\t\t}\n\t}\n\n\texecuteTriggerUrl(url, trigger, { event, message, room, owner, user }, theHistoryId, tries = 0) {\n\t\tif (!this.isTriggerEnabled(trigger)) {\n\t\t\tlogger.outgoing.warn(`The trigger \"${ trigger.name }\" is no longer enabled, stopping execution of it at try: ${ tries }`);\n\t\t\treturn;\n\t\t}\n\n\t\tlogger.outgoing.debug(`Starting to execute trigger: ${ trigger.name } (${ trigger._id })`);\n\n\t\tlet word;\n\t\t//Not all triggers/events support triggerWords\n\t\tif (RocketChat.integrations.outgoingEvents[event].use.triggerWords) {\n\t\t\tif (trigger.triggerWords && trigger.triggerWords.length > 0) {\n\t\t\t\tfor (const triggerWord of trigger.triggerWords) {\n\t\t\t\t\tif (!trigger.triggerWordAnywhere && message.msg.indexOf(triggerWord) === 0) {\n\t\t\t\t\t\tword = triggerWord;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t} else if (trigger.triggerWordAnywhere && message.msg.includes(triggerWord)) {\n\t\t\t\t\t\tword = triggerWord;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Stop if there are triggerWords but none match\n\t\t\t\tif (!word) {\n\t\t\t\t\tlogger.outgoing.debug(`The trigger word which \"${ trigger.name }\" was expecting could not be found, not executing.`);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (message && message.editedAt && !trigger.runOnEdits) {\n\t\t\tlogger.outgoing.debug(`The trigger \"${ trigger.name }\"'s run on edits is disabled and the message was edited.`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst historyId = this.updateHistory({ step: 'start-execute-trigger-url', integration: trigger, event });\n\n\t\tconst data = {\n\t\t\ttoken: trigger.token,\n\t\t\tbot: false\n\t\t};\n\n\t\tif (word) {\n\t\t\tdata.trigger_word = word;\n\t\t}\n\n\t\tthis.mapEventArgsToData(data, { trigger, event, message, room, owner, user });\n\t\tthis.updateHistory({ historyId, step: 'mapped-args-to-data', data, triggerWord: word });\n\n\t\tlogger.outgoing.info(`Will be executing the Integration \"${ trigger.name }\" to the url: ${ url }`);\n\t\tlogger.outgoing.debug(data);\n\n\t\tlet opts = {\n\t\t\tparams: {},\n\t\t\tmethod: 'POST',\n\t\t\turl,\n\t\t\tdata,\n\t\t\tauth: undefined,\n\t\t\tnpmRequestOptions: {\n\t\t\t\trejectUnauthorized: !RocketChat.settings.get('Allow_Invalid_SelfSigned_Certs'),\n\t\t\t\tstrictSSL: !RocketChat.settings.get('Allow_Invalid_SelfSigned_Certs')\n\t\t\t},\n\t\t\theaders: {\n\t\t\t\t'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36'\n\t\t\t}\n\t\t};\n\n\t\tif (this.hasScriptAndMethod(trigger, 'prepare_outgoing_request')) {\n\t\t\topts = this.executeScript(trigger, 'prepare_outgoing_request', { request: opts }, historyId);\n\t\t}\n\n\t\tthis.updateHistory({ historyId, step: 'after-maybe-ran-prepare', ranPrepareScript: true });\n\n\t\tif (!opts) {\n\t\t\tthis.updateHistory({ historyId, step: 'after-prepare-no-opts', finished: true });\n\t\t\treturn;\n\t\t}\n\n\t\tif (opts.message) {\n\t\t\tconst prepareMessage = this.sendMessage({ trigger, room, message: opts.message, data });\n\t\t\tthis.updateHistory({ historyId, step: 'after-prepare-send-message', prepareSentMessage: prepareMessage });\n\t\t}\n\n\t\tif (!opts.url || !opts.method) {\n\t\t\tthis.updateHistory({ historyId, step: 'after-prepare-no-url_or_method', finished: true });\n\t\t\treturn;\n\t\t}\n\n\t\tthis.updateHistory({ historyId, step: 'pre-http-call', url: opts.url, httpCallData: opts.data });\n\t\tHTTP.call(opts.method, opts.url, opts, (error, result) => {\n\t\t\tif (!result) {\n\t\t\t\tlogger.outgoing.warn(`Result for the Integration ${ trigger.name } to ${ url } is empty`);\n\t\t\t} else {\n\t\t\t\tlogger.outgoing.info(`Status code for the Integration ${ trigger.name } to ${ url } is ${ result.statusCode }`);\n\t\t\t}\n\n\t\t\tthis.updateHistory({ historyId, step: 'after-http-call', httpError: error, httpResult: result });\n\n\t\t\tif (this.hasScriptAndMethod(trigger, 'process_outgoing_response')) {\n\t\t\t\tconst sandbox = {\n\t\t\t\t\trequest: opts,\n\t\t\t\t\tresponse: {\n\t\t\t\t\t\terror,\n\t\t\t\t\t\tstatus_code: result ? result.statusCode : undefined, //These values will be undefined to close issues #4175, #5762, and #5896\n\t\t\t\t\t\tcontent: result ? result.data : undefined,\n\t\t\t\t\t\tcontent_raw: result ? result.content : undefined,\n\t\t\t\t\t\theaders: result ? result.headers : {}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tconst scriptResult = this.executeScript(trigger, 'process_outgoing_response', sandbox, historyId);\n\n\t\t\t\tif (scriptResult && scriptResult.content) {\n\t\t\t\t\tconst resultMessage = this.sendMessage({ trigger, room, message: scriptResult.content, data });\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-send-message', processSentMessage: resultMessage, finished: true });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (scriptResult === false) {\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-false-result', finished: true });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// if the result contained nothing or wasn't a successful statusCode\n\t\t\tif (!result || !this.successResults.includes(result.statusCode)) {\n\t\t\t\tif (error) {\n\t\t\t\t\tlogger.outgoing.error(`Error for the Integration \"${ trigger.name }\" to ${ url } is:`);\n\t\t\t\t\tlogger.outgoing.error(error);\n\t\t\t\t}\n\n\t\t\t\tif (result) {\n\t\t\t\t\tlogger.outgoing.error(`Error for the Integration \"${ trigger.name }\" to ${ url } is:`);\n\t\t\t\t\tlogger.outgoing.error(result);\n\n\t\t\t\t\tif (result.statusCode === 410) {\n\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-http-status-410', error: true });\n\t\t\t\t\t\tlogger.outgoing.error(`Disabling the Integration \"${ trigger.name }\" because the status code was 401 (Gone).`);\n\t\t\t\t\t\tRocketChat.models.Integrations.update({ _id: trigger._id }, { $set: { enabled: false }});\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (result.statusCode === 500) {\n\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-http-status-500', error: true });\n\t\t\t\t\t\tlogger.outgoing.error(`Error \"500\" for the Integration \"${ trigger.name }\" to ${ url }.`);\n\t\t\t\t\t\tlogger.outgoing.error(result.content);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (trigger.retryFailedCalls) {\n\t\t\t\t\tif (tries < trigger.retryCount && trigger.retryDelay) {\n\t\t\t\t\t\tthis.updateHistory({ historyId, error: true, step: `going-to-retry-${ tries + 1 }` });\n\n\t\t\t\t\t\tlet waitTime;\n\n\t\t\t\t\t\tswitch (trigger.retryDelay) {\n\t\t\t\t\t\t\tcase 'powers-of-ten':\n\t\t\t\t\t\t\t\t// Try again in 0.1s, 1s, 10s, 1m40s, 16m40s, 2h46m40s, 27h46m40s, etc\n\t\t\t\t\t\t\t\twaitTime = Math.pow(10, tries + 2);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'powers-of-two':\n\t\t\t\t\t\t\t\t// 2 seconds, 4 seconds, 8 seconds\n\t\t\t\t\t\t\t\twaitTime = Math.pow(2, tries + 1) * 1000;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'increments-of-two':\n\t\t\t\t\t\t\t\t// 2 second, 4 seconds, 6 seconds, etc\n\t\t\t\t\t\t\t\twaitTime = (tries + 1) * 2 * 1000;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\tconst er = new Error('The integration\\'s retryDelay setting is invalid.');\n\t\t\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'failed-and-retry-delay-is-invalid', error: true, errorStack: er.stack });\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlogger.outgoing.info(`Trying the Integration ${ trigger.name } to ${ url } again in ${ waitTime } milliseconds.`);\n\t\t\t\t\t\tMeteor.setTimeout(() => {\n\t\t\t\t\t\t\tthis.executeTriggerUrl(url, trigger, { event, message, room, owner, user }, historyId, tries + 1);\n\t\t\t\t\t\t}, waitTime);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'too-many-retries', error: true });\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'failed-and-not-configured-to-retry', error: true });\n\t\t\t\t}\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t//process outgoing webhook response as a new message\n\t\t\tif (result && this.successResults.includes(result.statusCode)) {\n\t\t\t\tif (result && result.data && (result.data.text || result.data.attachments)) {\n\t\t\t\t\tconst resultMsg = this.sendMessage({ trigger, room, message: result.data, data });\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'url-response-sent-message', resultMessage: resultMsg, finished: true });\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\treplay(integration, history) {\n\t\tif (!integration || integration.type !== 'webhook-outgoing') {\n\t\t\tthrow new Meteor.Error('integration-type-must-be-outgoing', 'The integration type to replay must be an outgoing webhook.');\n\t\t}\n\n\t\tif (!history || !history.data) {\n\t\t\tthrow new Meteor.Error('history-data-must-be-defined', 'The history data must be defined to replay an integration.');\n\t\t}\n\n\t\tconst event = history.event;\n\t\tconst message = RocketChat.models.Messages.findOneById(history.data.message_id);\n\t\tconst room = RocketChat.models.Rooms.findOneById(history.data.channel_id);\n\t\tconst user = RocketChat.models.Users.findOneById(history.data.user_id);\n\t\tlet owner;\n\n\t\tif (history.data.owner && history.data.owner._id) {\n\t\t\towner = RocketChat.models.Users.findOneById(history.data.owner._id);\n\t\t}\n\n\t\tthis.executeTriggerUrl(history.url, integration, { event, message, room, owner, user });\n\t}\n};\n","RocketChat.models.Integrations = new class Integrations extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('integrations');\n\t}\n\n\tfindByType(type, options) {\n\t\tif (type !== 'webhook-incoming' && type !== 'webhook-outgoing') {\n\t\t\tthrow new Meteor.Error('invalid-type-to-find');\n\t\t}\n\n\t\treturn this.find({ type }, options);\n\t}\n\n\tdisableByUserId(userId) {\n\t\treturn this.update({ userId }, { $set: { enabled: false }}, { multi: true });\n\t}\n};\n","RocketChat.models.IntegrationHistory = new class IntegrationHistory extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('integration_history');\n\t}\n\n\tfindByType(type, options) {\n\t\tif (type !== 'outgoing-webhook' || type !== 'incoming-webhook') {\n\t\t\tthrow new Meteor.Error('invalid-integration-type');\n\t\t}\n\n\t\treturn this.find({ type }, options);\n\t}\n\n\tfindByIntegrationId(id, options) {\n\t\treturn this.find({ 'integration._id': id }, options);\n\t}\n\n\tfindByIntegrationIdAndCreatedBy(id, creatorId, options) {\n\t\treturn this.find({ 'integration._id': id, 'integration._createdBy._id': creatorId }, options);\n\t}\n\n\tfindOneByIntegrationIdAndHistoryId(integrationId, historyId) {\n\t\treturn this.findOne({ 'integration._id': integrationId, _id: historyId });\n\t}\n\n\tfindByEventName(event, options) {\n\t\treturn this.find({ event }, options);\n\t}\n\n\tfindFailed(options) {\n\t\treturn this.find({ error: true }, options);\n\t}\n\n\tremoveByIntegrationId(integrationId) {\n\t\treturn this.remove({ 'integration._id': integrationId });\n\t}\n};\n","Meteor.publish('integrations', function _integrationPublication() {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\treturn RocketChat.models.Integrations.find();\n\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\treturn RocketChat.models.Integrations.find({ '_createdBy._id': this.userId });\n\t} else {\n\t\tthrow new Meteor.Error('not-authorized');\n\t}\n});\n","Meteor.publish('integrationHistory', function _integrationHistoryPublication(integrationId, limit = 25) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\treturn RocketChat.models.IntegrationHistory.findByIntegrationId(integrationId, { sort: { _updatedAt: -1 }, limit });\n\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\treturn RocketChat.models.IntegrationHistory.findByIntegrationIdAndCreatedBy(integrationId, this.userId, { sort: { _updatedAt: -1 }, limit });\n\t} else {\n\t\tthrow new Meteor.Error('not-authorized');\n\t}\n});\n","/* global Babel */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nconst validChannelChars = ['@', '#'];\n\nMeteor.methods({\n\taddIncomingIntegration(integration) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-integrations') && !RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tif (!_.isString(integration.channel)) {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid channel', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tif (integration.channel.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid channel', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tconst channels = _.map(integration.channel.split(','), (channel) => s.trim(channel));\n\n\t\tfor (const channel of channels) {\n\t\t\tif (!validChannelChars.includes(channel[0])) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel-start-with-chars', 'Invalid channel. Start with @ or #', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tif (!_.isString(integration.username) || integration.username.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-username', 'Invalid username', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tif (integration.scriptEnabled === true && integration.script && integration.script.trim() !== '') {\n\t\t\ttry {\n\t\t\t\tlet babelOptions = Babel.getDefaultOptions({ runtime: false });\n\t\t\t\tbabelOptions = _.extend(babelOptions, { compact: true, minified: true, comments: false });\n\n\t\t\t\tintegration.scriptCompiled = Babel.compile(integration.script, babelOptions).code;\n\t\t\t\tintegration.scriptError = undefined;\n\t\t\t} catch (e) {\n\t\t\t\tintegration.scriptCompiled = undefined;\n\t\t\t\tintegration.scriptError = _.pick(e, 'name', 'message', 'stack');\n\t\t\t}\n\t\t}\n\n\t\tfor (let channel of channels) {\n\t\t\tlet record;\n\t\t\tconst channelType = channel[0];\n\t\t\tchannel = channel.substr(1);\n\n\t\t\tswitch (channelType) {\n\t\t\t\tcase '#':\n\t\t\t\t\trecord = RocketChat.models.Rooms.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{name: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase '@':\n\t\t\t\t\trecord = RocketChat.models.Users.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{username: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!record) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'addIncomingIntegration' });\n\t\t\t}\n\n\t\t\tif (record.usernames && !RocketChat.authz.hasPermission(this.userId, 'manage-integrations') && RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') && !record.usernames.includes(Meteor.user().username)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { method: 'addIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOne({username: integration.username});\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tconst token = Random.id(48);\n\n\t\tintegration.type = 'webhook-incoming';\n\t\tintegration.token = token;\n\t\tintegration.channel = channels;\n\t\tintegration.userId = user._id;\n\t\tintegration._createdAt = new Date();\n\t\tintegration._createdBy = RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}});\n\n\t\tRocketChat.models.Roles.addUserRoles(user._id, 'bot');\n\n\t\tintegration._id = RocketChat.models.Integrations.insert(integration);\n\n\t\treturn integration;\n\t}\n});\n","/* global Babel */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nconst validChannelChars = ['@', '#'];\n\nMeteor.methods({\n\tupdateIncomingIntegration(integrationId, integration) {\n\t\tif (!_.isString(integration.channel) || integration.channel.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid channel', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tconst channels = _.map(integration.channel.split(','), (channel) => s.trim(channel));\n\n\t\tfor (const channel of channels) {\n\t\t\tif (!validChannelChars.includes(channel[0])) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel-start-with-chars', 'Invalid channel. Start with @ or #', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tlet currentIntegration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne({ _id: integrationId, '_createdBy._id': this.userId });\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tif (!currentIntegration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tif (integration.scriptEnabled === true && integration.script && integration.script.trim() !== '') {\n\t\t\ttry {\n\t\t\t\tlet babelOptions = Babel.getDefaultOptions({ runtime: false });\n\t\t\t\tbabelOptions = _.extend(babelOptions, { compact: true, minified: true, comments: false });\n\n\t\t\t\tintegration.scriptCompiled = Babel.compile(integration.script, babelOptions).code;\n\t\t\t\tintegration.scriptError = undefined;\n\t\t\t} catch (e) {\n\t\t\t\tintegration.scriptCompiled = undefined;\n\t\t\t\tintegration.scriptError = _.pick(e, 'name', 'message', 'stack');\n\t\t\t}\n\t\t}\n\n\t\tfor (let channel of channels) {\n\t\t\tconst channelType = channel[0];\n\t\t\tchannel = channel.substr(1);\n\t\t\tlet record;\n\n\t\t\tswitch (channelType) {\n\t\t\t\tcase '#':\n\t\t\t\t\trecord = RocketChat.models.Rooms.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{name: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase '@':\n\t\t\t\t\trecord = RocketChat.models.Users.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{username: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!record) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\n\t\t\tif (record.usernames && !RocketChat.authz.hasPermission(this.userId, 'manage-integrations') && RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') && !record.usernames.includes(Meteor.user().username)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOne({ username: currentIntegration.username });\n\n\t\tif (!user || !user._id) {\n\t\t\tthrow new Meteor.Error('error-invalid-post-as-user', 'Invalid Post As User', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tRocketChat.models.Roles.addUserRoles(user._id, 'bot');\n\n\t\tRocketChat.models.Integrations.update(integrationId, {\n\t\t\t$set: {\n\t\t\t\tenabled: integration.enabled,\n\t\t\t\tname: integration.name,\n\t\t\t\tavatar: integration.avatar,\n\t\t\t\temoji: integration.emoji,\n\t\t\t\talias: integration.alias,\n\t\t\t\tchannel: channels,\n\t\t\t\tscript: integration.script,\n\t\t\t\tscriptEnabled: integration.scriptEnabled,\n\t\t\t\tscriptCompiled: integration.scriptCompiled,\n\t\t\t\tscriptError: integration.scriptError,\n\t\t\t\t_updatedAt: new Date(),\n\t\t\t\t_updatedBy: RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}})\n\t\t\t}\n\t\t});\n\n\t\treturn RocketChat.models.Integrations.findOne(integrationId);\n\t}\n});\n","Meteor.methods({\n\tdeleteIncomingIntegration(integrationId) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields : { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'deleteIncomingIntegration' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'deleteIncomingIntegration' });\n\t\t}\n\n\t\tRocketChat.models.Integrations.remove({ _id: integrationId });\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\taddOutgoingIntegration(integration) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-integrations')\n\t\t\t&& !RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')\n\t\t\t&& !RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')\n\t\t\t&& !RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tintegration = RocketChat.integrations.validateOutgoing(integration, this.userId);\n\n\t\tintegration._createdAt = new Date();\n\t\tintegration._createdBy = RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}});\n\t\tintegration._id = RocketChat.models.Integrations.insert(integration);\n\n\t\treturn integration;\n\t}\n});\n","Meteor.methods({\n\tupdateOutgoingIntegration(integrationId, integration) {\n\t\tintegration = RocketChat.integrations.validateOutgoing(integration, this.userId);\n\n\t\tif (!integration.token || integration.token.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-token', 'Invalid token', { method: 'updateOutgoingIntegration' });\n\t\t}\n\n\t\tlet currentIntegration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne({ _id: integrationId, '_createdBy._id': this.userId });\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'updateOutgoingIntegration' });\n\t\t}\n\n\t\tif (!currentIntegration) {\n\t\t\tthrow new Meteor.Error('invalid_integration', '[methods] updateOutgoingIntegration -> integration not found');\n\t\t}\n\n\t\tRocketChat.models.Integrations.update(integrationId, {\n\t\t\t$set: {\n\t\t\t\tevent: integration.event,\n\t\t\t\tenabled: integration.enabled,\n\t\t\t\tname: integration.name,\n\t\t\t\tavatar: integration.avatar,\n\t\t\t\temoji: integration.emoji,\n\t\t\t\talias: integration.alias,\n\t\t\t\tchannel: integration.channel,\n\t\t\t\ttargetRoom: integration.targetRoom,\n\t\t\t\timpersonateUser: integration.impersonateUser,\n\t\t\t\tusername: integration.username,\n\t\t\t\tuserId: integration.userId,\n\t\t\t\turls: integration.urls,\n\t\t\t\ttoken: integration.token,\n\t\t\t\tscript: integration.script,\n\t\t\t\tscriptEnabled: integration.scriptEnabled,\n\t\t\t\tscriptCompiled: integration.scriptCompiled,\n\t\t\t\tscriptError: integration.scriptError,\n\t\t\t\ttriggerWords: integration.triggerWords,\n\t\t\t\tretryFailedCalls: integration.retryFailedCalls,\n\t\t\t\tretryCount: integration.retryCount,\n\t\t\t\tretryDelay: integration.retryDelay,\n\t\t\t\ttriggerWordAnywhere: integration.triggerWordAnywhere,\n\t\t\t\trunOnEdits: integration.runOnEdits,\n\t\t\t\t_updatedAt: new Date(),\n\t\t\t\t_updatedBy: RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}})\n\t\t\t}\n\t\t});\n\n\t\treturn RocketChat.models.Integrations.findOne(integrationId);\n\t}\n});\n","Meteor.methods({\n\treplayOutgoingIntegration({ integrationId, historyId }) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields: { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'replayOutgoingIntegration' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'replayOutgoingIntegration' });\n\t\t}\n\n\t\tconst history = RocketChat.models.IntegrationHistory.findOneByIntegrationIdAndHistoryId(integration._id, historyId);\n\n\t\tif (!history) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration-history', 'Invalid Integration History', { method: 'replayOutgoingIntegration' });\n\t\t}\n\n\t\tRocketChat.integrations.triggerHandler.replay(integration, history);\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\tdeleteOutgoingIntegration(integrationId) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields: { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'deleteOutgoingIntegration' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'deleteOutgoingIntegration' });\n\t\t}\n\n\t\tRocketChat.models.Integrations.remove({ _id: integrationId });\n\t\tRocketChat.models.IntegrationHistory.removeByIntegrationId(integrationId);\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\tclearIntegrationHistory(integrationId) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields: { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'clearIntegrationHistory' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'clearIntegrationHistory' });\n\t\t}\n\n\t\tRocketChat.models.IntegrationHistory.removeByIntegrationId(integrationId);\n\n\t\treturn true;\n\t}\n});\n","/* globals Api Meteor Restivus logger processWebhookMessage*/\n// TODO: remove globals\n\nimport _ from 'underscore';\nimport s from 'underscore.string';\nimport vm from 'vm';\nimport moment from 'moment';\n\nconst compiledScripts = {};\nfunction buildSandbox(store = {}) {\n\tconst sandbox = {\n\t\t_,\n\t\ts,\n\t\tconsole,\n\t\tmoment,\n\t\tLivechat: RocketChat.Livechat,\n\t\tStore: {\n\t\t\tset(key, val) {\n\t\t\t\treturn store[key] = val;\n\t\t\t},\n\t\t\tget(key) {\n\t\t\t\treturn store[key];\n\t\t\t}\n\t\t},\n\t\tHTTP(method, url, options) {\n\t\t\ttry {\n\t\t\t\treturn {\n\t\t\t\t\tresult: HTTP.call(method, url, options)\n\t\t\t\t};\n\t\t\t} catch (error) {\n\t\t\t\treturn {\n\t\t\t\t\terror\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t};\n\n\tObject.keys(RocketChat.models).filter((k) => !k.startsWith('_')).forEach((k) => sandbox[k] = RocketChat.models[k]);\n\treturn { store, sandbox\t};\n}\n\nfunction getIntegrationScript(integration) {\n\tconst compiledScript = compiledScripts[integration._id];\n\tif ((compiledScript != null) && +compiledScript._updatedAt === +integration._updatedAt) {\n\t\treturn compiledScript.script;\n\t}\n\tconst script = integration.scriptCompiled;\n\tconst {sandbox, store} = buildSandbox();\n\ttry {\n\t\tlogger.incoming.info('Will evaluate script of Trigger', integration.name);\n\t\tlogger.incoming.debug(script);\n\t\tconst vmScript = vm.createScript(script, 'script.js');\n\t\tvmScript.runInNewContext(sandbox);\n\t\tif (sandbox.Script != null) {\n\t\t\tcompiledScripts[integration._id] = {\n\t\t\t\tscript: new sandbox.Script(),\n\t\t\t\tstore,\n\t\t\t\t_updatedAt: integration._updatedAt\n\t\t\t};\n\t\t\treturn compiledScripts[integration._id].script;\n\t\t}\n\t} catch ({stack}) {\n\t\tlogger.incoming.error('[Error evaluating Script in Trigger', integration.name, ':]');\n\t\tlogger.incoming.error(script.replace(/^/gm, '  '));\n\t\tlogger.incoming.error('[Stack:]');\n\t\tlogger.incoming.error(stack.replace(/^/gm, '  '));\n\t\tthrow RocketChat.API.v1.failure('error-evaluating-script');\n\t}\n\tif (sandbox.Script == null) {\n\t\tlogger.incoming.error('[Class \"Script\" not in Trigger', integration.name, ']');\n\t\tthrow RocketChat.API.v1.failure('class-script-not-found');\n\t}\n}\n\nApi = new Restivus({\n\tenableCors: true,\n\tapiPath: 'hooks/',\n\tauth: {\n\t\tuser() {\n\t\t\tconst payloadKeys = Object.keys(this.bodyParams);\n\t\t\tconst payloadIsWrapped = (this.bodyParams && this.bodyParams.payload) && payloadKeys.length === 1;\n\t\t\tif (payloadIsWrapped && this.request.headers['content-type'] === 'application/x-www-form-urlencoded') {\n\t\t\t\ttry {\n\t\t\t\t\tthis.bodyParams = JSON.parse(this.bodyParams.payload);\n\t\t\t\t} catch ({message}) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\tstatusCode: 400,\n\t\t\t\t\t\t\tbody: {\n\t\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\t\terror: message\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.integration = RocketChat.models.Integrations.findOne({\n\t\t\t\t_id: this.request.params.integrationId,\n\t\t\t\ttoken: decodeURIComponent(this.request.params.token)\n\t\t\t});\n\t\t\tif (this.integration == null) {\n\t\t\t\tlogger.incoming.info('Invalid integration id', this.request.params.integrationId, 'or token', this.request.params.token);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst user = RocketChat.models.Users.findOne({\n\t\t\t\t_id: this.integration.userId\n\t\t\t});\n\t\t\treturn {user};\n\t\t}\n\t}\n});\n\nfunction createIntegration(options, user) {\n\tlogger.incoming.info('Add integration', options.name);\n\tlogger.incoming.debug(options);\n\tMeteor.runAsUser(user._id, function() {\n\t\tswitch (options['event']) {\n\t\t\tcase 'newMessageOnChannel':\n\t\t\t\tif (options.data == null) {\n\t\t\t\t\toptions.data = {};\n\t\t\t\t}\n\t\t\t\tif ((options.data.channel_name != null) && options.data.channel_name.indexOf('#') === -1) {\n\t\t\t\t\toptions.data.channel_name = `#${ options.data.channel_name }`;\n\t\t\t\t}\n\t\t\t\treturn Meteor.call('addOutgoingIntegration', {\n\t\t\t\t\tusername: 'rocket.cat',\n\t\t\t\t\turls: [options.target_url],\n\t\t\t\t\tname: options.name,\n\t\t\t\t\tchannel: options.data.channel_name,\n\t\t\t\t\ttriggerWords: options.data.trigger_words\n\t\t\t\t});\n\t\t\tcase 'newMessageToUser':\n\t\t\t\tif (options.data.username.indexOf('@') === -1) {\n\t\t\t\t\toptions.data.username = `@${ options.data.username }`;\n\t\t\t\t}\n\t\t\t\treturn Meteor.call('addOutgoingIntegration', {\n\t\t\t\t\tusername: 'rocket.cat',\n\t\t\t\t\turls: [options.target_url],\n\t\t\t\t\tname: options.name,\n\t\t\t\t\tchannel: options.data.username,\n\t\t\t\t\ttriggerWords: options.data.trigger_words\n\t\t\t\t});\n\t\t}\n\t});\n\treturn RocketChat.API.v1.success();\n}\n\nfunction removeIntegration(options, user) {\n\tlogger.incoming.info('Remove integration');\n\tlogger.incoming.debug(options);\n\tconst integrationToRemove = RocketChat.models.Integrations.findOne({\n\t\turls: options.target_url\n\t});\n\tMeteor.runAsUser(user._id, () => {\n\t\treturn Meteor.call('deleteOutgoingIntegration', integrationToRemove._id);\n\t});\n\treturn RocketChat.API.v1.success();\n}\n\nfunction executeIntegrationRest() {\n\tlogger.incoming.info('Post integration:', this.integration.name);\n\tlogger.incoming.debug('@urlParams:', this.urlParams);\n\tlogger.incoming.debug('@bodyParams:', this.bodyParams);\n\n\tif (this.integration.enabled !== true) {\n\t\treturn {\n\t\t\tstatusCode: 503,\n\t\t\tbody: 'Service Unavailable'\n\t\t};\n\t}\n\n\tconst defaultValues = {\n\t\tchannel: this.integration.channel,\n\t\talias: this.integration.alias,\n\t\tavatar: this.integration.avatar,\n\t\temoji: this.integration.emoji\n\t};\n\n\tif (this.integration.scriptEnabled === true && this.integration.scriptCompiled && this.integration.scriptCompiled.trim() !== '') {\n\t\tlet script;\n\t\ttry {\n\t\t\tscript = getIntegrationScript(this.integration);\n\t\t} catch (e) {\n\t\t\tlogger.incoming.warn(e);\n\t\t\treturn RocketChat.API.v1.failure(e.message);\n\t\t}\n\n\t\tconst request = {\n\t\t\turl: {\n\t\t\t\thash: this.request._parsedUrl.hash,\n\t\t\t\tsearch: this.request._parsedUrl.search,\n\t\t\t\tquery: this.queryParams,\n\t\t\t\tpathname: this.request._parsedUrl.pathname,\n\t\t\t\tpath: this.request._parsedUrl.path\n\t\t\t},\n\t\t\turl_raw: this.request.url,\n\t\t\turl_params: this.urlParams,\n\t\t\tcontent: this.bodyParams,\n\t\t\tcontent_raw: this.request._readableState && this.request._readableState.buffer && this.request._readableState.buffer.toString(),\n\t\t\theaders: this.request.headers,\n\t\t\tuser: {\n\t\t\t\t_id: this.user._id,\n\t\t\t\tname: this.user.name,\n\t\t\t\tusername: this.user.username\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\tconst { sandbox } = buildSandbox(compiledScripts[this.integration._id].store);\n\t\t\tsandbox.script = script;\n\t\t\tsandbox.request = request;\n\n\t\t\tconst result = vm.runInNewContext('script.process_incoming_request({ request: request })', sandbox, {\n\t\t\t\ttimeout: 3000\n\t\t\t});\n\n\t\t\tif (!result) {\n\t\t\t\tlogger.incoming.debug('[Process Incoming Request result of Trigger', this.integration.name, ':] No data');\n\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t} else if (result && result.error) {\n\t\t\t\treturn RocketChat.API.v1.failure(result.error);\n\t\t\t}\n\n\t\t\tthis.bodyParams = result && result.content;\n\t\t\tthis.scriptResponse = result.response;\n\t\t\tif (result.user) {\n\t\t\t\tthis.user = result.user;\n\t\t\t}\n\n\t\t\tlogger.incoming.debug('[Process Incoming Request result of Trigger', this.integration.name, ':]');\n\t\t\tlogger.incoming.debug('result', this.bodyParams);\n\t\t} catch ({stack}) {\n\t\t\tlogger.incoming.error('[Error running Script in Trigger', this.integration.name, ':]');\n\t\t\tlogger.incoming.error(this.integration.scriptCompiled.replace(/^/gm, '  '));\n\t\t\tlogger.incoming.error('[Stack:]');\n\t\t\tlogger.incoming.error(stack.replace(/^/gm, '  '));\n\t\t\treturn RocketChat.API.v1.failure('error-running-script');\n\t\t}\n\t}\n\n\t// TODO: Turn this into an option on the integrations - no body means a success\n\t// TODO: Temporary fix for https://github.com/RocketChat/Rocket.Chat/issues/7770 until the above is implemented\n\tif (!this.bodyParams) {\n\t\t// return RocketChat.API.v1.failure('body-empty');\n\t\treturn RocketChat.API.v1.success();\n\t}\n\n\tthis.bodyParams.bot = { i: this.integration._id };\n\n\ttry {\n\t\tconst message = processWebhookMessage(this.bodyParams, this.user, defaultValues);\n\t\tif (_.isEmpty(message)) {\n\t\t\treturn RocketChat.API.v1.failure('unknown-error');\n\t\t}\n\n\t\tif (this.scriptResponse) {\n\t\t\tlogger.incoming.debug('response', this.scriptResponse);\n\t\t}\n\n\t\treturn RocketChat.API.v1.success(this.scriptResponse);\n\t} catch ({ error }) {\n\t\treturn RocketChat.API.v1.failure(error);\n\t}\n}\n\nfunction addIntegrationRest() {\n\treturn createIntegration(this.bodyParams, this.user);\n}\n\nfunction removeIntegrationRest() {\n\treturn removeIntegration(this.bodyParams, this.user);\n}\n\nfunction integrationSampleRest() {\n\tlogger.incoming.info('Sample Integration');\n\treturn {\n\t\tstatusCode: 200,\n\t\tbody: [\n\t\t\t{\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date,\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 1',\n\t\t\t\ttrigger_word: 'Sample'\n\t\t\t}, {\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date,\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 2',\n\t\t\t\ttrigger_word: 'Sample'\n\t\t\t}, {\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date,\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 3',\n\t\t\t\ttrigger_word: 'Sample'\n\t\t\t}\n\t\t]\n\t};\n}\n\nfunction integrationInfoRest() {\n\tlogger.incoming.info('Info integration');\n\treturn {\n\t\tstatusCode: 200,\n\t\tbody: {\n\t\t\tsuccess: true\n\t\t}\n\t};\n}\n\nApi.addRoute(':integrationId/:userId/:token', { authRequired: true }, {\n\tpost: executeIntegrationRest,\n\tget: executeIntegrationRest\n});\n\nApi.addRoute(':integrationId/:token', { authRequired: true }, {\n\tpost: executeIntegrationRest,\n\tget: executeIntegrationRest\n});\n\nApi.addRoute('sample/:integrationId/:userId/:token', { authRequired: true }, {\n\tget: integrationSampleRest\n});\n\nApi.addRoute('sample/:integrationId/:token', { authRequired: true }, {\n\tget: integrationSampleRest\n});\n\nApi.addRoute('info/:integrationId/:userId/:token', { authRequired: true }, {\n\tget: integrationInfoRest\n});\n\nApi.addRoute('info/:integrationId/:token', { authRequired: true }, {\n\tget: integrationInfoRest\n});\n\nApi.addRoute('add/:integrationId/:userId/:token', { authRequired: true }, {\n\tpost: addIntegrationRest\n});\n\nApi.addRoute('add/:integrationId/:token', { authRequired: true }, {\n\tpost: addIntegrationRest\n});\n\nApi.addRoute('remove/:integrationId/:userId/:token', { authRequired: true }, {\n\tpost: removeIntegrationRest\n});\n\nApi.addRoute('remove/:integrationId/:token', { authRequired: true }, {\n\tpost: removeIntegrationRest\n});\n","const callbackHandler = function _callbackHandler(eventType) {\n\treturn function _wrapperFunction() {\n\t\treturn RocketChat.integrations.triggerHandler.executeTriggers(eventType, ...arguments);\n\t};\n};\n\nRocketChat.callbacks.add('afterSaveMessage', callbackHandler('sendMessage'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterCreateChannel', callbackHandler('roomCreated'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterCreatePrivateGroup', callbackHandler('roomCreated'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterCreateUser', callbackHandler('userCreated'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterJoinRoom', callbackHandler('roomJoined'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterLeaveRoom', callbackHandler('roomLeft'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterRoomArchived', callbackHandler('roomArchived'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterFileUpload', callbackHandler('fileUploaded'), RocketChat.callbacks.priority.LOW);\n","import _ from 'underscore';\nimport s from 'underscore.string';\n\nthis.processWebhookMessage = function(messageObj, user, defaultValues = { channel: '', alias: '', avatar: '', emoji: '' }, mustBeJoined = false) {\n\tconst sentData = [];\n\tconst channels = [].concat(messageObj.channel || messageObj.roomId || defaultValues.channel);\n\n\tfor (const channel of channels) {\n\t\tconst channelType = channel[0];\n\n\t\tlet channelValue = channel.substr(1);\n\t\tlet room;\n\n\t\tswitch (channelType) {\n\t\t\tcase '#':\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, joinChannel: true });\n\t\t\t\tbreak;\n\t\t\tcase '@':\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, type: 'd' });\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tchannelValue = channelType + channelValue;\n\n\t\t\t\t//Try to find the room by id or name if they didn't include the prefix.\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, joinChannel: true, errorOnEmpty: false });\n\t\t\t\tif (room) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\t//We didn't get a room, let's try finding direct messages\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, type: 'd', tryDirectByUserIdOnly: true });\n\t\t\t\tif (room) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\t//No room, so throw an error\n\t\t\t\tthrow new Meteor.Error('invalid-channel');\n\t\t}\n\n\t\tif (mustBeJoined && !room.usernames.includes(user.username)) {\n\t\t\t// throw new Meteor.Error('invalid-room', 'Invalid room provided to send a message to, must be joined.');\n\t\t\tthrow new Meteor.Error('invalid-channel'); // Throwing the generic one so people can't \"brute force\" find rooms\n\t\t}\n\n\t\tif (messageObj.attachments && !_.isArray(messageObj.attachments)) {\n\t\t\tconsole.log('Attachments should be Array, ignoring value'.red, messageObj.attachments);\n\t\t\tmessageObj.attachments = undefined;\n\t\t}\n\n\t\tconst message = {\n\t\t\talias: messageObj.username || messageObj.alias || defaultValues.alias,\n\t\t\tmsg: s.trim(messageObj.text || messageObj.msg || ''),\n\t\t\tattachments: messageObj.attachments,\n\t\t\tparseUrls: messageObj.parseUrls !== undefined ? messageObj.parseUrls : !messageObj.attachments,\n\t\t\tbot: messageObj.bot,\n\t\t\tgroupable: (messageObj.groupable !== undefined) ? messageObj.groupable : false\n\t\t};\n\n\t\tif (!_.isEmpty(messageObj.icon_url) || !_.isEmpty(messageObj.avatar)) {\n\t\t\tmessage.avatar = messageObj.icon_url || messageObj.avatar;\n\t\t} else if (!_.isEmpty(messageObj.icon_emoji) || !_.isEmpty(messageObj.emoji)) {\n\t\t\tmessage.emoji = messageObj.icon_emoji || messageObj.emoji;\n\t\t} else if (!_.isEmpty(defaultValues.avatar)) {\n\t\t\tmessage.avatar = defaultValues.avatar;\n\t\t} else if (!_.isEmpty(defaultValues.emoji)) {\n\t\t\tmessage.emoji = defaultValues.emoji;\n\t\t}\n\n\t\tif (_.isArray(message.attachments)) {\n\t\t\tfor (let i = 0; i < message.attachments.length; i++) {\n\t\t\t\tconst attachment = message.attachments[i];\n\t\t\t\tif (attachment.msg) {\n\t\t\t\t\tattachment.text = s.trim(attachment.msg);\n\t\t\t\t\tdelete attachment.msg;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst messageReturn = RocketChat.sendMessage(user, message, room);\n\t\tsentData.push({ channel, message: messageReturn });\n\t}\n\n\treturn sentData;\n};\n"]}