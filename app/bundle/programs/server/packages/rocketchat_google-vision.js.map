{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:google-vision/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:google-vision/server/googlevision.js","meteor://ðŸ’»app/packages/rocketchat:google-vision/server/models/Messages.js"],"names":["Meteor","startup","RocketChat","settings","add","type","group","section","public","enableQuery","_id","value","multiline","hidden","blocked","GoogleVision","constructor","storage","Npm","require","vision","storageClient","visionClient","enabled","get","serviceAccount","key","JSON","parse","credentials","e","callbacks","blockUnsafeImages","bind","priority","MEDIUM","remove","annotate","incCallCount","count","currentMonth","Date","getMonth","maxMonthlyCalls","set","models","Settings","update","$inc","message","file","Uploads","findOne","indexOf","store","GoogleStorage","bucket","bucketFile","path","results","wrapAsync","detectSafeSearch","adult","FileUpload","getStore","deleteById","user","Users","findOneById","u","Notifications","notifyUser","Random","id","rid","ts","msg","TAPi18n","__","language","Error","console","error","visionTypes","push","length","detect","bindEnvironment","Messages","setGoogleVisionData","getAnnotations","trace","stack","visionData","_visionData","index","hasOwnProperty","concat","messageId","updateObj","$set"],"mappings":"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","file":"/packages/rocketchat_google-vision.js","sourcesContent":["Meteor.startup(function() {\n\tRocketChat.settings.add('GoogleVision_Enable', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tpublic: true,\n\t\tenableQuery: { _id: 'FileUpload_Storage_Type', value: 'GoogleCloudStorage' }\n\t});\n\tRocketChat.settings.add('GoogleVision_ServiceAccount', '', {\n\t\ttype: 'string',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tmultiline: true,\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Max_Monthly_Calls', 0, {\n\t\ttype: 'int',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Current_Month', 0, {\n\t\ttype: 'int',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\thidden: true\n\t});\n\tRocketChat.settings.add('GoogleVision_Current_Month_Calls', 0, {\n\t\ttype: 'int',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tblocked: true\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Document', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Faces', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Landmarks', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Labels', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Logos', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Properties', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_SafeSearch', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Block_Adult_Images', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: [{ _id: 'GoogleVision_Enable', value: true }, { _id: 'GoogleVision_Type_SafeSearch', value: true }]\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Similar', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n});\n","class GoogleVision {\n\tconstructor() {\n\t\tthis.storage = Npm.require('@google-cloud/storage');\n\t\tthis.vision = Npm.require('@google-cloud/vision');\n\t\tthis.storageClient = {};\n\t\tthis.visionClient = {};\n\t\tthis.enabled = RocketChat.settings.get('GoogleVision_Enable');\n\t\tthis.serviceAccount = {};\n\t\tRocketChat.settings.get('GoogleVision_Enable', (key, value) => {\n\t\t\tthis.enabled = value;\n\t\t});\n\t\tRocketChat.settings.get('GoogleVision_ServiceAccount', (key, value) => {\n\t\t\ttry {\n\t\t\t\tthis.serviceAccount = JSON.parse(value);\n\t\t\t\tthis.storageClient = this.storage({ credentials: this.serviceAccount });\n\t\t\t\tthis.visionClient = this.vision({ credentials: this.serviceAccount });\n\t\t\t} catch (e) {\n\t\t\t\tthis.serviceAccount = {};\n\t\t\t}\n\t\t});\n\t\tRocketChat.settings.get('GoogleVision_Block_Adult_Images', (key, value) => {\n\t\t\tif (value) {\n\t\t\t\tRocketChat.callbacks.add('beforeSaveMessage', this.blockUnsafeImages.bind(this), RocketChat.callbacks.priority.MEDIUM, 'googlevision-blockunsafe');\n\t\t\t} else {\n\t\t\t\tRocketChat.callbacks.remove('beforeSaveMessage', 'googlevision-blockunsafe');\n\t\t\t}\n\t\t});\n\t\tRocketChat.callbacks.add('afterFileUpload', this.annotate.bind(this));\n\t}\n\n\tincCallCount(count) {\n\t\tconst currentMonth = new Date().getMonth();\n\t\tconst maxMonthlyCalls = RocketChat.settings.get('GoogleVision_Max_Monthly_Calls') || 0;\n\t\tif (maxMonthlyCalls > 0) {\n\t\t\tif (RocketChat.settings.get('GoogleVision_Current_Month') !== currentMonth) {\n\t\t\t\tRocketChat.settings.set('GoogleVision_Current_Month', currentMonth);\n\t\t\t\tif (count > maxMonthlyCalls) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t} else if (count + (RocketChat.settings.get('GoogleVision_Current_Month_Calls') || 0) > maxMonthlyCalls) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\tRocketChat.models.Settings.update({ _id: 'GoogleVision_Current_Month_Calls' }, { $inc: { value: count } });\n\t\treturn true;\n\t}\n\n\tblockUnsafeImages(message) {\n\t\tif (this.enabled && this.serviceAccount && message && message.file && message.file._id) {\n\t\t\tconst file = RocketChat.models.Uploads.findOne({ _id: message.file._id });\n\t\t\tif (file && file.type && file.type.indexOf('image') !== -1 && file.store === 'GoogleCloudStorage:Uploads' && file.GoogleStorage) {\n\t\t\t\tif (this.incCallCount(1)) {\n\t\t\t\t\tconst bucket = this.storageClient.bucket(RocketChat.settings.get('FileUpload_GoogleStorage_Bucket'));\n\t\t\t\t\tconst bucketFile = bucket.file(file.GoogleStorage.path);\n\t\t\t\t\tconst results = Meteor.wrapAsync(this.visionClient.detectSafeSearch, this.visionClient)(bucketFile);\n\t\t\t\t\tif (results && results.adult === true) {\n\t\t\t\t\t\tFileUpload.getStore('Uploads').deleteById(file._id);\n\t\t\t\t\t\tconst user = RocketChat.models.Users.findOneById(message.u && message.u._id);\n\t\t\t\t\t\tif (user) {\n\t\t\t\t\t\t\tRocketChat.Notifications.notifyUser(user._id, 'message', {\n\t\t\t\t\t\t\t\t_id: Random.id(),\n\t\t\t\t\t\t\t\trid: message.rid,\n\t\t\t\t\t\t\t\tts: new Date,\n\t\t\t\t\t\t\t\tmsg: TAPi18n.__('Adult_images_are_not_allowed', {}, user.language)\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthrow new Meteor.Error('GoogleVisionError: Image blocked');\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tconsole.error('Google Vision: Usage limit exceeded');\n\t\t\t\t}\n\t\t\t\treturn message;\n\t\t\t}\n\t\t}\n\t}\n\n\tannotate({ message }) {\n\t\tconst visionTypes = [];\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Document')) {\n\t\t\tvisionTypes.push('document');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Faces')) {\n\t\t\tvisionTypes.push('faces');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Landmarks')) {\n\t\t\tvisionTypes.push('landmarks');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Labels')) {\n\t\t\tvisionTypes.push('labels');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Logos')) {\n\t\t\tvisionTypes.push('logos');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Properties')) {\n\t\t\tvisionTypes.push('properties');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_SafeSearch')) {\n\t\t\tvisionTypes.push('safeSearch');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Similar')) {\n\t\t\tvisionTypes.push('similar');\n\t\t}\n\t\tif (this.enabled && this.serviceAccount && visionTypes.length > 0 && message.file && message.file._id) {\n\t\t\tconst file = RocketChat.models.Uploads.findOne({ _id: message.file._id });\n\t\t\tif (file && file.type && file.type.indexOf('image') !== -1 && file.store === 'GoogleCloudStorage:Uploads' && file.GoogleStorage) {\n\t\t\t\tif (this.incCallCount(visionTypes.length)) {\n\t\t\t\t\tconst bucket = this.storageClient.bucket(RocketChat.settings.get('FileUpload_GoogleStorage_Bucket'));\n\t\t\t\t\tconst bucketFile = bucket.file(file.GoogleStorage.path);\n\t\t\t\t\tthis.visionClient.detect(bucketFile, visionTypes, Meteor.bindEnvironment((error, results) => {\n\t\t\t\t\t\tif (!error) {\n\t\t\t\t\t\t\tRocketChat.models.Messages.setGoogleVisionData(message._id, this.getAnnotations(visionTypes, results));\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconsole.trace('GoogleVision error: ', error.stack);\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\t\t} else {\n\t\t\t\t\tconsole.error('Google Vision: Usage limit exceeded');\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tgetAnnotations(visionTypes, visionData) {\n\t\tif (visionTypes.length === 1) {\n\t\t\tconst _visionData = {};\n\t\t\t_visionData[`${ visionTypes[0] }`] = visionData;\n\t\t\tvisionData = _visionData;\n\t\t}\n\t\tconst results = {};\n\t\tfor (const index in visionData) {\n\t\t\tif (visionData.hasOwnProperty(index)) {\n\t\t\t\tswitch (index) {\n\t\t\t\t\tcase 'faces':\n\t\t\t\t\tcase 'landmarks':\n\t\t\t\t\tcase 'labels':\n\t\t\t\t\tcase 'similar':\n\t\t\t\t\tcase 'logos':\n\t\t\t\t\t\tresults[index] = (results[index] || []).concat(visionData[index] || []);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'safeSearch':\n\t\t\t\t\t\tresults['safeSearch'] = visionData['safeSearch'];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'properties':\n\t\t\t\t\t\tresults['colors'] = visionData[index]['colors'];\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn results;\n\t}\n}\n\nRocketChat.GoogleVision = new GoogleVision;\n","RocketChat.models.Messages.setGoogleVisionData = function(messageId, visionData) {\n\tconst updateObj = {};\n\tfor (const index in visionData) {\n\t\tif (visionData.hasOwnProperty(index)) {\n\t\t\tupdateObj[`attachments.0.${ index }`] = visionData[index];\n\t\t}\n\t}\n\n\treturn this.update({ _id: messageId }, { $set: updateObj });\n};\n"]}