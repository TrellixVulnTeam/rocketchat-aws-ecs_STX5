{"version":3,"sources":["meteor://ðŸ’»app/packages/jalik:ufs/ufs.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-config.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-filter.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-methods.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-mime.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-server.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-store-permissions.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-store.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-template-helpers.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-tokens.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-uploader.js"],"names":["module1","module","export","UploadFS","_","watch","require","v","Meteor","Mongo","MIME","Random","Tokens","Config","Filter","Store","StorePermissions","Uploader","stores","store","tokens","addETagAttributeToFiles","where","each","getStores","files","getCollection","find","etag","fields","_id","forEach","file","direct","update","$set","generateEtag","addMimeType","extension","mime","toLowerCase","addPathAttributeToFiles","path","getFileRelativeURL","addStore","TypeError","getName","id","getMimeType","getMimeTypes","getStore","name","getTempFilePath","fileId","config","tmpDir","importFromURL","url","callback","call","readAsArrayBuffer","event","console","error","selectFile","input","document","createElement","type","multiple","onchange","ev","target","div","className","style","appendChild","body","click","selectFiles","i","length","isClient","isServer","global","window","constructor","options","extend","defaultStorePermissions","https","simulateReadDelay","simulateUploadSpeed","simulateWriteDelay","storesPath","tmpDirPermissions","parseInt","self","contentTypes","extensions","minSize","maxSize","onCheck","Array","method","check","Error","size","getMinSize","getMaxSize","getExtensions","contains","getContentTypes","isContentTypeInList","list","wildCardGlob","wildcards","filter","item","indexOf","replace","isValid","result","err","fs","Npm","http","Future","methods","ufsComplete","storeName","token","String","checkToken","fut","tmpFile","removeTempFile","unlink","message","findOne","validate","rs","createReadStream","flags","encoding","autoClose","on","bindEnvironment","remove","throw","write","return","wait","ufsCreate","Object","complete","uploading","substr","lastIndexOf","progress","userId","getFilter","create","createToken","uploadUrl","getURL","ufsDelete","count","ufsImportURL","split","pop","originalUrl","warn","proto","test","unblock","get","res","ufsStop","WebApp","domain","mkdirp","stream","URL","zlib","startup","mode","stat","log","chmod","d","connectHandlers","use","req","next","parsedUrl","parse","pathname","allowCORS","setHeader","regExp","RegExp","match","exec","writeHead","end","query","ws","createWriteStream","parseFloat","isNaN","Math","min","chunk","onRead","undefined","index","_sleepForMs","run","status","headers","modifiedAt","Date","toUTCString","uploadedAt","modifiedSince","range","positions","start","total","getReadStream","PassThrough","onReadError","emit","transformRead","accept","pipe","createGzip","createDeflate","insert","actions","action","modifiers","checkInsert","checkRemove","checkUpdate","collection","onCopyError","onFinishUpload","onValidate","onWriteError","permissions","transformWrite","Collection","value","copy","omit","originalStore","originalId","copyId","generateToken","createdAt","getWriteStream","errorHandler","readStream","data","getFileURL","copyTo","after","before","delete","pattern","c","r","random","s","toString","round","toUpperCase","getRelativeURL","rootUrl","absoluteUrl","rootPath","trim","encodeURI","request","response","setPermissions","writeStream","Template","isMIME","registerHelper","adaptive","capacity","chunkSize","maxChunkSize","maxTries","onAbort","onComplete","onCreate","onError","onProgress","onStart","onStop","retryDelay","transferDelay","RangeError","Blob","File","capacityMargin","offset","loaded","tries","postUrl","timeA","timeB","elapsedTime","startTime","finish","uploadedFile","abort","getAverageSpeed","seconds","getElapsedTime","getLoaded","isUploading","now","getFile","getProgress","getRemainingTime","averageSpeed","remainingBytes","max","getSpeed","getTotal","isComplete","readChunk","slice","setTimeout","sendChunk","duration","abs","xhr","XMLHttpRequest","onreadystatechange","readyState","open","send","stop"],"mappings":"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","file":"/packages/jalik_ufs.js","sourcesContent":["/*\r\n * The MIT License (MIT)\r\n *\r\n * Copyright (c) 2017 Karl STEIN\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in all\r\n * copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n * SOFTWARE.\r\n *\r\n */\r\nimport {_} from \"meteor/underscore\";\r\nimport {Meteor} from \"meteor/meteor\";\r\nimport {Mongo} from \"meteor/mongo\";\r\nimport {MIME} from \"./ufs-mime\";\r\nimport {Random} from \"meteor/random\";\r\nimport {Tokens} from \"./ufs-tokens\";\r\nimport {Config} from \"./ufs-config\";\r\nimport {Filter} from \"./ufs-filter\";\r\nimport {Store} from \"./ufs-store\";\r\nimport {StorePermissions} from \"./ufs-store-permissions\";\r\nimport {Uploader} from \"./ufs-uploader\";\r\n\r\n\r\nlet stores = {};\r\n\r\nexport const UploadFS = {\r\n\r\n    /**\r\n     * Contains all stores\r\n     */\r\n    store: {},\r\n\r\n    /**\r\n     * Collection of tokens\r\n     */\r\n    tokens: Tokens,\r\n\r\n    /**\r\n     * Adds the \"etag\" attribute to files\r\n     * @param where\r\n     */\r\n    addETagAttributeToFiles(where) {\r\n        _.each(this.getStores(), (store) => {\r\n            const files = store.getCollection();\r\n\r\n            // By default update only files with no path set\r\n            files.find(where || {etag: null}, {fields: {_id: 1}}).forEach((file) => {\r\n                files.direct.update(file._id, {$set: {etag: this.generateEtag()}});\r\n            });\r\n        });\r\n    },\r\n\r\n    /**\r\n     * Adds the MIME type for an extension\r\n     * @param extension\r\n     * @param mime\r\n     */\r\n    addMimeType(extension, mime) {\r\n        MIME[extension.toLowerCase()] = mime;\r\n    },\r\n\r\n    /**\r\n     * Adds the \"path\" attribute to files\r\n     * @param where\r\n     */\r\n    addPathAttributeToFiles(where) {\r\n        _.each(this.getStores(), (store) => {\r\n            const files = store.getCollection();\r\n\r\n            // By default update only files with no path set\r\n            files.find(where || {path: null}, {fields: {_id: 1}}).forEach((file) => {\r\n                files.direct.update(file._id, {$set: {path: store.getFileRelativeURL(file._id)}});\r\n            });\r\n        });\r\n    },\r\n\r\n    /**\r\n     * Registers the store\r\n     * @param store\r\n     */\r\n    addStore(store) {\r\n        if (!(store instanceof Store)) {\r\n            throw new TypeError(`ufs: store is not an instance of UploadFS.Store.`);\r\n        }\r\n        stores[store.getName()] = store;\r\n    },\r\n\r\n    /**\r\n     * Generates a unique ETag\r\n     * @return {string}\r\n     */\r\n    generateEtag() {\r\n        return Random.id();\r\n    },\r\n\r\n    /**\r\n     * Returns the MIME type of the extension\r\n     * @param extension\r\n     * @returns {*}\r\n     */\r\n    getMimeType(extension) {\r\n        extension = extension.toLowerCase();\r\n        return MIME[extension];\r\n    },\r\n\r\n    /**\r\n     * Returns all MIME types\r\n     */\r\n    getMimeTypes() {\r\n        return MIME;\r\n    },\r\n\r\n    /**\r\n     * Returns the store by its name\r\n     * @param name\r\n     * @return {UploadFS.Store}\r\n     */\r\n    getStore(name) {\r\n        return stores[name];\r\n    },\r\n\r\n    /**\r\n     * Returns all stores\r\n     * @return {object}\r\n     */\r\n    getStores() {\r\n        return stores;\r\n    },\r\n\r\n    /**\r\n     * Returns the temporary file path\r\n     * @param fileId\r\n     * @return {string}\r\n     */\r\n    getTempFilePath(fileId) {\r\n        return `${this.config.tmpDir}/${fileId}`;\r\n    },\r\n\r\n    /**\r\n     * Imports a file from a URL\r\n     * @param url\r\n     * @param file\r\n     * @param store\r\n     * @param callback\r\n     */\r\n    importFromURL(url, file, store, callback) {\r\n        if (typeof store === 'string') {\r\n            Meteor.call('ufsImportURL', url, file, store, callback);\r\n        }\r\n        else if (typeof store === 'object') {\r\n            store.importFromURL(url, file, callback);\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Returns file and data as ArrayBuffer for each files in the event\r\n     * @deprecated\r\n     * @param event\r\n     * @param callback\r\n     */\r\n    readAsArrayBuffer (event, callback) {\r\n        console.error('UploadFS.readAsArrayBuffer is deprecated, see https://github.com/jalik/jalik-ufs#uploading-from-a-file');\r\n    },\r\n\r\n    /**\r\n     * Opens a dialog to select a single file\r\n     * @param callback\r\n     */\r\n    selectFile(callback) {\r\n        const input = document.createElement('input');\r\n        input.type = 'file';\r\n        input.multiple = false;\r\n        input.onchange = (ev) => {\r\n            let files = ev.target.files;\r\n            callback.call(UploadFS, files[0]);\r\n        };\r\n        // Fix for iOS/Safari\r\n        const div = document.createElement('div');\r\n        div.className = 'ufs-file-selector';\r\n        div.style = 'display:none; height:0; width:0; overflow: hidden;';\r\n        div.appendChild(input);\r\n        document.body.appendChild(div);\r\n        // Trigger file selection\r\n        input.click();\r\n    },\r\n\r\n    /**\r\n     * Opens a dialog to select multiple files\r\n     * @param callback\r\n     */\r\n    selectFiles(callback) {\r\n        const input = document.createElement('input');\r\n        input.type = 'file';\r\n        input.multiple = true;\r\n        input.onchange = (ev) => {\r\n            const files = ev.target.files;\r\n\r\n            for (let i = 0; i < files.length; i += 1) {\r\n                callback.call(UploadFS, files[i]);\r\n            }\r\n        };\r\n        // Fix for iOS/Safari\r\n        const div = document.createElement('div');\r\n        div.className = 'ufs-file-selector';\r\n        div.style = 'display:none; height:0; width:0; overflow: hidden;';\r\n        div.appendChild(input);\r\n        document.body.appendChild(div);\r\n        // Trigger file selection\r\n        input.click();\r\n    }\r\n};\r\n\r\n\r\nif (Meteor.isClient) {\r\n    require('./ufs-template-helpers');\r\n}\r\nif (Meteor.isServer) {\r\n    require('./ufs-methods');\r\n    require('./ufs-server');\r\n}\r\n\r\n/**\r\n * UploadFS Configuration\r\n * @type {Config}\r\n */\r\nUploadFS.config = new Config();\r\n\r\n// Add classes to global namespace\r\nUploadFS.Config = Config;\r\nUploadFS.Filter = Filter;\r\nUploadFS.Store = Store;\r\nUploadFS.StorePermissions = StorePermissions;\r\nUploadFS.Uploader = Uploader;\r\n\r\nif (Meteor.isServer) {\r\n    // Expose the module globally\r\n    if (typeof global !== 'undefined') {\r\n        global['UploadFS'] = UploadFS;\r\n    }\r\n}\r\nelse if (Meteor.isClient) {\r\n    // Expose the module globally\r\n    if (typeof window !== 'undefined') {\r\n        window.UploadFS = UploadFS;\r\n    }\r\n}\r\n","/*\r\n * The MIT License (MIT)\r\n *\r\n * Copyright (c) 2017 Karl STEIN\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in all\r\n * copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n * SOFTWARE.\r\n *\r\n */\r\n\r\nimport {_} from 'meteor/underscore';\r\nimport {Meteor} from 'meteor/meteor';\r\nimport {StorePermissions} from './ufs-store-permissions';\r\n\r\n\r\n/**\r\n * UploadFS configuration\r\n */\r\nexport class Config {\r\n\r\n    constructor(options) {\r\n        // Default options\r\n        options = _.extend({\r\n            defaultStorePermissions: null,\r\n            https: false,\r\n            simulateReadDelay: 0,\r\n            simulateUploadSpeed: 0,\r\n            simulateWriteDelay: 0,\r\n            storesPath: 'ufs',\r\n            tmpDir: '/tmp/ufs',\r\n            tmpDirPermissions: '0700'\r\n        }, options);\r\n\r\n        // Check options\r\n        if (options.defaultStorePermissions && !(options.defaultStorePermissions instanceof StorePermissions)) {\r\n            throw new TypeError('Config: defaultStorePermissions is not an instance of StorePermissions');\r\n        }\r\n        if (typeof options.https !== 'boolean') {\r\n            throw new TypeError('Config: https is not a function');\r\n        }\r\n        if (typeof options.simulateReadDelay !== 'number') {\r\n            throw new TypeError('Config: simulateReadDelay is not a number');\r\n        }\r\n        if (typeof options.simulateUploadSpeed !== 'number') {\r\n            throw new TypeError('Config: simulateUploadSpeed is not a number');\r\n        }\r\n        if (typeof options.simulateWriteDelay !== 'number') {\r\n            throw new TypeError('Config: simulateWriteDelay is not a number');\r\n        }\r\n        if (typeof options.storesPath !== 'string') {\r\n            throw new TypeError('Config: storesPath is not a string');\r\n        }\r\n        if (typeof options.tmpDir !== 'string') {\r\n            throw new TypeError('Config: tmpDir is not a string');\r\n        }\r\n        if (typeof options.tmpDirPermissions !== 'string') {\r\n            throw new TypeError('Config: tmpDirPermissions is not a string');\r\n        }\r\n\r\n        /**\r\n         * Default store permissions\r\n         * @type {UploadFS.StorePermissions}\r\n         */\r\n        this.defaultStorePermissions = options.defaultStorePermissions;\r\n        /**\r\n         * Use or not secured protocol in URLS\r\n         * @type {boolean}\r\n         */\r\n        this.https = options.https;\r\n        /**\r\n         * The simulation read delay\r\n         * @type {Number}\r\n         */\r\n        this.simulateReadDelay = parseInt(options.simulateReadDelay);\r\n        /**\r\n         * The simulation upload speed\r\n         * @type {Number}\r\n         */\r\n        this.simulateUploadSpeed = parseInt(options.simulateUploadSpeed);\r\n        /**\r\n         * The simulation write delay\r\n         * @type {Number}\r\n         */\r\n        this.simulateWriteDelay = parseInt(options.simulateWriteDelay);\r\n        /**\r\n         * The URL root path of stores\r\n         * @type {string}\r\n         */\r\n        this.storesPath = options.storesPath;\r\n        /**\r\n         * The temporary directory of uploading files\r\n         * @type {string}\r\n         */\r\n        this.tmpDir = options.tmpDir;\r\n        /**\r\n         * The permissions of the temporary directory\r\n         * @type {string}\r\n         */\r\n        this.tmpDirPermissions = options.tmpDirPermissions;\r\n    }\r\n}\r\n","/*\r\n * The MIT License (MIT)\r\n *\r\n * Copyright (c) 2017 Karl STEIN\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in all\r\n * copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n * SOFTWARE.\r\n *\r\n */\r\nimport {_} from \"meteor/underscore\";\r\nimport {Meteor} from \"meteor/meteor\";\r\n\r\n\r\n/**\r\n * File filter\r\n */\r\nexport class Filter {\r\n\r\n    constructor(options) {\r\n        const self = this;\r\n\r\n        // Default options\r\n        options = _.extend({\r\n            contentTypes: null,\r\n            extensions: null,\r\n            minSize: 1,\r\n            maxSize: 0,\r\n            onCheck: this.onCheck\r\n        }, options);\r\n\r\n        // Check options\r\n        if (options.contentTypes && !(options.contentTypes instanceof Array)) {\r\n            throw new TypeError(\"Filter: contentTypes is not an Array\");\r\n        }\r\n        if (options.extensions && !(options.extensions instanceof Array)) {\r\n            throw new TypeError(\"Filter: extensions is not an Array\");\r\n        }\r\n        if (typeof options.minSize !== \"number\") {\r\n            throw new TypeError(\"Filter: minSize is not a number\");\r\n        }\r\n        if (typeof options.maxSize !== \"number\") {\r\n            throw new TypeError(\"Filter: maxSize is not a number\");\r\n        }\r\n        if (options.onCheck && typeof options.onCheck !== \"function\") {\r\n            throw new TypeError(\"Filter: onCheck is not a function\");\r\n        }\r\n\r\n        // Public attributes\r\n        self.options = options;\r\n        _.each([\r\n            'onCheck'\r\n        ], (method) => {\r\n            if (typeof options[method] === 'function') {\r\n                self[method] = options[method];\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Checks the file\r\n     * @param file\r\n     */\r\n    check(file) {\r\n        if (typeof file !== \"object\" || !file) {\r\n            throw new Meteor.Error('invalid-file', \"File is not valid\");\r\n        }\r\n        // Check size\r\n        if (file.size <= 0 || file.size < this.getMinSize()) {\r\n            throw new Meteor.Error('file-too-small', `File size is too small (min = ${this.getMinSize()})`);\r\n        }\r\n        if (this.getMaxSize() > 0 && file.size > this.getMaxSize()) {\r\n            throw new Meteor.Error('file-too-large', `File size is too large (max = ${this.getMaxSize()})`);\r\n        }\r\n        // Check extension\r\n        if (this.getExtensions() && !_.contains(this.getExtensions(), file.extension)) {\r\n            throw new Meteor.Error('invalid-file-extension', `File extension \"${file.extension}\" is not accepted`);\r\n        }\r\n        // Check content type\r\n        if (this.getContentTypes() && !this.isContentTypeInList(file.type, this.getContentTypes())) {\r\n            throw new Meteor.Error('invalid-file-type', `File type \"${file.type}\" is not accepted`);\r\n        }\r\n        // Apply custom check\r\n        if (typeof this.onCheck === 'function' && !this.onCheck(file)) {\r\n            throw new Meteor.Error('invalid-file', \"File does not match filter\");\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns the allowed content types\r\n     * @return {Array}\r\n     */\r\n    getContentTypes() {\r\n        return this.options.contentTypes;\r\n    }\r\n\r\n    /**\r\n     * Returns the allowed extensions\r\n     * @return {Array}\r\n     */\r\n    getExtensions() {\r\n        return this.options.extensions;\r\n    }\r\n\r\n    /**\r\n     * Returns the maximum file size\r\n     * @return {Number}\r\n     */\r\n    getMaxSize() {\r\n        return this.options.maxSize;\r\n    }\r\n\r\n    /**\r\n     * Returns the minimum file size\r\n     * @return {Number}\r\n     */\r\n    getMinSize() {\r\n        return this.options.minSize;\r\n    }\r\n\r\n    /**\r\n     * Checks if content type is in the given list\r\n     * @param type\r\n     * @param list\r\n     * @return {boolean}\r\n     */\r\n    isContentTypeInList(type, list) {\r\n        if (typeof type === 'string' && list instanceof Array) {\r\n            if (_.contains(list, type)) {\r\n                return true;\r\n            } else {\r\n                let wildCardGlob = '/*';\r\n                let wildcards = _.filter(list, (item) => {\r\n                    return item.indexOf(wildCardGlob) > 0;\r\n                });\r\n\r\n                if (_.contains(wildcards, type.replace(/(\\/.*)$/, wildCardGlob))) {\r\n                    return true;\r\n                }\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Checks if the file matches filter\r\n     * @param file\r\n     * @return {boolean}\r\n     */\r\n    isValid(file) {\r\n        let result = true;\r\n        try {\r\n            this.check(file);\r\n        } catch (err) {\r\n            result = false;\r\n        }\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Executes custom checks\r\n     * @param file\r\n     * @return {boolean}\r\n     */\r\n    onCheck(file) {\r\n        return true;\r\n    }\r\n}\r\n","/*\r\n * The MIT License (MIT)\r\n *\r\n * Copyright (c) 2017 Karl STEIN\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in all\r\n * copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n * SOFTWARE.\r\n *\r\n */\r\n\r\nimport {_} from 'meteor/underscore';\r\nimport {check} from 'meteor/check';\r\nimport {Meteor} from 'meteor/meteor';\r\nimport {UploadFS} from './ufs';\r\nimport {Filter} from './ufs-filter';\r\nimport {Tokens} from './ufs-tokens';\r\n\r\nconst fs = Npm.require('fs');\r\nconst http = Npm.require('http');\r\nconst https = Npm.require('https');\r\nconst Future = Npm.require('fibers/future');\r\n\r\n\r\nif (Meteor.isServer) {\r\n    Meteor.methods({\r\n\r\n        /**\r\n         * Completes the file transfer\r\n         * @param fileId\r\n         * @param storeName\r\n         * @param token\r\n         */\r\n        ufsComplete(fileId, storeName, token) {\r\n            check(fileId, String);\r\n            check(storeName, String);\r\n            check(token, String);\r\n\r\n            // Get store\r\n            let store = UploadFS.getStore(storeName);\r\n            if (!store) {\r\n                throw new Meteor.Error('invalid-store', \"Store not found\");\r\n            }\r\n            // Check token\r\n            if (!store.checkToken(token, fileId)) {\r\n                throw new Meteor.Error('invalid-token', \"Token is not valid\");\r\n            }\r\n\r\n            let fut = new Future();\r\n            let tmpFile = UploadFS.getTempFilePath(fileId);\r\n\r\n            const removeTempFile = function () {\r\n                fs.unlink(tmpFile, function (err) {\r\n                    err && console.error(`ufs: cannot delete temp file \"${tmpFile}\" (${err.message})`);\r\n                });\r\n            };\r\n\r\n            try {\r\n                // todo check if temp file exists\r\n\r\n                // Get file\r\n                let file = store.getCollection().findOne({_id: fileId});\r\n\r\n                // Validate file before moving to the store\r\n                store.validate(file);\r\n\r\n                // Get the temp file\r\n                let rs = fs.createReadStream(tmpFile, {\r\n                    flags: 'r',\r\n                    encoding: null,\r\n                    autoClose: true\r\n                });\r\n\r\n                // Clean upload if error occurs\r\n                rs.on('error', Meteor.bindEnvironment(function (err) {\r\n                    console.error(err);\r\n                    store.getCollection().remove({_id: fileId});\r\n                    fut.throw(err);\r\n                }));\r\n\r\n                // Save file in the store\r\n                store.write(rs, fileId, Meteor.bindEnvironment(function (err, file) {\r\n                    removeTempFile();\r\n\r\n                    if (err) {\r\n                        fut.throw(err);\r\n                    } else {\r\n                        // File has been fully uploaded\r\n                        // so we don't need to keep the token anymore.\r\n                        // Also this ensure that the file cannot be modified with extra chunks later.\r\n                        Tokens.remove({fileId: fileId});\r\n                        fut.return(file);\r\n                    }\r\n                }));\r\n            }\r\n            catch (err) {\r\n                // If write failed, remove the file\r\n                store.getCollection().remove({_id: fileId});\r\n                // removeTempFile();\r\n                fut.throw(err);\r\n            }\r\n            return fut.wait();\r\n        },\r\n\r\n        /**\r\n         * Creates the file and returns the file upload token\r\n         * @param file\r\n         * @return {{fileId: string, token: *, url: *}}\r\n         */\r\n        ufsCreate(file) {\r\n            check(file, Object);\r\n\r\n            if (typeof file.name !== 'string' || !file.name.length) {\r\n                throw new Meteor.Error('invalid-file-name', \"file name is not valid\");\r\n            }\r\n            if (typeof file.store !== 'string' || !file.store.length) {\r\n                throw new Meteor.Error('invalid-store', \"store is not valid\");\r\n            }\r\n            // Get store\r\n            let store = UploadFS.getStore(file.store);\r\n            if (!store) {\r\n                throw new Meteor.Error('invalid-store', \"Store not found\");\r\n            }\r\n\r\n            // Set default info\r\n            file.complete = false;\r\n            file.uploading = false;\r\n            file.extension = file.name && file.name.substr((~-file.name.lastIndexOf('.') >>> 0) + 2).toLowerCase();\r\n            // Assign file MIME type based on the extension\r\n            if (file.extension && !file.type) {\r\n                file.type = UploadFS.getMimeType(file.extension) || 'application/octet-stream';\r\n            }\r\n            file.progress = 0;\r\n            file.size = parseInt(file.size) || 0;\r\n            file.userId = file.userId || this.userId;\r\n\r\n            // Check if the file matches store filter\r\n            let filter = store.getFilter();\r\n            if (filter instanceof Filter) {\r\n                filter.check(file);\r\n            }\r\n\r\n            // Create the file\r\n            let fileId = store.create(file);\r\n            let token = store.createToken(fileId);\r\n            let uploadUrl = store.getURL(`${fileId}?token=${token}`);\r\n\r\n            return {\r\n                fileId: fileId,\r\n                token: token,\r\n                url: uploadUrl\r\n            };\r\n        },\r\n\r\n        /**\r\n         * Deletes a file\r\n         * @param fileId\r\n         * @param storeName\r\n         * @param token\r\n         * @returns {*}\r\n         */\r\n        ufsDelete(fileId, storeName, token) {\r\n            check(fileId, String);\r\n            check(storeName, String);\r\n            check(token, String);\r\n\r\n            // Check store\r\n            let store = UploadFS.getStore(storeName);\r\n            if (!store) {\r\n                throw new Meteor.Error('invalid-store', \"Store not found\");\r\n            }\r\n            // Ignore files that does not exist\r\n            if (store.getCollection().find({_id: fileId}).count() === 0) {\r\n                return 1;\r\n            }\r\n            // Check token\r\n            if (!store.checkToken(token, fileId)) {\r\n                throw new Meteor.Error('invalid-token', \"Token is not valid\");\r\n            }\r\n            return store.getCollection().remove({_id: fileId});\r\n        },\r\n\r\n        /**\r\n         * Imports a file from the URL\r\n         * @param url\r\n         * @param file\r\n         * @param storeName\r\n         * @return {*}\r\n         */\r\n        ufsImportURL(url, file, storeName) {\r\n            check(url, String);\r\n            check(file, Object);\r\n            check(storeName, String);\r\n\r\n            // Check URL\r\n            if (typeof url !== 'string' || url.length <= 0) {\r\n                throw new Meteor.Error('invalid-url', \"The url is not valid\");\r\n            }\r\n            // Check file\r\n            if (typeof file !== 'object' || file === null) {\r\n                throw new Meteor.Error('invalid-file', \"The file is not valid\");\r\n            }\r\n            // Check store\r\n            const store = UploadFS.getStore(storeName);\r\n            if (!store) {\r\n                throw new Meteor.Error('invalid-store', 'The store does not exist');\r\n            }\r\n\r\n            // Extract file info\r\n            if (!file.name) {\r\n                file.name = url.replace(/\\?.*$/, '').split('/').pop();\r\n            }\r\n            if (file.name && !file.extension) {\r\n                file.extension = file.name && file.name.substr((~-file.name.lastIndexOf('.') >>> 0) + 2).toLowerCase();\r\n            }\r\n            if (file.extension && !file.type) {\r\n                // Assign file MIME type based on the extension\r\n                file.type = UploadFS.getMimeType(file.extension) || 'application/octet-stream';\r\n            }\r\n            // Check if file is valid\r\n            if (store.getFilter() instanceof Filter) {\r\n                store.getFilter().check(file);\r\n            }\r\n\r\n            if (file.originalUrl) {\r\n                console.warn(`ufs: The \"originalUrl\" attribute is automatically set when importing a file from a URL`);\r\n            }\r\n\r\n            // Add original URL\r\n            file.originalUrl = url;\r\n\r\n            // Create the file\r\n            file.complete = false;\r\n            file.uploading = true;\r\n            file.progress = 0;\r\n            file._id = store.create(file);\r\n\r\n            let fut = new Future();\r\n            let proto;\r\n\r\n            // Detect protocol to use\r\n            if (/http:\\/\\//i.test(url)) {\r\n                proto = http;\r\n            } else if (/https:\\/\\//i.test(url)) {\r\n                proto = https;\r\n            }\r\n\r\n            this.unblock();\r\n\r\n            // Download file\r\n            proto.get(url, Meteor.bindEnvironment(function (res) {\r\n                // Save the file in the store\r\n                store.write(res, file._id, function (err, file) {\r\n                    if (err) {\r\n                        fut.throw(err);\r\n                    } else {\r\n                        fut.return(file);\r\n                    }\r\n                });\r\n            })).on('error', function (err) {\r\n                fut.throw(err);\r\n            });\r\n            return fut.wait();\r\n        },\r\n\r\n        /**\r\n         * Marks the file uploading as stopped\r\n         * @param fileId\r\n         * @param storeName\r\n         * @param token\r\n         * @returns {*}\r\n         */\r\n        ufsStop(fileId, storeName, token) {\r\n            check(fileId, String);\r\n            check(storeName, String);\r\n            check(token, String);\r\n\r\n            // Check store\r\n            const store = UploadFS.getStore(storeName);\r\n            if (!store) {\r\n                throw new Meteor.Error('invalid-store', \"Store not found\");\r\n            }\r\n            // Check file\r\n            const file = store.getCollection().find({_id: fileId}, {fields: {userId: 1}});\r\n            if (!file) {\r\n                throw new Meteor.Error('invalid-file', \"File not found\");\r\n            }\r\n            // Check token\r\n            if (!store.checkToken(token, fileId)) {\r\n                throw new Meteor.Error('invalid-token', \"Token is not valid\");\r\n            }\r\n\r\n            return store.getCollection().update({_id: fileId}, {\r\n                $set: {uploading: false}\r\n            });\r\n        }\r\n    });\r\n}\r\n","/*\r\n * The MIT License (MIT)\r\n *\r\n * Copyright (c) 2017 Karl STEIN\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in all\r\n * copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n * SOFTWARE.\r\n *\r\n */\r\n\r\n/**\r\n * MIME types and extensions\r\n */\r\nexport const MIME = {\r\n\r\n    // application\r\n    '7z': 'application/x-7z-compressed',\r\n    'arc': 'application/octet-stream',\r\n    'ai': 'application/postscript',\r\n    'bin': 'application/octet-stream',\r\n    'bz': 'application/x-bzip',\r\n    'bz2': 'application/x-bzip2',\r\n    'eps': 'application/postscript',\r\n    'exe': 'application/octet-stream',\r\n    'gz': 'application/x-gzip',\r\n    'gzip': 'application/x-gzip',\r\n    'js': 'application/javascript',\r\n    'json': 'application/json',\r\n    'ogx': 'application/ogg',\r\n    'pdf': 'application/pdf',\r\n    'ps': 'application/postscript',\r\n    'psd': 'application/octet-stream',\r\n    'rar': 'application/x-rar-compressed',\r\n    'rev': 'application/x-rar-compressed',\r\n    'swf': 'application/x-shockwave-flash',\r\n    'tar': 'application/x-tar',\r\n    'xhtml': 'application/xhtml+xml',\r\n    'xml': 'application/xml',\r\n    'zip': 'application/zip',\r\n\r\n    // audio\r\n    'aif': 'audio/aiff',\r\n    'aifc': 'audio/aiff',\r\n    'aiff': 'audio/aiff',\r\n    'au': 'audio/basic',\r\n    'flac': 'audio/flac',\r\n    'midi': 'audio/midi',\r\n    'mp2': 'audio/mpeg',\r\n    'mp3': 'audio/mpeg',\r\n    'mpa': 'audio/mpeg',\r\n    'oga': 'audio/ogg',\r\n    'ogg': 'audio/ogg',\r\n    'opus': 'audio/ogg',\r\n    'ra': 'audio/vnd.rn-realaudio',\r\n    'spx': 'audio/ogg',\r\n    'wav': 'audio/x-wav',\r\n    'weba': 'audio/webm',\r\n    'wma': 'audio/x-ms-wma',\r\n\r\n    // image\r\n    'avs': 'image/avs-video',\r\n    'bmp': 'image/x-windows-bmp',\r\n    'gif': 'image/gif',\r\n    'ico': 'image/vnd.microsoft.icon',\r\n    'jpeg': 'image/jpeg',\r\n    'jpg': 'image/jpg',\r\n    'mjpg': 'image/x-motion-jpeg',\r\n    'pic': 'image/pic',\r\n    'png': 'image/png',\r\n    'svg': 'image/svg+xml',\r\n    'tif': 'image/tiff',\r\n    'tiff': 'image/tiff',\r\n\r\n    // text\r\n    'css': 'text/css',\r\n    'csv': 'text/csv',\r\n    'html': 'text/html',\r\n    'txt': 'text/plain',\r\n\r\n    // video\r\n    'avi': 'video/avi',\r\n    'dv': 'video/x-dv',\r\n    'flv': 'video/x-flv',\r\n    'mov': 'video/quicktime',\r\n    'mp4': 'video/mp4',\r\n    'mpeg': 'video/mpeg',\r\n    'mpg': 'video/mpg',\r\n    'ogv': 'video/ogg',\r\n    'vdo': 'video/vdo',\r\n    'webm': 'video/webm',\r\n    'wmv': 'video/x-ms-wmv',\r\n\r\n    // specific to vendors\r\n    'doc': 'application/msword',\r\n    'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\r\n    'odb': 'application/vnd.oasis.opendocument.database',\r\n    'odc': 'application/vnd.oasis.opendocument.chart',\r\n    'odf': 'application/vnd.oasis.opendocument.formula',\r\n    'odg': 'application/vnd.oasis.opendocument.graphics',\r\n    'odi': 'application/vnd.oasis.opendocument.image',\r\n    'odm': 'application/vnd.oasis.opendocument.text-master',\r\n    'odp': 'application/vnd.oasis.opendocument.presentation',\r\n    'ods': 'application/vnd.oasis.opendocument.spreadsheet',\r\n    'odt': 'application/vnd.oasis.opendocument.text',\r\n    'otg': 'application/vnd.oasis.opendocument.graphics-template',\r\n    'otp': 'application/vnd.oasis.opendocument.presentation-template',\r\n    'ots': 'application/vnd.oasis.opendocument.spreadsheet-template',\r\n    'ott': 'application/vnd.oasis.opendocument.text-template',\r\n    'ppt': 'application/vnd.ms-powerpoint',\r\n    'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',\r\n    'xls': 'application/vnd.ms-excel',\r\n    'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'\r\n};\r\n","/*\r\n * The MIT License (MIT)\r\n *\r\n * Copyright (c) 2017 Karl STEIN\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in all\r\n * copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n * SOFTWARE.\r\n *\r\n */\r\nimport {_} from \"meteor/underscore\";\r\nimport {Meteor} from \"meteor/meteor\";\r\nimport {WebApp} from \"meteor/webapp\";\r\nimport {UploadFS} from \"./ufs\";\r\n\r\n\r\nif (Meteor.isServer) {\r\n\r\n    const domain = Npm.require('domain');\r\n    const fs = Npm.require('fs');\r\n    const http = Npm.require('http');\r\n    const https = Npm.require('https');\r\n    const mkdirp = Npm.require('mkdirp');\r\n    const stream = Npm.require('stream');\r\n    const URL = Npm.require('url');\r\n    const zlib = Npm.require('zlib');\r\n\r\n\r\n    Meteor.startup(() => {\r\n        let path = UploadFS.config.tmpDir;\r\n        let mode = UploadFS.config.tmpDirPermissions;\r\n\r\n        fs.stat(path, (err) => {\r\n            if (err) {\r\n                // Create the temp directory\r\n                mkdirp(path, {mode: mode}, (err) => {\r\n                    if (err) {\r\n                        console.error(`ufs: cannot create temp directory at \"${path}\" (${err.message})`);\r\n                    } else {\r\n                        console.log(`ufs: temp directory created at \"${path}\"`);\r\n                    }\r\n                });\r\n            } else {\r\n                // Set directory permissions\r\n                fs.chmod(path, mode, (err) => {\r\n                    err && console.error(`ufs: cannot set temp directory permissions ${mode} (${err.message})`);\r\n                });\r\n            }\r\n        });\r\n    });\r\n\r\n    // Create domain to handle errors\r\n    // and possibly avoid server crashes.\r\n    let d = domain.create();\r\n\r\n    d.on('error', (err) => {\r\n        console.error('ufs: ' + err.message);\r\n    });\r\n\r\n    // Listen HTTP requests to serve files\r\n    WebApp.connectHandlers.use((req, res, next) => {\r\n        // Quick check to see if request should be catch\r\n        if (req.url.indexOf(UploadFS.config.storesPath) === -1) {\r\n            next();\r\n            return;\r\n        }\r\n\r\n        // Remove store path\r\n        let parsedUrl = URL.parse(req.url);\r\n        let path = parsedUrl.pathname.substr(UploadFS.config.storesPath.length + 1);\r\n\r\n        let allowCORS = () => {\r\n            // res.setHeader('Access-Control-Allow-Origin', req.headers.origin);\r\n            res.setHeader(\"Access-Control-Allow-Methods\", \"POST\");\r\n            res.setHeader(\"Access-Control-Allow-Origin\", \"*\");\r\n            res.setHeader(\"Access-Control-Allow-Headers\", \"Content-Type\");\r\n        };\r\n\r\n        if (req.method === \"OPTIONS\") {\r\n            let regExp = new RegExp('^\\/([^\\/\\?]+)\\/([^\\/\\?]+)$');\r\n            let match = regExp.exec(path);\r\n\r\n            // Request is not valid\r\n            if (match === null) {\r\n                res.writeHead(400);\r\n                res.end();\r\n                return;\r\n            }\r\n\r\n            // Get store\r\n            let store = UploadFS.getStore(match[1]);\r\n            if (!store) {\r\n                res.writeHead(404);\r\n                res.end();\r\n                return;\r\n            }\r\n\r\n            // If a store is found, go ahead and allow the origin\r\n            allowCORS();\r\n\r\n            next();\r\n        }\r\n        else if (req.method === 'POST') {\r\n            // Get store\r\n            let regExp = new RegExp('^\\/([^\\/\\?]+)\\/([^\\/\\?]+)$');\r\n            let match = regExp.exec(path);\r\n\r\n            // Request is not valid\r\n            if (match === null) {\r\n                res.writeHead(400);\r\n                res.end();\r\n                return;\r\n            }\r\n\r\n            // Get store\r\n            let store = UploadFS.getStore(match[1]);\r\n            if (!store) {\r\n                res.writeHead(404);\r\n                res.end();\r\n                return;\r\n            }\r\n\r\n            // If a store is found, go ahead and allow the origin\r\n            allowCORS();\r\n\r\n            // Get file\r\n            let fileId = match[2];\r\n            if (store.getCollection().find({_id: fileId}).count() === 0) {\r\n                res.writeHead(404);\r\n                res.end();\r\n                return;\r\n            }\r\n\r\n            // Check upload token\r\n            if (!store.checkToken(req.query.token, fileId)) {\r\n                res.writeHead(403);\r\n                res.end();\r\n                return;\r\n            }\r\n\r\n            let tmpFile = UploadFS.getTempFilePath(fileId);\r\n            let ws = fs.createWriteStream(tmpFile, {flags: 'a'});\r\n            let fields = {uploading: true};\r\n            let progress = parseFloat(req.query.progress);\r\n            if (!isNaN(progress) && progress > 0) {\r\n                fields.progress = Math.min(progress, 1);\r\n            }\r\n\r\n            req.on('data', (chunk) => {\r\n                ws.write(chunk);\r\n            });\r\n            req.on('error', (err) => {\r\n                res.writeHead(500);\r\n                res.end();\r\n            });\r\n            req.on('end', Meteor.bindEnvironment(() => {\r\n                // Update completed state without triggering hooks\r\n                store.getCollection().direct.update({_id: fileId}, {$set: fields});\r\n                ws.end();\r\n            }));\r\n            ws.on('error', (err) => {\r\n                console.error(`ufs: cannot write chunk of file \"${fileId}\" (${err.message})`);\r\n                fs.unlink(tmpFile, (err) => {\r\n                    err && console.error(`ufs: cannot delete temp file \"${tmpFile}\" (${err.message})`);\r\n                });\r\n                res.writeHead(500);\r\n                res.end();\r\n            });\r\n            ws.on('finish', () => {\r\n                res.writeHead(204, {\"Content-Type\": 'text/plain'});\r\n                res.end();\r\n            });\r\n        }\r\n        else if (req.method == 'GET') {\r\n            // Get store, file Id and file name\r\n            let regExp = new RegExp('^\\/([^\\/\\?]+)\\/([^\\/\\?]+)(?:\\/([^\\/\\?]+))?$');\r\n            let match = regExp.exec(path);\r\n\r\n            // Avoid 504 Gateway timeout error\r\n            // if file is not handled by UploadFS.\r\n            if (match === null) {\r\n                next();\r\n                return;\r\n            }\r\n\r\n            // Get store\r\n            const storeName = match[1];\r\n            const store = UploadFS.getStore(storeName);\r\n\r\n            if (!store) {\r\n                res.writeHead(404);\r\n                res.end();\r\n                return;\r\n            }\r\n\r\n            if (store.onRead !== null && store.onRead !== undefined && typeof store.onRead !== 'function') {\r\n                console.error(`ufs: Store.onRead is not a function in store \"${storeName}\"`);\r\n                res.writeHead(500);\r\n                res.end();\r\n                return;\r\n            }\r\n\r\n            // Remove file extension from file Id\r\n            let index = match[2].indexOf('.');\r\n            let fileId = index !== -1 ? match[2].substr(0, index) : match[2];\r\n\r\n            // Get file from database\r\n            const file = store.getCollection().findOne({_id: fileId});\r\n            if (!file) {\r\n                res.writeHead(404);\r\n                res.end();\r\n                return;\r\n            }\r\n\r\n            // Simulate read speed\r\n            if (UploadFS.config.simulateReadDelay) {\r\n                Meteor._sleepForMs(UploadFS.config.simulateReadDelay);\r\n            }\r\n\r\n            d.run(() => {\r\n                // Check if the file can be accessed\r\n                if (store.onRead.call(store, fileId, file, req, res) !== false) {\r\n                    let options = {};\r\n                    let status = 200;\r\n\r\n                    // Prepare response headers\r\n                    let headers = {\r\n                        'Content-Type': file.type,\r\n                        'Content-Length': file.size\r\n                    };\r\n\r\n                    // Add ETag header\r\n                    if (typeof file.etag === 'string') {\r\n                        headers['ETag'] = file.etag;\r\n                    }\r\n\r\n                    // Add Last-Modified header\r\n                    if (file.modifiedAt instanceof Date) {\r\n                        headers['Last-Modified'] = file.modifiedAt.toUTCString();\r\n                    }\r\n                    else if (file.uploadedAt instanceof Date) {\r\n                        headers['Last-Modified'] = file.uploadedAt.toUTCString();\r\n                    }\r\n\r\n                    // Parse request headers\r\n                    if (typeof req.headers === 'object') {\r\n\r\n                        // Compare ETag\r\n                        if (req.headers['if-none-match']) {\r\n                            if (file.etag === req.headers['if-none-match']) {\r\n                                res.writeHead(304); // Not Modified\r\n                                res.end();\r\n                                return;\r\n                            }\r\n                        }\r\n\r\n                        // Compare file modification date\r\n                        if (req.headers['if-modified-since']) {\r\n                            const modifiedSince = new Date(req.headers['if-modified-since']);\r\n\r\n                            if ((file.modifiedAt instanceof Date && file.modifiedAt > modifiedSince)\r\n                                || file.uploadedAt instanceof Date && file.uploadedAt > modifiedSince) {\r\n                                res.writeHead(304); // Not Modified\r\n                                res.end();\r\n                                return;\r\n                            }\r\n                        }\r\n\r\n                        // Send data in range\r\n                        if (typeof req.headers.range === 'string') {\r\n                            let range = req.headers.range;\r\n\r\n                            // Range is not valid\r\n                            if (!range) {\r\n                                res.writeHead(416);\r\n                                res.end();\r\n                                return;\r\n                            }\r\n\r\n                            let positions = range.replace(/bytes=/, '').split('-');\r\n                            let start = parseInt(positions[0], 10);\r\n                            let total = file.size;\r\n                            let end = positions[1] ? parseInt(positions[1], 10) : total - 1;\r\n\r\n                            // Update headers\r\n                            headers['Content-Range'] = `bytes ${start}-${end}/${total}`;\r\n                            headers['Accept-Ranges'] = `bytes`;\r\n                            headers['Content-Length'] = (end - start) + 1;\r\n\r\n                            status = 206; // partial content\r\n                            options.start = start;\r\n                            options.end = end;\r\n                        }\r\n                    }\r\n\r\n                    // Open the file stream\r\n                    let rs = store.getReadStream(fileId, file, options);\r\n                    let ws = new stream.PassThrough();\r\n\r\n                    rs.on('error', Meteor.bindEnvironment((err) => {\r\n                        store.onReadError.call(store, err, fileId, file);\r\n                        res.end();\r\n                    }));\r\n                    ws.on('error', Meteor.bindEnvironment((err) => {\r\n                        store.onReadError.call(store, err, fileId, file);\r\n                        res.end();\r\n                    }));\r\n                    ws.on('close', () => {\r\n                        // Close output stream at the end\r\n                        ws.emit('end');\r\n                    });\r\n\r\n                    // Transform stream\r\n                    store.transformRead(rs, ws, fileId, file, req, headers);\r\n\r\n                    // Parse request headers\r\n                    if (typeof req.headers === 'object') {\r\n                        // Compress data using if needed (ignore audio/video as they are already compressed)\r\n                        if (typeof req.headers['accept-encoding'] === 'string' && !/^(audio|video)/.test(file.type)) {\r\n                            let accept = req.headers['accept-encoding'];\r\n\r\n                            // Compress with gzip\r\n                            if (accept.match(/\\bgzip\\b/)) {\r\n                                headers['Content-Encoding'] = 'gzip';\r\n                                delete headers['Content-Length'];\r\n                                res.writeHead(status, headers);\r\n                                ws.pipe(zlib.createGzip()).pipe(res);\r\n                                return;\r\n                            }\r\n                            // Compress with deflate\r\n                            else if (accept.match(/\\bdeflate\\b/)) {\r\n                                headers['Content-Encoding'] = 'deflate';\r\n                                delete headers['Content-Length'];\r\n                                res.writeHead(status, headers);\r\n                                ws.pipe(zlib.createDeflate()).pipe(res);\r\n                                return;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    // Send raw data\r\n                    if (!headers['Content-Encoding']) {\r\n                        res.writeHead(status, headers);\r\n                        ws.pipe(res);\r\n                    }\r\n\r\n                } else {\r\n                    res.end();\r\n                }\r\n            });\r\n        } else {\r\n            next();\r\n        }\r\n    });\r\n}\r\n","/*\r\n * The MIT License (MIT)\r\n *\r\n * Copyright (c) 2017 Karl STEIN\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in all\r\n * copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n * SOFTWARE.\r\n *\r\n */\r\nimport {_} from \"meteor/underscore\";\r\n\r\n\r\n/**\r\n * Store permissions\r\n */\r\nexport class StorePermissions {\r\n\r\n    constructor(options) {\r\n        // Default options\r\n        options = _.extend({\r\n            insert: null,\r\n            remove: null,\r\n            update: null\r\n        }, options);\r\n\r\n        // Check options\r\n        if (options.insert && typeof options.insert !== 'function') {\r\n            throw new TypeError(\"StorePermissions: insert is not a function\");\r\n        }\r\n        if (options.remove && typeof options.remove !== 'function') {\r\n            throw new TypeError(\"StorePermissions: remove is not a function\");\r\n        }\r\n        if (options.update && typeof options.update !== 'function') {\r\n            throw new TypeError(\"StorePermissions: update is not a function\");\r\n        }\r\n\r\n        // Public attributes\r\n        this.actions = {\r\n            insert: options.insert,\r\n            remove: options.remove,\r\n            update: options.update,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Checks the permission for the action\r\n     * @param action\r\n     * @param userId\r\n     * @param file\r\n     * @param fields\r\n     * @param modifiers\r\n     * @return {*}\r\n     */\r\n    check(action, userId, file, fields, modifiers) {\r\n        if (typeof this.actions[action] === 'function') {\r\n            return this.actions[action](userId, file, fields, modifiers);\r\n        }\r\n        return true; // by default allow all\r\n    }\r\n\r\n    /**\r\n     * Checks the insert permission\r\n     * @param userId\r\n     * @param file\r\n     * @returns {*}\r\n     */\r\n    checkInsert(userId, file) {\r\n        return this.check('insert', userId, file);\r\n    }\r\n\r\n    /**\r\n     * Checks the remove permission\r\n     * @param userId\r\n     * @param file\r\n     * @returns {*}\r\n     */\r\n    checkRemove(userId, file) {\r\n        return this.check('remove', userId, file);\r\n    }\r\n\r\n    /**\r\n     * Checks the update permission\r\n     * @param userId\r\n     * @param file\r\n     * @param fields\r\n     * @param modifiers\r\n     * @returns {*}\r\n     */\r\n    checkUpdate(userId, file, fields, modifiers) {\r\n        return this.check('update', userId, file, fields, modifiers);\r\n    }\r\n}\r\n","/*\r\n * The MIT License (MIT)\r\n *\r\n * Copyright (c) 2017 Karl STEIN\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in all\r\n * copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n * SOFTWARE.\r\n *\r\n */\r\nimport {_} from \"meteor/underscore\";\r\nimport {check} from \"meteor/check\";\r\nimport {Meteor} from \"meteor/meteor\";\r\nimport {Mongo} from \"meteor/mongo\";\r\nimport {UploadFS} from \"./ufs\";\r\nimport {Filter} from \"./ufs-filter\";\r\nimport {StorePermissions} from \"./ufs-store-permissions\";\r\nimport {Tokens} from \"./ufs-tokens\";\r\n\r\n\r\n/**\r\n * File store\r\n */\r\nexport class Store {\r\n\r\n    constructor(options) {\r\n        let self = this;\r\n\r\n        // Default options\r\n        options = _.extend({\r\n            collection: null,\r\n            filter: null,\r\n            name: null,\r\n            onCopyError: this.onCopyError,\r\n            onFinishUpload: this.onFinishUpload,\r\n            onRead: this.onRead,\r\n            onReadError: this.onReadError,\r\n            onValidate: this.onValidate,\r\n            onWriteError: this.onWriteError,\r\n            permissions: null,\r\n            transformRead: null,\r\n            transformWrite: null\r\n        }, options);\r\n\r\n        // Check options\r\n        if (!(options.collection instanceof Mongo.Collection)) {\r\n            throw new TypeError('Store: collection is not a Mongo.Collection');\r\n        }\r\n        if (options.filter && !(options.filter instanceof Filter)) {\r\n            throw new TypeError('Store: filter is not a UploadFS.Filter');\r\n        }\r\n        if (typeof options.name !== 'string') {\r\n            throw new TypeError('Store: name is not a string');\r\n        }\r\n        if (UploadFS.getStore(options.name)) {\r\n            throw new TypeError('Store: name already exists');\r\n        }\r\n        if (options.onCopyError && typeof options.onCopyError !== 'function') {\r\n            throw new TypeError('Store: onCopyError is not a function');\r\n        }\r\n        if (options.onFinishUpload && typeof options.onFinishUpload !== 'function') {\r\n            throw new TypeError('Store: onFinishUpload is not a function');\r\n        }\r\n        if (options.onRead && typeof options.onRead !== 'function') {\r\n            throw new TypeError('Store: onRead is not a function');\r\n        }\r\n        if (options.onReadError && typeof options.onReadError !== 'function') {\r\n            throw new TypeError('Store: onReadError is not a function');\r\n        }\r\n        if (options.onWriteError && typeof options.onWriteError !== 'function') {\r\n            throw new TypeError('Store: onWriteError is not a function');\r\n        }\r\n        if (options.permissions && !(options.permissions instanceof StorePermissions)) {\r\n            throw new TypeError('Store: permissions is not a UploadFS.StorePermissions');\r\n        }\r\n        if (options.transformRead && typeof options.transformRead !== 'function') {\r\n            throw new TypeError('Store: transformRead is not a function');\r\n        }\r\n        if (options.transformWrite && typeof options.transformWrite !== 'function') {\r\n            throw new TypeError('Store: transformWrite is not a function');\r\n        }\r\n        if (options.onValidate && typeof options.onValidate !== 'function') {\r\n            throw new TypeError('Store: onValidate is not a function');\r\n        }\r\n\r\n        // Public attributes\r\n        self.options = options;\r\n        self.permissions = options.permissions;\r\n        _.each([\r\n            'onCopyError',\r\n            'onFinishUpload',\r\n            'onRead',\r\n            'onReadError',\r\n            'onWriteError',\r\n            'onValidate'\r\n        ], (method) => {\r\n            if (typeof options[method] === 'function') {\r\n                self[method] = options[method];\r\n            }\r\n        });\r\n\r\n        // Add the store to the list\r\n        UploadFS.addStore(self);\r\n\r\n        // Set default permissions\r\n        if (!(self.permissions instanceof StorePermissions)) {\r\n            // Uses custom default permissions or UFS default permissions\r\n            if (UploadFS.config.defaultStorePermissions instanceof StorePermissions) {\r\n                self.permissions = UploadFS.config.defaultStorePermissions;\r\n            } else {\r\n                self.permissions = new StorePermissions();\r\n                console.warn(`ufs: permissions are not defined for store \"${options.name}\"`);\r\n            }\r\n        }\r\n\r\n        if (Meteor.isServer) {\r\n\r\n            /**\r\n             * Checks token validity\r\n             * @param token\r\n             * @param fileId\r\n             * @returns {boolean}\r\n             */\r\n            self.checkToken = function (token, fileId) {\r\n                check(token, String);\r\n                check(fileId, String);\r\n                return Tokens.find({value: token, fileId: fileId}).count() === 1;\r\n            };\r\n\r\n            /**\r\n             * Copies the file to a store\r\n             * @param fileId\r\n             * @param store\r\n             * @param callback\r\n             */\r\n            self.copy = function (fileId, store, callback) {\r\n                check(fileId, String);\r\n\r\n                if (!(store instanceof Store)) {\r\n                    throw new TypeError('store is not an instance of UploadFS.Store');\r\n                }\r\n                // Get original file\r\n                let file = self.getCollection().findOne({_id: fileId});\r\n                if (!file) {\r\n                    throw new Meteor.Error('file-not-found', 'File not found');\r\n                }\r\n                // Silently ignore the file if it does not match filter\r\n                const filter = store.getFilter();\r\n                if (filter instanceof Filter && !filter.isValid(file)) {\r\n                    return;\r\n                }\r\n\r\n                // Prepare copy\r\n                let copy = _.omit(file, '_id', 'url');\r\n                copy.originalStore = self.getName();\r\n                copy.originalId = fileId;\r\n\r\n                // Create the copy\r\n                let copyId = store.create(copy);\r\n\r\n                // Get original stream\r\n                let rs = self.getReadStream(fileId, file);\r\n\r\n                // Catch errors to avoid app crashing\r\n                rs.on('error', Meteor.bindEnvironment(function (err) {\r\n                    callback.call(self, err, null);\r\n                }));\r\n\r\n                // Copy file data\r\n                store.write(rs, copyId, Meteor.bindEnvironment(function (err) {\r\n                    if (err) {\r\n                        self.getCollection().remove({_id: copyId});\r\n                        self.onCopyError.call(self, err, fileId, file);\r\n                    }\r\n                    if (typeof callback === 'function') {\r\n                        callback.call(self, err, copyId, copy, store);\r\n                    }\r\n                }));\r\n            };\r\n\r\n            /**\r\n             * Creates the file in the collection\r\n             * @param file\r\n             * @param callback\r\n             * @return {string}\r\n             */\r\n            self.create = function (file, callback) {\r\n                check(file, Object);\r\n                file.store = self.options.name; // assign store to file\r\n                return self.getCollection().insert(file, callback);\r\n            };\r\n\r\n            /**\r\n             * Creates a token for the file (only needed for client side upload)\r\n             * @param fileId\r\n             * @returns {*}\r\n             */\r\n            self.createToken = function (fileId) {\r\n                let token = self.generateToken();\r\n\r\n                // Check if token exists\r\n                if (Tokens.find({fileId: fileId}).count()) {\r\n                    Tokens.update({fileId: fileId}, {\r\n                        $set: {\r\n                            createdAt: new Date(),\r\n                            value: token\r\n                        }\r\n                    });\r\n                } else {\r\n                    Tokens.insert({\r\n                        createdAt: new Date(),\r\n                        fileId: fileId,\r\n                        value: token\r\n                    });\r\n                }\r\n                return token;\r\n            };\r\n\r\n            /**\r\n             * Writes the file to the store\r\n             * @param rs\r\n             * @param fileId\r\n             * @param callback\r\n             */\r\n            self.write = function (rs, fileId, callback) {\r\n                let file = self.getCollection().findOne({_id: fileId});\r\n                let ws = self.getWriteStream(fileId, file);\r\n\r\n                let errorHandler = Meteor.bindEnvironment(function (err) {\r\n                    self.getCollection().remove({_id: fileId});\r\n                    self.onWriteError.call(self, err, fileId, file);\r\n                    callback.call(self, err);\r\n                });\r\n\r\n                ws.on('error', errorHandler);\r\n                ws.on('finish', Meteor.bindEnvironment(function () {\r\n                    let size = 0;\r\n                    let readStream = self.getReadStream(fileId, file);\r\n\r\n                    readStream.on('error', Meteor.bindEnvironment(function (error) {\r\n                        callback.call(self, error, null);\r\n                    }));\r\n                    readStream.on('data', Meteor.bindEnvironment(function (data) {\r\n                        size += data.length;\r\n                    }));\r\n                    readStream.on('end', Meteor.bindEnvironment(function () {\r\n                        // Set file attribute\r\n                        file.complete = true;\r\n                        file.etag = UploadFS.generateEtag();\r\n                        file.path = self.getFileRelativeURL(fileId);\r\n                        file.progress = 1;\r\n                        file.size = size;\r\n                        file.token = self.generateToken();\r\n                        file.uploading = false;\r\n                        file.uploadedAt = new Date();\r\n                        file.url = self.getFileURL(fileId);\r\n\r\n                        // Sets the file URL when file transfer is complete,\r\n                        // this way, the image will loads entirely.\r\n                        self.getCollection().direct.update({_id: fileId}, {\r\n                            $set: {\r\n                                complete: file.complete,\r\n                                etag: file.etag,\r\n                                path: file.path,\r\n                                progress: file.progress,\r\n                                size: file.size,\r\n                                token: file.token,\r\n                                uploading: file.uploading,\r\n                                uploadedAt: file.uploadedAt,\r\n                                url: file.url\r\n                            }\r\n                        });\r\n\r\n                        // Return file info\r\n                        callback.call(self, null, file);\r\n\r\n                        // Execute callback\r\n                        if (typeof self.onFinishUpload == 'function') {\r\n                            self.onFinishUpload.call(self, file);\r\n                        }\r\n\r\n                        // Simulate write speed\r\n                        if (UploadFS.config.simulateWriteDelay) {\r\n                            Meteor._sleepForMs(UploadFS.config.simulateWriteDelay);\r\n                        }\r\n\r\n                        // Copy file to other stores\r\n                        if (self.options.copyTo instanceof Array) {\r\n                            for (let i = 0; i < self.options.copyTo.length; i += 1) {\r\n                                let store = self.options.copyTo[i];\r\n\r\n                                if (!store.getFilter() || store.getFilter().isValid(file)) {\r\n                                    self.copy(fileId, store);\r\n                                }\r\n                            }\r\n                        }\r\n                    }));\r\n                }));\r\n\r\n                // Execute transformation\r\n                self.transformWrite(rs, ws, fileId, file);\r\n            };\r\n        }\r\n\r\n        if (Meteor.isServer) {\r\n            const fs = Npm.require('fs');\r\n            const collection = self.getCollection();\r\n\r\n            // Code executed after removing file\r\n            collection.after.remove(function (userId, file) {\r\n                // Remove associated tokens\r\n                Tokens.remove({fileId: file._id});\r\n\r\n                if (self.options.copyTo instanceof Array) {\r\n                    for (let i = 0; i < self.options.copyTo.length; i += 1) {\r\n                        // Remove copies in stores\r\n                        self.options.copyTo[i].getCollection().remove({originalId: file._id});\r\n                    }\r\n                }\r\n            });\r\n\r\n            // Code executed before inserting file\r\n            collection.before.insert(function (userId, file) {\r\n                if (!self.permissions.checkInsert(userId, file)) {\r\n                    throw new Meteor.Error('forbidden', \"Forbidden\");\r\n                }\r\n            });\r\n\r\n            // Code executed before updating file\r\n            collection.before.update(function (userId, file, fields, modifiers) {\r\n                if (!self.permissions.checkUpdate(userId, file, fields, modifiers)) {\r\n                    throw new Meteor.Error('forbidden', \"Forbidden\");\r\n                }\r\n            });\r\n\r\n            // Code executed before removing file\r\n            collection.before.remove(function (userId, file) {\r\n                if (!self.permissions.checkRemove(userId, file)) {\r\n                    throw new Meteor.Error('forbidden', \"Forbidden\");\r\n                }\r\n\r\n                // Delete the physical file in the store\r\n                self.delete(file._id);\r\n\r\n                let tmpFile = UploadFS.getTempFilePath(file._id);\r\n\r\n                // Delete the temp file\r\n                fs.stat(tmpFile, function (err) {\r\n                    !err && fs.unlink(tmpFile, function (err) {\r\n                        err && console.error(`ufs: cannot delete temp file at ${tmpFile} (${err.message})`);\r\n                    });\r\n                });\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Deletes a file async\r\n     * @param fileId\r\n     * @param callback\r\n     */\r\n    delete(fileId, callback) {\r\n        throw new Error('delete is not implemented');\r\n    }\r\n\r\n    /**\r\n     * Generates a random token\r\n     * @param pattern\r\n     * @return {string}\r\n     */\r\n    generateToken(pattern) {\r\n        return (pattern || 'xyxyxyxyxy').replace(/[xy]/g, (c) => {\r\n            let r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\r\n            let s = v.toString(16);\r\n            return Math.round(Math.random()) ? s.toUpperCase() : s;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Returns the collection\r\n     * @return {Mongo.Collection}\r\n     */\r\n    getCollection() {\r\n        return this.options.collection;\r\n    }\r\n\r\n    /**\r\n     * Returns the file URL\r\n     * @param fileId\r\n     * @return {string|null}\r\n     */\r\n    getFileRelativeURL(fileId) {\r\n        let file = this.getCollection().findOne(fileId, {fields: {name: 1}});\r\n        return file ? this.getRelativeURL(`${fileId}/${file.name}`) : null;\r\n    }\r\n\r\n    /**\r\n     * Returns the file URL\r\n     * @param fileId\r\n     * @return {string|null}\r\n     */\r\n    getFileURL(fileId) {\r\n        let file = this.getCollection().findOne(fileId, {fields: {name: 1}});\r\n        return file ? this.getURL(`${fileId}/${file.name}`) : null;\r\n    }\r\n\r\n    /**\r\n     * Returns the file filter\r\n     * @return {UploadFS.Filter}\r\n     */\r\n    getFilter() {\r\n        return this.options.filter;\r\n    }\r\n\r\n    /**\r\n     * Returns the store name\r\n     * @return {string}\r\n     */\r\n    getName() {\r\n        return this.options.name;\r\n    }\r\n\r\n    /**\r\n     * Returns the file read stream\r\n     * @param fileId\r\n     * @param file\r\n     */\r\n    getReadStream(fileId, file) {\r\n        throw new Error('Store.getReadStream is not implemented');\r\n    }\r\n\r\n    /**\r\n     * Returns the store relative URL\r\n     * @param path\r\n     * @return {string}\r\n     */\r\n    getRelativeURL(path) {\r\n        const rootUrl = Meteor.absoluteUrl().replace(/\\/+$/, '');\r\n        const rootPath = rootUrl.replace(/^[a-z]+:\\/\\/[^/]+\\/*/gi, '');\r\n        const storeName = this.getName();\r\n        path = String(path).replace(/\\/$/, '').trim();\r\n        return encodeURI(`${rootPath}/${UploadFS.config.storesPath}/${storeName}/${path}`);\r\n    }\r\n\r\n    /**\r\n     * Returns the store absolute URL\r\n     * @param path\r\n     * @return {string}\r\n     */\r\n    getURL(path) {\r\n        const rootUrl = Meteor.absoluteUrl().replace(/\\/+$/, '');\r\n        const storeName = this.getName();\r\n        path = String(path).replace(/\\/$/, '').trim();\r\n        return encodeURI(`${rootUrl}/${UploadFS.config.storesPath}/${storeName}/${path}`);\r\n    }\r\n\r\n    /**\r\n     * Returns the file write stream\r\n     * @param fileId\r\n     * @param file\r\n     */\r\n    getWriteStream(fileId, file) {\r\n        throw new Error('getWriteStream is not implemented');\r\n    }\r\n\r\n    /**\r\n     * Completes the file upload\r\n     * @param url\r\n     * @param file\r\n     * @param callback\r\n     */\r\n    importFromURL(url, file, callback) {\r\n        Meteor.call('ufsImportURL', url, file, this.getName(), callback);\r\n    }\r\n\r\n    /**\r\n     * Called when a copy error happened\r\n     * @param err\r\n     * @param fileId\r\n     * @param file\r\n     */\r\n    onCopyError(err, fileId, file) {\r\n        console.error(`ufs: cannot copy file \"${fileId}\" (${err.message})`, err);\r\n    }\r\n\r\n    /**\r\n     * Called when a file has been uploaded\r\n     * @param file\r\n     */\r\n    onFinishUpload(file) {\r\n    }\r\n\r\n    /**\r\n     * Called when a file is read from the store\r\n     * @param fileId\r\n     * @param file\r\n     * @param request\r\n     * @param response\r\n     * @return boolean\r\n     */\r\n    onRead(fileId, file, request, response) {\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Called when a read error happened\r\n     * @param err\r\n     * @param fileId\r\n     * @param file\r\n     * @return boolean\r\n     */\r\n    onReadError(err, fileId, file) {\r\n        console.error(`ufs: cannot read file \"${fileId}\" (${err.message})`, err);\r\n    }\r\n\r\n    /**\r\n     * Called when file is being validated\r\n     * @param file\r\n     */\r\n    onValidate(file) {\r\n    }\r\n\r\n    /**\r\n     * Called when a write error happened\r\n     * @param err\r\n     * @param fileId\r\n     * @param file\r\n     * @return boolean\r\n     */\r\n    onWriteError(err, fileId, file) {\r\n        console.error(`ufs: cannot write file \"${fileId}\" (${err.message})`, err);\r\n    }\r\n\r\n    /**\r\n     * Sets the store permissions\r\n     * @param permissions\r\n     */\r\n    setPermissions(permissions) {\r\n        if (!(permissions instanceof StorePermissions)) {\r\n            throw new TypeError(\"Permissions is not an instance of UploadFS.StorePermissions\");\r\n        }\r\n        this.permissions = permissions;\r\n    }\r\n\r\n    /**\r\n     * Transforms the file on reading\r\n     * @param readStream\r\n     * @param writeStream\r\n     * @param fileId\r\n     * @param file\r\n     * @param request\r\n     * @param headers\r\n     */\r\n    transformRead(readStream, writeStream, fileId, file, request, headers) {\r\n        if (typeof this.options.transformRead === 'function') {\r\n            this.options.transformRead.call(this, readStream, writeStream, fileId, file, request, headers);\r\n        } else {\r\n            readStream.pipe(writeStream);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Transforms the file on writing\r\n     * @param readStream\r\n     * @param writeStream\r\n     * @param fileId\r\n     * @param file\r\n     */\r\n    transformWrite(readStream, writeStream, fileId, file) {\r\n        if (typeof this.options.transformWrite === 'function') {\r\n            this.options.transformWrite.call(this, readStream, writeStream, fileId, file);\r\n        } else {\r\n            readStream.pipe(writeStream);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validates the file\r\n     * @param file\r\n     */\r\n    validate(file) {\r\n        if (typeof this.onValidate === 'function') {\r\n            this.onValidate(file);\r\n        }\r\n    }\r\n}\r\n","/*\r\n * The MIT License (MIT)\r\n *\r\n * Copyright (c) 2017 Karl STEIN\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in all\r\n * copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n * SOFTWARE.\r\n *\r\n */\r\n\r\nimport {Template} from 'meteor/templating';\r\n\r\n\r\nlet isMIME = function (type, mime) {\r\n    return typeof type === 'string'\r\n        && typeof mime === 'string'\r\n        && mime.indexOf(type + '/') === 0;\r\n};\r\n\r\nTemplate.registerHelper('isApplication', function (type) {\r\n    return isMIME('application', this.type || type);\r\n});\r\n\r\nTemplate.registerHelper('isAudio', function (type) {\r\n    return isMIME('audio', this.type || type);\r\n});\r\n\r\nTemplate.registerHelper('isImage', function (type) {\r\n    return isMIME('image', this.type || type);\r\n});\r\n\r\nTemplate.registerHelper('isText', function (type) {\r\n    return isMIME('text', this.type || type);\r\n});\r\n\r\nTemplate.registerHelper('isVideo', function (type) {\r\n    return isMIME('video', this.type || type);\r\n});\r\n","/*\r\n * The MIT License (MIT)\r\n *\r\n * Copyright (c) 2017 Karl STEIN\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in all\r\n * copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n * SOFTWARE.\r\n *\r\n */\r\n\r\nimport {Mongo} from 'meteor/mongo';\r\n\r\n/**\r\n * Collection of upload tokens\r\n * @type {Mongo.Collection}\r\n */\r\nexport const Tokens = new Mongo.Collection('ufsTokens');\r\n","/*\r\n * The MIT License (MIT)\r\n *\r\n * Copyright (c) 2017 Karl STEIN\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in all\r\n * copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n * SOFTWARE.\r\n *\r\n */\r\n\r\nimport {_} from 'meteor/underscore';\r\nimport {Meteor} from 'meteor/meteor';\r\nimport {Store} from './ufs-store';\r\n\r\n\r\n/**\r\n * File uploader\r\n */\r\nexport class Uploader {\r\n\r\n    constructor(options) {\r\n        let self = this;\r\n\r\n        // Set default options\r\n        options = _.extend({\r\n            adaptive: true,\r\n            capacity: 0.9,\r\n            chunkSize: 16 * 1024,\r\n            data: null,\r\n            file: null,\r\n            maxChunkSize: 4 * 1024 * 1000,\r\n            maxTries: 5,\r\n            onAbort: this.onAbort,\r\n            onComplete: this.onComplete,\r\n            onCreate: this.onCreate,\r\n            onError: this.onError,\r\n            onProgress: this.onProgress,\r\n            onStart: this.onStart,\r\n            onStop: this.onStop,\r\n            retryDelay: 2000,\r\n            store: null,\r\n            transferDelay: 100\r\n        }, options);\r\n\r\n        // Check options\r\n        if (typeof options.adaptive !== 'boolean') {\r\n            throw new TypeError('adaptive is not a number');\r\n        }\r\n        if (typeof options.capacity !== 'number') {\r\n            throw new TypeError('capacity is not a number');\r\n        }\r\n        if (options.capacity <= 0 || options.capacity > 1) {\r\n            throw new RangeError('capacity must be a float between 0.1 and 1.0');\r\n        }\r\n        if (typeof options.chunkSize !== 'number') {\r\n            throw new TypeError('chunkSize is not a number');\r\n        }\r\n        if (!(options.data instanceof Blob) && !(options.data instanceof File)) {\r\n            throw new TypeError('data is not an Blob or File');\r\n        }\r\n        if (options.file === null || typeof options.file !== 'object') {\r\n            throw new TypeError('file is not an object');\r\n        }\r\n        if (typeof options.maxChunkSize !== 'number') {\r\n            throw new TypeError('maxChunkSize is not a number');\r\n        }\r\n        if (typeof options.maxTries !== 'number') {\r\n            throw new TypeError('maxTries is not a number');\r\n        }\r\n        if (typeof options.retryDelay !== 'number') {\r\n            throw new TypeError('retryDelay is not a number');\r\n        }\r\n        if (typeof options.transferDelay !== 'number') {\r\n            throw new TypeError('transferDelay is not a number');\r\n        }\r\n        if (typeof options.onAbort !== 'function') {\r\n            throw new TypeError('onAbort is not a function');\r\n        }\r\n        if (typeof options.onComplete !== 'function') {\r\n            throw new TypeError('onComplete is not a function');\r\n        }\r\n        if (typeof options.onCreate !== 'function') {\r\n            throw new TypeError('onCreate is not a function');\r\n        }\r\n        if (typeof options.onError !== 'function') {\r\n            throw new TypeError('onError is not a function');\r\n        }\r\n        if (typeof options.onProgress !== 'function') {\r\n            throw new TypeError('onProgress is not a function');\r\n        }\r\n        if (typeof options.onStart !== 'function') {\r\n            throw new TypeError('onStart is not a function');\r\n        }\r\n        if (typeof options.onStop !== 'function') {\r\n            throw new TypeError('onStop is not a function');\r\n        }\r\n        if (typeof options.store !== 'string' && !(options.store instanceof Store)) {\r\n            throw new TypeError('store must be the name of the store or an instance of UploadFS.Store');\r\n        }\r\n\r\n        // Public attributes\r\n        self.adaptive = options.adaptive;\r\n        self.capacity = parseFloat(options.capacity);\r\n        self.chunkSize = parseInt(options.chunkSize);\r\n        self.maxChunkSize = parseInt(options.maxChunkSize);\r\n        self.maxTries = parseInt(options.maxTries);\r\n        self.retryDelay = parseInt(options.retryDelay);\r\n        self.transferDelay = parseInt(options.transferDelay);\r\n        self.onAbort = options.onAbort;\r\n        self.onComplete = options.onComplete;\r\n        self.onCreate = options.onCreate;\r\n        self.onError = options.onError;\r\n        self.onProgress = options.onProgress;\r\n        self.onStart = options.onStart;\r\n        self.onStop = options.onStop;\r\n\r\n        // Private attributes\r\n        let store = options.store;\r\n        let data = options.data;\r\n        let capacityMargin = 0.1;\r\n        let file = options.file;\r\n        let fileId = null;\r\n        let offset = 0;\r\n        let loaded = 0;\r\n        let total = data.size;\r\n        let tries = 0;\r\n        let postUrl = null;\r\n        let token = null;\r\n        let complete = false;\r\n        let uploading = false;\r\n\r\n        let timeA = null;\r\n        let timeB = null;\r\n\r\n        let elapsedTime = 0;\r\n        let startTime = 0;\r\n\r\n        // Keep only the name of the store\r\n        if (store instanceof Store) {\r\n            store = store.getName();\r\n        }\r\n\r\n        // Assign file to store\r\n        file.store = store;\r\n\r\n        function finish() {\r\n            // Finish the upload by telling the store the upload is complete\r\n            Meteor.call('ufsComplete', fileId, store, token, function (err, uploadedFile) {\r\n                if (err) {\r\n                    self.onError(err, file);\r\n                    self.abort();\r\n                }\r\n                else if (uploadedFile) {\r\n                    uploading = false;\r\n                    complete = true;\r\n                    file = uploadedFile;\r\n                    self.onComplete(uploadedFile);\r\n                }\r\n            });\r\n        }\r\n\r\n        /**\r\n         * Aborts the current transfer\r\n         */\r\n        self.abort = function () {\r\n            // Remove the file from database\r\n            Meteor.call('ufsDelete', fileId, store, token, function (err, result) {\r\n                if (err) {\r\n                    self.onError(err, file);\r\n                }\r\n            });\r\n\r\n            // Reset uploader status\r\n            uploading = false;\r\n            fileId = null;\r\n            offset = 0;\r\n            tries = 0;\r\n            loaded = 0;\r\n            complete = false;\r\n            startTime = null;\r\n            self.onAbort(file);\r\n        };\r\n\r\n        /**\r\n         * Returns the average speed in bytes per second\r\n         * @returns {number}\r\n         */\r\n        self.getAverageSpeed = function () {\r\n            let seconds = self.getElapsedTime() / 1000;\r\n            return self.getLoaded() / seconds;\r\n        };\r\n\r\n        /**\r\n         * Returns the elapsed time in milliseconds\r\n         * @returns {number}\r\n         */\r\n        self.getElapsedTime = function () {\r\n            if (startTime && self.isUploading()) {\r\n                return elapsedTime + (Date.now() - startTime);\r\n            }\r\n            return elapsedTime;\r\n        };\r\n\r\n        /**\r\n         * Returns the file\r\n         * @return {object}\r\n         */\r\n        self.getFile = function () {\r\n            return file;\r\n        };\r\n\r\n        /**\r\n         * Returns the loaded bytes\r\n         * @return {number}\r\n         */\r\n        self.getLoaded = function () {\r\n            return loaded;\r\n        };\r\n\r\n        /**\r\n         * Returns current progress\r\n         * @return {number}\r\n         */\r\n        self.getProgress = function () {\r\n            return Math.min((loaded / total) * 100 / 100, 1.0);\r\n        };\r\n\r\n        /**\r\n         * Returns the remaining time in milliseconds\r\n         * @returns {number}\r\n         */\r\n        self.getRemainingTime = function () {\r\n            let averageSpeed = self.getAverageSpeed();\r\n            let remainingBytes = total - self.getLoaded();\r\n            return averageSpeed && remainingBytes ? Math.max(remainingBytes / averageSpeed, 0) : 0;\r\n        };\r\n\r\n        /**\r\n         * Returns the upload speed in bytes per second\r\n         * @returns {number}\r\n         */\r\n        self.getSpeed = function () {\r\n            if (timeA && timeB && self.isUploading()) {\r\n                let seconds = (timeB - timeA) / 1000;\r\n                return self.chunkSize / seconds;\r\n            }\r\n            return 0;\r\n        };\r\n\r\n        /**\r\n         * Returns the total bytes\r\n         * @return {number}\r\n         */\r\n        self.getTotal = function () {\r\n            return total;\r\n        };\r\n\r\n        /**\r\n         * Checks if the transfer is complete\r\n         * @return {boolean}\r\n         */\r\n        self.isComplete = function () {\r\n            return complete;\r\n        };\r\n\r\n        /**\r\n         * Checks if the transfer is active\r\n         * @return {boolean}\r\n         */\r\n        self.isUploading = function () {\r\n            return uploading;\r\n        };\r\n\r\n        /**\r\n         * Reads a portion of file\r\n         * @param start\r\n         * @param length\r\n         * @param callback\r\n         * @returns {Blob}\r\n         */\r\n        self.readChunk = function (start, length, callback) {\r\n            if (typeof callback != 'function') {\r\n                throw new Error('readChunk is missing callback');\r\n            }\r\n            try {\r\n                let end;\r\n\r\n                // Calculate the chunk size\r\n                if (length && start + length > total) {\r\n                    end = total;\r\n                } else {\r\n                    end = start + length;\r\n                }\r\n                // Get chunk\r\n                let chunk = data.slice(start, end);\r\n                // Pass chunk to callback\r\n                callback.call(self, null, chunk);\r\n\r\n            } catch (err) {\r\n                console.error('read error', err);\r\n                // Retry to read chunk\r\n                Meteor.setTimeout(function () {\r\n                    if (tries < self.maxTries) {\r\n                        tries += 1;\r\n                        self.readChunk(start, length, callback);\r\n                    }\r\n                }, self.retryDelay);\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Sends a file chunk to the store\r\n         */\r\n        self.sendChunk = function () {\r\n            if (!complete && startTime !== null) {\r\n                if (offset < total) {\r\n                    let chunkSize = self.chunkSize;\r\n\r\n                    // Use adaptive length\r\n                    if (self.adaptive && timeA && timeB && timeB > timeA) {\r\n                        let duration = (timeB - timeA) / 1000;\r\n                        let max = self.capacity * (1 + capacityMargin);\r\n                        let min = self.capacity * (1 - capacityMargin);\r\n\r\n                        if (duration >= max) {\r\n                            chunkSize = Math.abs(Math.round(chunkSize * (max - duration)));\r\n\r\n                        } else if (duration < min) {\r\n                            chunkSize = Math.round(chunkSize * (min / duration));\r\n                        }\r\n                        // Limit to max chunk size\r\n                        if (self.maxChunkSize > 0 && chunkSize > self.maxChunkSize) {\r\n                            chunkSize = self.maxChunkSize;\r\n                        }\r\n                    }\r\n\r\n                    // Limit to max chunk size\r\n                    if (self.maxChunkSize > 0 && chunkSize > self.maxChunkSize) {\r\n                        chunkSize = self.maxChunkSize;\r\n                    }\r\n\r\n                    // Reduce chunk size to fit total\r\n                    if (offset + chunkSize > total) {\r\n                        chunkSize = total - offset;\r\n                    }\r\n\r\n                    // Prepare the chunk\r\n                    self.readChunk(offset, chunkSize, function (err, chunk) {\r\n                        if (err) {\r\n                            self.onError(err, file);\r\n                            return;\r\n                        }\r\n\r\n                        let xhr = new XMLHttpRequest();\r\n                        xhr.onreadystatechange = function () {\r\n                            if (xhr.readyState === 4) {\r\n                                if (_.contains([200, 201, 202, 204], xhr.status)) {\r\n                                    timeB = Date.now();\r\n                                    offset += chunkSize;\r\n                                    loaded += chunkSize;\r\n\r\n                                    // Send next chunk\r\n                                    self.onProgress(file, self.getProgress());\r\n\r\n                                    // Finish upload\r\n                                    if (loaded >= total) {\r\n                                        elapsedTime = Date.now() - startTime;\r\n                                        finish();\r\n                                    } else {\r\n                                        Meteor.setTimeout(self.sendChunk, self.transferDelay);\r\n                                    }\r\n                                }\r\n                                else if (!_.contains([402, 403, 404, 500], xhr.status)) {\r\n                                    // Retry until max tries is reach\r\n                                    // But don't retry if these errors occur\r\n                                    if (tries <= self.maxTries) {\r\n                                        tries += 1;\r\n                                        // Wait before retrying\r\n                                        Meteor.setTimeout(self.sendChunk, self.retryDelay);\r\n                                    } else {\r\n                                        self.abort();\r\n                                    }\r\n                                }\r\n                                else {\r\n                                    self.abort();\r\n                                }\r\n                            }\r\n                        };\r\n\r\n                        // Calculate upload progress\r\n                        let progress = (offset + chunkSize) / total;\r\n                        // let formData = new FormData();\r\n                        // formData.append('progress', progress);\r\n                        // formData.append('chunk', chunk);\r\n                        let url = `${postUrl}&progress=${progress}`;\r\n\r\n                        timeA = Date.now();\r\n                        timeB = null;\r\n                        uploading = true;\r\n\r\n                        // Send chunk to the store\r\n                        xhr.open('POST', url, true);\r\n                        xhr.send(chunk);\r\n                    });\r\n                }\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Starts or resumes the transfer\r\n         */\r\n        self.start = function () {\r\n            if (!fileId) {\r\n                // Create the file document and get the token\r\n                // that allows the user to send chunks to the store.\r\n                Meteor.call('ufsCreate', _.extend({}, file), function (err, result) {\r\n                    if (err) {\r\n                        self.onError(err, file);\r\n                    } else if (result) {\r\n                        token = result.token;\r\n                        postUrl = result.url;\r\n                        fileId = result.fileId;\r\n                        file._id = result.fileId;\r\n                        self.onCreate(file);\r\n                        tries = 0;\r\n                        startTime = Date.now();\r\n                        self.onStart(file);\r\n                        self.sendChunk();\r\n                    }\r\n                });\r\n            } else if (!uploading && !complete) {\r\n                // Resume uploading\r\n                tries = 0;\r\n                startTime = Date.now();\r\n                self.onStart(file);\r\n                self.sendChunk();\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Stops the transfer\r\n         */\r\n        self.stop = function () {\r\n            if (uploading) {\r\n                // Update elapsed time\r\n                elapsedTime = Date.now() - startTime;\r\n                startTime = null;\r\n                uploading = false;\r\n                self.onStop(file);\r\n\r\n                Meteor.call('ufsStop', fileId, store, token, function (err, result) {\r\n                    if (err) {\r\n                        self.onError(err, file);\r\n                    }\r\n                });\r\n            }\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Called when the file upload is aborted\r\n     * @param file\r\n     */\r\n    onAbort(file) {\r\n    }\r\n\r\n    /**\r\n     * Called when the file upload is complete\r\n     * @param file\r\n     */\r\n    onComplete(file) {\r\n    }\r\n\r\n    /**\r\n     * Called when the file is created in the collection\r\n     * @param file\r\n     */\r\n    onCreate(file) {\r\n    }\r\n\r\n    /**\r\n     * Called when an error occurs during file upload\r\n     * @param err\r\n     * @param file\r\n     */\r\n    onError(err, file) {\r\n        console.error(`ufs: ${err.message}`);\r\n    }\r\n\r\n    /**\r\n     * Called when a file chunk has been sent\r\n     * @param file\r\n     * @param progress is a float from 0.0 to 1.0\r\n     */\r\n    onProgress(file, progress) {\r\n    }\r\n\r\n    /**\r\n     * Called when the file upload starts\r\n     * @param file\r\n     */\r\n    onStart(file) {\r\n    }\r\n\r\n    /**\r\n     * Called when the file upload stops\r\n     * @param file\r\n     */\r\n    onStop(file) {\r\n    }\r\n}\r\n"]}